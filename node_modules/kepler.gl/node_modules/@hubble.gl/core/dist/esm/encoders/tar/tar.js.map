{"version":3,"sources":["../../../../src/encoders/tar/tar.js"],"names":["utils","header","blockSize","recordSize","Tar","recordsPerBlock","written","out","clean","blocks","length","save","bind","clear","append","filepath","input","opts","checksum","stringToUint8","constructor","Uint8Array","prototype","errorInput","toString","match","errorMessage","mode","parseInt","mtime","Math","floor","Number","Date","uid","gid","data","fileName","fileMode","pad","fileSize","type","ustar","owner","group","Object","keys","forEach","key","i","value","charCodeAt","headerArr","format","headerLength","ceil","inputLength","push","buffers","chunks","max","pow","chunk","b","c","buffer","set","Blob"],"mappings":"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","sourcesContent":["// Copyright (c) 2020 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n/* global Blob */\nimport * as utils from './utils';\nimport * as header from './header';\n\nlet blockSize;\nconst recordSize = 512;\n\nclass Tar {\n  /** @type {{ header: any; input: string | Uint8Array; headerLength: number; inputLength: number; }[]} */\n  blocks;\n  /**\n   * @param {number} [recordsPerBlock]\n   */\n  constructor(recordsPerBlock) {\n    this.written = 0;\n    blockSize = (recordsPerBlock || 20) * recordSize;\n    this.out = utils.clean(blockSize);\n    this.blocks = [];\n    this.length = 0;\n    this.save = this.save.bind(this);\n    this.clear = this.clear.bind(this);\n    this.append = this.append.bind(this);\n  }\n\n  /**\n   * @param {string} filepath\n   * @param {string | Uint8Array} input\n   * @param {{ mode?: any; mtime?: any; uid?: any; gid?: any; owner?: any; group?: any; }} [opts]\n   */\n  append(filepath, input, opts) {\n    let checksum;\n\n    if (typeof input === 'string') {\n      input = utils.stringToUint8(input);\n    } else if (input.constructor !== Uint8Array.prototype.constructor) {\n      const errorInput = input.constructor\n        .toString()\n        .match(/function\\s*([$A-Za-z_][0-9A-Za-z_]*)\\s*\\(/)[1];\n      const errorMessage = `Invalid input type. You gave me: ${errorInput}`;\n      throw errorMessage;\n    }\n\n    opts = opts || {};\n\n    const mode = opts.mode || parseInt('777', 8) & 0xfff;\n    const mtime = opts.mtime || Math.floor(Number(new Date()) / 1000);\n    const uid = opts.uid || 0;\n    const gid = opts.gid || 0;\n\n    const data = {\n      fileName: filepath,\n      fileMode: utils.pad(mode, 7),\n      uid: utils.pad(uid, 7),\n      gid: utils.pad(gid, 7),\n      fileSize: utils.pad(input.length, 11),\n      mtime: utils.pad(mtime, 11),\n      checksum: '        ',\n      // 0 = just a file\n      type: '0',\n      ustar: 'ustar  ',\n      owner: opts.owner || '',\n      group: opts.group || ''\n    };\n\n    // calculate the checksum\n    checksum = 0;\n    Object.keys(data).forEach(key => {\n      let i;\n      const value = data[key];\n      let length;\n\n      for (i = 0, length = value.length; i < length; i += 1) {\n        checksum += value.charCodeAt(i);\n      }\n    });\n\n    data.checksum = `${utils.pad(checksum, 6)}\\u0000 `;\n\n    const headerArr = header.format(data);\n\n    const headerLength = Math.ceil(headerArr.length / recordSize) * recordSize;\n    const inputLength = Math.ceil(input.length / recordSize) * recordSize;\n\n    this.blocks.push({\n      header: headerArr,\n      input,\n      headerLength,\n      inputLength\n    });\n  }\n\n  save() {\n    const buffers = [];\n    const chunks = [];\n    let length = 0;\n    const max = Math.pow(2, 20);\n\n    let chunk = [];\n    this.blocks.forEach(b => {\n      if (length + b.headerLength + b.inputLength > max) {\n        chunks.push({blocks: chunk, length});\n        chunk = [];\n        length = 0;\n      }\n      chunk.push(b);\n      length += b.headerLength + b.inputLength;\n    });\n    chunks.push({blocks: chunk, length});\n\n    chunks.forEach(c => {\n      const buffer = new Uint8Array(c.length);\n      let written = 0;\n      c.blocks.forEach(b => {\n        buffer.set(b.header, written);\n        written += b.headerLength;\n        buffer.set(b.input, written);\n        written += b.inputLength;\n      });\n      buffers.push(buffer);\n    });\n\n    buffers.push(new Uint8Array(2 * recordSize));\n\n    return new Blob(buffers, {type: 'octet/stream'});\n  }\n\n  clear() {\n    this.written = 0;\n    this.out = utils.clean(blockSize);\n  }\n}\n\nexport default Tar;\n"],"file":"tar.js"}