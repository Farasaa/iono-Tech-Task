"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.testForCoordinates = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _react = _interopRequireWildcard(require("react"));

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _classnames = _interopRequireDefault(require("classnames"));

var _geocoding = _interopRequireDefault(require("@mapbox/mapbox-sdk/services/geocoding"));

var _reactIntl = require("react-intl");

var _viewportMercatorProject = require("viewport-mercator-project");

var _constants = require("@kepler.gl/constants");

var _styledComponents2 = require("../common/styled-components");

var _icons = require("../common/icons");

var _templateObject;

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

// matches only valid coordinates
var COORDINATE_REGEX_STRING = '^[-+]?([1-8]?\\d(\\.\\d+)?|90(\\.0+)?),\\s*[-+]?(180(\\.0+)?|((1[0-7]\\d)|([1-9]?\\d))(\\.\\d+)?)';
var COORDINATE_REGEX = RegExp(COORDINATE_REGEX_STRING);
var PLACEHOLDER = 'Enter an address or coordinates, ex 37.79,-122.40';
var debounceTimeout = null;

var testForCoordinates = function testForCoordinates(query) {
  var isValid = COORDINATE_REGEX.test(query.trim());

  if (!isValid) {
    return [isValid, query];
  }

  var tokens = query.trim().split(',');
  return [isValid, Number(tokens[0]), Number(tokens[1])];
};

exports.testForCoordinates = testForCoordinates;

var StyledContainer = _styledComponents["default"].div(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2["default"])(["\n  position: relative;\n  color: ", ";\n\n  .geocoder-input {\n    box-shadow: ", ";\n\n    .geocoder-input__search {\n      position: absolute;\n      height: ", "px;\n      width: 30px;\n      padding-left: 6px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      color: ", ";\n    }\n\n    input {\n      padding: 4px 36px;\n      height: ", "px;\n      caret-color: unset;\n    }\n  }\n\n  .geocoder-results {\n    box-shadow: ", ";\n    background-color: ", ";\n    position: absolute;\n    width: ", "px;\n    margin-top: ", "px;\n  }\n\n  .geocoder-item {\n    ", ";\n    ", ";\n\n    &.active {\n      background-color: ", ";\n    }\n  }\n\n  .remove-result {\n    position: absolute;\n    right: 16px;\n    top: 0px;\n    height: ", "px;\n    display: flex;\n    align-items: center;\n\n    :hover {\n      cursor: pointer;\n      color: ", ";\n    }\n  }\n"])), function (props) {
  return props.theme.textColor;
}, function (props) {
  return props.theme.boxShadow;
}, function (props) {
  return props.theme.geocoderInputHeight;
}, function (props) {
  return props.theme.subtextColor;
}, function (props) {
  return props.theme.geocoderInputHeight;
}, function (props) {
  return props.theme.boxShadow;
}, function (props) {
  return props.theme.panelBackground;
}, function (props) {
  return Number.isFinite(props.width) ? props.width : props.theme.geocoderWidth;
}, function (props) {
  return props.theme.dropdownWapperMargin;
}, function (props) {
  return props.theme.dropdownListItem;
}, function (props) {
  return props.theme.textTruncate;
}, function (props) {
  return props.theme.dropdownListHighlightBg;
}, function (props) {
  return props.theme.geocoderInputHeight;
}, function (props) {
  return props.theme.textColorHl;
});

/** @type {import('./geocoder').GeocoderComponent} */
var GeoCoder = function GeoCoder(_ref) {
  var mapboxApiAccessToken = _ref.mapboxApiAccessToken,
      _ref$className = _ref.className,
      className = _ref$className === void 0 ? '' : _ref$className,
      _ref$limit = _ref.limit,
      limit = _ref$limit === void 0 ? 5 : _ref$limit,
      _ref$timeout = _ref.timeout,
      timeout = _ref$timeout === void 0 ? 300 : _ref$timeout,
      _ref$formatItem = _ref.formatItem,
      formatItem = _ref$formatItem === void 0 ? function (item) {
    return item.place_name;
  } : _ref$formatItem,
      viewport = _ref.viewport,
      onSelected = _ref.onSelected,
      onDeleteMarker = _ref.onDeleteMarker,
      transitionDuration = _ref.transitionDuration,
      pointZoom = _ref.pointZoom,
      width = _ref.width,
      intl = _ref.intl;

  var _useState = (0, _react.useState)(''),
      _useState2 = (0, _slicedToArray2["default"])(_useState, 2),
      inputValue = _useState2[0],
      setInputValue = _useState2[1];

  var _useState3 = (0, _react.useState)(false),
      _useState4 = (0, _slicedToArray2["default"])(_useState3, 2),
      showResults = _useState4[0],
      setShowResults = _useState4[1];

  var _useState5 = (0, _react.useState)(false),
      _useState6 = (0, _slicedToArray2["default"])(_useState5, 2),
      showDelete = _useState6[0],
      setShowDelete = _useState6[1];
  /** @type {import('./geocoder').Results} */


  var initialResults = [];

  var _useState7 = (0, _react.useState)(initialResults),
      _useState8 = (0, _slicedToArray2["default"])(_useState7, 2),
      results = _useState8[0],
      setResults = _useState8[1];

  var _useState9 = (0, _react.useState)(0),
      _useState10 = (0, _slicedToArray2["default"])(_useState9, 2),
      selectedIndex = _useState10[0],
      setSelectedIndex = _useState10[1];

  var client = (0, _react.useMemo)(function () {
    return (0, _geocoding["default"])({
      accessToken: mapboxApiAccessToken
    });
  }, [mapboxApiAccessToken]);
  var onChange = (0, _react.useCallback)(function (event) {
    var queryString = event.target.value;
    setInputValue(queryString);
    var resultCoordinates = testForCoordinates(queryString);

    if (resultCoordinates[0]) {
      var _resultCoordinates = (0, _slicedToArray2["default"])(resultCoordinates, 3),
          _ = _resultCoordinates[0],
          latitude = _resultCoordinates[1],
          longitude = _resultCoordinates[2];

      setResults([{
        center: [latitude, longitude],
        place_name: queryString
      }]);
    } else {
      if (debounceTimeout) {
        clearTimeout(debounceTimeout);
      }

      debounceTimeout = setTimeout( /*#__PURE__*/(0, _asyncToGenerator2["default"])( /*#__PURE__*/_regenerator["default"].mark(function _callee() {
        var response;
        return _regenerator["default"].wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                if (!(limit > 0 && Boolean(queryString))) {
                  _context.next = 11;
                  break;
                }

                _context.prev = 1;
                _context.next = 4;
                return client.forwardGeocode({
                  query: queryString,
                  limit: limit
                }).send();

              case 4:
                response = _context.sent;

                if (response.body.features) {
                  setShowResults(true);
                  setResults(response.body.features);
                }

                _context.next = 11;
                break;

              case 8:
                _context.prev = 8;
                _context.t0 = _context["catch"](1);
                // TODO: show geocode error
                // eslint-disable-next-line no-console
                console.log(_context.t0);

              case 11:
              case "end":
                return _context.stop();
            }
          }
        }, _callee, null, [[1, 8]]);
      })), timeout);
    }
  }, [client, limit, timeout, setResults, setShowResults]);
  var onBlur = (0, _react.useCallback)(function () {
    setTimeout(function () {
      setShowResults(false);
    }, timeout);
  }, [setShowResults, timeout]);
  var onFocus = (0, _react.useCallback)(function () {
    return setShowResults(true);
  }, [setShowResults]);
  var onItemSelected = (0, _react.useCallback)(function (item) {
    var newViewport = new _viewportMercatorProject.WebMercatorViewport(viewport);
    var bbox = item.bbox,
        center = item.center;
    var gotoViewport = bbox ? newViewport.fitBounds([[bbox[0], bbox[1]], [bbox[2], bbox[3]]]) : {
      longitude: center[0],
      latitude: center[1],
      zoom: pointZoom
    };
    var longitude = gotoViewport.longitude,
        latitude = gotoViewport.latitude,
        zoom = gotoViewport.zoom;
    onSelected(_objectSpread(_objectSpread({}, viewport), {
      longitude: longitude,
      latitude: latitude,
      zoom: zoom,
      transitionDuration: transitionDuration
    }), item);
    setShowResults(false);
    setInputValue(formatItem(item));
    setShowDelete(true);
  }, [viewport, onSelected, transitionDuration, pointZoom, formatItem]);
  var onMarkDeleted = (0, _react.useCallback)(function () {
    setShowDelete(false);
    setInputValue('');
    onDeleteMarker === null || onDeleteMarker === void 0 ? void 0 : onDeleteMarker();
  }, [onDeleteMarker]);
  var onKeyDown = (0, _react.useCallback)(function (e) {
    if (!results || results.length === 0) {
      return;
    }

    switch (e.keyCode) {
      case _constants.KeyEvent.DOM_VK_UP:
        setSelectedIndex(selectedIndex > 0 ? selectedIndex - 1 : selectedIndex);
        break;

      case _constants.KeyEvent.DOM_VK_DOWN:
        setSelectedIndex(selectedIndex < results.length - 1 ? selectedIndex + 1 : selectedIndex);
        break;

      case _constants.KeyEvent.DOM_VK_ENTER:
      case _constants.KeyEvent.DOM_VK_RETURN:
        if (results[selectedIndex]) {
          onItemSelected(results[selectedIndex]);
        }

        break;

      default:
        break;
    }
  }, [results, selectedIndex, setSelectedIndex, onItemSelected]);
  return /*#__PURE__*/_react["default"].createElement(StyledContainer, {
    className: className,
    width: width
  }, /*#__PURE__*/_react["default"].createElement("div", {
    className: "geocoder-input"
  }, /*#__PURE__*/_react["default"].createElement("div", {
    className: "geocoder-input__search"
  }, /*#__PURE__*/_react["default"].createElement(_icons.Search, {
    height: "20px"
  })), /*#__PURE__*/_react["default"].createElement(_styledComponents2.Input, {
    type: "text",
    onChange: onChange,
    onBlur: onBlur,
    onFocus: onFocus,
    onKeyDown: onKeyDown,
    value: inputValue,
    placeholder: intl ? intl.formatMessage({
      id: 'geocoder.title',
      defaultMessage: PLACEHOLDER
    }) : PLACEHOLDER
  }), showDelete ? /*#__PURE__*/_react["default"].createElement("div", {
    className: "remove-result"
  }, /*#__PURE__*/_react["default"].createElement(_icons.Delete, {
    height: "12px",
    onClick: onMarkDeleted
  })) : null), showResults ? /*#__PURE__*/_react["default"].createElement("div", {
    className: "geocoder-results"
  }, results.map(function (item, index) {
    return /*#__PURE__*/_react["default"].createElement("div", {
      key: index,
      className: (0, _classnames["default"])('geocoder-item', {
        active: selectedIndex === index
      }),
      onClick: function onClick() {
        return onItemSelected(item);
      }
    }, formatItem(item));
  })) : null);
};

var _default = (0, _reactIntl.injectIntl)(GeoCoder);

exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9nZW9jb2Rlci9nZW9jb2Rlci50c3giXSwibmFtZXMiOlsiQ09PUkRJTkFURV9SRUdFWF9TVFJJTkciLCJDT09SRElOQVRFX1JFR0VYIiwiUmVnRXhwIiwiUExBQ0VIT0xERVIiLCJkZWJvdW5jZVRpbWVvdXQiLCJ0ZXN0Rm9yQ29vcmRpbmF0ZXMiLCJxdWVyeSIsImlzVmFsaWQiLCJ0ZXN0IiwidHJpbSIsInRva2VucyIsInNwbGl0IiwiTnVtYmVyIiwiU3R5bGVkQ29udGFpbmVyIiwic3R5bGVkIiwiZGl2IiwicHJvcHMiLCJ0aGVtZSIsInRleHRDb2xvciIsImJveFNoYWRvdyIsImdlb2NvZGVySW5wdXRIZWlnaHQiLCJzdWJ0ZXh0Q29sb3IiLCJwYW5lbEJhY2tncm91bmQiLCJpc0Zpbml0ZSIsIndpZHRoIiwiZ2VvY29kZXJXaWR0aCIsImRyb3Bkb3duV2FwcGVyTWFyZ2luIiwiZHJvcGRvd25MaXN0SXRlbSIsInRleHRUcnVuY2F0ZSIsImRyb3Bkb3duTGlzdEhpZ2hsaWdodEJnIiwidGV4dENvbG9ySGwiLCJHZW9Db2RlciIsIm1hcGJveEFwaUFjY2Vzc1Rva2VuIiwiY2xhc3NOYW1lIiwibGltaXQiLCJ0aW1lb3V0IiwiZm9ybWF0SXRlbSIsIml0ZW0iLCJwbGFjZV9uYW1lIiwidmlld3BvcnQiLCJvblNlbGVjdGVkIiwib25EZWxldGVNYXJrZXIiLCJ0cmFuc2l0aW9uRHVyYXRpb24iLCJwb2ludFpvb20iLCJpbnRsIiwiaW5wdXRWYWx1ZSIsInNldElucHV0VmFsdWUiLCJzaG93UmVzdWx0cyIsInNldFNob3dSZXN1bHRzIiwic2hvd0RlbGV0ZSIsInNldFNob3dEZWxldGUiLCJpbml0aWFsUmVzdWx0cyIsInJlc3VsdHMiLCJzZXRSZXN1bHRzIiwic2VsZWN0ZWRJbmRleCIsInNldFNlbGVjdGVkSW5kZXgiLCJjbGllbnQiLCJhY2Nlc3NUb2tlbiIsIm9uQ2hhbmdlIiwiZXZlbnQiLCJxdWVyeVN0cmluZyIsInRhcmdldCIsInZhbHVlIiwicmVzdWx0Q29vcmRpbmF0ZXMiLCJfIiwibGF0aXR1ZGUiLCJsb25naXR1ZGUiLCJjZW50ZXIiLCJjbGVhclRpbWVvdXQiLCJzZXRUaW1lb3V0IiwiQm9vbGVhbiIsImZvcndhcmRHZW9jb2RlIiwic2VuZCIsInJlc3BvbnNlIiwiYm9keSIsImZlYXR1cmVzIiwiY29uc29sZSIsImxvZyIsIm9uQmx1ciIsIm9uRm9jdXMiLCJvbkl0ZW1TZWxlY3RlZCIsIm5ld1ZpZXdwb3J0IiwiV2ViTWVyY2F0b3JWaWV3cG9ydCIsImJib3giLCJnb3RvVmlld3BvcnQiLCJmaXRCb3VuZHMiLCJ6b29tIiwib25NYXJrRGVsZXRlZCIsIm9uS2V5RG93biIsImUiLCJsZW5ndGgiLCJrZXlDb2RlIiwiS2V5RXZlbnQiLCJET01fVktfVVAiLCJET01fVktfRE9XTiIsIkRPTV9WS19FTlRFUiIsIkRPTV9WS19SRVRVUk4iLCJmb3JtYXRNZXNzYWdlIiwiaWQiLCJkZWZhdWx0TWVzc2FnZSIsIm1hcCIsImluZGV4IiwiYWN0aXZlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7QUFPQTtBQUNBLElBQU1BLHVCQUF1QixHQUMzQixtR0FERjtBQUVBLElBQU1DLGdCQUFnQixHQUFHQyxNQUFNLENBQUNGLHVCQUFELENBQS9CO0FBRUEsSUFBTUcsV0FBVyxHQUFHLG1EQUFwQjtBQUVBLElBQUlDLGVBQXNDLEdBQUcsSUFBN0M7O0FBRU8sSUFBTUMsa0JBQWtCLEdBQUcsU0FBckJBLGtCQUFxQixDQUFDQyxLQUFELEVBQTZEO0FBQzdGLE1BQU1DLE9BQU8sR0FBR04sZ0JBQWdCLENBQUNPLElBQWpCLENBQXNCRixLQUFLLENBQUNHLElBQU4sRUFBdEIsQ0FBaEI7O0FBRUEsTUFBSSxDQUFDRixPQUFMLEVBQWM7QUFDWixXQUFPLENBQUNBLE9BQUQsRUFBVUQsS0FBVixDQUFQO0FBQ0Q7O0FB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RUFBRUEsS0FEUDtBQUVFLE1BQUEsU0FBUyxFQUFFLDRCQUFXLGVBQVgsRUFBNEI7QUFBQ0MsUUFBQUEsTUFBTSxFQUFFaEQsYUFBYSxLQUFLK0M7QUFBM0IsT0FBNUIsQ0FGYjtBQUdFLE1BQUEsT0FBTyxFQUFFO0FBQUEsZUFBTXJCLGNBQWMsQ0FBQzNDLElBQUQsQ0FBcEI7QUFBQTtBQUhYLE9BS0dELFVBQVUsQ0FBQ0MsSUFBRCxDQUxiLENBRFc7QUFBQSxHQUFaLENBREgsQ0FEVSxHQVlSLElBckNOLENBREY7QUF5Q0QsQ0ExS0Q7O2VBNEtlLDJCQUFXTixRQUFYLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTUlUXG4vLyBDb3B5cmlnaHQgY29udHJpYnV0b3JzIHRvIHRoZSBrZXBsZXIuZ2wgcHJvamVjdFxuXG5pbXBvcnQgUmVhY3QsIHt1c2VDYWxsYmFjaywgdXNlTWVtbywgdXNlU3RhdGV9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBzdHlsZWQgZnJvbSAnc3R5bGVkLWNvbXBvbmVudHMnO1xuaW1wb3J0IGNsYXNzbmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgZ2VvY29kZXJTZXJ2aWNlIGZyb20gJ0BtYXBib3gvbWFwYm94LXNkay9zZXJ2aWNlcy9nZW9jb2RpbmcnO1xuaW1wb3J0IHtpbmplY3RJbnRsLCBJbnRsU2hhcGV9IGZyb20gJ3JlYWN0LWludGwnO1xuaW1wb3J0IHtXZWJNZXJjYXRvclZpZXdwb3J0fSBmcm9tICd2aWV3cG9ydC1tZXJjYXRvci1wcm9qZWN0JztcbmltcG9ydCB7S2V5RXZlbnR9IGZyb20gJ0BrZXBsZXIuZ2wvY29uc3RhbnRzJztcbmltcG9ydCB7SW5wdXR9IGZyb20gJy4uL2NvbW1vbi9zdHlsZWQtY29tcG9uZW50cyc7XG5pbXBvcnQge1NlYXJjaCwgRGVsZXRlfSBmcm9tICcuLi9jb21tb24vaWNvbnMnO1xuaW1wb3J0IHtWaWV3cG9ydH0gZnJvbSAnQGtlcGxlci5nbC90eXBlcyc7XG5cbnR5cGUgU3R5bGVkQ29udGFpbmVyUHJvcHMgPSB7XG4gIHdpZHRoPzogbnVtYmVyO1xufTtcblxuLy8gbWF0Y2hlcyBvbmx5IHZhbGlkIGNvb3JkaW5hdGVzXG5jb25zdCBDT09SRElOQVRFX1JFR0VYX1NUUklORyA9XG4gICdeWy0rXT8oWzEtOF0/XFxcXGQoXFxcXC5cXFxcZCspP3w5MChcXFxcLjArKT8pLFxcXFxzKlstK10/KDE4MChcXFxcLjArKT98KCgxWzAtN11cXFxcZCl8KFsxLTldP1xcXFxkKSkoXFxcXC5cXFxcZCspPyknO1xuY29uc3QgQ09PUkRJTkFURV9SRUdFWCA9IFJlZ0V4cChDT09SRElOQVRFX1JFR0VYX1NUUklORyk7XG5cbmNvbnN0IFBMQUNFSE9MREVSID0gJ0VudGVyIGFuIGFkZHJlc3Mgb3IgY29vcmRpbmF0ZXMsIGV4IDM3Ljc5LC0xMjIuNDAnO1xuXG5sZXQgZGVib3VuY2VUaW1lb3V0OiBOb2RlSlMuVGltZW91dCB8IG51bGwgPSBudWxsO1xuXG5leHBvcnQgY29uc3QgdGVzdEZvckNvb3JkaW5hdGVzID0gKHF1ZXJ5OiBzdHJpbmcpOiBbdHJ1ZSwgbnVtYmVyLCBudW1iZXJdIHwgW2ZhbHNlLCBzdHJpbmddID0+IHtcbiAgY29uc3QgaXNWYWxpZCA9IENPT1JESU5BVEVfUkVHRVgudGVzdChxdWVyeS50cmltKCkpO1xuXG4gIGlmICghaXNWYWxpZCkge1xuICAgIHJldHVybiBbaXNWYWxpZCwgcXVlcnldO1xuICB9XG5cbiAgY29uc3QgdG9rZW5zID0gcXVlcnkudHJpbSgpLnNwbGl0KCcsJyk7XG5cbiAgcmV0dXJuIFtpc1ZhbGlkLCBOdW1iZXIodG9rZW5zWzBdKSwgTnVtYmVyKHRva2Vuc1sxXSldO1xufTtcblxuY29uc3QgU3R5bGVkQ29udGFpbmVyID0gc3R5bGVkLmRpdjxTdHlsZWRDb250YWluZXJQcm9wcz5gXG4gIHBvc2l0aW9uOiByZWxhdGl2ZTtcbiAgY29sb3I6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUudGV4dENvbG9yfTtcblxuICAuZ2VvY29kZXItaW5wdXQge1xuICAgIGJveC1zaGFkb3c6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUuYm94U2hhZG93fTtcblxuICAgIC5nZW9jb2Rlci1pbnB1dF9fc2VhcmNoIHtcbiAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTtcbiAgICAgIGhlaWdodDogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS5nZW9jb2RlcklucHV0SGVpZ2h0fXB4O1xuICAgICAgd2lkdGg6IDMwcHg7XG4gICAgICBwYWRkaW5nLWxlZnQ6IDZweDtcbiAgICAgIGRpc3BsYXk6IGZsZXg7XG4gICAgICBhbGlnbi1pdGVtczogY2VudGVyO1xuICAgICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7XG4gICAgICBjb2xvcjogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS5zdWJ0ZXh0Q29sb3J9O1xuICAgIH1cblxuICAgIGlucHV0IHtcbiAgICAgIHBhZGRpbmc6IDRweCAzNnB4O1xuICAgICAgaGVpZ2h0OiAke3Byb3BzID0+IHByb3BzLnRoZW1lLmdlb2NvZGVySW5wdXRIZWlnaHR9cHg7XG4gICAgICBjYXJldC1jb2xvcjogdW5zZXQ7XG4gICAgfVxuICB9XG5cbiAgLmdlb2NvZGVyLXJlc3VsdHMge1xuICAgIGJveC1zaGFkb3c6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUuYm94U2hhZG93fTtcbiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAke3Byb3BzID0+IHByb3BzLnRoZW1lLnBhbmVsQmFja2dyb3VuZH07XG4gICAgcG9zaXRpb246IGFic29sdXRlO1xuICAgIHdpZHRoOiAke3Byb3BzID0+IChOdW1iZXIuaXNGaW5pdGUocHJvcHMud2lkdGgpID8gcHJvcHMud2lkdGggOiBwcm9wcy50aGVtZS5nZW9jb2RlcldpZHRoKX1weDtcbiAgICBtYXJnaW4tdG9wOiAke3Byb3BzID0+IHByb3BzLnRoZW1lLmRyb3Bkb3duV2FwcGVyTWFyZ2lufXB4O1xuICB9XG5cbiAgLmdlb2NvZGVyLWl0ZW0ge1xuICAgICR7cHJvcHMgPT4gcHJvcHMudGhlbWUuZHJvcGRvd25MaXN0SXRlbX07XG4gICAgJHtwcm9wcyA9PiBwcm9wcy50aGVtZS50ZXh0VHJ1bmNhdGV9O1xuXG4gICAgJi5hY3RpdmUge1xuICAgICAgYmFja2dyb3VuZC1jb2xvcjogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS5kcm9wZG93bkxpc3RIaWdobGlnaHRCZ307XG4gICAgfVxuICB9XG5cbiAgLnJlbW92ZS1yZXN1bHQge1xuICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTtcbiAgICByaWdodDogMTZweDtcbiAgICB0b3A6IDBweDtcbiAgICBoZWlnaHQ6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUuZ2VvY29kZXJJbnB1dEhlaWdodH1weDtcbiAgICBkaXNwbGF5OiBmbGV4O1xuICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7XG5cbiAgICA6aG92ZXIge1xuICAgICAgY3Vyc29yOiBwb2ludGVyO1xuICAgICAgY29sb3I6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUudGV4dENvbG9ySGx9O1xuICAgIH1cbiAgfVxuYDtcblxuZXhwb3J0IGludGVyZmFjZSBSZXN1bHQge1xuICBjZW50ZXI6IFtudW1iZXIsIG51bWJlcl07XG4gIHBsYWNlX25hbWU6IHN0cmluZztcbiAgYmJveD86IFtudW1iZXIsIG51bWJlciwgbnVtYmVyLCBudW1iZXJdO1xuICB0ZXh0Pzogc3RyaW5nO1xufVxuXG5leHBvcnQgdHlwZSBSZXN1bHRzID0gUmVhZG9ubHlBcnJheTxSZXN1bHQ+O1xuXG50eXBlIEdlb2NvZGVyUHJvcHMgPSB7XG4gIG1hcGJveEFwaUFjY2Vzc1Rva2VuOiBzdHJpbmc7XG4gIGNsYXNzTmFtZT86IHN0cmluZztcbiAgbGltaXQ/OiBudW1iZXI7XG4gIHRpbWVvdXQ/OiBudW1iZXI7XG4gIGZvcm1hdEl0ZW0/OiAoaXRlbTogUmVzdWx0KSA9PiBzdHJpbmc7XG4gIHZpZXdwb3J0PzogVmlld3BvcnQ7XG4gIG9uU2VsZWN0ZWQ6ICh2aWV3cG9ydDogVmlld3BvcnQgfCBudWxsLCBpdGVtOiBSZXN1bHQpID0+IHZvaWQ7XG4gIG9uRGVsZXRlTWFya2VyPzogKCkgPT4gdm9pZDtcbiAgdHJhbnNpdGlvbkR1cmF0aW9uPzogbnVtYmVyO1xuICBwb2ludFpvb20/OiBudW1iZXI7XG4gIHdpZHRoPzogbnVtYmVyO1xufTtcblxudHlwZSBJbnRsUHJvcHMgPSB7XG4gIGludGw6IEludGxTaGFwZTtcbn07XG5cbi8qKiBAdHlwZSB7aW1wb3J0KCcuL2dlb2NvZGVyJykuR2VvY29kZXJDb21wb25lbnR9ICovXG5jb25zdCBHZW9Db2RlcjogUmVhY3QuRkM8R2VvY29kZXJQcm9wcyAmIEludGxQcm9wcz4gPSAoe1xuICBtYXBib3hBcGlBY2Nlc3NUb2tlbixcbiAgY2xhc3NOYW1lID0gJycsXG4gIGxpbWl0ID0gNSxcbiAgdGltZW91dCA9IDMwMCxcbiAgZm9ybWF0SXRlbSA9IGl0ZW0gPT4gaXRlbS5wbGFjZV9uYW1lLFxuICB2aWV3cG9ydCxcbiAgb25TZWxlY3RlZCxcbiAgb25EZWxldGVNYXJrZXIsXG4gIHRyYW5zaXRpb25EdXJhdGlvbixcbiAgcG9pbnRab29tLFxuICB3aWR0aCxcbiAgaW50bFxufSkgPT4ge1xuICBjb25zdCBbaW5wdXRWYWx1ZSwgc2V0SW5wdXRWYWx1ZV0gPSB1c2VTdGF0ZSgnJyk7XG4gIGNvbnN0IFtzaG93UmVzdWx0cywgc2V0U2hvd1Jlc3VsdHNdID0gdXNlU3RhdGUoZmFsc2UpO1xuICBjb25zdCBbc2hvd0RlbGV0ZSwgc2V0U2hvd0RlbGV0ZV0gPSB1c2VTdGF0ZShmYWxzZSk7XG4gIC8qKiBAdHlwZSB7aW1wb3J0KCcuL2dlb2NvZGVyJykuUmVzdWx0c30gKi9cbiAgY29uc3QgaW5pdGlhbFJlc3VsdHM6IFJlc3VsdFtdID0gW107XG4gIGNvbnN0IFtyZXN1bHRzLCBzZXRSZXN1bHRzXSA9IHVzZVN0YXRlKGluaXRpYWxSZXN1bHRzKTtcbiAgY29uc3QgW3NlbGVjdGVkSW5kZXgsIHNldFNlbGVjdGVkSW5kZXhdID0gdXNlU3RhdGUoMCk7XG5cbiAgY29uc3QgY2xpZW50ID0gdXNlTWVtbygoKSA9PiBnZW9jb2RlclNlcnZpY2Uoe2FjY2Vzc1Rva2VuOiBtYXBib3hBcGlBY2Nlc3NUb2tlbn0pLCBbXG4gICAgbWFwYm94QXBpQWNjZXNzVG9rZW5cbiAgXSk7XG5cbiAgY29uc3Qgb25DaGFuZ2UgPSB1c2VDYWxsYmFjayhcbiAgICBldmVudCA9PiB7XG4gICAgICBjb25zdCBxdWVyeVN0cmluZyA9IGV2ZW50LnRhcmdldC52YWx1ZTtcbiAgICAgIHNldElucHV0VmFsdWUocXVlcnlTdHJpbmcpO1xuICAgICAgY29uc3QgcmVzdWx0Q29vcmRpbmF0ZXMgPSB0ZXN0Rm9yQ29vcmRpbmF0ZXMocXVlcnlTdHJpbmcpO1xuICAgICAgaWYgKHJlc3VsdENvb3JkaW5hdGVzWzBdKSB7XG4gICAgICAgIGNvbnN0IFtfLCBsYXRpdHVkZSwgbG9uZ2l0dWRlXSA9IHJlc3VsdENvb3JkaW5hdGVzO1xuICAgICAgICBzZXRSZXN1bHRzKFt7Y2VudGVyOiBbbGF0aXR1ZGUsIGxvbmdpdHVkZV0sIHBsYWNlX25hbWU6IHF1ZXJ5U3RyaW5nfV0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGRlYm91bmNlVGltZW91dCkge1xuICAgICAgICAgIGNsZWFyVGltZW91dChkZWJvdW5jZVRpbWVvdXQpO1xuICAgICAgICB9XG4gICAgICAgIGRlYm91bmNlVGltZW91dCA9IHNldFRpbWVvdXQoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgIGlmIChsaW1pdCA+IDAgJiYgQm9vbGVhbihxdWVyeVN0cmluZykpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgY2xpZW50XG4gICAgICAgICAgICAgICAgLmZvcndhcmRHZW9jb2RlKHtcbiAgICAgICAgICAgICAgICAgIHF1ZXJ5OiBxdWVyeVN0cmluZyxcbiAgICAgICAgICAgICAgICAgIGxpbWl0XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAuc2VuZCgpO1xuICAgICAgICAgICAgICBpZiAocmVzcG9uc2UuYm9keS5mZWF0dXJlcykge1xuICAgICAgICAgICAgICAgIHNldFNob3dSZXN1bHRzKHRydWUpO1xuICAgICAgICAgICAgICAgIHNldFJlc3VsdHMocmVzcG9uc2UuYm9keS5mZWF0dXJlcyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgLy8gVE9ETzogc2hvdyBnZW9jb2RlIGVycm9yXG4gICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSwgdGltZW91dCk7XG4gICAgICB9XG4gICAgfSxcbiAgICBbY2xpZW50LCBsaW1pdCwgdGltZW91dCwgc2V0UmVzdWx0cywgc2V0U2hvd1Jlc3VsdHNdXG4gICk7XG5cbiAgY29uc3Qgb25CbHVyID0gdXNlQ2FsbGJhY2soKCkgPT4ge1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgc2V0U2hvd1Jlc3VsdHMoZmFsc2UpO1xuICAgIH0sIHRpbWVvdXQpO1xuICB9LCBbc2V0U2hvd1Jlc3VsdHMsIHRpbWVvdXRdKTtcblxuICBjb25zdCBvbkZvY3VzID0gdXNlQ2FsbGJhY2soKCkgPT4gc2V0U2hvd1Jlc3VsdHModHJ1ZSksIFtzZXRTaG93UmVzdWx0c10pO1xuXG4gIGNvbnN0IG9uSXRlbVNlbGVjdGVkID0gdXNlQ2FsbGJhY2soXG4gICAgaXRlbSA9PiB7XG4gICAgICBjb25zdCBuZXdWaWV3cG9ydCA9IG5ldyBXZWJNZXJjYXRvclZpZXdwb3J0KHZpZXdwb3J0KTtcbiAgICAgIGNvbnN0IHtiYm94LCBjZW50ZXJ9ID0gaXRlbTtcblxuICAgICAgY29uc3QgZ290b1ZpZXdwb3J0ID0gYmJveFxuICAgICAgICA/IG5ld1ZpZXdwb3J0LmZpdEJvdW5kcyhbXG4gICAgICAgICAgICBbYmJveFswXSwgYmJveFsxXV0sXG4gICAgICAgICAgICBbYmJveFsyXSwgYmJveFszXV1cbiAgICAgICAgICBdKVxuICAgICAgICA6IHtcbiAgICAgICAgICAgIGxvbmdpdHVkZTogY2VudGVyWzBdLFxuICAgICAgICAgICAgbGF0aXR1ZGU6IGNlbnRlclsxXSxcbiAgICAgICAgICAgIHpvb206IHBvaW50Wm9vbVxuICAgICAgICAgIH07XG5cbiAgICAgIGNvbnN0IHtsb25naXR1ZGUsIGxhdGl0dWRlLCB6b29tfSA9IGdvdG9WaWV3cG9ydDtcblxuICAgICAgb25TZWxlY3RlZCh7Li4udmlld3BvcnQsIC4uLntsb25naXR1ZGUsIGxhdGl0dWRlLCB6b29tLCB0cmFuc2l0aW9uRHVyYXRpb259fSwgaXRlbSk7XG5cbiAgICAgIHNldFNob3dSZXN1bHRzKGZhbHNlKTtcbiAgICAgIHNldElucHV0VmFsdWUoZm9ybWF0SXRlbShpdGVtKSk7XG4gICAgICBzZXRTaG93RGVsZXRlKHRydWUpO1xuICAgIH0sXG4gICAgW3ZpZXdwb3J0LCBvblNlbGVjdGVkLCB0cmFuc2l0aW9uRHVyYXRpb24sIHBvaW50Wm9vbSwgZm9ybWF0SXRlbV1cbiAgKTtcblxuICBjb25zdCBvbk1hcmtEZWxldGVkID0gdXNlQ2FsbGJhY2soKCkgPT4ge1xuICAgIHNldFNob3dEZWxldGUoZmFsc2UpO1xuICAgIHNldElucHV0VmFsdWUoJycpO1xuICAgIG9uRGVsZXRlTWFya2VyPy4oKTtcbiAgfSwgW29uRGVsZXRlTWFya2VyXSk7XG5cbiAgY29uc3Qgb25LZXlEb3duID0gdXNlQ2FsbGJhY2soXG4gICAgZSA9PiB7XG4gICAgICBpZiAoIXJlc3VsdHMgfHwgcmVzdWx0cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgc3dpdGNoIChlLmtleUNvZGUpIHtcbiAgICAgICAgY2FzZSBLZXlFdmVudC5ET01fVktfVVA6XG4gICAgICAgICAgc2V0U2VsZWN0ZWRJbmRleChzZWxlY3RlZEluZGV4ID4gMCA/IHNlbGVjdGVkSW5kZXggLSAxIDogc2VsZWN0ZWRJbmRleCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgS2V5RXZlbnQuRE9NX1ZLX0RPV046XG4gICAgICAgICAgc2V0U2VsZWN0ZWRJbmRleChzZWxlY3RlZEluZGV4IDwgcmVzdWx0cy5sZW5ndGggLSAxID8gc2VsZWN0ZWRJbmRleCArIDEgOiBzZWxlY3RlZEluZGV4KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBLZXlFdmVudC5ET01fVktfRU5URVI6XG4gICAgICAgIGNhc2UgS2V5RXZlbnQuRE9NX1ZLX1JFVFVSTjpcbiAgICAgICAgICBpZiAocmVzdWx0c1tzZWxlY3RlZEluZGV4XSkge1xuICAgICAgICAgICAgb25JdGVtU2VsZWN0ZWQocmVzdWx0c1tzZWxlY3RlZEluZGV4XSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH0sXG4gICAgW3Jlc3VsdHMsIHNlbGVjdGVkSW5kZXgsIHNldFNlbGVjdGVkSW5kZXgsIG9uSXRlbVNlbGVjdGVkXVxuICApO1xuXG4gIHJldHVybiAoXG4gICAgPFN0eWxlZENvbnRhaW5lciBjbGFzc05hbWU9e2NsYXNzTmFtZX0gd2lkdGg9e3dpZHRofT5cbiAgICAgIDxkaXYgY2xhc3NOYW1lPVwiZ2VvY29kZXItaW5wdXRcIj5cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJnZW9jb2Rlci1pbnB1dF9fc2VhcmNoXCI+XG4gICAgICAgICAgPFNlYXJjaCBoZWlnaHQ9XCIyMHB4XCIgLz5cbiAgICAgICAgPC9kaXY+XG4gICAgICAgIDxJbnB1dFxuICAgICAgICAgIHR5cGU9XCJ0ZXh0XCJcbiAgICAgICAgICBvbkNoYW5nZT17b25DaGFuZ2V9XG4gICAgICAgICAgb25CbHVyPXtvbkJsdXJ9XG4gICAgICAgICAgb25Gb2N1cz17b25Gb2N1c31cbiAgICAgICAgICBvbktleURvd249e29uS2V5RG93bn1cbiAgICAgICAgICB2YWx1ZT17aW5wdXRWYWx1ZX1cbiAgICAgICAgICBwbGFjZWhvbGRlcj17XG4gICAgICAgICAgICBpbnRsXG4gICAgICAgICAgICAgID8gaW50bC5mb3JtYXRNZXNzYWdlKHtpZDogJ2dlb2NvZGVyLnRpdGxlJywgZGVmYXVsdE1lc3NhZ2U6IFBMQUNFSE9MREVSfSlcbiAgICAgICAgICAgICAgOiBQTEFDRUhPTERFUlxuICAgICAgICAgIH1cbiAgICAgICAgLz5cbiAgICAgICAge3Nob3dEZWxldGUgPyAoXG4gICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJyZW1vdmUtcmVzdWx0XCI+XG4gICAgICAgICAgICA8RGVsZXRlIGhlaWdodD1cIjEycHhcIiBvbkNsaWNrPXtvbk1hcmtEZWxldGVkfSAvPlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICApIDogbnVsbH1cbiAgICAgIDwvZGl2PlxuXG4gICAgICB7c2hvd1Jlc3VsdHMgPyAoXG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPVwiZ2VvY29kZXItcmVzdWx0c1wiPlxuICAgICAgICAgIHtyZXN1bHRzLm1hcCgoaXRlbSwgaW5kZXgpID0+IChcbiAgICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgICAga2V5PXtpbmRleH1cbiAgICAgICAgICAgICAgY2xhc3NOYW1lPXtjbGFzc25hbWVzKCdnZW9jb2Rlci1pdGVtJywge2FjdGl2ZTogc2VsZWN0ZWRJbmRleCA9PT0gaW5kZXh9KX1cbiAgICAgICAgICAgICAgb25DbGljaz17KCkgPT4gb25JdGVtU2VsZWN0ZWQoaXRlbSl9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgIHtmb3JtYXRJdGVtKGl0ZW0pfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgKSl9XG4gICAgICAgIDwvZGl2PlxuICAgICAgKSA6IG51bGx9XG4gICAgPC9TdHlsZWRDb250YWluZXI+XG4gICk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBpbmplY3RJbnRsKEdlb0NvZGVyKTtcbiJdfQ==