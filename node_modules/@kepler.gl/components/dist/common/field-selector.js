"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.FieldListItemFactoryFactory = FieldListItemFactoryFactory;
exports["default"] = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _react = _interopRequireWildcard(require("react"));

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _reselect = require("reselect");

var _utils = require("@kepler.gl/utils");

var _itemSelector = _interopRequireDefault(require("./item-selector/item-selector"));

var _dropdownList = require("./item-selector/dropdown-list");

var _fieldToken = _interopRequireDefault(require("../common/field-token"));

var _templateObject, _templateObject2;

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = (0, _getPrototypeOf2["default"])(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = (0, _getPrototypeOf2["default"])(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return (0, _possibleConstructorReturn2["default"])(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }

var defaultDisplayOption = function defaultDisplayOption(d) {
  return d.displayName || d.name;
};

var defaultValueOption = function defaultValueOption(d) {
  return d.name;
};

var StyledToken = _styledComponents["default"].div(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2["default"])(["\n  display: inline-block;\n  margin: 0 ", "px 0 0;\n"])), function (props) {
  return props.theme.fieldTokenRightMargin;
});

var StyledFieldListItem = _styledComponents["default"].div(_templateObject2 || (_templateObject2 = (0, _taggedTemplateLiteral2["default"])(["\n  line-height: 0;\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n"])));

FieldListItemFactoryFactory.deps = [_fieldToken["default"]]; // custom list Item

function FieldListItemFactoryFactory(FieldToken) {
  var FieldListItemFactory = function FieldListItemFactory() {
    var showToken = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;

    var FieldListItem = function FieldListItem(_ref) {
      var value = _ref.value,
          _ref$displayOption = _ref.displayOption,
          displayOption = _ref$displayOption === void 0 ? defaultDisplayOption : _ref$displayOption;
      return /*#__PURE__*/_react["default"].createElement(StyledFieldListItem, {
        className: "field-selector_list-item"
      }, showToken ? /*#__PURE__*/_react["default"].createElement(StyledToken, null, /*#__PURE__*/_react["default"].createElement(FieldToken, {
        type: value.type
      })) : null, /*#__PURE__*/_react["default"].createElement("span", {
        className: _dropdownList.classList.listItemAnchor
      }, displayOption(value)));
    };

    return FieldListItem;
  };

  return FieldListItemFactory;
}

var SuggestedFieldHeader = function SuggestedFieldHeader() {
  return /*#__PURE__*/_react["default"].createElement("div", null, "Suggested Field");
};

function FieldSelectorFactory(FieldListItemFactory) {
  var FieldSelector = /*#__PURE__*/function (_Component) {
    (0, _inherits2["default"])(FieldSelector, _Component);

    var _super = _createSuper(FieldSelector);

    function FieldSelector() {
      var _this;

      (0, _classCallCheck2["default"])(this, FieldSelector);

      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
        args[_key] = arguments[_key];
      }

      _this = _super.call.apply(_super, [this].concat(args));
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "fieldsSelector", function (props) {
        return props.fields;
      });
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "valueSelector", function (props) {
        return props.value;
      });
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "filteredFieldsSelector", (0, _reselect.createSelector)(_this.fieldsSelector, _this.valueSelector, function (fields, value) {
        return fields.filter(function (field) {
          return !(0, _utils.toArray)(value).find(function (d) {
            return d.name ? d.name === field.name : d === field.name;
          });
        });
      }));
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "filterFieldTypesSelector", function (props) {
        return props.filterFieldTypes;
      });
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "showTokenSelector", function (props) {
        return props.showToken;
      });
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "selectedItemsSelector", (0, _reselect.createSelector)(_this.fieldsSelector, _this.valueSelector, function (fields, value) {
        return (0, _utils.toArray)(value).map(function (d) {
          return fields.find(function (f) {
            return (0, _utils.notNullorUndefined)(d) && d.name ? d.name === defaultValueOption(f) : d === defaultValueOption(f);
          });
        }).filter(function (d) {
          return d;
        });
      }));
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "fieldOptionsSelector", (0, _reselect.createSelector)(_this.filteredFieldsSelector, _this.filterFieldTypesSelector, function (fields, filterFieldTypes) {
        if (!filterFieldTypes) {
          return fields;
        }

        var filters = Array.isArray(filterFieldTypes) ? filterFieldTypes : [filterFieldTypes];
        return fields.filter(function (f) {
          return filters.includes(f.type);
        });
      }));
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "fieldListItemSelector", (0, _reselect.createSelector)(_this.showTokenSelector, FieldListItemFactory));
      return _this;
    }

    (0, _createClass2["default"])(FieldSelector, [{
      key: "render",
      value: function render() {
        return /*#__PURE__*/_react["default"].createElement("div", {
          className: "field-selector"
        }, /*#__PURE__*/_react["default"].createElement(_itemSelector["default"], {
          getOptionValue: function getOptionValue(d) {
            return d;
          },
          closeOnSelect: this.props.closeOnSelect,
          displayOption: defaultDisplayOption,
          filterOption: "displayName",
          fixedOptions: this.props.suggested,
          inputTheme: this.props.inputTheme,
          size: this.props.size,
          isError: this.props.error,
          selectedItems: this.selectedItemsSelector(this.props),
          erasable: this.props.erasable,
          options: this.fieldOptionsSelector(this.props),
          multiSelect: this.props.multiSelect,
          placeholder: this.props.placeholder,
          placement: this.props.placement,
          onChange: this.props.onSelect,
          reorderItems: this.props.reorderItems,
          DropDownLineItemRenderComponent: this.fieldListItemSelector(this.props),
          DropdownHeaderComponent: this.props.suggested ? SuggestedFieldHeader : null,
          CustomChickletComponent: this.props.CustomChickletComponent
        }));
      }
    }]);
    return FieldSelector;
  }(_react.Component);

  (0, _defineProperty2["default"])(FieldSelector, "defaultProps", {
    erasable: true,
    error: false,
    fields: [],
    onSelect: function onSelect() {},
    reorderItems: function reorderItems() {},
    placement: 'bottom',
    value: null,
    multiSelect: false,
    closeOnSelect: true,
    showToken: true,
    placeholder: 'placeholder.selectField'
  });
  return FieldSelector;
}

FieldSelectorFactory.deps = [FieldListItemFactoryFactory];
var _default = FieldSelectorFactory;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21tb24vZmllbGQtc2VsZWN0b3IudHN4Il0sIm5hbWVzIjpbImRlZmF1bHREaXNwbGF5T3B0aW9uIiwiZCIsImRpc3BsYXlOYW1lIiwibmFtZSIsImRlZmF1bHRWYWx1ZU9wdGlvbiIsIlN0eWxlZFRva2VuIiwic3R5bGVkIiwiZGl2IiwicHJvcHMiLCJ0aGVtZSIsImZpZWxkVG9rZW5SaWdodE1hcmdpbiIsIlN0eWxlZEZpZWxkTGlzdEl0ZW0iLCJGaWVsZExpc3RJdGVtRmFjdG9yeUZhY3RvcnkiLCJkZXBzIiwiRmllbGRUb2tlbkZhY3RvcnkiLCJGaWVsZFRva2VuIiwiRmllbGRMaXN0SXRlbUZhY3RvcnkiLCJzaG93VG9rZW4iLCJGaWVsZExpc3RJdGVtIiwidmFsdWUiLCJkaXNwbGF5T3B0aW9uIiwidHlwZSIsImNsYXNzTGlzdCIsImxpc3RJdGVtQW5jaG9yIiwiU3VnZ2VzdGVkRmllbGRIZWFkZXIiLCJGaWVsZFNlbGVjdG9yRmFjdG9yeSIsIkZpZWxkU2VsZWN0b3IiLCJmaWVsZHMiLCJmaWVsZHNTZWxlY3RvciIsInZhbHVlU2VsZWN0b3IiLCJmaWx0ZXIiLCJmaWVsZCIsImZpbmQiLCJmaWx0ZXJGaWVsZFR5cGVzIiwibWFwIiwiZiIsImZpbHRlcmVkRmllbGRzU2VsZWN0b3IiLCJmaWx0ZXJGaWVsZFR5cGVzU2VsZWN0b3IiLCJmaWx0ZXJzIiwiQXJyYXkiLCJpc0FycmF5IiwiaW5jbHVkZXMiLCJzaG93VG9rZW5TZWxlY3RvciIsImNsb3NlT25TZWxlY3QiLCJzdWdnZXN0ZWQiLCJpbnB1dFRoZW1lIiwic2l6ZSIsImVycm9yIiwic2VsZWN0ZWRJdGVtc1NlbGVjdG9yIiwiZXJhc2FibGUiLCJmaWVsZE9wdGlvbnNTZWxlY3RvciIsIm11bHRpU2VsZWN0IiwicGxhY2Vob2xkZXIiLCJwbGFjZW1lbnQiLCJvblNlbGVjdCIsInJlb3JkZXJJdGVtcyIsImZpZWxkTGlzdEl0ZW1TZWxlY3RvciIsIkN1c3RvbUNoaWNrbGV0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QUFtQkUsVUFBQSx1QkFBdUIsRUFBRSxLQUFLaEIsS0FBTCxDQUFXaUQ7QUFuQnRDLFVBREYsQ0FERjtBQXlCRDtBQXJGdUM7QUFBQTtBQUFBLElBQ2RDLGdCQURjOztBQUFBLG1DQUNwQ2hDLGFBRG9DLGtCQUVsQjtBQUNwQnVCLElBQUFBLFFBQVEsRUFBRSxJQURVO0FBRXBCRixJQUFBQSxLQUFLLEVBQUUsS0FGYTtBQUdwQnBCLElBQUFBLE1BQU0sRUFBRSxFQUhZO0FBSXBCMkIsSUFBQUEsUUFBUSxFQUFFLG9CQUFNLENBQUUsQ0FKRTtBQUtwQkMsSUFBQUEsWUFBWSxFQUFFLHdCQUFNLENBQUUsQ0FMRjtBQU1wQkYsSUFBQUEsU0FBUyxFQUFFLFFBTlM7QUFPcEJsQyxJQUFBQSxLQUFLLEVBQUUsSUFQYTtBQVFwQmdDLElBQUFBLFdBQVcsRUFBRSxLQVJPO0FBU3BCUixJQUFBQSxhQUFhLEVBQUUsSUFUSztBQVVwQjFCLElBQUFBLFNBQVMsRUFBRSxJQVZTO0FBV3BCbUMsSUFBQUEsV0FBVyxFQUFFO0FBWE8sR0FGa0I7QUF1RjFDLFNBQU8xQixhQUFQO0FBQ0Q7O0FBRURELG9CQUFvQixDQUFDWixJQUFyQixHQUE0QixDQUFDRCwyQkFBRCxDQUE1QjtlQUNlYSxvQiIsInNvdXJjZXNDb250ZW50IjpbIi8vIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVRcbi8vIENvcHlyaWdodCBjb250cmlidXRvcnMgdG8gdGhlIGtlcGxlci5nbCBwcm9qZWN0XG5cbmltcG9ydCBSZWFjdCwge0NvbXBvbmVudCwgQ29tcG9uZW50VHlwZX0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHN0eWxlZCBmcm9tICdzdHlsZWQtY29tcG9uZW50cyc7XG5pbXBvcnQge2NyZWF0ZVNlbGVjdG9yfSBmcm9tICdyZXNlbGVjdCc7XG5cbmltcG9ydCB7RmllbGR9IGZyb20gJ0BrZXBsZXIuZ2wvdHlwZXMnO1xuaW1wb3J0IHtub3ROdWxsb3JVbmRlZmluZWQsIHRvQXJyYXl9IGZyb20gJ0BrZXBsZXIuZ2wvdXRpbHMnO1xuXG5pbXBvcnQgSXRlbVNlbGVjdG9yIGZyb20gJy4vaXRlbS1zZWxlY3Rvci9pdGVtLXNlbGVjdG9yJztcbmltcG9ydCB7Y2xhc3NMaXN0fSBmcm9tICcuL2l0ZW0tc2VsZWN0b3IvZHJvcGRvd24tbGlzdCc7XG5pbXBvcnQgRmllbGRUb2tlbkZhY3RvcnkgZnJvbSAnLi4vY29tbW9uL2ZpZWxkLXRva2VuJztcblxuY29uc3QgZGVmYXVsdERpc3BsYXlPcHRpb24gPSAoZDogRmllbGQpID0+IGQuZGlzcGxheU5hbWUgfHwgZC5uYW1lO1xuY29uc3QgZGVmYXVsdFZhbHVlT3B0aW9uID0gKGQ6IEZpZWxkKSA9PiBkLm5hbWU7XG5cbmNvbnN0IFN0eWxlZFRva2VuID0gc3R5bGVkLmRpdmBcbiAgZGlzcGxheTogaW5saW5lLWJsb2NrO1xuICBtYXJnaW46IDAgJHtwcm9wcyA9PiBwcm9wcy50aGVtZS5maWVsZFRva2VuUmlnaHRNYXJnaW59cHggMCAwO1xuYDtcbmNvbnN0IFN0eWxlZEZpZWxkTGlzdEl0ZW0gPSBzdHlsZWQuZGl2YFxuICBsaW5lLWhlaWdodDogMDtcbiAgZGlzcGxheTogZmxleDtcbiAgZmxleC1kaXJlY3Rpb246IHJvdztcbiAgYWxpZ24taXRlbXM6IGNlbnRlcjtcbmA7XG5cbmV4cG9ydCB0eXBlIEZpZWxkTGlzdEl0ZW1GYWN0b3J5UHJvcHMgPSB7XG4gIHZhbHVlOiBGaWVsZDtcbiAgZGlzcGxheU9wdGlvbjogKGZpZWxkOiBGaWVsZCkgPT4gc3RyaW5nO1xufTtcblxuRmllbGRMaXN0SXRlbUZhY3RvcnlGYWN0b3J5LmRlcHMgPSBbRmllbGRUb2tlbkZhY3RvcnldO1xuLy8gY3VzdG9tIGxpc3QgSXRlbVxuZXhwb3J0IGZ1bmN0aW9uIEZpZWxkTGlzdEl0ZW1GYWN0b3J5RmFjdG9yeShGaWVsZFRva2VuKSB7XG4gIGNvbnN0IEZpZWxkTGlzdEl0ZW1GYWN0b3J5ID0gKHNob3dUb2tlbiA9IHRydWUpID0+IHtcbiAgICBjb25zdCBGaWVsZExpc3RJdGVtID0gKHtcbiAgICAgIHZhbHVlLFxuICAgICAgZGlzcGxheU9wdGlvbiA9IGRlZmF1bHREaXNwbGF5T3B0aW9uXG4gICAgfTogRmllbGRMaXN0SXRlbUZhY3RvcnlQcm9wcykgPT4gKFxuICAgICAgPFN0eWxlZEZpZWxkTGlzdEl0ZW0gY2xhc3NOYW1lPVwiZmllbGQtc2VsZWN0b3JfbGlzdC1pdGVtXCI+XG4gICAgICAgIHtzaG93VG9rZW4gPyAoXG4gICAgICAgICAgPFN0eWxlZFRva2VuPlxuICAgICAgICAgICAgPEZpZWxkVG9rZW4gdHlwZT17dmFsdWUudHlwZX0gLz5cbiAgICAgICAgICA8L1N0eWxlZFRva2VuPlxuICAgICAgICApIDogbnVsbH1cbiAgICAgICAgPHNwYW4gY2xhc3NOYW1lPXtjbGFzc0xpc3QubGlzdEl0ZW1BbmNob3J9PntkaXNwbGF5T3B0aW9uKHZhbHVlKX08L3NwYW4+XG4gICAgICA8L1N0eWxlZEZpZWxkTGlzdEl0ZW0+XG4gICAgKTtcbiAgICByZXR1cm4gRmllbGRMaXN0SXRlbTtcbiAgfTtcbiAgcmV0dXJuIEZpZWxkTGlzdEl0ZW1GYWN0b3J5O1xufVxuXG5jb25zdCBTdWdnZXN0ZWRGaWVsZEhlYWRlciA9ICgpID0+IDxkaXY+U3VnZ2VzdGVkIEZpZWxkPC9kaXY+O1xuXG5leHBvcnQgdHlwZSBNaW5pbWFsRmllbGQgPSB7bmFtZTogc3RyaW5nOyBkaXNwbGF5TmFtZTogc3RyaW5nOyBmb3JtYXQ6IHN0cmluZzsgdHlwZT86IHN0cmluZ307XG50eXBlIEZpZWxkVHlwZSA9XG4gIHwgc3RyaW5nXG4gIHwgc3RyaW5nW11cbiAgfCB7XG4gICAgICBuYW1lOiBzdHJpbmc7XG4gICAgICBmb3JtYXQ6IHN0cmluZyB8IG51bGw7XG4gICAgfVtdXG4gIHwge1xuICAgICAgZm9ybWF0Pzogc3RyaW5nO1xuICAgICAgaWQ/OiBzdHJpbmc7XG4gICAgICBuYW1lPzogc3RyaW5nO1xuICAgICAgZmllbGRJZHg/OiBudW1iZXI7XG4gICAgICB0eXBlPzogbnVtYmVyO1xuICAgIH1cbiAgfCBGaWVsZDtcblxuaW50ZXJmYWNlIEZpZWxkU2VsZWN0b3JGYWN0b3J5UHJvcHMge1xuICBmaWVsZHM/OiBGaWVsZFR5cGVbXTtcbiAgb25TZWxlY3Q6IChcbiAgICBpdGVtczpcbiAgICAgIHwgUmVhZG9ubHlBcnJheTxzdHJpbmcgfCBudW1iZXIgfCBib29sZWFuIHwgb2JqZWN0PlxuICAgICAgfCBzdHJpbmdcbiAgICAgIHwgbnVtYmVyXG4gICAgICB8IGJvb2xlYW5cbiAgICAgIHwgb2JqZWN0XG4gICAgICB8IG51bGxcbiAgKSA9PiB2b2lkO1xuICBwbGFjZW1lbnQ/OiBzdHJpbmc7XG4gIHZhbHVlPzogRmllbGRUeXBlIHwgbnVsbDtcbiAgZmlsdGVyRmllbGRUeXBlcz86IEZpZWxkVHlwZSB8IEZpZWxkVHlwZVtdO1xuICBpbnB1dFRoZW1lPzogc3RyaW5nO1xuICBwbGFjZWhvbGRlcj86IHN0cmluZztcbiAgZXJhc2FibGU/OiBib29sZWFuO1xuICBlcnJvcj86IGJvb2xlYW47XG4gIG11bHRpU2VsZWN0PzogYm9vbGVhbjtcbiAgY2xvc2VPblNlbGVjdD86IGJvb2xlYW47XG4gIHNob3dUb2tlbj86IGJvb2xlYW47XG4gIHN1Z2dlc3RlZD86IFJlYWRvbmx5QXJyYXk8c3RyaW5nIHwgbnVtYmVyIHwgYm9vbGVhbiB8IG9iamVjdD4gfCBudWxsO1xuICBDdXN0b21DaGlja2xldENvbXBvbmVudD86IENvbXBvbmVudFR5cGU8YW55PjtcbiAgc2l6ZT86IHN0cmluZztcbiAgcmVvcmRlckl0ZW1zPzogKG5ld09yZGVyOiBhbnkpID0+IHZvaWQ7XG59XG5cbmZ1bmN0aW9uIEZpZWxkU2VsZWN0b3JGYWN0b3J5KFxuICBGaWVsZExpc3RJdGVtRmFjdG9yeTogUmV0dXJuVHlwZTx0eXBlb2YgRmllbGRMaXN0SXRlbUZhY3RvcnlGYWN0b3J5PlxuKTogQ29tcG9uZW50VHlwZTxGaWVsZFNlbGVjdG9yRmFjdG9yeVByb3BzPiB7XG4gIGNsYXNzIEZpZWxkU2VsZWN0b3IgZXh0ZW5kcyBDb21wb25lbnQ8RmllbGRTZWxlY3RvckZhY3RvcnlQcm9wcz4ge1xuICAgIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgICBlcmFzYWJsZTogdHJ1ZSxcbiAgICAgIGVycm9yOiBmYWxzZSxcbiAgICAgIGZpZWxkczogW10sXG4gICAgICBvblNlbGVjdDogKCkgPT4ge30sXG4gICAgICByZW9yZGVySXRlbXM6ICgpID0+IHt9LFxuICAgICAgcGxhY2VtZW50OiAnYm90dG9tJyxcbiAgICAgIHZhbHVlOiBudWxsLFxuICAgICAgbXVsdGlTZWxlY3Q6IGZhbHNlLFxuICAgICAgY2xvc2VPblNlbGVjdDogdHJ1ZSxcbiAgICAgIHNob3dUb2tlbjogdHJ1ZSxcbiAgICAgIHBsYWNlaG9sZGVyOiAncGxhY2Vob2xkZXIuc2VsZWN0RmllbGQnXG4gICAgfTtcblxuICAgIGZpZWxkc1NlbGVjdG9yID0gcHJvcHMgPT4gcHJvcHMuZmllbGRzO1xuICAgIHZhbHVlU2VsZWN0b3IgPSBwcm9wcyA9PiBwcm9wcy52YWx1ZTtcbiAgICBmaWx0ZXJlZEZpZWxkc1NlbGVjdG9yID0gY3JlYXRlU2VsZWN0b3IoXG4gICAgICB0aGlzLmZpZWxkc1NlbGVjdG9yLFxuICAgICAgdGhpcy52YWx1ZVNlbGVjdG9yLFxuICAgICAgKGZpZWxkcywgdmFsdWUpID0+IHtcbiAgICAgICAgcmV0dXJuIGZpZWxkcy5maWx0ZXIoXG4gICAgICAgICAgZmllbGQgPT4gIXRvQXJyYXkodmFsdWUpLmZpbmQoZCA9PiAoZC5uYW1lID8gZC5uYW1lID09PSBmaWVsZC5uYW1lIDogZCA9PT0gZmllbGQubmFtZSkpXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgKTtcbiAgICBmaWx0ZXJGaWVsZFR5cGVzU2VsZWN0b3IgPSBwcm9wcyA9PiBwcm9wcy5maWx0ZXJGaWVsZFR5cGVzO1xuICAgIHNob3dUb2tlblNlbGVjdG9yID0gcHJvcHMgPT4gcHJvcHMuc2hvd1Rva2VuO1xuXG4gICAgc2VsZWN0ZWRJdGVtc1NlbGVjdG9yID0gY3JlYXRlU2VsZWN0b3IoXG4gICAgICB0aGlzLmZpZWxkc1NlbGVjdG9yLFxuICAgICAgdGhpcy52YWx1ZVNlbGVjdG9yLFxuICAgICAgKGZpZWxkcywgdmFsdWUpID0+XG4gICAgICAgIHRvQXJyYXkodmFsdWUpXG4gICAgICAgICAgLm1hcChkID0+XG4gICAgICAgICAgICBmaWVsZHMuZmluZChmID0+XG4gICAgICAgICAgICAgIG5vdE51bGxvclVuZGVmaW5lZChkKSAmJiBkLm5hbWVcbiAgICAgICAgICAgICAgICA/IGQubmFtZSA9PT0gZGVmYXVsdFZhbHVlT3B0aW9uKGYpXG4gICAgICAgICAgICAgICAgOiBkID09PSBkZWZhdWx0VmFsdWVPcHRpb24oZilcbiAgICAgICAgICAgIClcbiAgICAgICAgICApXG4gICAgICAgICAgLmZpbHRlcihkID0+IGQpXG4gICAgKTtcblxuICAgIGZpZWxkT3B0aW9uc1NlbGVjdG9yID0gY3JlYXRlU2VsZWN0b3IoXG4gICAgICB0aGlzLmZpbHRlcmVkRmllbGRzU2VsZWN0b3IsXG4gICAgICB0aGlzLmZpbHRlckZpZWxkVHlwZXNTZWxlY3RvcixcbiAgICAgIChmaWVsZHMsIGZpbHRlckZpZWxkVHlwZXMpID0+IHtcbiAgICAgICAgaWYgKCFmaWx0ZXJGaWVsZFR5cGVzKSB7XG4gICAgICAgICAgcmV0dXJuIGZpZWxkcztcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBmaWx0ZXJzID0gQXJyYXkuaXNBcnJheShmaWx0ZXJGaWVsZFR5cGVzKSA/IGZpbHRlckZpZWxkVHlwZXMgOiBbZmlsdGVyRmllbGRUeXBlc107XG4gICAgICAgIHJldHVybiBmaWVsZHMuZmlsdGVyKGYgPT4gZmlsdGVycy5pbmNsdWRlcyhmLnR5cGUpKTtcbiAgICAgIH1cbiAgICApO1xuXG4gICAgZmllbGRMaXN0SXRlbVNlbGVjdG9yID0gY3JlYXRlU2VsZWN0b3IodGhpcy5zaG93VG9rZW5TZWxlY3RvciwgRmllbGRMaXN0SXRlbUZhY3RvcnkpO1xuXG4gICAgcmVuZGVyKCkge1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJmaWVsZC1zZWxlY3RvclwiPlxuICAgICAgICAgIDxJdGVtU2VsZWN0b3JcbiAgICAgICAgICAgIGdldE9wdGlvblZhbHVlPXtkID0+IGR9XG4gICAgICAgICAgICBjbG9zZU9uU2VsZWN0PXt0aGlzLnByb3BzLmNsb3NlT25TZWxlY3R9XG4gICAgICAgICAgICBkaXNwbGF5T3B0aW9uPXtkZWZhdWx0RGlzcGxheU9wdGlvbn1cbiAgICAgICAgICAgIGZpbHRlck9wdGlvbj1cImRpc3BsYXlOYW1lXCJcbiAgICAgICAgICAgIGZpeGVkT3B0aW9ucz17dGhpcy5wcm9wcy5zdWdnZXN0ZWR9XG4gICAgICAgICAgICBpbnB1dFRoZW1lPXt0aGlzLnByb3BzLmlucHV0VGhlbWV9XG4gICAgICAgICAgICBzaXplPXt0aGlzLnByb3BzLnNpemV9XG4gICAgICAgICAgICBpc0Vycm9yPXt0aGlzLnByb3BzLmVycm9yfVxuICAgICAgICAgICAgc2VsZWN0ZWRJdGVtcz17dGhpcy5zZWxlY3RlZEl0ZW1zU2VsZWN0b3IodGhpcy5wcm9wcyl9XG4gICAgICAgICAgICBlcmFzYWJsZT17dGhpcy5wcm9wcy5lcmFzYWJsZX1cbiAgICAgICAgICAgIG9wdGlvbnM9e3RoaXMuZmllbGRPcHRpb25zU2VsZWN0b3IodGhpcy5wcm9wcyl9XG4gICAgICAgICAgICBtdWx0aVNlbGVjdD17dGhpcy5wcm9wcy5tdWx0aVNlbGVjdH1cbiAgICAgICAgICAgIHBsYWNlaG9sZGVyPXt0aGlzLnByb3BzLnBsYWNlaG9sZGVyfVxuICAgICAgICAgICAgcGxhY2VtZW50PXt0aGlzLnByb3BzLnBsYWNlbWVudH1cbiAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLnByb3BzLm9uU2VsZWN0fVxuICAgICAgICAgICAgcmVvcmRlckl0ZW1zPXt0aGlzLnByb3BzLnJlb3JkZXJJdGVtc31cbiAgICAgICAgICAgIERyb3BEb3duTGluZUl0ZW1SZW5kZXJDb21wb25lbnQ9e3RoaXMuZmllbGRMaXN0SXRlbVNlbGVjdG9yKHRoaXMucHJvcHMpfVxuICAgICAgICAgICAgRHJvcGRvd25IZWFkZXJDb21wb25lbnQ9e3RoaXMucHJvcHMuc3VnZ2VzdGVkID8gU3VnZ2VzdGVkRmllbGRIZWFkZXIgOiBudWxsfVxuICAgICAgICAgICAgQ3VzdG9tQ2hpY2tsZXRDb21wb25lbnQ9e3RoaXMucHJvcHMuQ3VzdG9tQ2hpY2tsZXRDb21wb25lbnR9XG4gICAgICAgICAgLz5cbiAgICAgICAgPC9kaXY+XG4gICAgICApO1xuICAgIH1cbiAgfVxuICByZXR1cm4gRmllbGRTZWxlY3Rvcjtcbn1cblxuRmllbGRTZWxlY3RvckZhY3RvcnkuZGVwcyA9IFtGaWVsZExpc3RJdGVtRmFjdG9yeUZhY3RvcnldO1xuZXhwb3J0IGRlZmF1bHQgRmllbGRTZWxlY3RvckZhY3Rvcnk7XG4iXX0=