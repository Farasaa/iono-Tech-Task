"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.DragItem = void 0;

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _react = _interopRequireWildcard(require("react"));

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _core = require("@dnd-kit/core");

var _console = _interopRequireDefault(require("global/console"));

var _constants = require("@kepler.gl/constants");

var _reducers = require("@kepler.gl/reducers");

var _layerPanelHeader = _interopRequireDefault(require("./side-panel/layer-panel/layer-panel-header"));

var _injector = require("./injector");

var _useDndLayers2 = _interopRequireDefault(require("./hooks/use-dnd-layers"));

var _useDndEffects2 = _interopRequireDefault(require("./hooks/use-dnd-effects"));

var _templateObject;

var DragItem = _styledComponents["default"].div(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2["default"])(["\n  color: ", ";\n  border-radius: ", "px;\n  padding: 5px 10px;\n  display: inline;\n"])), function (props) {
  return props.theme.textColorHl;
}, function (props) {
  return props.theme.radioButtonRadius;
});

exports.DragItem = DragItem;

var nop = function nop() {
  return undefined;
};

DndContextFactory.deps = [_layerPanelHeader["default"]];

function DndContextFactory(LayerPanelHeader) {
  var LayerPanelOverlay = function LayerPanelOverlay(_ref) {
    var layer = _ref.layer,
        datasets = _ref.datasets;
    var color = layer.config.dataId && datasets[layer.config.dataId] ? datasets[layer.config.dataId].color : null;
    return /*#__PURE__*/_react["default"].createElement(LayerPanelHeader, {
      isConfigActive: false,
      layerId: layer.id,
      isVisible: true,
      isValid: true,
      label: layer.config.label,
      labelRCGColorValues: color,
      onToggleVisibility: nop,
      onResetIsValid: nop,
      onUpdateLayerLabel: nop,
      onToggleEnableConfig: nop,
      onDuplicateLayer: nop,
      onRemoveLayer: nop,
      layerType: layer.type,
      allowDuplicate: false,
      isDragNDropEnabled: false
    });
  };

  var DndContext = function DndContext(_ref2) {
    var children = _ref2.children,
        visState = _ref2.visState;
    var datasets = visState.datasets,
        layerOrder = visState.layerOrder,
        layers = visState.layers,
        effects = visState.effects,
        effectOrder = visState.effectOrder,
        splitMaps = visState.splitMaps;

    var _useDndLayers = (0, _useDndLayers2["default"])(layers, layerOrder),
        activeLayer = _useDndLayers.activeLayer,
        onLayerDragStart = _useDndLayers.onDragStart,
        onLayerDragEnd = _useDndLayers.onDragEnd;

    var _useDndEffects = (0, _useDndEffects2["default"])(effects, effectOrder),
        onEffectDragStart = _useDndEffects.onDragStart,
        onEffectDragEnd = _useDndEffects.onDragEnd;

    var isSplit = (0, _react.useMemo)(function () {
      return (splitMaps === null || splitMaps === void 0 ? void 0 : splitMaps.length) > 1;
    }, [splitMaps]);
    var dndModifiers = (0, _react.useMemo)(function () {
      return isSplit ? _constants.DND_EMPTY_MODIFIERS : _constants.DND_MODIFIERS;
    }, [isSplit]);
    var onDragStart = (0, _react.useCallback)(function (event) {
      var _event$active$data, _event$active$data$cu;

      var activeType = (_event$active$data = event.active.data) === null || _event$active$data === void 0 ? void 0 : (_event$active$data$cu = _event$active$data.current) === null || _event$active$data$cu === void 0 ? void 0 : _event$active$data$cu.type;

      switch (activeType) {
        case _constants.SORTABLE_LAYER_TYPE:
          onLayerDragStart(event);
          break;

        case _constants.SORTABLE_EFFECT_TYPE:
          onEffectDragStart(event);
          break;

        default:
          _console["default"].log("activeType ".concat(activeType, " unknown"));

      }
    }, [onLayerDragStart, onEffectDragStart]);
    var onDragEnd = (0, _react.useCallback)(function (event) {
      var _event$active$data2, _event$active$data2$c;

      var activeType = (_event$active$data2 = event.active.data) === null || _event$active$data2 === void 0 ? void 0 : (_event$active$data2$c = _event$active$data2.current) === null || _event$active$data2$c === void 0 ? void 0 : _event$active$data2$c.type;

      switch (activeType) {
        case _constants.SORTABLE_LAYER_TYPE:
          onLayerDragEnd(event);
          break;

        case _constants.SORTABLE_EFFECT_TYPE:
          onEffectDragEnd(event);
          break;

        default:
          _console["default"].log("activeType ".concat(activeType, " unknown"));

      }
    }, [onLayerDragEnd, onEffectDragEnd]);
    return /*#__PURE__*/_react["default"].createElement(_core.DndContext, {
      onDragStart: onDragStart,
      onDragEnd: onDragEnd,
      modifiers: dndModifiers
    }, children, activeLayer ? /*#__PURE__*/_react["default"].createElement(_core.DragOverlay, {
      modifiers: dndModifiers,
      dropAnimation: null
    }, /*#__PURE__*/_react["default"].createElement(DragItem, null, /*#__PURE__*/_react["default"].createElement(LayerPanelOverlay, {
      layer: activeLayer,
      datasets: datasets
    }))) : null);
  };

  return (0, _injector.withState)([_reducers.visStateLens], function (state) {
    return state;
  })(DndContext);
}

var _default = DndContextFactory;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9kbmQtY29udGV4dC50c3giXSwibmFtZXMiOlsiRHJhZ0l0ZW0iLCJzdHlsZWQiLCJkaXYiLCJwcm9wcyIsInRoZW1lIiwidGV4dENvbG9ySGwiLCJyYWRpb0J1dHRvblJhZGl1cyIsIm5vcCIsInVuZGVmaW5lZCIsIkRuZENvbnRleHRGYWN0b3J5IiwiZGVwcyIsIkxheWVyUGFuZWxIZWFkZXJGYWN0b3J5IiwiTGF5ZXJQYW5lbEhlYWRlciIsIkxheWVyUGFuZWxPdmVybGF5IiwibGF5ZXIiLCJkYXRhc2V0cyIsImNvbG9yIiwiY29uZmlnIiwiZGF0YUlkIiwiaWQiLCJsYWJlbCIsInR5cGUiLCJEbmRDb250ZXh0IiwiY2hpbGRyZW4iLCJ2aXNTdGF0ZSIsImxheWVyT3JkZXIiLCJsYXllcnMiLCJlZmZlY3RzIiwiZWZmZWN0T3JkZXIiLCJzcGxpdE1hcHMiLCJhY3RpdmVMYXllciIsIm9uTGF5ZXJEcmFnU3RhcnQiLCJvbkRyYWdTdGFydCIsIm9uTGF5ZXJEcmFnRW5kIiwib25EcmFnRW5kIiwib25FZmZlY3REcmFnU3RhcnQiLCJvbkVmZmVjdERyYWdFbmQiLCJpc1NwbGl0IiwibGVuZ3RoIiwiZG5kTW9kaWZpZXJzIiwiRE5EX0VNUFRZX01PRElGSUVSUyIsIkRORF9NT0RJRklFUlMiLCJldmVudCIsImFjdGl2ZVR5cGUiLCJhY3RpdmUiLCJkYXRhIiwiY3VycmVudCIsIlNPUlRBQkxFX0xBWUVSX1RZUEUiLCJTT1JUQUJMRV9FRkZFQ1RfVFlQRSIsIkNvbnNvbGUiLCJsb2ciLCJ2aXNTdGF0ZUxlbnMiLCJzdGF0ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUdBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQU1BOztBQUdBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBUU8sSUFBTUEsUUFBUSxHQUFHQyw2QkFBT0MsR0FBViw2S0FDVixVQUFBQyxLQUFLO0FBQUEsU0FBSUEsS0FBSyxDQUFDQyxLQUFOLENBQVlDLFdBQWhCO0FB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REgsRUFFR08sV0FBVyxnQkFDVixnQ0FBQyxpQkFBRDtBQUFhLE1BQUEsU0FBUyxFQUFFUyxZQUF4QjtBQUFzQyxNQUFBLGFBQWEsRUFBRTtBQUFyRCxvQkFDRSxnQ0FBQyxRQUFELHFCQUNFLGdDQUFDLGlCQUFEO0FBQW1CLE1BQUEsS0FBSyxFQUFFVCxXQUExQjtBQUF1QyxNQUFBLFFBQVEsRUFBRWY7QUFBakQsTUFERixDQURGLENBRFUsR0FNUixJQVJOLENBREY7QUFZRCxHQTdERDs7QUErREEsU0FBTyx5QkFBVSxDQUFDb0Msc0JBQUQsQ0FBVixFQUEwQixVQUFBQyxLQUFLO0FBQUEsV0FBSUEsS0FBSjtBQUFBLEdBQS9CLEVBQTBDOUIsVUFBMUMsQ0FBUDtBQUNEOztlQUVjYixpQiIsInNvdXJjZXNDb250ZW50IjpbIi8vIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVRcbi8vIENvcHlyaWdodCBjb250cmlidXRvcnMgdG8gdGhlIGtlcGxlci5nbCBwcm9qZWN0XG5cbmltcG9ydCBSZWFjdCwge3VzZUNhbGxiYWNrLCB1c2VNZW1vLCBQcm9wc1dpdGhDaGlsZHJlbn0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHN0eWxlZCBmcm9tICdzdHlsZWQtY29tcG9uZW50cyc7XG5pbXBvcnQge0RuZENvbnRleHQgYXMgRG5kS2l0Q29udGV4dCwgRHJhZ092ZXJsYXl9IGZyb20gJ0BkbmQta2l0L2NvcmUnO1xuaW1wb3J0IENvbnNvbGUgZnJvbSAnZ2xvYmFsL2NvbnNvbGUnO1xuXG5pbXBvcnQge1xuICBETkRfRU1QVFlfTU9ESUZJRVJTLFxuICBETkRfTU9ESUZJRVJTLFxuICBTT1JUQUJMRV9MQVlFUl9UWVBFLFxuICBTT1JUQUJMRV9FRkZFQ1RfVFlQRVxufSBmcm9tICdAa2VwbGVyLmdsL2NvbnN0YW50cyc7XG5pbXBvcnQge3Zpc1N0YXRlTGVuc30gZnJvbSAnQGtlcGxlci5nbC9yZWR1Y2Vycyc7XG5pbXBvcnQge1Zpc1N0YXRlfSBmcm9tICdAa2VwbGVyLmdsL3NjaGVtYXMnO1xuXG5pbXBvcnQgTGF5ZXJQYW5lbEhlYWRlckZhY3RvcnkgZnJvbSAnLi9zaWRlLXBhbmVsL2xheWVyLXBhbmVsL2xheWVyLXBhbmVsLWhlYWRlcic7XG5pbXBvcnQge3dpdGhTdGF0ZX0gZnJvbSAnLi9pbmplY3Rvcic7XG5pbXBvcnQgdXNlRG5kTGF5ZXJzIGZyb20gJy4vaG9va3MvdXNlLWRuZC1sYXllcnMnO1xuaW1wb3J0IHVzZURuZEVmZmVjdHMgZnJvbSAnLi9ob29rcy91c2UtZG5kLWVmZmVjdHMnO1xuXG5leHBvcnQgdHlwZSBEbmRDb250ZXh0UHJvcHMgPSBQcm9wc1dpdGhDaGlsZHJlbjx7XG4gIHZpc1N0YXRlOiBWaXNTdGF0ZTtcbn0+O1xuXG5leHBvcnQgdHlwZSBEbmRDb250ZXh0Q29tcG9uZW50ID0gUmVhY3QuRkM8RG5kQ29udGV4dFByb3BzPjtcblxuZXhwb3J0IGNvbnN0IERyYWdJdGVtID0gc3R5bGVkLmRpdmBcbiAgY29sb3I6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUudGV4dENvbG9ySGx9O1xuICBib3JkZXItcmFkaXVzOiAke3Byb3BzID0+IHByb3BzLnRoZW1lLnJhZGlvQnV0dG9uUmFkaXVzfXB4O1xuICBwYWRkaW5nOiA1cHggMTBweDtcbiAgZGlzcGxheTogaW5saW5lO1xuYDtcblxuY29uc3Qgbm9wID0gKCkgPT4gdW5kZWZpbmVkO1xuXG5EbmRDb250ZXh0RmFjdG9yeS5kZXBzID0gW0xheWVyUGFuZWxIZWFkZXJGYWN0b3J5XTtcblxuZnVuY3Rpb24gRG5kQ29udGV4dEZhY3RvcnkoXG4gIExheWVyUGFuZWxIZWFkZXI6IFJldHVyblR5cGU8dHlwZW9mIExheWVyUGFuZWxIZWFkZXJGYWN0b3J5PlxuKTogUmVhY3QuRkM8UHJvcHNXaXRoQ2hpbGRyZW4+IHtcbiAgY29uc3QgTGF5ZXJQYW5lbE92ZXJsYXkgPSAoe2xheWVyLCBkYXRhc2V0c30pID0+IHtcbiAgICBjb25zdCBjb2xvciA9XG4gICAgICBsYXllci5jb25maWcuZGF0YUlkICYmIGRhdGFzZXRzW2xheWVyLmNvbmZpZy5kYXRhSWRdXG4gICAgICAgID8gZGF0YXNldHNbbGF5ZXIuY29uZmlnLmRhdGFJZF0uY29sb3JcbiAgICAgICAgOiBudWxsO1xuICAgIHJldHVybiAoXG4gICAgICA8TGF5ZXJQYW5lbEhlYWRlclxuICAgICAgICBpc0NvbmZpZ0FjdGl2ZT17ZmFsc2V9XG4gICAgICAgIGxheWVySWQ9e2xheWVyLmlkfVxuICAgICAgICBpc1Zpc2libGU9e3RydWV9XG4gICAgICAgIGlzVmFsaWQ9e3RydWV9XG4gICAgICAgIGxhYmVsPXtsYXllci5jb25maWcubGFiZWx9XG4gICAgICAgIGxhYmVsUkNHQ29sb3JWYWx1ZXM9e2NvbG9yfVxuICAgICAgICBvblRvZ2dsZVZpc2liaWxpdHk9e25vcH1cbiAgICAgICAgb25SZXNldElzVmFsaWQ9e25vcH1cbiAgICAgICAgb25VcGRhdGVMYXllckxhYmVsPXtub3B9XG4gICAgICAgIG9uVG9nZ2xlRW5hYmxlQ29uZmlnPXtub3B9XG4gICAgICAgIG9uRHVwbGljYXRlTGF5ZXI9e25vcH1cbiAgICAgICAgb25SZW1vdmVMYXllcj17bm9wfVxuICAgICAgICBsYXllclR5cGU9e2xheWVyLnR5cGV9XG4gICAgICAgIGFsbG93RHVwbGljYXRlPXtmYWxzZX1cbiAgICAgICAgaXNEcmFnTkRyb3BFbmFibGVkPXtmYWxzZX1cbiAgICAgIC8+XG4gICAgKTtcbiAgfTtcblxuICBjb25zdCBEbmRDb250ZXh0ID0gKHtjaGlsZHJlbiwgdmlzU3RhdGV9OiBEbmRDb250ZXh0UHJvcHMpID0+IHtcbiAgICBjb25zdCB7ZGF0YXNldHMsIGxheWVyT3JkZXIsIGxheWVycywgZWZmZWN0cywgZWZmZWN0T3JkZXIsIHNwbGl0TWFwc30gPSB2aXNTdGF0ZTtcblxuICAgIGNvbnN0IHthY3RpdmVMYXllciwgb25EcmFnU3RhcnQ6IG9uTGF5ZXJEcmFnU3RhcnQsIG9uRHJhZ0VuZDogb25MYXllckRyYWdFbmR9ID0gdXNlRG5kTGF5ZXJzKFxuICAgICAgbGF5ZXJzLFxuICAgICAgbGF5ZXJPcmRlclxuICAgICk7XG4gICAgY29uc3Qge29uRHJhZ1N0YXJ0OiBvbkVmZmVjdERyYWdTdGFydCwgb25EcmFnRW5kOiBvbkVmZmVjdERyYWdFbmR9ID0gdXNlRG5kRWZmZWN0cyhcbiAgICAgIGVmZmVjdHMsXG4gICAgICBlZmZlY3RPcmRlclxuICAgICk7XG5cbiAgICBjb25zdCBpc1NwbGl0ID0gdXNlTWVtbygoKSA9PiBzcGxpdE1hcHM/Lmxlbmd0aCA+IDEsIFtzcGxpdE1hcHNdKTtcbiAgICBjb25zdCBkbmRNb2RpZmllcnMgPSB1c2VNZW1vKCgpID0+IChpc1NwbGl0ID8gRE5EX0VNUFRZX01PRElGSUVSUyA6IERORF9NT0RJRklFUlMpLCBbaXNTcGxpdF0pO1xuXG4gICAgY29uc3Qgb25EcmFnU3RhcnQgPSB1c2VDYWxsYmFjayhcbiAgICAgIGV2ZW50ID0+IHtcbiAgICAgICAgY29uc3QgYWN0aXZlVHlwZSA9IGV2ZW50LmFjdGl2ZS5kYXRhPy5jdXJyZW50Py50eXBlO1xuICAgICAgICBzd2l0Y2ggKGFjdGl2ZVR5cGUpIHtcbiAgICAgICAgICBjYXNlIFNPUlRBQkxFX0xBWUVSX1RZUEU6XG4gICAgICAgICAgICBvbkxheWVyRHJhZ1N0YXJ0KGV2ZW50KTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgU09SVEFCTEVfRUZGRUNUX1RZUEU6XG4gICAgICAgICAgICBvbkVmZmVjdERyYWdTdGFydChldmVudCk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgQ29uc29sZS5sb2coYGFjdGl2ZVR5cGUgJHthY3RpdmVUeXBlfSB1bmtub3duYCk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBbb25MYXllckRyYWdTdGFydCwgb25FZmZlY3REcmFnU3RhcnRdXG4gICAgKTtcblxuICAgIGNvbnN0IG9uRHJhZ0VuZCA9IHVzZUNhbGxiYWNrKFxuICAgICAgZXZlbnQgPT4ge1xuICAgICAgICBjb25zdCBhY3RpdmVUeXBlID0gZXZlbnQuYWN0aXZlLmRhdGE/LmN1cnJlbnQ/LnR5cGU7XG4gICAgICAgIHN3aXRjaCAoYWN0aXZlVHlwZSkge1xuICAgICAgICAgIGNhc2UgU09SVEFCTEVfTEFZRVJfVFlQRTpcbiAgICAgICAgICAgIG9uTGF5ZXJEcmFnRW5kKGV2ZW50KTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgU09SVEFCTEVfRUZGRUNUX1RZUEU6XG4gICAgICAgICAgICBvbkVmZmVjdERyYWdFbmQoZXZlbnQpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIENvbnNvbGUubG9nKGBhY3RpdmVUeXBlICR7YWN0aXZlVHlwZX0gdW5rbm93bmApO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgW29uTGF5ZXJEcmFnRW5kLCBvbkVmZmVjdERyYWdFbmRdXG4gICAgKTtcblxuICAgIHJldHVybiAoXG4gICAgICA8RG5kS2l0Q29udGV4dCBvbkRyYWdTdGFydD17b25EcmFnU3RhcnR9IG9uRHJhZ0VuZD17b25EcmFnRW5kfSBtb2RpZmllcnM9e2RuZE1vZGlmaWVyc30+XG4gICAgICAgIHtjaGlsZHJlbn1cbiAgICAgICAge2FjdGl2ZUxheWVyID8gKFxuICAgICAgICAgIDxEcmFnT3ZlcmxheSBtb2RpZmllcnM9e2RuZE1vZGlmaWVyc30gZHJvcEFuaW1hdGlvbj17bnVsbH0+XG4gICAgICAgICAgICA8RHJhZ0l0ZW0+XG4gICAgICAgICAgICAgIDxMYXllclBhbmVsT3ZlcmxheSBsYXllcj17YWN0aXZlTGF5ZXJ9IGRhdGFzZXRzPXtkYXRhc2V0c30gLz5cbiAgICAgICAgICAgIDwvRHJhZ0l0ZW0+XG4gICAgICAgICAgPC9EcmFnT3ZlcmxheT5cbiAgICAgICAgKSA6IG51bGx9XG4gICAgICA8L0RuZEtpdENvbnRleHQ+XG4gICAgKTtcbiAgfTtcblxuICByZXR1cm4gd2l0aFN0YXRlKFt2aXNTdGF0ZUxlbnNdLCBzdGF0ZSA9PiBzdGF0ZSkoRG5kQ29udGV4dCkgYXMgUmVhY3QuRkM8UHJvcHNXaXRoQ2hpbGRyZW4+O1xufVxuXG5leHBvcnQgZGVmYXVsdCBEbmRDb250ZXh0RmFjdG9yeTtcbiJdfQ==