{"version":3,"sources":["../../../../src/components/export-video/export-video-panel-preview.js"],"names":["ExportVideoPanelPreview","props","user","mapData","mapStyle","bottomMapStyle","owner","mapId","id","mapRef","React","createRef","deckRef","state","timestamp","latitude","longitude","glContext","undefined","memoDevicePixelRatio","window","devicePixelRatio","_onLayerSetDomain","bind","_renderLayer","_onMapLoad","_resizeVideo","_getContainerHeight","prevProps","resolution","_setDevicePixelRatio","exportVideoWidth","current","map","getMap","resize","idx","colorDomain","overlays","visState","mapState","datasets","layers","layerData","hoverInfo","clicked","interactionConfig","animationConfig","layer","data","config","dataId","gpuFilter","objectHovered","layerCallbacks","onSetLayerDomain","val","layerOverlay","renderLayer","concat","aspectRatio","deck","addLayer","MapboxLayer","on","adapter","onAfterRender","forceUpdate","layerOrder","deckGlLayers","length","slice","reverse","reduce","deckStyle","width","height","containerStyle","position","overflow","viewState","stencil","gl","setState","setViewState","getProps","Component"],"mappings":"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","sourcesContent":["// Copyright (c) 2020 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport React, {Component} from 'react';\nimport DeckGL from '@deck.gl/react';\nimport {StaticMap} from 'react-map-gl';\nimport {MapboxLayer} from '@deck.gl/mapbox';\n\nexport class ExportVideoPanelPreview extends Component {\n  constructor(props) {\n    super(props);\n    const user = this.props.mapData.mapStyle.bottomMapStyle.owner;\n    const mapId = this.props.mapData.mapStyle.bottomMapStyle.id;\n\n    this.mapRef = React.createRef();\n    this.deckRef = React.createRef();\n\n    this.state = {\n      timestamp: {\n        latitude: 47.65,\n        longitude: 7\n      },\n      mapStyle: `mapbox://styles/${user}/${mapId}`, // Unsure if mapStyle would ever change but allowing it just in case\n      glContext: undefined,\n      memoDevicePixelRatio: window.devicePixelRatio // memoize\n    };\n\n    this._onLayerSetDomain = this._onLayerSetDomain.bind(this);\n    this._renderLayer = this._renderLayer.bind(this);\n    this._onMapLoad = this._onMapLoad.bind(this);\n    this._resizeVideo = this._resizeVideo.bind(this);\n    this._getContainerHeight = this._getContainerHeight.bind(this);\n\n    this._resizeVideo();\n  }\n\n  componentDidUpdate(prevProps) {\n    if (prevProps.resolution !== this.props.resolution) {\n      this._resizeVideo();\n    }\n  }\n\n  componentWillUnmount() {\n    const {memoDevicePixelRatio} = this.state;\n    this._setDevicePixelRatio(memoDevicePixelRatio);\n  }\n\n  _resizeVideo() {\n    const {exportVideoWidth, resolution} = this.props;\n    this._setDevicePixelRatio(resolution[0] / exportVideoWidth);\n    if (this.mapRef.current) {\n      const map = this.mapRef.current.getMap();\n      map.resize();\n    }\n  }\n\n  _setDevicePixelRatio(devicePixelRatio) {\n    /**\n     * TODO: This is the only way to trick mapbox into scaling its render buffer up\n     * to match the desired resolution. It is built to always fit it's render buffer size\n     * to it's CSS container size, which makes it impossible to make a small \"preview\" box.\n     *\n     * deck.gl has the useDevicePixels prop, which would have been used if it also changed mapbox.\n     * https://github.com/visgl/luma.gl/pull/1155 for background.\n     *\n     * Compare implementations of luma.gl to mapbox for context:\n     * https://github.com/visgl/luma.gl/blob/f622105e30c4dcda434f80ebc4680356003b12fa/modules/gltools/src/utils/device-pixels.js#L31\n     * https://github.com/mapbox/mapbox-gl-js/blob/3136a53235cf17b732e84c9945c4e85ba3369a93/src/ui/map.js#L2324\n     *\n     * In luma the scaler can be overriden by useDevicePixels.\n     *\n     * The workaround is to change window.devicePixelRatio while the component is mounted to scale up the render buffers of deck and mapbox.\n     * This is hacky and can cause issues in certain applications. We should try to produce a better solution.\n     */\n    // @ts-ignore\n    window.devicePixelRatio = devicePixelRatio;\n  }\n\n  _onLayerSetDomain(idx, colorDomain) {\n    // TODO: this isn't dispatched to the redux store yet.\n    // layerConfigChange(this.props.mapData.visState.layers[idx], {\n    //   colorDomain\n    // });\n  }\n\n  _renderLayer(overlays, idx) {\n    const {\n      mapData: {visState, mapState}\n    } = this.props;\n\n    const {\n      datasets,\n      layers,\n      layerData,\n      hoverInfo,\n      clicked,\n      interactionConfig,\n      animationConfig\n    } = visState;\n\n    const layer = layers[idx];\n    const data = layerData[idx];\n    const {gpuFilter} = datasets[layer.config.dataId] || {};\n\n    const objectHovered = clicked || hoverInfo;\n    const layerCallbacks = {\n      onSetLayerDomain: val => this._onLayerSetDomain(idx, val)\n    };\n\n    // Layer is Layer class\n    const layerOverlay = layer.renderLayer({\n      data,\n      gpuFilter,\n      idx,\n      interactionConfig,\n      layerCallbacks,\n      mapState,\n      animationConfig,\n      objectHovered\n    });\n    return overlays.concat(layerOverlay || []);\n  }\n\n  _getContainerHeight() {\n    const {exportVideoWidth, resolution} = this.props;\n    const aspectRatio = resolution[0] / resolution[1];\n    return exportVideoWidth / aspectRatio;\n  }\n\n  _onMapLoad() {\n    // Adds mapbox layer to modal\n    const map = this.mapRef.current.getMap();\n    const deck = this.deckRef.current.deck;\n    map.addLayer(new MapboxLayer({id: 'my-deck', deck}));\n    // TODO trying to make map scale to 100% of modal\n    // map.on('load', function () {\n    //   map.resize();\n    // });\n    map.on('render', () =>\n      this.props.adapter.onAfterRender(() => {\n        this.forceUpdate();\n      })\n    );\n    map.resize();\n    // map.setCenter([this.props.mapData.mapState.longitude, this.props.mapData.mapState.latitude]);\n    // console.log(\"this.props.mapData.mapState\", this.props.mapData.mapState)\n  }\n\n  render() {\n    // const mapStyle = this.mapData.mapStyle;\n    // const mapState = this.props.mapData.mapState;\n    // const layers = this.mapData.visState.layers;\n    // const layerData = this.mapData.visState.layerData;\n    const layerOrder = this.props.mapData.visState.layerOrder;\n    // const animationConfig = this.mapData.visState.animationConfig;\n\n    // Map data\n    // const mapboxApiAccessToken = this.props.mapData.mapStyle.mapboxApiAccessToken;\n    // const mapboxApiUrl = this.props.mapData.mapStyle.mapboxApiUrl;\n\n    // define trip and geojson layers\n    let deckGlLayers = [];\n\n    // TODO refactor this. Layers are reverse, filtered, etc. only to be redefined later\n    // wait until data is ready before render data layers\n    if (layerOrder && layerOrder.length) {\n      // last layer render first\n      deckGlLayers = layerOrder\n        .slice()\n        .reverse()\n        // .filter(\n        //   idx => layers[idx].overlayType === OVERLAY_TYPE.deckgl && layers[idx].id\n        // )\n        .reduce(this._renderLayer, []);\n    }\n\n    const deckStyle = {\n      width: '100%',\n      height: '100%'\n    };\n\n    const containerStyle = {\n      width: `${this.props.exportVideoWidth}px`,\n      height: `${this._getContainerHeight()}px`,\n      position: 'relative',\n      overflow: 'auto'\n    };\n\n    return (\n      <div id=\"deck-canvas\" style={containerStyle}>\n        <DeckGL\n          ref={this.deckRef}\n          viewState={this.props.viewState}\n          id=\"hubblegl-overlay\"\n          layers={deckGlLayers}\n          style={deckStyle}\n          controller={true}\n          glOptions={{stencil: true}}\n          onWebGLInitialized={gl => this.setState({glContext: gl})}\n          onViewStateChange={this.props.setViewState}\n          // onClick={visStateActions.onLayerClick}\n          {...this.props.adapter.getProps(this.deckRef, () => {})}\n        >\n          {this.state.glContext && (\n            <StaticMap\n              ref={this.mapRef}\n              // reuseMaps // Part of default example but causes modal to lose Mapbox tile layer?\n              mapStyle={this.state.mapStyle}\n              preventStyleDiffing={true}\n              gl={this.state.glContext}\n              onLoad={this._onMapLoad}\n            />\n          )}\n        </DeckGL>\n      </div>\n    );\n  }\n}\n"],"file":"export-video-panel-preview.js"}