"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.ListItem = exports.classList = void 0;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _react = _interopRequireWildcard(require("react"));

var _classnames = _interopRequireDefault(require("classnames"));

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _constants = require("@kepler.gl/constants");

var _templateObject, _templateObject2;

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = (0, _getPrototypeOf2["default"])(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = (0, _getPrototypeOf2["default"])(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return (0, _possibleConstructorReturn2["default"])(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }

var LEFT_BUTTON = 0;
var classList = {
  list: 'list-selector',
  listHeader: 'list__header',
  listSection: 'list__section',
  listItem: 'list__item',
  listItemAnchor: 'list__item__anchor',
  listItemFixed: 'list__item__fixed'
};
exports.classList = classList;

var defaultDisplay = function defaultDisplay(d) {
  return d;
};

var ListItem = function ListItem(_ref) {
  var value = _ref.value,
      _ref$displayOption = _ref.displayOption,
      displayOption = _ref$displayOption === void 0 ? defaultDisplay : _ref$displayOption,
      disabled = _ref.disabled,
      light = _ref.light;
  var displayValue = displayOption(value);
  return /*#__PURE__*/_react["default"].createElement("span", {
    title: displayValue,
    className: (0, _classnames["default"])(classList.listItemAnchor, {
      disabled: disabled
    })
  }, displayValue);
};

exports.ListItem = ListItem;

var DropdownListWrapper = _styledComponents["default"].div(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2["default"])(["\n  background-color: ", ";\n  border-top: 1px solid\n    ", ";\n  ", ";\n"])), function (props) {
  return props.light ? props.theme.dropdownListBgdLT : props.theme.dropdownListBgd;
}, function (props) {
  return props.light ? props.theme.dropdownListBorderTopLT : props.theme.dropdownListBorderTop;
}, function (props) {
  return props.light ? props.theme.dropdownListLT : props.theme.dropdownList;
});

var DropdownFooterWrapper = _styledComponents["default"].div(_templateObject2 || (_templateObject2 = (0, _taggedTemplateLiteral2["default"])(["\n  height: '0px';\n"])));

var DropdownList = /*#__PURE__*/function (_Component) {
  (0, _inherits2["default"])(DropdownList, _Component);

  var _super = _createSuper(DropdownList);

  function DropdownList(props) {
    var _this;

    (0, _classCallCheck2["default"])(this, DropdownList);
    _this = _super.call(this, props);
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "initNumberOfOptions", void 0);
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "page", void 0);
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "prevY", void 0);
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "loadingRef", void 0);
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "observer", void 0);
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "handleObserver", function (entities) {
      var y = entities[0].boundingClientRect.y;

      if (_this.prevY > y) {
        var options = _this._getOptions(_this.page);

        if (options) _this.setState({
          options: options
        });
      }

      _this.prevY = y;
    });
    _this.state = {
      options: []
    };
    _this.initNumberOfOptions = _constants.INIT_FILTER_ITEMS_IN_DROPDOWN;
    _this.page = 0;
    _this.prevY = 0;
    _this.loadingRef = /*#__PURE__*/_react["default"].createRef();
    return _this;
  }

  (0, _createClass2["default"])(DropdownList, [{
    key: "componentDidMount",
    value: function componentDidMount() {
      var options = this._getOptions(this.page);

      this.setState({
        options: options
      });
      var divOptions = {
        root: null,
        rootMargin: '0%',
        threshold: 1.0
      };

      if (this.loadingRef.current) {
        this.observer = new IntersectionObserver(this.handleObserver, divOptions);
        this.observer.observe(this.loadingRef.current);
      }
    }
  }, {
    key: "getSnapshotBeforeUpdate",
    value: function getSnapshotBeforeUpdate(prevProps, prevState) {
      if (prevProps.options !== this.props.options) {
        // check if user searching, reset state.options at the first time
        var options = this._getOptions(0);

        this.setState({
          options: options
        });
      }

      return null;
    } // prevent console warning: getSnapshotBeforeUpdate() should be used with componentDidUpdate().

  }, {
    key: "componentDidUpdate",
    value: function componentDidUpdate(prevProps, prevState, snapshot) {}
  }, {
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      if (this.loadingRef.current) {
        var _this$observer;

        (_this$observer = this.observer) === null || _this$observer === void 0 ? void 0 : _this$observer.unobserve(this.loadingRef.current);
      }
    }
  }, {
    key: "_getOptions",
    value: function _getOptions(page) {
      if (!this.props.options) {
        return [];
      }

      var n = this.props.options.length;

      if (n === 0) {
        return [];
      }

      var start = page * this.initNumberOfOptions;
      var end = start + this.initNumberOfOptions > n ? n : start + this.initNumberOfOptions;

      if (start < end && end <= n) {
        this.page = page + 1; // in case of user searching, props.options will be updated
        // so "page" value will be set to 0 and previous state.options will be discarded

        return [].concat((0, _toConsumableArray2["default"])(page > 0 ? this.state.options || [] : []), (0, _toConsumableArray2["default"])(this.props.options.slice(start, end)));
      }

      return null;
    }
  }, {
    key: "_onClick",
    value: function _onClick(result, event) {
      event.preventDefault(); // only work when left is clicked

      if (event.type === 'mousedown' && event.button === LEFT_BUTTON || event.type === 'click') {
        var _this$props$onOptionS, _this$props;

        (_this$props$onOptionS = (_this$props = this.props).onOptionSelected) === null || _this$props$onOptionS === void 0 ? void 0 : _this$props$onOptionS.call(_this$props, result, event);
      }
    }
  }, {
    key: "render",
    value: function render() {
      var _this$props$options,
          _this$props$customCla,
          _this$props$customCla2,
          _this2 = this,
          _this$state$options;

      var _this$props2 = this.props,
          fixedOptions = _this$props2.fixedOptions,
          light = _this$props2.light,
          _this$props2$allowCus = _this$props2.allowCustomValues,
          allowCustomValues = _this$props2$allowCus === void 0 ? 0 : _this$props2$allowCus,
          _this$props2$customLi = _this$props2.customListItemComponent,
          CustomListItemComponent = _this$props2$customLi === void 0 ? ListItem : _this$props2$customLi;
      var _this$props$displayOp = this.props.displayOption,
          display = _this$props$displayOp === void 0 ? defaultDisplay : _this$props$displayOp; // Don't render if there are no options to display

      if (!((_this$props$options = this.props.options) !== null && _this$props$options !== void 0 && _this$props$options.length) && allowCustomValues <= 0) {
        return /*#__PURE__*/_react["default"].createElement("div", null);
      }

      var valueOffset = Array.isArray(fixedOptions) ? fixedOptions.length : 0; // For some reason onClick is not fired when clicked on an option
      // onMouseDown is used here as a workaround of #205 and other

      return /*#__PURE__*/_react["default"].createElement(DropdownListWrapper, {
        className: (0, _classnames["default"])(classList.list, (_this$props$customCla = this.props.customClasses) === null || _this$props$customCla === void 0 ? void 0 : _this$props$customCla.results),
        light: light
      }, this.props.customListHeaderComponent ? /*#__PURE__*/_react["default"].createElement("div", {
        className: (0, _classnames["default"])(classList.listHeader, (_this$props$customCla2 = this.props.customClasses) === null || _this$props$customCla2 === void 0 ? void 0 : _this$props$customCla2.listHeader)
      }, /*#__PURE__*/_react["default"].createElement(this.props.customListHeaderComponent, null)) : null, valueOffset > 0 ? /*#__PURE__*/_react["default"].createElement("div", {
        className: classList.listSection
      }, fixedOptions === null || fixedOptions === void 0 ? void 0 : fixedOptions.map(function (value, i) {
        var _this2$props$customCl;

        return /*#__PURE__*/_react["default"].createElement("div", {
          className: (0, _classnames["default"])(classList.listItem, (0, _defineProperty2["default"])({
            hover: _this2.props.selectionIndex === i
          }, classList.listItemFixed, true), (_this2$props$customCl = _this2.props.customClasses) === null || _this2$props$customCl === void 0 ? void 0 : _this2$props$customCl.listItem),
          key: "".concat(display(value), "_").concat(i),
          onMouseDown: function onMouseDown(e) {
            return _this2._onClick(value, e);
          },
          onClick: function onClick(e) {
            return _this2._onClick(value, e);
          }
        }, /*#__PURE__*/_react["default"].createElement(CustomListItemComponent, {
          value: value,
          displayOption: display
        }));
      })) : null, (_this$state$options = this.state.options) === null || _this$state$options === void 0 ? void 0 : _this$state$options.map(function (value, i) {
        var _this2$props$customCl2;

        return /*#__PURE__*/_react["default"].createElement("div", {
          className: (0, _classnames["default"])(classList.listItem, {
            hover: _this2.props.selectionIndex === i + valueOffset
          }, (_this2$props$customCl2 = _this2.props.customClasses) === null || _this2$props$customCl2 === void 0 ? void 0 : _this2$props$customCl2.listItem),
          key: "".concat(display(value), "_").concat(i),
          onMouseDown: function onMouseDown(e) {
            return _this2._onClick(value, e);
          },
          onClick: function onClick(e) {
            return _this2._onClick(value, e);
          }
        }, /*#__PURE__*/_react["default"].createElement(CustomListItemComponent, {
          value: value,
          displayOption: display
        }));
      }), /*#__PURE__*/_react["default"].createElement(DropdownFooterWrapper, {
        ref: this.loadingRef
      }));
    }
  }]);
  return DropdownList;
}(_react.Component);

exports["default"] = DropdownList;
(0, _defineProperty2["default"])(DropdownList, "defaultProps", {
  customClasses: {},
  customListItemComponent: ListItem,
  customListHeaderComponent: null,
  allowCustomValues: 0,
  customValues: [],
  displayOption: defaultDisplay,
  onOptionSelected: function onOptionSelected() {},
  defaultClassNames: true,
  selectionIndex: null
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21tb24vaXRlbS1zZWxlY3Rvci9kcm9wZG93bi1saXN0LnRzeCJdLCJuYW1lcyI6WyJMRUZUX0JVVFRPTiIsImNsYXNzTGlzdCIsImxpc3QiLCJsaXN0SGVhZGVyIiwibGlzdFNlY3Rpb24iLCJsaXN0SXRlbSIsImxpc3RJdGVtQW5jaG9yIiwibGlzdEl0ZW1GaXhlZCIsImRlZmF1bHREaXNwbGF5IiwiZCIsIkxpc3RJdGVtIiwidmFsdWUiLCJkaXNwbGF5T3B0aW9uIiwiZGlzYWJsZWQiLCJsaWdodCIsImRpc3BsYXlWYWx1ZSIsIkRyb3Bkb3duTGlzdFdyYXBwZXIiLCJzdHlsZWQiLCJkaXYiLCJwcm9wcyIsInRoZW1lIiwiZHJvcGRvd25MaXN0QmdkTFQiLCJkcm9wZG93bkxpc3RCZ2QiLCJkcm9wZG93bkxpc3RCb3JkZXJUb3BMVCIsImRyb3Bkb3duTGlzdEJvcmRlclRvcCIsImRyb3Bkb3duTGlzdExUIiwiZHJvcGRvd25MaXN0IiwiRHJvcGRvd25Gb290ZXJXcmFwcGVyIiwiRHJvcGRvd25MaXN0IiwiZW50aXRpZXMiLCJ5IiwiYm91bmRpbmdDbGllbnRSZWN0IiwicHJldlkiLCJvcHRpb25zIiwiX2dldE9wdGlvbnMiLCJwYWdlIiwic2V0U3RhdGUiLCJzdGF0ZSIsImluaXROdW1iZXJPZk9wdGlvbnMiLCJJTklUX0ZJTFRFUl9JVEVNU19JTl9EUk9QRE9XTiIsImxvYWRpbmdSZWYiLCJSZWFjdCIsImNyZWF0ZVJlZiIsImRpdk9wdGlvbnMiLCJyb290Iiwicm9vdE1hcmdpbiIsInRocmVzaG9sZCIsImN1cnJlbnQiLCJvYnNlcnZlciIsIkludGVyc2VjdGlvbk9ic2VydmVyIiwiaGFuZGxlT2JzZXJ2ZXIiLCJvYnNlcnZlIiwicHJldlByb3BzIiwicHJldlN0YXRlIiwic25hcHNob3QiLCJ1bm9ic2VydmUiLCJuIiwibGVuZ3RoIiwic3RhcnQiLCJlbmQiLCJzbGljZSIsInJlc3VsdCIsImV2ZW50IiwicHJldmVudERlZmF1bHQiLCJ0eXBlIiwiYnV0dG9uIiwib25PcHRpb25TZWxlY3RlZCIsImZpeGVkT3B0aW9ucyIsImFsbG93Q3VzdG9tVmFsdWVzIiwiY3VzdG9tTGlzdEl0ZW1Db21wb25lbnQiLCJDdXN0b21MaXN0SXRlbUNvbXBvbmVudCIsImRpc3BsYXkiLCJ2YWx1ZU9mZnNldCIsIkFycmF5IiwiaXNBcnJheSIsImN1c3RvbUNsYXNzZXMiLCJyZXN1bHRzIiwiY3VzdG9tTGlzdEhlYWRlckNvbXBvbmVudCIsIm1hcCIsImkiLCJob3ZlciIsInNlbGVjdGlvbkluZGV4IiwiZSIsIl9vbkNsaWNrIiwiQ29tcG9uZW50IiwiY3VzdG9tVmFsdWVzIiwiZGVmYXVsdENsYXNzTmFtZXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FBRUEsSUFBTUEsV0FBVyxHQUFHLENBQXBCO0FBRU8sSUFBTUMsU0FBUyxHQUFHO0FBQ3ZCQyxFQUFBQSxJQUFJLEVBQUUsZUFEaUI7QUFFdkJDLEVBQUFBLFVBQVUsRUFBRSxjQUZXO0FBR3ZCQyxFQUFBQSxXQUFXLEVBQUUsZUFIVTtBQUl2QkMsRUFBQUEsUUFBUSxFQUFFLFlBSmE7QUFLdkJDLEVBQUFBLGNBQWMsRUFBRSxvQkFMTztBQU12QkMsRUFBQUEsYUFBYSxFQUFFO0FBTlEsQ0FBbEI7OztBQVNQLElBQU1DLGNBQWMsR0FBRyxTQUFqQkEsY0FBaUIsQ0FBQUMsQ0FBQztBQUFBLFNBQUlBLENBQUo7QUFBQSxDQUF4Qjs7QUFDTyxJQUFNQyxRQUFRLEdBQUcsU0FBWEEsUUFBVyxPQUE4RDtBQUFBLE1BQTVEQyxLQUE0RCxRQUE1REEsS0FBNEQ7QUFBQSxnQ0FBckRDLGFBQXFEO0FBQUEsTUFBckRBLGFBQXFELG1DQUFyQ0osY0FBcUM7QUFBQSxNQUFyQkssUUFBcUIsUUFBckJBLFFBQXFCO0FBQUEsTUFBWEMsS0FBVyxRQUFYQSxLQUFXO0FBQ3BGLE1BQU1DLFlBQVksR0FBR0gsYUFBYSxD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LEVBQUFBLHVCQUF1QixFQUFFM0QsUUFGTDtBQUdwQm1FLEVBQUFBLHlCQUF5QixFQUFFLElBSFA7QUFJcEJULEVBQUFBLGlCQUFpQixFQUFFLENBSkM7QUFLcEJpQixFQUFBQSxZQUFZLEVBQUUsRUFMTTtBQU1wQnpFLEVBQUFBLGFBQWEsRUFBRUosY0FOSztBQU9wQjBELEVBQUFBLGdCQUFnQixFQUFFLDRCQUFNLENBQUUsQ0FQTjtBQVFwQm9CLEVBQUFBLGlCQUFpQixFQUFFLElBUkM7QUFTcEJMLEVBQUFBLGNBQWMsRUFBRTtBQVRJLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTUlUXG4vLyBDb3B5cmlnaHQgY29udHJpYnV0b3JzIHRvIHRoZSBrZXBsZXIuZ2wgcHJvamVjdFxuXG5pbXBvcnQgUmVhY3QsIHtDb21wb25lbnQsIEVsZW1lbnRUeXBlfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgY2xhc3NOYW1lcyBmcm9tICdjbGFzc25hbWVzJztcbmltcG9ydCBzdHlsZWQgZnJvbSAnc3R5bGVkLWNvbXBvbmVudHMnO1xuaW1wb3J0IHtJTklUX0ZJTFRFUl9JVEVNU19JTl9EUk9QRE9XTn0gZnJvbSAnQGtlcGxlci5nbC9jb25zdGFudHMnO1xuXG5jb25zdCBMRUZUX0JVVFRPTiA9IDA7XG5cbmV4cG9ydCBjb25zdCBjbGFzc0xpc3QgPSB7XG4gIGxpc3Q6ICdsaXN0LXNlbGVjdG9yJyxcbiAgbGlzdEhlYWRlcjogJ2xpc3RfX2hlYWRlcicsXG4gIGxpc3RTZWN0aW9uOiAnbGlzdF9fc2VjdGlvbicsXG4gIGxpc3RJdGVtOiAnbGlzdF9faXRlbScsXG4gIGxpc3RJdGVtQW5jaG9yOiAnbGlzdF9faXRlbV9fYW5jaG9yJyxcbiAgbGlzdEl0ZW1GaXhlZDogJ2xpc3RfX2l0ZW1fX2ZpeGVkJ1xufTtcblxuY29uc3QgZGVmYXVsdERpc3BsYXkgPSBkID0+IGQ7XG5leHBvcnQgY29uc3QgTGlzdEl0ZW0gPSAoe3ZhbHVlLCBkaXNwbGF5T3B0aW9uID0gZGVmYXVsdERpc3BsYXksIGRpc2FibGVkLCBsaWdodH0pID0+IHtcbiAgY29uc3QgZGlzcGxheVZhbHVlID0gZGlzcGxheU9wdGlvbih2YWx1ZSk7XG4gIHJldHVybiAoXG4gICAgPHNwYW4gdGl0bGU9e2Rpc3BsYXlWYWx1ZX0gY2xhc3NOYW1lPXtjbGFzc05hbWVzKGNsYXNzTGlzdC5saXN0SXRlbUFuY2hvciwge2Rpc2FibGVkfSl9PlxuICAgICAge2Rpc3BsYXlWYWx1ZX1cbiAgICA8L3NwYW4+XG4gICk7XG59O1xuXG5pbnRlcmZhY2UgRHJvcGRvd25MaXN0V3JhcHBlclByb3BzIHtcbiAgbGlnaHQ/OiBib29sZWFuO1xufVxuXG5jb25zdCBEcm9wZG93bkxpc3RXcmFwcGVyID0gc3R5bGVkLmRpdjxEcm9wZG93bkxpc3RXcmFwcGVyUHJvcHM+YFxuICBiYWNrZ3JvdW5kLWNvbG9yOiAke3Byb3BzID0+XG4gICAgcHJvcHMubGlnaHQgPyBwcm9wcy50aGVtZS5kcm9wZG93bkxpc3RCZ2RMVCA6IHByb3BzLnRoZW1lLmRyb3Bkb3duTGlzdEJnZH07XG4gIGJvcmRlci10b3A6IDFweCBzb2xpZFxuICAgICR7cHJvcHMgPT5cbiAgICAgIHByb3BzLmxpZ2h0ID8gcHJvcHMudGhlbWUuZHJvcGRvd25MaXN0Qm9yZGVyVG9wTFQgOiBwcm9wcy50aGVtZS5kcm9wZG93bkxpc3RCb3JkZXJUb3B9O1xuICAke3Byb3BzID0+IChwcm9wcy5saWdodCA/IHByb3BzLnRoZW1lLmRyb3Bkb3duTGlzdExUIDogcHJvcHMudGhlbWUuZHJvcGRvd25MaXN0KX07XG5gO1xuXG5jb25zdCBEcm9wZG93bkZvb3RlcldyYXBwZXIgPSBzdHlsZWQuZGl2YFxuICBoZWlnaHQ6ICcwcHgnO1xuYDtcblxuaW50ZXJmYWNlIERyb3Bkb3duTGlzdFByb3BzIHtcbiAgb3B0aW9ucz86IGFueVtdO1xuICBhbGxvd0N1c3RvbVZhbHVlcz86IG51bWJlcjtcbiAgY3VzdG9tQ2xhc3Nlcz86IHtsaXN0SGVhZGVyPzogc3RyaW5nOyBsaXN0SXRlbT86IHN0cmluZzsgcmVzdWx0cz86IHN0cmluZ307XG4gIGN1c3RvbVZhbHVlcz86IGFueVtdO1xuICBjdXN0b21MaXN0SXRlbUNvbXBvbmVudD86IEVsZW1lbnRUeXBlO1xuICBjdXN0b21MaXN0SGVhZGVyQ29tcG9uZW50PzogRWxlbWVudFR5cGU7XG4gIHNlbGVjdGlvbkluZGV4PzogbnVtYmVyO1xuICBvbk9wdGlvblNlbGVjdGVkPzogRnVuY3Rpb247XG4gIGRpc3BsYXlPcHRpb24/OiBGdW5jdGlvbjtcbiAgZGVmYXVsdENsYXNzTmFtZXM/OiBib29sZWFuO1xuICBhcmVSZXN1bHRzVHJ1bmNhdGVkPzogYm9vbGVhbjtcbiAgcmVzdWx0c1RydW5jYXRlZE1lc3NhZ2U/OiBzdHJpbmc7XG4gIGxpc3RJdGVtQ29tcG9uZW50PzogRnVuY3Rpb247XG4gIGxpZ2h0PzogYm9vbGVhbjtcbiAgZml4ZWRPcHRpb25zPzogYW55W107XG59XG5cbmludGVyZmFjZSBEcm9wZG93bkxpc3RTdGF0ZSB7XG4gIG9wdGlvbnM6IEFycmF5PGFueT4gfCBudWxsO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBEcm9wZG93bkxpc3QgZXh0ZW5kcyBDb21wb25lbnQ8RHJvcGRvd25MaXN0UHJvcHMsIERyb3Bkb3duTGlzdFN0YXRlPiB7XG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgY3VzdG9tQ2xhc3Nlczoge30sXG4gICAgY3VzdG9tTGlzdEl0ZW1Db21wb25lbnQ6IExpc3RJdGVtLFxuICAgIGN1c3RvbUxpc3RIZWFkZXJDb21wb25lbnQ6IG51bGwsXG4gICAgYWxsb3dDdXN0b21WYWx1ZXM6IDAsXG4gICAgY3VzdG9tVmFsdWVzOiBbXSxcbiAgICBkaXNwbGF5T3B0aW9uOiBkZWZhdWx0RGlzcGxheSxcbiAgICBvbk9wdGlvblNlbGVjdGVkOiAoKSA9PiB7fSxcbiAgICBkZWZhdWx0Q2xhc3NOYW1lczogdHJ1ZSxcbiAgICBzZWxlY3Rpb25JbmRleDogbnVsbFxuICB9O1xuXG4gIGluaXROdW1iZXJPZk9wdGlvbnM6IG51bWJlcjtcbiAgcGFnZTogbnVtYmVyO1xuICBwcmV2WTogbnVtYmVyO1xuICBsb2FkaW5nUmVmOiBSZWFjdC5SZWZPYmplY3Q8SFRNTERpdkVsZW1lbnQ+O1xuICBvYnNlcnZlcjogSW50ZXJzZWN0aW9uT2JzZXJ2ZXIgfCB1bmRlZmluZWQ7XG5cbiAgY29uc3RydWN0b3IocHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcyk7XG5cbiAgICB0aGlzLnN0YXRlID0ge29wdGlvbnM6IFtdfTtcbiAgICB0aGlzLmluaXROdW1iZXJPZk9wdGlvbnMgPSBJTklUX0ZJTFRFUl9JVEVNU19JTl9EUk9QRE9XTjtcbiAgICB0aGlzLnBhZ2UgPSAwO1xuICAgIHRoaXMucHJldlkgPSAwO1xuICAgIHRoaXMubG9hZGluZ1JlZiA9IFJlYWN0LmNyZWF0ZVJlZigpO1xuICB9XG5cbiAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMuX2dldE9wdGlvbnModGhpcy5wYWdlKTtcbiAgICB0aGlzLnNldFN0YXRlKHtvcHRpb25zfSk7XG5cbiAgICBjb25zdCBkaXZPcHRpb25zID0ge1xuICAgICAgcm9vdDogbnVsbCxcbiAgICAgIHJvb3RNYXJnaW46ICcwJScsXG4gICAgICB0aHJlc2hvbGQ6IDEuMFxuICAgIH07XG5cbiAgICBpZiAodGhpcy5sb2FkaW5nUmVmLmN1cnJlbnQpIHtcbiAgICAgIHRoaXMub2JzZXJ2ZXIgPSBuZXcgSW50ZXJzZWN0aW9uT2JzZXJ2ZXIodGhpcy5oYW5kbGVPYnNlcnZlciwgZGl2T3B0aW9ucyk7XG4gICAgICB0aGlzLm9ic2VydmVyLm9ic2VydmUodGhpcy5sb2FkaW5nUmVmLmN1cnJlbnQpO1xuICAgIH1cbiAgfVxuXG4gIGdldFNuYXBzaG90QmVmb3JlVXBkYXRlKHByZXZQcm9wczogRHJvcGRvd25MaXN0UHJvcHMsIHByZXZTdGF0ZTogRHJvcGRvd25MaXN0U3RhdGUpIHtcbiAgICBpZiAocHJldlByb3BzLm9wdGlvbnMgIT09IHRoaXMucHJvcHMub3B0aW9ucykge1xuICAgICAgLy8gY2hlY2sgaWYgdXNlciBzZWFyY2hpbmcsIHJlc2V0IHN0YXRlLm9wdGlvbnMgYXQgdGhlIGZpcnN0IHRpbWVcbiAgICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLl9nZXRPcHRpb25zKDApO1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7b3B0aW9uc30pO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIC8vIHByZXZlbnQgY29uc29sZSB3YXJuaW5nOiBnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpIHNob3VsZCBiZSB1c2VkIHdpdGggY29tcG9uZW50RGlkVXBkYXRlKCkuXG4gIGNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHMsIHByZXZTdGF0ZSwgc25hcHNob3QpIHt9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgaWYgKHRoaXMubG9hZGluZ1JlZi5jdXJyZW50KSB7XG4gICAgICB0aGlzLm9ic2VydmVyPy51bm9ic2VydmUodGhpcy5sb2FkaW5nUmVmLmN1cnJlbnQpO1xuICAgIH1cbiAgfVxuXG4gIGhhbmRsZU9ic2VydmVyID0gZW50aXRpZXMgPT4ge1xuICAgIGNvbnN0IHkgPSBlbnRpdGllc1swXS5ib3VuZGluZ0NsaWVudFJlY3QueTtcbiAgICBpZiAodGhpcy5wcmV2WSA+IHkpIHtcbiAgICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLl9nZXRPcHRpb25zKHRoaXMucGFnZSk7XG4gICAgICBpZiAob3B0aW9ucykgdGhpcy5zZXRTdGF0ZSh7b3B0aW9uc30pO1xuICAgIH1cbiAgICB0aGlzLnByZXZZID0geTtcbiAgfTtcblxuICBfZ2V0T3B0aW9ucyhwYWdlKSB7XG4gICAgaWYgKCF0aGlzLnByb3BzLm9wdGlvbnMpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICBjb25zdCBuID0gdGhpcy5wcm9wcy5vcHRpb25zLmxlbmd0aDtcbiAgICBpZiAobiA9PT0gMCkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBjb25zdCBzdGFydCA9IHBhZ2UgKiB0aGlzLmluaXROdW1iZXJPZk9wdGlvbnM7XG4gICAgY29uc3QgZW5kID0gc3RhcnQgKyB0aGlzLmluaXROdW1iZXJPZk9wdGlvbnMgPiBuID8gbiA6IHN0YXJ0ICsgdGhpcy5pbml0TnVtYmVyT2ZPcHRpb25zO1xuXG4gICAgaWYgKHN0YXJ0IDwgZW5kICYmIGVuZCA8PSBuKSB7XG4gICAgICB0aGlzLnBhZ2UgPSBwYWdlICsgMTtcbiAgICAgIC8vIGluIGNhc2Ugb2YgdXNlciBzZWFyY2hpbmcsIHByb3BzLm9wdGlvbnMgd2lsbCBiZSB1cGRhdGVkXG4gICAgICAvLyBzbyBcInBhZ2VcIiB2YWx1ZSB3aWxsIGJlIHNldCB0byAwIGFuZCBwcmV2aW91cyBzdGF0ZS5vcHRpb25zIHdpbGwgYmUgZGlzY2FyZGVkXG4gICAgICByZXR1cm4gW1xuICAgICAgICAuLi4ocGFnZSA+IDAgPyB0aGlzLnN0YXRlLm9wdGlvbnMgfHwgW10gOiBbXSksXG4gICAgICAgIC4uLnRoaXMucHJvcHMub3B0aW9ucy5zbGljZShzdGFydCwgZW5kKVxuICAgICAgXTtcbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIF9vbkNsaWNrKHJlc3VsdCwgZXZlbnQpIHtcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIC8vIG9ubHkgd29yayB3aGVuIGxlZnQgaXMgY2xpY2tlZFxuICAgIGlmICgoZXZlbnQudHlwZSA9PT0gJ21vdXNlZG93bicgJiYgZXZlbnQuYnV0dG9uID09PSBMRUZUX0JVVFRPTikgfHwgZXZlbnQudHlwZSA9PT0gJ2NsaWNrJykge1xuICAgICAgdGhpcy5wcm9wcy5vbk9wdGlvblNlbGVjdGVkPy4ocmVzdWx0LCBldmVudCk7XG4gICAgfVxuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHtcbiAgICAgIGZpeGVkT3B0aW9ucyxcbiAgICAgIGxpZ2h0LFxuICAgICAgYWxsb3dDdXN0b21WYWx1ZXMgPSAwLFxuICAgICAgY3VzdG9tTGlzdEl0ZW1Db21wb25lbnQ6IEN1c3RvbUxpc3RJdGVtQ29tcG9uZW50ID0gTGlzdEl0ZW1cbiAgICB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCB7ZGlzcGxheU9wdGlvbjogZGlzcGxheSA9IGRlZmF1bHREaXNwbGF5fSA9IHRoaXMucHJvcHM7XG5cbiAgICAvLyBEb24ndCByZW5kZXIgaWYgdGhlcmUgYXJlIG5vIG9wdGlvbnMgdG8gZGlzcGxheVxuICAgIGlmICghdGhpcy5wcm9wcy5vcHRpb25zPy5sZW5ndGggJiYgYWxsb3dDdXN0b21WYWx1ZXMgPD0gMCkge1xuICAgICAgcmV0dXJuIDxkaXYgLz47XG4gICAgfVxuXG4gICAgY29uc3QgdmFsdWVPZmZzZXQgPSBBcnJheS5pc0FycmF5KGZpeGVkT3B0aW9ucykgPyBmaXhlZE9wdGlvbnMubGVuZ3RoIDogMDtcblxuICAgIC8vIEZvciBzb21lIHJlYXNvbiBvbkNsaWNrIGlzIG5vdCBmaXJlZCB3aGVuIGNsaWNrZWQgb24gYW4gb3B0aW9uXG4gICAgLy8gb25Nb3VzZURvd24gaXMgdXNlZCBoZXJlIGFzIGEgd29ya2Fyb3VuZCBvZiAjMjA1IGFuZCBvdGhlclxuICAgIHJldHVybiAoXG4gICAgICA8RHJvcGRvd25MaXN0V3JhcHBlclxuICAgICAgICBjbGFzc05hbWU9e2NsYXNzTmFtZXMoY2xhc3NMaXN0Lmxpc3QsIHRoaXMucHJvcHMuY3VzdG9tQ2xhc3Nlcz8ucmVzdWx0cyl9XG4gICAgICAgIGxpZ2h0PXtsaWdodH1cbiAgICAgID5cbiAgICAgICAge3RoaXMucHJvcHMuY3VzdG9tTGlzdEhlYWRlckNvbXBvbmVudCA/IChcbiAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT17Y2xhc3NOYW1lcyhjbGFzc0xpc3QubGlzdEhlYWRlciwgdGhpcy5wcm9wcy5jdXN0b21DbGFzc2VzPy5saXN0SGVhZGVyKX0+XG4gICAgICAgICAgICA8dGhpcy5wcm9wcy5jdXN0b21MaXN0SGVhZGVyQ29tcG9uZW50IC8+XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgICkgOiBudWxsfVxuXG4gICAgICAgIHt2YWx1ZU9mZnNldCA+IDAgPyAoXG4gICAgICAgICAgPGRpdiBjbGFzc05hbWU9e2NsYXNzTGlzdC5saXN0U2VjdGlvbn0+XG4gICAgICAgICAgICB7Zml4ZWRPcHRpb25zPy5tYXAoKHZhbHVlLCBpKSA9PiAoXG4gICAgICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9e2NsYXNzTmFtZXMoXG4gICAgICAgICAgICAgICAgICBjbGFzc0xpc3QubGlzdEl0ZW0sXG4gICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGhvdmVyOiB0aGlzLnByb3BzLnNlbGVjdGlvbkluZGV4ID09PSBpLFxuICAgICAgICAgICAgICAgICAgICBbY2xhc3NMaXN0Lmxpc3RJdGVtRml4ZWRdOiB0cnVlXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgdGhpcy5wcm9wcy5jdXN0b21DbGFzc2VzPy5saXN0SXRlbVxuICAgICAgICAgICAgICAgICl9XG4gICAgICAgICAgICAgICAga2V5PXtgJHtkaXNwbGF5KHZhbHVlKX1fJHtpfWB9XG4gICAgICAgICAgICAgICAgb25Nb3VzZURvd249e2UgPT4gdGhpcy5fb25DbGljayh2YWx1ZSwgZSl9XG4gICAgICAgICAgICAgICAgb25DbGljaz17ZSA9PiB0aGlzLl9vbkNsaWNrKHZhbHVlLCBlKX1cbiAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIDxDdXN0b21MaXN0SXRlbUNvbXBvbmVudCB2YWx1ZT17dmFsdWV9IGRpc3BsYXlPcHRpb249e2Rpc3BsYXl9IC8+XG4gICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgKSl9XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgICkgOiBudWxsfVxuXG4gICAgICAgIHt0aGlzLnN0YXRlLm9wdGlvbnM/Lm1hcCgodmFsdWUsIGkpID0+IChcbiAgICAgICAgICA8ZGl2XG4gICAgICAgICAgICBjbGFzc05hbWU9e2NsYXNzTmFtZXMoXG4gICAgICAgICAgICAgIGNsYXNzTGlzdC5saXN0SXRlbSxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGhvdmVyOiB0aGlzLnByb3BzLnNlbGVjdGlvbkluZGV4ID09PSBpICsgdmFsdWVPZmZzZXRcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgdGhpcy5wcm9wcy5jdXN0b21DbGFzc2VzPy5saXN0SXRlbVxuICAgICAgICAgICAgKX1cbiAgICAgICAgICAgIGtleT17YCR7ZGlzcGxheSh2YWx1ZSl9XyR7aX1gfVxuICAgICAgICAgICAgb25Nb3VzZURvd249e2UgPT4gdGhpcy5fb25DbGljayh2YWx1ZSwgZSl9XG4gICAgICAgICAgICBvbkNsaWNrPXtlID0+IHRoaXMuX29uQ2xpY2sodmFsdWUsIGUpfVxuICAgICAgICAgID5cbiAgICAgICAgICAgIDxDdXN0b21MaXN0SXRlbUNvbXBvbmVudCB2YWx1ZT17dmFsdWV9IGRpc3BsYXlPcHRpb249e2Rpc3BsYXl9IC8+XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgICkpfVxuXG4gICAgICAgIDxEcm9wZG93bkZvb3RlcldyYXBwZXIgcmVmPXt0aGlzLmxvYWRpbmdSZWZ9IC8+XG4gICAgICA8L0Ryb3Bkb3duTGlzdFdyYXBwZXI+XG4gICAgKTtcbiAgfVxufVxuIl19