"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getUIBlocks = getUIBlocks;
exports["default"] = EffectTimeSliderFactory;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _react = _interopRequireWildcard(require("react"));

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _rangeSlider = _interopRequireDefault(require("../common/range-slider"));

var _icons = require("../common/icons");

var _templateObject, _templateObject2, _templateObject3, _templateObject4, _templateObject5, _templateObject6, _templateObject7, _templateObject8;

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var TimeSliderWrapper = _styledComponents["default"].div(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2["default"])(["\n  width: 100%;\n  height: 48px;\n"])));

var TopRowWrapper = _styledComponents["default"].div(_templateObject2 || (_templateObject2 = (0, _taggedTemplateLiteral2["default"])(["\n  width: 100%;\n  height: 32px;\n  display: flex;\n  position: relative;\n  align-items: center;\n\n  .day {\n    background-color: ", ";\n  }\n  .night {\n    background-color: ", ";\n  }\n  .sunrise,\n  .sunset {\n    background-color: ", ";\n  }\n  .inline_icon__day {\n    color: ", ";\n  }\n  .inline_icon__night {\n    color: ", ";\n  }\n"])), function (props) {
  return props.theme.effectPanelElementColorHovered;
}, function (props) {
  return props.theme.effectPanelElementColor;
}, function (props) {
  return props.theme.effectPanelElementColorActive;
}, function (props) {
  return props.theme.effectPanelElementColorSun;
}, function (props) {
  return props.theme.effectPanelTextSecondary2;
});

var BottomRowWrapper = _styledComponents["default"].div(_templateObject3 || (_templateObject3 = (0, _taggedTemplateLiteral2["default"])(["\n  position: relative;\n  height: 16px;\n  .bottom_icon__sunrise,\n  .bottom_icon__sunset {\n    color: ", ";\n  }\n"])), function (props) {
  return props.theme.effectPanelTextSecondary2;
});

var BackgroundBlock = _styledComponents["default"].div(_templateObject4 || (_templateObject4 = (0, _taggedTemplateLiteral2["default"])(["\n  margin: 0px;\n  padding: 0px;\n  width: ", ";\n  height: 24px;\n  pointer-events: none;\n"])), function (props) {
  return props.width;
});

var StyledIcon = _styledComponents["default"].div(_templateObject5 || (_templateObject5 = (0, _taggedTemplateLiteral2["default"])(["\n  position: absolute;\n  top: 0px;\n  left: calc(", "% - 8px);\n  height: 32px;\n  pointer-events: none;\n"])), function (props) {
  return props.left;
});

var StyledBottomIcon = _styledComponents["default"].div(_templateObject6 || (_templateObject6 = (0, _taggedTemplateLiteral2["default"])(["\n  position: absolute;\n  top: 0px;\n  left: calc(", "% - 27px);\n  height: 12px;\n  pointer-events: none;\n  margin-top: 1px;\n  display: flex;\n  align-items: flex-end;\n"])), function (props) {
  return props.left;
});

var RangeSliderWrapper = _styledComponents["default"].div(_templateObject7 || (_templateObject7 = (0, _taggedTemplateLiteral2["default"])(["\n  position: absolute;\n  width: 100%;\n  .kg-slider {\n    padding-left: 6px;\n  }\n  .kg-range-slider {\n    padding: 0px !important;\n    background-color: transparent;\n  }\n  .kg-range-slider__bar {\n    background-color: transparent;\n  }\n  .kg-range-slider__handle {\n    height: 32px;\n    width: 8px;\n    margin-top: -14px;\n    align-items: center;\n    display: flex;\n    justify-content: center;\n  }\n  .kg-range-slider__handle::after {\n    margin-left: 1px;\n  }\n  .kg-range-slider__input {\n    height: 32px;\n    text-align: center;\n    padding: 3px 6px;\n  }\n"])));

var Text = _styledComponents["default"].div(_templateObject8 || (_templateObject8 = (0, _taggedTemplateLiteral2["default"])(["\n  margin-left: 3px;\n  font-size: 10px;\n  line-height: 11px;\n  white-space: nowrap;\n"])));

var MODES = {
  sunrise: 'sunrise',
  day: 'day',
  sunset: 'sunset',
  night: 'night'
};
/**
 * Generate rendering blocks for each part of the day.
 */

function getUIBlocks(config) {
  var dawn = config.dawn,
      sunrise = config.sunrise,
      sunset = config.sunset,
      dusk = config.dusk;
  if (dawn > sunrise) sunrise += 1;
  if (dawn > sunset) sunset += 1;
  if (dawn > dusk) dusk += 1;
  var blocks = [{
    start: dawn,
    end: sunrise,
    type: MODES.sunrise,
    width: 0,
    center: 0
  }, {
    start: sunrise,
    end: sunset,
    type: MODES.day,
    width: 0,
    center: 0
  }, {
    start: sunset,
    end: dusk,
    type: MODES.sunset,
    width: 0,
    center: 0
  }, {
    start: dusk,
    end: dawn,
    type: MODES.night,
    width: 0,
    center: 0
  }];
  var updatedBlocks = []; // sort and split ui blocks

  blocks.forEach(function (block) {
    if (block.start > block.end) {
      block.end += 1;
    }

    if (block.start > 1 && block.end > 1) {
      updatedBlocks.push(_objectSpread(_objectSpread({}, block), {}, {
        start: block.start - 1,
        end: block.end - 1
      }));
    } else if (block.end > 1) {
      updatedBlocks.push(_objectSpread(_objectSpread({}, block), {}, {
        end: 1
      }));
      updatedBlocks.push(_objectSpread(_objectSpread({}, block), {}, {
        start: 0,
        end: block.end - 1
      }));
    } else {
      updatedBlocks.push(block);
    }
  });
  updatedBlocks.sort(function (a, b) {
    return a.start - b.start;
  });
  var existingBottomBlocks = {};
  updatedBlocks.forEach(function (block) {
    block.width = (block.end - block.start) * 100;
    block.center = block.start * 100 + block.width / 2; // Don't display inline icons when day or night is too short.

    if ((block.type === MODES.day || block.type === MODES.night) && block.width > 5) {
      block.TopRowIcon = block.type === MODES.day ? _icons.Sun : _icons.Moon;
    } // bottom row icons below the slider


    if ((block.type === MODES.sunrise || block.type === MODES.sunset) && block.width > 0.1) {
      // prevent duplicates for bottom row
      var existingBlock = existingBottomBlocks[block.type];

      if (existingBlock) {
        if (existingBlock.width < block.width) existingBlock.BottomRowIcon = null;else if (existingBlock.width > block.width) return;
      }

      existingBottomBlocks[block.type] = block; // prevent bottom icon and labels

      block.BottomRowIcon = block.type === MODES.sunrise ? _icons.Sunrise : _icons.Sunset;

      if (block.center > 90) {
        block.center = 90;
      } else if (block.center < 10) {
        block.center = 10;
      }

      block.text = block.type === MODES.sunrise ? config.sunriseTime : config.sunsetTime;
    }
  });
  return updatedBlocks;
}

EffectTimeSliderFactory.deps = [_rangeSlider["default"]];

function EffectTimeSliderFactory(RangeSlider) {
  var EffectTimeSlider = function EffectTimeSlider(_ref) {
    var rangeSliderValue = _ref.value,
        onChange = _ref.onChange,
        config = _ref.config;
    var uiBlocks = (0, _react.useMemo)(function () {
      return getUIBlocks(config);
    }, [config]);
    var rangeSliderProps = (0, _react.useMemo)(function () {
      return {
        label: 'value',
        value1: rangeSliderValue,
        step: 0.001,
        range: [0, 1],
        value0: 0,
        onChange: onChange,
        showInput: false,
        isRanged: false
      };
    }, [rangeSliderValue, onChange]);
    return /*#__PURE__*/_react["default"].createElement(TimeSliderWrapper, null, /*#__PURE__*/_react["default"].createElement(TopRowWrapper, null, uiBlocks.map(function (block, index) {
      return /*#__PURE__*/_react["default"].createElement(BackgroundBlock, {
        key: index,
        width: "".concat(block.width, "%"),
        className: block.type
      });
    }), uiBlocks.map(function (block, index) {
      return block.TopRowIcon ? /*#__PURE__*/_react["default"].createElement(StyledIcon, {
        key: index,
        left: block.center,
        className: "inline_icon__".concat(block.type)
      }, /*#__PURE__*/_react["default"].createElement(block.TopRowIcon, {
        width: "16px",
        height: "32px"
      })) : null;
    }), /*#__PURE__*/_react["default"].createElement(RangeSliderWrapper, null, /*#__PURE__*/_react["default"].createElement(RangeSlider, rangeSliderProps))), /*#__PURE__*/_react["default"].createElement(BottomRowWrapper, null, uiBlocks.map(function (block, index) {
      return block.BottomRowIcon ? /*#__PURE__*/_react["default"].createElement(StyledBottomIcon, {
        key: index,
        left: block.center,
        className: "bottom_icon__".concat(block.type)
      }, /*#__PURE__*/_react["default"].createElement(block.BottomRowIcon, {
        width: "12px",
        height: "12px"
      }), /*#__PURE__*/_react["default"].createElement(Text, null, block.text)) : null;
    })));
  };

  return EffectTimeSlider;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lZmZlY3RzL2VmZmVjdC10aW1lLXNsaWRlci50c3giXSwibmFtZXMiOlsiVGltZVNsaWRlcldyYXBwZXIiLCJzdHlsZWQiLCJkaXYiLCJUb3BSb3dXcmFwcGVyIiwicHJvcHMiLCJ0aGVtZSIsImVmZmVjdFBhbmVsRWxlbWVudENvbG9ySG92ZXJlZCIsImVmZmVjdFBhbmVsRWxlbWVudENvbG9yIiwiZWZmZWN0UGFuZWxFbGVtZW50Q29sb3JBY3RpdmUiLCJlZmZlY3RQYW5lbEVsZW1lbnRDb2xvclN1biIsImVmZmVjdFBhbmVsVGV4dFNlY29uZGFyeTIiLCJCb3R0b21Sb3dXcmFwcGVyIiwiQmFja2dyb3VuZEJsb2NrIiwid2lkdGgiLCJTdHlsZWRJY29uIiwibGVmdCIsIlN0eWxlZEJvdHRvbUljb24iLCJSYW5nZVNsaWRlcldyYXBwZXIiLCJUZXh0IiwiTU9ERVMiLCJzdW5yaXNlIiwiZGF5Iiwic3Vuc2V0IiwibmlnaHQiLCJnZXRVSUJsb2NrcyIsImNvbmZpZyIsImRhd24iLCJkdXNrIiwiYmxvY2tzIiwic3RhcnQiLCJlbmQiLCJ0eXBlIiwiY2VudGVyIiwidXBkYXRlZEJsb2NrcyIsImZvckVhY2giLCJibG9jayIsInB1c2giLCJzb3J0IiwiYSIsImIiLCJleGlzdGluZ0JvdHRvbUJsb2NrcyIsIlRvcFJvd0ljb24iLCJTdW4iLCJNb29uIiwiZXhpc3RpbmdCbG9jayIsIkJvdHRvbVJvd0ljb24iLCJTdW5yaXNlIiwiU3Vuc2V0IiwidGV4dCIsInN1bnJpc2VUaW1lIiwic3Vuc2V0VGltZSIsIkVmZmVjdFRpbWVTbGlkZXJGYWN0b3J5IiwiZGVwcyIsIlJhbmdlU2xpZGVyRmFjdG9yeSIsIlJhbmdlU2xpZGVyIiwiRWZmZWN0VGltZVNsaWRlciIsInJhbmdlU2xpZGVyVmFsdWUiLCJ2YWx1ZSIsIm9uQ2hhbmdlIiwidWlCbG9ja3MiLCJyYW5nZVNsaWRlclByb3BzIiwibGFiZWwiLCJ2YWx1ZTEiLCJzdGVwIiwicmFuZ2UiLCJ2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bnNlLUlkZW50aWZpZXI6IE1JVFxuLy8gQ29weXJpZ2h0IGNvbnRyaWJ1dG9ycyB0byB0aGUga2VwbGVyLmdsIHByb2plY3RcblxuaW1wb3J0IFJlYWN0LCB7dXNlTWVtb30gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHN0eWxlZCBmcm9tICdzdHlsZWQtY29tcG9uZW50cyc7XG5cbmltcG9ydCBSYW5nZVNsaWRlckZhY3RvcnkgZnJvbSAnLi4vY29tbW9uL3JhbmdlLXNsaWRlcic7XG5pbXBvcnQge1N1biwgTW9vbiwgU3Vuc2V0LCBTdW5yaXNlfSBmcm9tICcuLi9jb21tb24vaWNvbnMnO1xuXG5leHBvcnQgdHlwZSBFZmZlY3RUaW1lU2xpZGVyQ29uZmlnID0ge1xuICBkYXduOiBudW1iZXI7XG4gIHN1bnJpc2U6IG51bWJlcjtcbiAgc3Vuc2V0OiBudW1iZXI7XG4gIGR1c2s6IG51bWJlcjtcbiAgc3VucmlzZVRpbWU6IHN0cmluZztcbiAgc3Vuc2V0VGltZTogc3RyaW5nO1xufTtcblxuZXhwb3J0IHR5cGUgVUlCbG9jayA9IHtcbiAgdHlwZTogc3RyaW5nO1xuICB3aWR0aDogbnVtYmVyO1xuICBjZW50ZXI6IG51bWJlcjtcbiAgc3RhcnQ6IG51bWJlcjtcbiAgZW5kOiBudW1iZXI7XG4gIHRleHQ/OiBzdHJpbmc7XG4gIFRvcFJvd0ljb24/OiBSZWFjdC5FbGVtZW50VHlwZTxhbnk+O1xuICBCb3R0b21Sb3dJY29uPzogUmVhY3QuRWxlbWVudFR5cGU8YW55Pjtcbn07XG5cbmV4cG9ydCB0eXBlIEVmZmVjdFRpbWVTbGlkZXJQcm9wcyA9IHtcbiAgdmFsdWU6IG51bWJlcjtcbiAgb25DaGFuZ2U6IChudW1iZXIpID0+IHZvaWQ7XG4gIGNvbmZpZzogRWZmZWN0VGltZVNsaWRlckNvbmZpZztcbn07XG5cbmNvbnN0IFRpbWVTbGlkZXJXcmFwcGVyID0gc3R5bGVkLmRpdmBcbiAgd2lkdGg6IDEwMCU7XG4gIGhlaWdodDogNDhweDtcbmA7XG5cbmNvbnN0IFRvcFJvd1dyYXBwZXIgPSBzdHlsZWQuZGl2YFxuICB3aWR0aDogMTAwJTtcbiAgaGVpZ2h0OiAzMnB4O1xuICBkaXNwbGF5OiBmbGV4O1xuICBwb3NpdGlvbjogcmVsYXRpdmU7XG4gIGFsaWduLWl0ZW1zOiBjZW50ZXI7XG5cbiAgLmRheSB7XG4gICAgYmFja2dyb3VuZC1jb2xvcjogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS5lZmZlY3RQYW5lbEVsZW1lbnRDb2xvckhvdmVyZWR9O1xuICB9XG4gIC5uaWdodCB7XG4gICAgYmFja2dyb3VuZC1jb2xvcjogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS5lZmZlY3RQYW5lbEVsZW1lbnRDb2xvcn07XG4gIH1cbiAgLnN1bnJpc2UsXG4gIC5zdW5zZXQge1xuICAgIGJhY2tncm91bmQtY29sb3I6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUuZWZmZWN0UGFuZWxFbGVtZW50Q29sb3JBY3RpdmV9O1xuICB9XG4gIC5pbmxpbmVfaWNvbl9fZGF5IHtcbiAgICBjb2xvcjogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS5lZmZlY3RQYW5lbEVsZW1lbnRDb2xvclN1bn07XG4gIH1cbiAgLmlubGluZV9pY29uX19uaWdodCB7XG4gICAgY29sb3I6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUuZWZmZWN0UGFuZWxUZXh0U2Vjb25kYXJ5Mn07XG4gIH1cbmA7XG5cbmNvbnN0IEJvdHRvbVJvd1dyYXBwZXIgPSBzdHlsZWQuZGl2YFxuICBwb3NpdGlvbjogcmVsYXRpdmU7XG4gIGhlaWdodDogMTZweDtcbiAgLmJvdHRvbV9pY29uX19zdW5yaXNlLFxuICAuYm90dG9tX2ljb25fX3N1bnNldCB7XG4gICAgY29sb3I6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUuZWZmZWN0UGFuZWxUZXh0U2Vjb25kYXJ5Mn07XG4gIH1cbmA7XG5cbnR5cGUgQmFja2dyb3VuZEJsb2NrUHJvcHMgPSB7d2lkdGg6IHN0cmluZ307XG5jb25zdCBCYWNrZ3JvdW5kQmxvY2sgPSBzdHlsZWQuZGl2PEJhY2tncm91bmRCbG9ja1Byb3BzPmBcbiAgbWFyZ2luOiAwcHg7XG4gIHBhZGRpbmc6IDBweDtcbiAgd2lkdGg6ICR7cHJvcHMgPT4gcHJvcHMud2lkdGh9O1xuICBoZWlnaHQ6IDI0cHg7XG4gIHBvaW50ZXItZXZlbnRzOiBub25lO1xuYDtcblxudHlwZSBTdHlsZWRJY29uUHJvcHMgPSB7bGVmdDogbnVtYmVyfTtcbmNvbnN0IFN0eWxlZEljb24gPSBzdHlsZWQuZGl2PFN0eWxlZEljb25Qcm9wcz5gXG4gIHBvc2l0aW9uOiBhYnNvbHV0ZTtcbiAgdG9wOiAwcHg7XG4gIGxlZnQ6IGNhbGMoJHtwcm9wcyA9PiBwcm9wcy5sZWZ0fSUgLSA4cHgpO1xuICBoZWlnaHQ6IDMycHg7XG4gIHBvaW50ZXItZXZlbnRzOiBub25lO1xuYDtcblxudHlwZSBTdHlsZWRCb3R0b21JY29uUHJvcHMgPSB7bGVmdDogbnVtYmVyfTtcbmNvbnN0IFN0eWxlZEJvdHRvbUljb24gPSBzdHlsZWQuZGl2PFN0eWxlZEJvdHRvbUljb25Qcm9wcz5gXG4gIHBvc2l0aW9uOiBhYnNvbHV0ZTtcbiAgdG9wOiAwcHg7XG4gIGxlZnQ6IGNhbGMoJHtwcm9wcyA9PiBwcm9wcy5sZWZ0fSUgLSAyN3B4KTtcbiAgaGVpZ2h0OiAxMnB4O1xuICBwb2ludGVyLWV2ZW50czogbm9uZTtcbiAgbWFyZ2luLXRvcDogMXB4O1xuICBkaXNwbGF5OiBmbGV4O1xuICBhbGlnbi1pdGVtczogZmxleC1lbmQ7XG5gO1xuXG5jb25zdCBSYW5nZVNsaWRlcldyYXBwZXIgPSBzdHlsZWQuZGl2YFxuICBwb3NpdGlvbjogYWJzb2x1dGU7XG4gIHdpZHRoOiAxMDAlO1xuICAua2ctc2xpZGVyIHtcbiAgICBwYWRkaW5nLWxlZnQ6IDZweDtcbiAgfVxuICAua2ctcmFuZ2Utc2xpZGVyIHtcbiAgICBwYWRkaW5nOiAwcHggIWltcG9ydGFudDtcbiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudDtcbiAgfVxuICAua2ctcmFuZ2Utc2xpZGVyX19iYXIge1xuICAgIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50O1xuICB9XG4gIC5rZy1yYW5nZS1zbGlkZXJfX2hhbmRsZSB7XG4gICAgaGVpZ2h0OiAzMnB4O1xuICAgIHdpZHRoOiA4cHg7XG4gICAgbWFyZ2luLXRvcDogLTE0cHg7XG4gICAgYWxpZ24taXRlbXM6IGNlbnRlcjtcbiAgICBkaXNwbGF5OiBmbGV4O1xuICAgIGp1c3RpZnktY29udGVudDogY2VudGVyO1xuICB9XG4gIC5rZy1yYW5nZS1zbGlkZXJfX2hhbmRsZTo6YWZ0ZXIge1xuICAgIG1hcmdpbi1sZWZ0OiAxcHg7XG4gIH1cbiAgLmtnLXJhbmdlLXNsaWRlcl9faW5wdXQge1xuICAgIGhlaWdodDogMzJweDtcbiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7XG4gICAgcGFkZGluZzogM3B4IDZweDtcbiAgfVxuYDtcblxuY29uc3QgVGV4dCA9IHN0eWxlZC5kaXZgXG4gIG1hcmdpbi1sZWZ0OiAzcHg7XG4gIGZvbnQtc2l6ZTogMTBweDtcbiAgbGluZS1oZWlnaHQ6IDExcHg7XG4gIHdoaXRlLXNwYWNlOiBub3dyYXA7XG5gO1xuXG5jb25zdCBNT0RFUyA9IHtcbiAgc3VucmlzZTogJ3N1bnJpc2UnLFxuICBkYXk6ICdkYXknLFxuICBzdW5zZXQ6ICdzdW5zZXQnLFxuICBuaWdodDogJ25pZ2h0J1xufTtcblxuLyoqXG4gKiBHZW5lcmF0ZSByZW5kZXJpbmcgYmxvY2tzIGZvciBlYWNoIHBhcnQgb2YgdGhlIGRheS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFVJQmxvY2tzKGNvbmZpZzogRWZmZWN0VGltZVNsaWRlckNvbmZpZyk6IFVJQmxvY2tbXSB7XG4gIGxldCB7ZGF3biwgc3VucmlzZSwgc3Vuc2V0LCBkdXNrfSA9IGNvbmZpZztcbiAgaWYgKGRhd24gPiBzdW5yaXNlKSBzdW5yaXNlICs9IDE7XG4gIGlmIChkYXduID4gc3Vuc2V0KSBzdW5zZXQgKz0gMTtcbiAgaWYgKGRhd24gPiBkdXNrKSBkdXNrICs9IDE7XG5cbiAgY29uc3QgYmxvY2tzID0gW1xuICAgIHtcbiAgICAgIHN0YXJ0OiBkYXduLFxuICAgICAgZW5kOiBzdW5yaXNlLFxuICAgICAgdHlwZTogTU9ERVMuc3VucmlzZSxcbiAgICAgIHdpZHRoOiAwLFxuICAgICAgY2VudGVyOiAwXG4gICAgfSxcbiAgICB7XG4gICAgICBzdGFydDogc3VucmlzZSxcbiAgICAgIGVuZDogc3Vuc2V0LFxuICAgICAgdHlwZTogTU9ERVMuZGF5LFxuICAgICAgd2lkdGg6IDAsXG4gICAgICBjZW50ZXI6IDBcbiAgICB9LFxuICAgIHtcbiAgICAgIHN0YXJ0OiBzdW5zZXQsXG4gICAgICBlbmQ6IGR1c2ssXG4gICAgICB0eXBlOiBNT0RFUy5zdW5zZXQsXG4gICAgICB3aWR0aDogMCxcbiAgICAgIGNlbnRlcjogMFxuICAgIH0sXG4gICAge1xuICAgICAgc3RhcnQ6IGR1c2ssXG4gICAgICBlbmQ6IGRhd24sXG4gICAgICB0eXBlOiBNT0RFUy5uaWdodCxcbiAgICAgIHdpZHRoOiAwLFxuICAgICAgY2VudGVyOiAwXG4gICAgfVxuICBdO1xuICBjb25zdCB1cGRhdGVkQmxvY2tzOiBVSUJsb2NrW10gPSBbXTtcblxuICAvLyBzb3J0IGFuZCBzcGxpdCB1aSBibG9ja3NcbiAgYmxvY2tzLmZvckVhY2goYmxvY2sgPT4ge1xuICAgIGlmIChibG9jay5zdGFydCA+IGJsb2NrLmVuZCkge1xuICAgICAgYmxvY2suZW5kICs9IDE7XG4gICAgfVxuICAgIGlmIChibG9jay5zdGFydCA+IDEgJiYgYmxvY2suZW5kID4gMSkge1xuICAgICAgdXBkYXRlZEJsb2Nrcy5wdXNoKHsuLi5ibG9jaywgc3RhcnQ6IGJsb2NrLnN0YXJ0IC0gMSwgZW5kOiBibG9jay5lbmQgLSAxfSk7XG4gICAgfSBlbHNlIGlmIChibG9jay5lbmQgPiAxKSB7XG4gICAgICB1cGRhdGVkQmxvY2tzLnB1c2goe1xuICAgICAgICAuLi5ibG9jayxcbiAgICAgICAgZW5kOiAxXG4gICAgICB9KTtcblxuICAgICAgdXBkYXRlZEJsb2Nrcy5wdXNoKHsuLi5ibG9jaywgc3RhcnQ6IDAsIGVuZDogYmxvY2suZW5kIC0gMX0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB1cGRhdGVkQmxvY2tzLnB1c2goYmxvY2spO1xuICAgIH1cbiAgfSk7XG4gIHVwZGF0ZWRCbG9ja3Muc29ydCgoYSwgYikgPT4gYS5zdGFydCAtIGIuc3RhcnQpO1xuXG4gIGNvbnN0IGV4aXN0aW5nQm90dG9tQmxvY2tzID0ge307XG4gIHVwZGF0ZWRCbG9ja3MuZm9yRWFjaChibG9jayA9PiB7XG4gICAgYmxvY2sud2lkdGggPSAoYmxvY2suZW5kIC0gYmxvY2suc3RhcnQpICogMTAwO1xuICAgIGJsb2NrLmNlbnRlciA9IGJsb2NrLnN0YXJ0ICogMTAwICsgYmxvY2sud2lkdGggLyAyO1xuXG4gICAgLy8gRG9uJ3QgZGlzcGxheSBpbmxpbmUgaWNvbnMgd2hlbiBkYXkgb3IgbmlnaHQgaXMgdG9vIHNob3J0LlxuICAgIGlmICgoYmxvY2sudHlwZSA9PT0gTU9ERVMuZGF5IHx8IGJsb2NrLnR5cGUgPT09IE1PREVTLm5pZ2h0KSAmJiBibG9jay53aWR0aCA+IDUpIHtcbiAgICAgIGJsb2NrLlRvcFJvd0ljb24gPSBibG9jay50eXBlID09PSBNT0RFUy5kYXkgPyBTdW4gOiBNb29uO1xuICAgIH1cblxuICAgIC8vIGJvdHRvbSByb3cgaWNvbnMgYmVsb3cgdGhlIHNsaWRlclxuICAgIGlmICgoYmxvY2sudHlwZSA9PT0gTU9ERVMuc3VucmlzZSB8fCBibG9jay50eXBlID09PSBNT0RFUy5zdW5zZXQpICYmIGJsb2NrLndpZHRoID4gMC4xKSB7XG4gICAgICAvLyBwcmV2ZW50IGR1cGxpY2F0ZXMgZm9yIGJvdHRvbSByb3dcbiAgICAgIGNvbnN0IGV4aXN0aW5nQmxvY2sgPSBleGlzdGluZ0JvdHRvbUJsb2Nrc1tibG9jay50eXBlXTtcbiAgICAgIGlmIChleGlzdGluZ0Jsb2NrKSB7XG4gICAgICAgIGlmIChleGlzdGluZ0Jsb2NrLndpZHRoIDwgYmxvY2sud2lkdGgpIGV4aXN0aW5nQmxvY2suQm90dG9tUm93SWNvbiA9IG51bGw7XG4gICAgICAgIGVsc2UgaWYgKGV4aXN0aW5nQmxvY2sud2lkdGggPiBibG9jay53aWR0aCkgcmV0dXJuO1xuICAgICAgfVxuICAgICAgZXhpc3RpbmdCb3R0b21CbG9ja3NbYmxvY2sudHlwZV0gPSBibG9jaztcblxuICAgICAgLy8gcHJldmVudCBib3R0b20gaWNvbiBhbmQgbGFiZWxzXG4gICAgICBibG9jay5Cb3R0b21Sb3dJY29uID0gYmxvY2sudHlwZSA9PT0gTU9ERVMuc3VucmlzZSA/IFN1bnJpc2UgOiBTdW5zZXQ7XG4gICAgICBpZiAoYmxvY2suY2VudGVyID4gOTApIHtcbiAgICAgICAgYmxvY2suY2VudGVyID0gOTA7XG4gICAgICB9IGVsc2UgaWYgKGJsb2NrLmNlbnRlciA8IDEwKSB7XG4gICAgICAgIGJsb2NrLmNlbnRlciA9IDEwO1xuICAgICAgfVxuICAgICAgYmxvY2sudGV4dCA9IGJsb2NrLnR5cGUgPT09IE1PREVTLnN1bnJpc2UgPyBjb25maWcuc3VucmlzZVRpbWUgOiBjb25maWcuc3Vuc2V0VGltZTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gdXBkYXRlZEJsb2Nrcztcbn1cblxuRWZmZWN0VGltZVNsaWRlckZhY3RvcnkuZGVwcyA9IFtSYW5nZVNsaWRlckZhY3RvcnldO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBFZmZlY3RUaW1lU2xpZGVyRmFjdG9yeShcbiAgUmFuZ2VTbGlkZXI6IFJldHVyblR5cGU8dHlwZW9mIFJhbmdlU2xpZGVyRmFjdG9yeT5cbikge1xuICBjb25zdCBFZmZlY3RUaW1lU2xpZGVyOiBSZWFjdC5GQzxFZmZlY3RUaW1lU2xpZGVyUHJvcHM+ID0gKHtcbiAgICB2YWx1ZTogcmFuZ2VTbGlkZXJWYWx1ZSxcbiAgICBvbkNoYW5nZSxcbiAgICBjb25maWdcbiAgfTogRWZmZWN0VGltZVNsaWRlclByb3BzKSA9PiB7XG4gICAgY29uc3QgdWlCbG9ja3MgPSB1c2VNZW1vKCgpID0+IHtcbiAgICAgIHJldHVybiBnZXRVSUJsb2Nrcyhjb25maWcpO1xuICAgIH0sIFtjb25maWddKTtcblxuICAgIGNvbnN0IHJhbmdlU2xpZGVyUHJvcHMgPSB1c2VNZW1vKCgpID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGxhYmVsOiAndmFsdWUnLFxuICAgICAgICB2YWx1ZTE6IHJhbmdlU2xpZGVyVmFsdWUsXG4gICAgICAgIHN0ZXA6IDAuMDAxLFxuICAgICAgICByYW5nZTogWzAsIDFdLFxuICAgICAgICB2YWx1ZTA6IDAsXG4gICAgICAgIG9uQ2hhbmdlLFxuICAgICAgICBzaG93SW5wdXQ6IGZhbHNlLFxuICAgICAgICBpc1JhbmdlZDogZmFsc2VcbiAgICAgIH07XG4gICAgfSwgW3JhbmdlU2xpZGVyVmFsdWUsIG9uQ2hhbmdlXSk7XG5cbiAgICByZXR1cm4gKFxuICAgICAgPFRpbWVTbGlkZXJXcmFwcGVyPlxuICAgICAgICA8VG9wUm93V3JhcHBlcj5cbiAgICAgICAgICB7dWlCbG9ja3MubWFwKChibG9jaywgaW5kZXgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiA8QmFja2dyb3VuZEJsb2NrIGtleT17aW5kZXh9IHdpZHRoPXtgJHtibG9jay53aWR0aH0lYH0gY2xhc3NOYW1lPXtibG9jay50eXBlfSAvPjtcbiAgICAgICAgICB9KX1cblxuICAgICAgICAgIHt1aUJsb2Nrcy5tYXAoKGJsb2NrLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGJsb2NrLlRvcFJvd0ljb24gPyAoXG4gICAgICAgICAgICAgIDxTdHlsZWRJY29uIGtleT17aW5kZXh9IGxlZnQ9e2Jsb2NrLmNlbnRlcn0gY2xhc3NOYW1lPXtgaW5saW5lX2ljb25fXyR7YmxvY2sudHlwZX1gfT5cbiAgICAgICAgICAgICAgICA8YmxvY2suVG9wUm93SWNvbiB3aWR0aD1cIjE2cHhcIiBoZWlnaHQ9XCIzMnB4XCIgLz5cbiAgICAgICAgICAgICAgPC9TdHlsZWRJY29uPlxuICAgICAgICAgICAgKSA6IG51bGw7XG4gICAgICAgICAgfSl9XG5cbiAgICAgICAgICA8UmFuZ2VTbGlkZXJXcmFwcGVyPlxuICAgICAgICAgICAgPFJhbmdlU2xpZGVyIHsuLi5yYW5nZVNsaWRlclByb3BzfSAvPlxuICAgICAgICAgIDwvUmFuZ2VTbGlkZXJXcmFwcGVyPlxuICAgICAgICA8L1RvcFJvd1dyYXBwZXI+XG4gICAgICAgIDxCb3R0b21Sb3dXcmFwcGVyPlxuICAgICAgICAgIHt1aUJsb2Nrcy5tYXAoKGJsb2NrLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGJsb2NrLkJvdHRvbVJvd0ljb24gPyAoXG4gICAgICAgICAgICAgIDxTdHlsZWRCb3R0b21JY29uXG4gICAgICAgICAgICAgICAga2V5PXtpbmRleH1cbiAgICAgICAgICAgICAgICBsZWZ0PXtibG9jay5jZW50ZXJ9XG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lPXtgYm90dG9tX2ljb25fXyR7YmxvY2sudHlwZX1gfVxuICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgPGJsb2NrLkJvdHRvbVJvd0ljb24gd2lkdGg9XCIxMnB4XCIgaGVpZ2h0PVwiMTJweFwiIC8+XG4gICAgICAgICAgICAgICAgPFRleHQ+e2Jsb2NrLnRleHR9PC9UZXh0PlxuICAgICAgICAgICAgICA8L1N0eWxlZEJvdHRvbUljb24+XG4gICAgICAgICAgICApIDogbnVsbDtcbiAgICAgICAgICB9KX1cbiAgICAgICAgPC9Cb3R0b21Sb3dXcmFwcGVyPlxuICAgICAgPC9UaW1lU2xpZGVyV3JhcHBlcj5cbiAgICApO1xuICB9O1xuXG4gIHJldHVybiBFZmZlY3RUaW1lU2xpZGVyO1xufVxuIl19