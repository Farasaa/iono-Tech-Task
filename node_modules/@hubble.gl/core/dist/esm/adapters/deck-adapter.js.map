{"version":3,"file":"deck-adapter.js","names":["PreviewEncoder","AnimationManager","VideoCapture","DeckAdapter","constructor","animationManager","undefined","glContext","videoCapture","shouldAnimate","enabled","getProps","bind","render","stop","seek","setDeck","deck","onNextFrame","extraProps","props","_animate","onAfterRender","controller","gl","Encoder","formatConfigs","filename","timecode","start","end","framerate","onStopped","onSave","onComplete","onStop","timeMs","abort","timeline","setTime","draw","proceedToNextFrame","readyToCapture","areAllLayersLoaded","layers","every","layer","isLoaded","isRecording","capture","canvas","nextTimeMs"],"sources":["../../../src/adapters/deck-adapter.js"],"sourcesContent":["// Copyright (c) 2021 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n/* eslint-disable no-console */\nimport {PreviewEncoder} from '../encoders';\n// eslint-disable-next-line no-unused-vars\nimport {AnimationManager} from '../animations';\nimport {VideoCapture} from '../capture/video-capture';\n\nexport default class DeckAdapter {\n  /** @type {any} */\n  deck;\n  /** @type {AnimationManager} */\n  animationManager;\n  /** @type {boolean} */\n  shouldAnimate;\n  /** @type {boolean} */\n  enabled;\n  /** @type {WebGL2RenderingContext} */\n  glContext;\n\n  /**\n   * @param {Object} params\n   * @param {AnimationManager} params.animationManager\n   * @param {WebGL2RenderingContext} params.glContext\n   */\n  constructor({animationManager = undefined, glContext = undefined}) {\n    this.animationManager = animationManager || new AnimationManager({});\n    this.glContext = glContext;\n    this.videoCapture = new VideoCapture();\n    this.shouldAnimate = false;\n    this.enabled = false;\n    this.getProps = this.getProps.bind(this);\n    this.render = this.render.bind(this);\n    this.stop = this.stop.bind(this);\n    this.seek = this.seek.bind(this);\n  }\n\n  setDeck(deck) {\n    this.deck = deck;\n  }\n\n  /**\n   * @param {Object} params\n   * @param {any} params.deck\n   * @param {(nextTimeMs: number) => void} params.onNextFrame\n   * @param {Object} params.extraProps\n   */\n  getProps({deck, onNextFrame = undefined, extraProps = undefined}) {\n    if (deck) {\n      this.deck = deck;\n    }\n    const props = {\n      _animate: this.shouldAnimate\n    };\n\n    if (onNextFrame) {\n      props.onAfterRender = () => this.onAfterRender(onNextFrame);\n    }\n\n    if (this.enabled) {\n      props.controller = false;\n    } else {\n      props.controller = true;\n    }\n\n    if (this.glContext) {\n      props.gl = this.glContext;\n    }\n    return {...extraProps, ...props};\n  }\n\n  /**\n   * @param {Object} params\n   * @param {typeof import('../encoders').FrameEncoder} params.Encoder\n   * @param {Partial<import('types').FormatConfigs>} params.formatConfigs\n   * @param {string} params.filename\n   * @param {{start: number, end: number, framerate: number}} params.timecode\n   * @param {() => void} params.onStopped\n   * @param {(blob: Blob) => void} params.onSave\n   * @param {() => void} params.onComplete\n   */\n  render({\n    Encoder = PreviewEncoder,\n    formatConfigs = {},\n    filename = undefined,\n    timecode = {start: 0, end: 0, framerate: 30},\n    onStopped = undefined,\n    onSave = undefined,\n    onComplete = undefined\n  }) {\n    this.shouldAnimate = true;\n    this.videoCapture.render({\n      Encoder,\n      formatConfigs,\n      timecode,\n      filename,\n      onStop: () => this.stop({onStopped, onSave, onComplete})\n    });\n    this.enabled = true;\n    this.seek({timeMs: timecode.start});\n  }\n\n  /**\n   * @param {Object} params\n   * @param {() => void} params.onStopped\n   * @param {(blob: Blob) => void} params.onSave\n   * @param {() => void} params.onComplete\n   * @param {boolean} [params.abort]\n   */\n  stop({onStopped, onSave, onComplete, abort}) {\n    this.enabled = false;\n    this.shouldAnimate = false;\n    this.videoCapture.stop({onStopped, onSave, onComplete, abort});\n  }\n\n  /**\n   * @param {Object} params\n   * @param {number} params.timeMs\n   */\n  seek({timeMs}) {\n    this.animationManager.timeline.setTime(timeMs);\n    this.animationManager.draw();\n  }\n\n  /**\n   * @param {(nextTimeMs: number) => void} proceedToNextFrame\n   * @param {boolean} readyToCapture\n   */\n  onAfterRender(proceedToNextFrame, readyToCapture = true) {\n    const areAllLayersLoaded = this.deck && this.deck.props.layers.every(layer => layer.isLoaded);\n    if (this.videoCapture.isRecording() && areAllLayersLoaded && readyToCapture) {\n      this.videoCapture.capture(this.deck.canvas, nextTimeMs => {\n        this.seek({timeMs: nextTimeMs});\n        proceedToNextFrame(nextTimeMs);\n      });\n    }\n  }\n}\n"],"mappings":"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"}