{"version":3,"file":"kepler-filter-keyframes.js","names":["getKeyFramesFree","filter","delta","value","keyframes","domain","easings","linear","timeRangeKeyframes","timings","type","Error","duration","animationWindow","bins","plotType","interval","Object","keys","length","values","intervalBins","Math","round","map","_","idx","bin","x0","x1","hold","KeplerFilterKeyframes","filterIdx","interpolators","getTimeRangeFilterKeyframes","undefined","_processParams","id","factor","start","getStartData","end","getEndData","includes","factorInterpolator","ease","params","features","Keyframes"],"sources":["../../../src/keyframes/kepler-filter-keyframes.js"],"sourcesContent":["// Copyright (c) 2021 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport {factorInterpolator} from './utils';\nimport Keyframes from './keyframes';\nimport {hold, linear} from './easings';\n\n/**\n * 4 Animation Window Types\n * 1. free\n *  |->  |->\n * Current time is a fixed range, animation controller calls next animation frames continuously to animation a moving window\n * The increment id based on domain / BASE_SPEED * SPEED\n *\n * 2. incremental\n * |    |->\n * Same as free, current time is a growing range, only the max value of range increment during animation.\n * The increment is also based on domain / BASE_SPEED * SPEED\n *\n * 3. point\n * o -> o\n * Current time is a point, animation controller calls next animation frame continuously to animation a moving point\n * The increment is based on domain / BASE_SPEED * SPEED\n *\n * 4. interval\n * o ~> o\n * Current time is a point. An array of sorted time steps need to be provided.\n * animation controller calls next animation at a interval when the point jumps to the next step\n */\nfunction getKeyFramesFree(filter) {\n  const delta = filter.value[1] - filter.value[0];\n  return {\n    keyframes: [\n      {value: [filter.domain[0], filter.domain[0] + delta]},\n      {value: [filter.domain[1] - delta, filter.domain[1]]}\n    ],\n    easings: linear\n  };\n}\n\nexport function timeRangeKeyframes({filter, timings}) {\n  if (filter.type !== 'timeRange') {\n    throw new Error(\"filter type must be 'timeRange'.'\");\n  }\n\n  const duration = timings[1] - timings[0];\n\n  switch (filter.animationWindow) {\n    default:\n    case 'free': {\n      return getKeyFramesFree(filter);\n    }\n    case 'incremental': {\n      return {\n        keyframes: [\n          {value: [filter.value[0], filter.value[0] + 1]},\n          {value: [filter.value[0], filter.domain[1]]}\n        ],\n        easings: linear\n      };\n    }\n    case 'point': {\n      return {\n        keyframes: [{value: filter.domain[0]}, {value: filter.domain[1]}],\n        easings: linear\n      };\n    }\n    case 'interval': {\n      const {bins, plotType} = filter;\n      const {interval} = plotType;\n      if (\n        !interval ||\n        !bins ||\n        Object.keys(bins).length === 0 ||\n        !Object.values(bins)[0][interval]\n      ) {\n        // shouldn't happen return\n        return getKeyFramesFree(filter);\n      }\n      const intervalBins = Object.values(bins)[0][interval];\n      const delta = Math.round(duration / intervalBins.length);\n\n      // const delta = Math.round(duration / filter.steps.length);\n      return {\n        timings: intervalBins.map((_, idx) => timings[0] + delta * idx),\n        keyframes: intervalBins.map(bin => {\n          return {\n            value: [bin.x0, bin.x1]\n          };\n        }),\n        easings: hold\n      };\n    }\n  }\n}\n\nclass KeplerFilterKeyframes extends Keyframes {\n  id;\n  type;\n  filterIdx;\n  getTimeRangeFilterKeyframes;\n\n  constructor({\n    filter,\n    filterIdx,\n    timings,\n    keyframes,\n    easings,\n    interpolators,\n    getTimeRangeFilterKeyframes = undefined\n  }) {\n    if (filter.type === 'input') {\n      throw new Error(\"filter type 'input' is not supported.\");\n    }\n    super(\n      KeplerFilterKeyframes._processParams({\n        filter,\n        timings,\n        keyframes,\n        easings,\n        interpolators,\n        getTimeRangeFilterKeyframes\n      })\n    );\n    this.id = filter.id;\n    this.type = filter.type;\n    this.animationWindow = filter.animationWindow;\n    this.filterIdx = filterIdx;\n    this.getTimeRangeFilterKeyframes = getTimeRangeFilterKeyframes;\n  }\n\n  set({filter = undefined, filterIdx = undefined, timings, keyframes, easings, interpolators}) {\n    if (filter && filterIdx) {\n      this.id = filter.id;\n      this.type = filter.type;\n      this.animationWindow = filter.animationWindow;\n      this.filterIdx = filterIdx;\n    }\n    super.set(\n      KeplerFilterKeyframes._processParams({\n        filter,\n        timings,\n        keyframes,\n        easings,\n        interpolators,\n        getTimeRangeFilterKeyframes: this.getTimeRangeFilterKeyframes\n      })\n    );\n  }\n\n  getFrame() {\n    const factor = this.factor;\n    const start = this.getStartData();\n    const end = this.getEndData();\n\n    if (['select', 'multiSelect', 'polygon'].includes(this.type)) {\n      return start.value;\n    }\n\n    if (this.type === 'range') {\n      return [\n        factorInterpolator(start.value[0], end.value[0], end.ease)(factor),\n        factorInterpolator(start.value[1], end.value[1], end.ease)(factor)\n      ];\n    }\n\n    if (this.type === 'timeRange') {\n      switch (this.animationWindow) {\n        case 'free':\n        case 'incremental': {\n          return [\n            factorInterpolator(start.value[0], end.value[0], end.ease)(factor),\n            factorInterpolator(start.value[1], end.value[1], end.ease)(factor)\n          ];\n        }\n        case 'point': {\n          return factorInterpolator(start.value, end.value, end.ease)(factor);\n        }\n        case 'interval':\n        default: {\n          return start.value;\n        }\n      }\n    }\n\n    return super.getFrame();\n  }\n\n  static _processParams({\n    filter = undefined,\n    timings,\n    keyframes,\n    easings,\n    interpolators,\n    getTimeRangeFilterKeyframes = undefined\n  }) {\n    let params = {features: ['value'], timings, keyframes, easings, interpolators};\n    if (filter && filter.type === 'timeRange' && keyframes === undefined) {\n      if (timings.length !== 2) throw new Error('[start, end] timings required.');\n      params = {\n        ...params,\n        ...(getTimeRangeFilterKeyframes\n          ? getTimeRangeFilterKeyframes({filter, timings})\n          : timeRangeKeyframes({filter, timings}))\n      };\n    }\n    return params;\n  }\n}\n\nexport default KeplerFilterKeyframes;\n"],"mappings":"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"}