"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _react = _interopRequireWildcard(require("react"));

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _classnames3 = _interopRequireDefault(require("classnames"));

var _utilities = require("@dnd-kit/utilities");

var _sortable = require("@dnd-kit/sortable");

var _constants = require("@kepler.gl/constants");

var _utils = require("@kepler.gl/utils");

var _effectPanel = _interopRequireDefault(require("./effect-panel"));

var _templateObject, _templateObject2;

var Container = _styledComponents["default"].div(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2["default"])(["\n  display: flex;\n  flex-direction: column;\n"])));

var SortableStyledItem = _styledComponents["default"].div(_templateObject2 || (_templateObject2 = (0, _taggedTemplateLiteral2["default"])(["\n  z-index: ", ";\n  transition: ", ";\n  transform: ", ";\n  outline: none;\n  &.sorting {\n    opacity: 0.3;\n    pointer-events: none;\n  }\n  &.sorting-effects .effect-panel__header {\n    background-color: ", ";\n    font-family: ", ";\n    font-weight: ", ";\n    font-size: ", ";\n    line-height: ", ";\n    *,\n    *:before,\n    *:after {\n      box-sizing: border-box;\n    }\n    .effect__drag-handle {\n      opacity: 1;\n      color: ", ";\n    }\n  }\n"])), function (props) {
  return props.theme.dropdownWrapperZ + 1;
}, function (props) {
  return props.transition;
}, function (props) {
  return props.transform;
}, function (props) {
  return props.theme.panelBackgroundHover;
}, function (props) {
  return props.theme.fontFamily;
}, function (props) {
  return props.theme.fontWeight;
}, function (props) {
  return props.theme.fontSize;
}, function (props) {
  return props.theme.lineHeight;
}, function (props) {
  return props.theme.textColorHl;
});

EffectListFactory.deps = [_effectPanel["default"]];

function EffectListFactory(EffectPanel) {
  var SortableItem = function SortableItem(_ref) {
    var effect = _ref.effect,
        idx = _ref.idx,
        panelProps = _ref.panelProps,
        disabled = _ref.disabled;

    var _useSortable = (0, _sortable.useSortable)({
      id: effect.id,
      data: {
        type: _constants.SORTABLE_EFFECT_TYPE,
        parent: _constants.SORTABLE_EFFECT_PANEL_TYPE
      },
      disabled: disabled
    }),
        attributes = _useSortable.attributes,
        listeners = _useSortable.listeners,
        setNodeRef = _useSortable.setNodeRef,
        isDragging = _useSortable.isDragging,
        transform = _useSortable.transform,
        transition = _useSortable.transition;

    return /*#__PURE__*/_react["default"].createElement(SortableStyledItem, (0, _extends2["default"])({
      ref: setNodeRef,
      className: (0, _classnames3["default"])((0, _defineProperty2["default"])({}, _constants.dataTestIds.sortableEffectItem, !disabled), (0, _defineProperty2["default"])({}, _constants.dataTestIds.staticEffectItem, disabled), {
        sorting: isDragging
      }),
      "data-testid": disabled ? _constants.dataTestIds.staticEffectItem : _constants.dataTestIds.sortableEffectItem,
      transform: _utilities.CSS.Transform.toString(transform),
      transition: transition || ''
    }, attributes), /*#__PURE__*/_react["default"].createElement(EffectPanel, (0, _extends2["default"])({}, panelProps, {
      key: effect.id,
      idx: idx,
      effect: effect,
      listeners: listeners,
      isDraggable: !disabled
    })));
  };

  var EffectList = function EffectList(props) {
    var effects = props.effects,
        effectOrder = props.effectOrder,
        visStateActions = props.visStateActions;
    var effectsToShow = (0, _react.useMemo)(function () {
      return effectOrder.reduce(function (acc, effectId) {
        var effect = (0, _utils.findById)(effectId)(effects.filter(Boolean));

        if (!effect) {
          return acc;
        }

        return [].concat((0, _toConsumableArray2["default"])(acc), [effect]);
      }, []);
    }, [effects, effectOrder]);
    var sidePanelDndItems = (0, _react.useMemo)(function () {
      return effectsToShow.map(function (_ref2) {
        var id = _ref2.id;
        return id;
      });
    }, [effectsToShow]);
    var panelProps = (0, _react.useMemo)(function () {
      return {
        effects: effects,
        effectOrder: effectOrder,
        removeEffect: visStateActions.removeEffect,
        updateEffect: visStateActions.updateEffect
      };
    }, [effects, effectOrder, visStateActions]);
    return /*#__PURE__*/_react["default"].createElement(Container, null, /*#__PURE__*/_react["default"].createElement(_sortable.SortableContext, {
      id: _constants.SORTABLE_EFFECT_PANEL_TYPE,
      items: sidePanelDndItems,
      strategy: _sortable.verticalListSortingStrategy,
      disabled: false
    }, effectsToShow.map(function (effect) {
      return /*#__PURE__*/_react["default"].createElement(SortableItem, {
        key: effect.id,
        effect: effect,
        idx: effects.findIndex(function (l) {
          return (l === null || l === void 0 ? void 0 : l.id) === effect.id;
        }),
        panelProps: panelProps,
        disabled: false
      });
    })));
  };

  return EffectList;
}

var _default = EffectListFactory;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lZmZlY3RzL2VmZmVjdC1saXN0LnRzeCJdLCJuYW1lcyI6WyJDb250YWluZXIiLCJzdHlsZWQiLCJkaXYiLCJTb3J0YWJsZVN0eWxlZEl0ZW0iLCJwcm9wcyIsInRoZW1lIiwiZHJvcGRvd25XcmFwcGVyWiIsInRyYW5zaXRpb24iLCJ0cmFuc2Zvcm0iLCJwYW5lbEJhY2tncm91bmRIb3ZlciIsImZvbnRGYW1pbHkiLCJmb250V2VpZ2h0IiwiZm9udFNpemUiLCJsaW5lSGVpZ2h0IiwidGV4dENvbG9ySGwiLCJFZmZlY3RMaXN0RmFjdG9yeSIsImRlcHMiLCJFZmZlY3RQYW5lbEZhY3RvcnkiLCJFZmZlY3RQYW5lbCIsIlNvcnRhYmxlSXRlbSIsImVmZmVjdCIsImlkeCIsInBhbmVsUHJvcHMiLCJkaXNhYmxlZCIsImlkIiwiZGF0YSIsInR5cGUiLCJTT1JUQUJMRV9FRkZFQ1RfVFlQRSIsInBhcmVudCIsIlNPUlRBQkxFX0VGRkVDVF9QQU5FTF9UWVBFIiwiYXR0cmlidXRlcyIsImxpc3RlbmVycyIsInNldE5vZGVSZWYiLCJpc0RyYWdnaW5nIiwiZGF0YVRlc3RJZHMiLCJzb3J0YWJsZUVmZmVjdEl0ZW0iLCJzdGF0aWNFZmZlY3RJdGVtIiwic29ydGluZyIsIkNTUyIsIlRyYW5zZm9ybSIsInRvU3RyaW5nIiwiRWZmZWN0TGlzdCIsImVmZmVjdHMiLCJlZmZlY3RPcmRlciIsInZpc1N0YXRlQWN0aW9ucyIsImVmZmVjdHNUb1Nob3ciLCJyZWR1Y2UiLCJhY2MiLCJlZmZlY3RJZCIsImZpbHRlciIsIkJvb2xlYW4iLCJzaWRlUGFuZWxEbmRJdGVtcyIsIm1hcCIsInJlbW92ZUVmZmVjdCIsInVwZGF0ZUVmZmVjdCIsInZlcnRpY2FsTGlzdFNvcnRpbmdTdHJhdGVneSIsImZpbmRJbmRleCIsImwiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFJ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QixPQUFQO0FBQUEsS0FEaUIsRUFPakIsQ0FBQ1osT0FBRCxFQUFVQyxXQUFWLEVBQXVCQyxlQUF2QixDQVBpQixDQUFuQjtBQVVBLHdCQUNFLGdDQUFDLFNBQUQscUJBQ0UsZ0NBQUMseUJBQUQ7QUFDRSxNQUFBLEVBQUUsRUFBRWYscUNBRE47QUFFRSxNQUFBLEtBQUssRUFBRXNCLGlCQUZUO0FBR0UsTUFBQSxRQUFRLEVBQUVJLHFDQUhaO0FBSUUsTUFBQSxRQUFRLEVBQUU7QUFKWixPQU1HVixhQUFhLENBQUNPLEdBQWQsQ0FBa0IsVUFBQWhDLE1BQU07QUFBQSwwQkFDdkIsZ0NBQUMsWUFBRDtBQUNFLFFBQUEsR0FBRyxFQUFFQSxNQUFNLENBQUNJLEVBRGQ7QUFFRSxRQUFBLE1BQU0sRUFBRUosTUFGVjtBQUdFLFFBQUEsR0FBRyxFQUFFc0IsT0FBTyxDQUFDYyxTQUFSLENBQWtCLFVBQUFDLENBQUM7QUFBQSxpQkFBSSxDQUFBQSxDQUFDLFNBQUQsSUFBQUEsQ0FBQyxXQUFELFlBQUFBLENBQUMsQ0FBRWpDLEVBQUgsTUFBVUosTUFBTSxDQUFDSSxFQUFyQjtBQUFBLFNBQW5CLENBSFA7QUFJRSxRQUFBLFVBQVUsRUFBRUYsVUFKZDtBQUtFLFFBQUEsUUFBUSxFQUFFO0FBTFosUUFEdUI7QUFBQSxLQUF4QixDQU5ILENBREYsQ0FERjtBQW9CRCxHQS9DRDs7QUFnREEsU0FBT21CLFVBQVA7QUFDRDs7ZUFFYzFCLGlCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVFxuLy8gQ29weXJpZ2h0IGNvbnRyaWJ1dG9ycyB0byB0aGUga2VwbGVyLmdsIHByb2plY3RcblxuaW1wb3J0IFJlYWN0LCB7dXNlTWVtb30gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHN0eWxlZCBmcm9tICdzdHlsZWQtY29tcG9uZW50cyc7XG5pbXBvcnQgY2xhc3NuYW1lcyBmcm9tICdjbGFzc25hbWVzJztcbmltcG9ydCB7Q1NTfSBmcm9tICdAZG5kLWtpdC91dGlsaXRpZXMnO1xuaW1wb3J0IHt1c2VTb3J0YWJsZSwgU29ydGFibGVDb250ZXh0LCB2ZXJ0aWNhbExpc3RTb3J0aW5nU3RyYXRlZ3l9IGZyb20gJ0BkbmQta2l0L3NvcnRhYmxlJztcblxuaW1wb3J0IHtkYXRhVGVzdElkcywgU09SVEFCTEVfRUZGRUNUX1RZUEUsIFNPUlRBQkxFX0VGRkVDVF9QQU5FTF9UWVBFfSBmcm9tICdAa2VwbGVyLmdsL2NvbnN0YW50cyc7XG5pbXBvcnQge2ZpbmRCeUlkfSBmcm9tICdAa2VwbGVyLmdsL3V0aWxzJztcbmltcG9ydCB7VmlzU3RhdGVBY3Rpb25zfSBmcm9tICdAa2VwbGVyLmdsL2FjdGlvbnMnO1xuaW1wb3J0IHtFZmZlY3R9IGZyb20gJ0BrZXBsZXIuZ2wvdHlwZXMnO1xuXG5pbXBvcnQgRWZmZWN0UGFuZWxGYWN0b3J5IGZyb20gJy4vZWZmZWN0LXBhbmVsJztcblxuZXhwb3J0IHR5cGUgRWZmZWN0TGlzdFByb3BzID0ge1xuICBlZmZlY3RzOiBFZmZlY3RbXTtcbiAgZWZmZWN0T3JkZXI6IHN0cmluZ1tdO1xuICB2aXNTdGF0ZUFjdGlvbnM6IHR5cGVvZiBWaXNTdGF0ZUFjdGlvbnM7XG4gIGlzU29ydGFibGU6IGJvb2xlYW47XG59O1xuXG5jb25zdCBDb250YWluZXIgPSBzdHlsZWQuZGl2YFxuICBkaXNwbGF5OiBmbGV4O1xuICBmbGV4LWRpcmVjdGlvbjogY29sdW1uO1xuYDtcblxudHlwZSBTb3J0YWJsZVN0eWxlZEl0ZW1Qcm9wcyA9IHt0cmFuc2l0aW9uPzogc3RyaW5nOyB0cmFuc2Zvcm0/OiBzdHJpbmd9O1xuY29uc3QgU29ydGFibGVTdHlsZWRJdGVtID0gc3R5bGVkLmRpdjxTb3J0YWJsZVN0eWxlZEl0ZW1Qcm9wcz5gXG4gIHotaW5kZXg6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUuZHJvcGRvd25XcmFwcGVyWiArIDF9O1xuICB0cmFuc2l0aW9uOiAke3Byb3BzID0+IHByb3BzLnRyYW5zaXRpb259O1xuICB0cmFuc2Zvcm06ICR7cHJvcHMgPT4gcHJvcHMudHJhbnNmb3JtfTtcbiAgb3V0bGluZTogbm9uZTtcbiAgJi5zb3J0aW5nIHtcbiAgICBvcGFjaXR5OiAwLjM7XG4gICAgcG9pbnRlci1ldmVudHM6IG5vbmU7XG4gIH1cbiAgJi5zb3J0aW5nLWVmZmVjdHMgLmVmZmVjdC1wYW5lbF9faGVhZGVyIHtcbiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAke3Byb3BzID0+IHByb3BzLnRoZW1lLnBhbmVsQmFja2dyb3VuZEhvdmVyfTtcbiAgICBmb250LWZhbWlseTogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS5mb250RmFtaWx5fTtcbiAgICBmb250LXdlaWdodDogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS5mb250V2VpZ2h0fTtcbiAgICBmb250LXNpemU6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUuZm9udFNpemV9O1xuICAgIGxpbmUtaGVpZ2h0OiAke3Byb3BzID0+IHByb3BzLnRoZW1lLmxpbmVIZWlnaHR9O1xuICAgICosXG4gICAgKjpiZWZvcmUsXG4gICAgKjphZnRlciB7XG4gICAgICBib3gtc2l6aW5nOiBib3JkZXItYm94O1xuICAgIH1cbiAgICAuZWZmZWN0X19kcmFnLWhhbmRsZSB7XG4gICAgICBvcGFjaXR5OiAxO1xuICAgICAgY29sb3I6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUudGV4dENvbG9ySGx9O1xuICAgIH1cbiAgfVxuYDtcblxuRWZmZWN0TGlzdEZhY3RvcnkuZGVwcyA9IFtFZmZlY3RQYW5lbEZhY3RvcnldO1xuXG5mdW5jdGlvbiBFZmZlY3RMaXN0RmFjdG9yeShcbiAgRWZmZWN0UGFuZWw6IFJldHVyblR5cGU8dHlwZW9mIEVmZmVjdFBhbmVsRmFjdG9yeT5cbik6IFJlYWN0LkZDPEVmZmVjdExpc3RQcm9wcz4ge1xuICBjb25zdCBTb3J0YWJsZUl0ZW0gPSAoe2VmZmVjdCwgaWR4LCBwYW5lbFByb3BzLCBkaXNhYmxlZH0pID0+IHtcbiAgICBjb25zdCB7YXR0cmlidXRlcywgbGlzdGVuZXJzLCBzZXROb2RlUmVmLCBpc0RyYWdnaW5nLCB0cmFuc2Zvcm0sIHRyYW5zaXRpb259ID0gdXNlU29ydGFibGUoe1xuICAgICAgaWQ6IGVmZmVjdC5pZCxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgdHlwZTogU09SVEFCTEVfRUZGRUNUX1RZUEUsXG4gICAgICAgIHBhcmVudDogU09SVEFCTEVfRUZGRUNUX1BBTkVMX1RZUEVcbiAgICAgIH0sXG4gICAgICBkaXNhYmxlZFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIDxTb3J0YWJsZVN0eWxlZEl0ZW1cbiAgICAgICAgcmVmPXtzZXROb2RlUmVmfVxuICAgICAgICBjbGFzc05hbWU9e2NsYXNzbmFtZXMoXG4gICAgICAgICAge1tkYXRhVGVzdElkcy5zb3J0YWJsZUVmZmVjdEl0ZW1dOiAhZGlzYWJsZWR9LFxuICAgICAgICAgIHtbZGF0YVRlc3RJZHMuc3RhdGljRWZmZWN0SXRlbV06IGRpc2FibGVkfSxcbiAgICAgICAgICB7c29ydGluZzogaXNEcmFnZ2luZ31cbiAgICAgICAgKX1cbiAgICAgICAgZGF0YS10ZXN0aWQ9e2Rpc2FibGVkID8gZGF0YVRlc3RJZHMuc3RhdGljRWZmZWN0SXRlbSA6IGRhdGFUZXN0SWRzLnNvcnRhYmxlRWZmZWN0SXRlbX1cbiAgICAgICAgdHJhbnNmb3JtPXtDU1MuVHJhbnNmb3JtLnRvU3RyaW5nKHRyYW5zZm9ybSl9XG4gICAgICAgIHRyYW5zaXRpb249e3RyYW5zaXRpb24gfHwgJyd9XG4gICAgICAgIHsuLi5hdHRyaWJ1dGVzfVxuICAgICAgPlxuICAgICAgICA8RWZmZWN0UGFuZWxcbiAgICAgICAgICB7Li4ucGFuZWxQcm9wc31cbiAgICAgICAgICBrZXk9e2VmZmVjdC5pZH1cbiAgICAgICAgICBpZHg9e2lkeH1cbiAgICAgICAgICBlZmZlY3Q9e2VmZmVjdH1cbiAgICAgICAgICBsaXN0ZW5lcnM9e2xpc3RlbmVyc31cbiAgICAgICAgICBpc0RyYWdnYWJsZT17IWRpc2FibGVkfVxuICAgICAgICAvPlxuICAgICAgPC9Tb3J0YWJsZVN0eWxlZEl0ZW0+XG4gICAgKTtcbiAgfTtcblxuICBjb25zdCBFZmZlY3RMaXN0ID0gKHByb3BzOiBFZmZlY3RMaXN0UHJvcHMpID0+IHtcbiAgICBjb25zdCB7ZWZmZWN0cywgZWZmZWN0T3JkZXIsIHZpc1N0YXRlQWN0aW9uc30gPSBwcm9wcztcblxuICAgIGNvbnN0IGVmZmVjdHNUb1Nob3cgPSB1c2VNZW1vKCgpID0+IHtcbiAgICAgIHJldHVybiBlZmZlY3RPcmRlci5yZWR1Y2UoKGFjYywgZWZmZWN0SWQpID0+IHtcbiAgICAgICAgY29uc3QgZWZmZWN0ID0gZmluZEJ5SWQoZWZmZWN0SWQpKGVmZmVjdHMuZmlsdGVyKEJvb2xlYW4pKTtcbiAgICAgICAgaWYgKCFlZmZlY3QpIHtcbiAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBbLi4uYWNjLCBlZmZlY3RdO1xuICAgICAgfSwgW10gYXMgRWZmZWN0W10pO1xuICAgIH0sIFtlZmZlY3RzLCBlZmZlY3RPcmRlcl0pO1xuXG4gICAgY29uc3Qgc2lkZVBhbmVsRG5kSXRlbXMgPSB1c2VNZW1vKCgpID0+IHtcbiAgICAgIHJldHVybiBlZmZlY3RzVG9TaG93Lm1hcCgoe2lkfSkgPT4gaWQpO1xuICAgIH0sIFtlZmZlY3RzVG9TaG93XSk7XG5cbiAgICBjb25zdCBwYW5lbFByb3BzID0gdXNlTWVtbyhcbiAgICAgICgpID0+ICh7XG4gICAgICAgIGVmZmVjdHMsXG4gICAgICAgIGVmZmVjdE9yZGVyLFxuICAgICAgICByZW1vdmVFZmZlY3Q6IHZpc1N0YXRlQWN0aW9ucy5yZW1vdmVFZmZlY3QsXG4gICAgICAgIHVwZGF0ZUVmZmVjdDogdmlzU3RhdGVBY3Rpb25zLnVwZGF0ZUVmZmVjdFxuICAgICAgfSksXG4gICAgICBbZWZmZWN0cywgZWZmZWN0T3JkZXIsIHZpc1N0YXRlQWN0aW9uc11cbiAgICApO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIDxDb250YWluZXI+XG4gICAgICAgIDxTb3J0YWJsZUNvbnRleHRcbiAgICAgICAgICBpZD17U09SVEFCTEVfRUZGRUNUX1BBTkVMX1RZUEV9XG4gICAgICAgICAgaXRlbXM9e3NpZGVQYW5lbERuZEl0ZW1zfVxuICAgICAgICAgIHN0cmF0ZWd5PXt2ZXJ0aWNhbExpc3RTb3J0aW5nU3RyYXRlZ3l9XG4gICAgICAgICAgZGlzYWJsZWQ9e2ZhbHNlfVxuICAgICAgICA+XG4gICAgICAgICAge2VmZmVjdHNUb1Nob3cubWFwKGVmZmVjdCA9PiAoXG4gICAgICAgICAgICA8U29ydGFibGVJdGVtXG4gICAgICAgICAgICAgIGtleT17ZWZmZWN0LmlkfVxuICAgICAgICAgICAgICBlZmZlY3Q9e2VmZmVjdH1cbiAgICAgICAgICAgICAgaWR4PXtlZmZlY3RzLmZpbmRJbmRleChsID0+IGw/LmlkID09PSBlZmZlY3QuaWQpfVxuICAgICAgICAgICAgICBwYW5lbFByb3BzPXtwYW5lbFByb3BzfVxuICAgICAgICAgICAgICBkaXNhYmxlZD17ZmFsc2V9XG4gICAgICAgICAgICAvPlxuICAgICAgICAgICkpfVxuICAgICAgICA8L1NvcnRhYmxlQ29udGV4dD5cbiAgICAgIDwvQ29udGFpbmVyPlxuICAgICk7XG4gIH07XG4gIHJldHVybiBFZmZlY3RMaXN0O1xufVxuXG5leHBvcnQgZGVmYXVsdCBFZmZlY3RMaXN0RmFjdG9yeTtcbiJdfQ==