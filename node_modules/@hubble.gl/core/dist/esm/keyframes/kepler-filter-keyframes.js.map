{"version":3,"file":"kepler-filter-keyframes.js","names":["factorInterpolator","Keyframes","hold","linear","getKeyFramesFree","filter","delta","value","keyframes","domain","easings","timeRangeKeyframes","timings","type","Error","duration","animationWindow","bins","plotType","interval","Object","keys","length","values","intervalBins","Math","round","map","_","idx","bin","x0","x1","KeplerFilterKeyframes","constructor","filterIdx","interpolators","getTimeRangeFilterKeyframes","undefined","_processParams","id","set","getFrame","factor","start","getStartData","end","getEndData","includes","ease","params","features"],"sources":["../../../src/keyframes/kepler-filter-keyframes.js"],"sourcesContent":["// Copyright (c) 2021 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport {factorInterpolator} from './utils';\nimport Keyframes from './keyframes';\nimport {hold, linear} from './easings';\n\n/**\n * 4 Animation Window Types\n * 1. free\n *  |->  |->\n * Current time is a fixed range, animation controller calls next animation frames continuously to animation a moving window\n * The increment id based on domain / BASE_SPEED * SPEED\n *\n * 2. incremental\n * |    |->\n * Same as free, current time is a growing range, only the max value of range increment during animation.\n * The increment is also based on domain / BASE_SPEED * SPEED\n *\n * 3. point\n * o -> o\n * Current time is a point, animation controller calls next animation frame continuously to animation a moving point\n * The increment is based on domain / BASE_SPEED * SPEED\n *\n * 4. interval\n * o ~> o\n * Current time is a point. An array of sorted time steps need to be provided.\n * animation controller calls next animation at a interval when the point jumps to the next step\n */\nfunction getKeyFramesFree(filter) {\n  const delta = filter.value[1] - filter.value[0];\n  return {\n    keyframes: [\n      {value: [filter.domain[0], filter.domain[0] + delta]},\n      {value: [filter.domain[1] - delta, filter.domain[1]]}\n    ],\n    easings: linear\n  };\n}\n\nexport function timeRangeKeyframes({filter, timings}) {\n  if (filter.type !== 'timeRange') {\n    throw new Error(\"filter type must be 'timeRange'.'\");\n  }\n\n  const duration = timings[1] - timings[0];\n\n  switch (filter.animationWindow) {\n    default:\n    case 'free': {\n      return getKeyFramesFree(filter);\n    }\n    case 'incremental': {\n      return {\n        keyframes: [\n          {value: [filter.value[0], filter.value[0] + 1]},\n          {value: [filter.value[0], filter.domain[1]]}\n        ],\n        easings: linear\n      };\n    }\n    case 'point': {\n      return {\n        keyframes: [{value: filter.domain[0]}, {value: filter.domain[1]}],\n        easings: linear\n      };\n    }\n    case 'interval': {\n      const {bins, plotType} = filter;\n      const {interval} = plotType;\n      if (\n        !interval ||\n        !bins ||\n        Object.keys(bins).length === 0 ||\n        !Object.values(bins)[0][interval]\n      ) {\n        // shouldn't happen return\n        return getKeyFramesFree(filter);\n      }\n      const intervalBins = Object.values(bins)[0][interval];\n      const delta = Math.round(duration / intervalBins.length);\n\n      // const delta = Math.round(duration / filter.steps.length);\n      return {\n        timings: intervalBins.map((_, idx) => timings[0] + delta * idx),\n        keyframes: intervalBins.map(bin => {\n          return {\n            value: [bin.x0, bin.x1]\n          };\n        }),\n        easings: hold\n      };\n    }\n  }\n}\n\nclass KeplerFilterKeyframes extends Keyframes {\n  id;\n  type;\n  filterIdx;\n  getTimeRangeFilterKeyframes;\n\n  constructor({\n    filter,\n    filterIdx,\n    timings,\n    keyframes,\n    easings,\n    interpolators,\n    getTimeRangeFilterKeyframes = undefined\n  }) {\n    if (filter.type === 'input') {\n      throw new Error(\"filter type 'input' is not supported.\");\n    }\n    super(\n      KeplerFilterKeyframes._processParams({\n        filter,\n        timings,\n        keyframes,\n        easings,\n        interpolators,\n        getTimeRangeFilterKeyframes\n      })\n    );\n    this.id = filter.id;\n    this.type = filter.type;\n    this.animationWindow = filter.animationWindow;\n    this.filterIdx = filterIdx;\n    this.getTimeRangeFilterKeyframes = getTimeRangeFilterKeyframes;\n  }\n\n  set({filter = undefined, filterIdx = undefined, timings, keyframes, easings, interpolators}) {\n    if (filter && filterIdx) {\n      this.id = filter.id;\n      this.type = filter.type;\n      this.animationWindow = filter.animationWindow;\n      this.filterIdx = filterIdx;\n    }\n    super.set(\n      KeplerFilterKeyframes._processParams({\n        filter,\n        timings,\n        keyframes,\n        easings,\n        interpolators,\n        getTimeRangeFilterKeyframes: this.getTimeRangeFilterKeyframes\n      })\n    );\n  }\n\n  getFrame() {\n    const factor = this.factor;\n    const start = this.getStartData();\n    const end = this.getEndData();\n\n    if (['select', 'multiSelect', 'polygon'].includes(this.type)) {\n      return start.value;\n    }\n\n    if (this.type === 'range') {\n      return [\n        factorInterpolator(start.value[0], end.value[0], end.ease)(factor),\n        factorInterpolator(start.value[1], end.value[1], end.ease)(factor)\n      ];\n    }\n\n    if (this.type === 'timeRange') {\n      switch (this.animationWindow) {\n        case 'free':\n        case 'incremental': {\n          return [\n            factorInterpolator(start.value[0], end.value[0], end.ease)(factor),\n            factorInterpolator(start.value[1], end.value[1], end.ease)(factor)\n          ];\n        }\n        case 'point': {\n          return factorInterpolator(start.value, end.value, end.ease)(factor);\n        }\n        case 'interval':\n        default: {\n          return start.value;\n        }\n      }\n    }\n\n    return super.getFrame();\n  }\n\n  static _processParams({\n    filter = undefined,\n    timings,\n    keyframes,\n    easings,\n    interpolators,\n    getTimeRangeFilterKeyframes = undefined\n  }) {\n    let params = {features: ['value'], timings, keyframes, easings, interpolators};\n    if (filter && filter.type === 'timeRange' && keyframes === undefined) {\n      if (timings.length !== 2) throw new Error('[start, end] timings required.');\n      params = {\n        ...params,\n        ...(getTimeRangeFilterKeyframes\n          ? getTimeRangeFilterKeyframes({filter, timings})\n          : timeRangeKeyframes({filter, timings}))\n      };\n    }\n    return params;\n  }\n}\n\nexport default KeplerFilterKeyframes;\n"],"mappings":"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"}