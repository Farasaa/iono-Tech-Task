"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = VisConfigSliderFactory;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _react = _interopRequireWildcard(require("react"));

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _styledComponents2 = require("../../common/styled-components");

var _rangeSlider = _interopRequireDefault(require("../../common/range-slider"));

var _localization = require("@kepler.gl/localization");

var _constants = require("@kepler.gl/constants");

var _ = require("../..");

var _utils = require("@kepler.gl/utils");

var _templateObject, _templateObject2, _templateObject3, _templateObject4;

var InputWrapper = _styledComponents["default"].div(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2["default"])(["\n  display: flex;\n  line-height: 12px;\n  margin-bottom: 12px;\n"])));

var CustomInputWrapper = _styledComponents["default"].div(_templateObject2 || (_templateObject2 = (0, _taggedTemplateLiteral2["default"])(["\n  display: flex;\n"])));

var CustomInputLabel = _styledComponents["default"].label(_templateObject3 || (_templateObject3 = (0, _taggedTemplateLiteral2["default"])(["\n  color: ", ";\n  font-weight: 500;\n  letter-spacing: 0.2px;\n  font-size: ", ";\n  padding-right: 15px;\n\n  &:last-child {\n    position: absolute;\n    right: 0;\n    padding: 0;\n  }\n"])), function (props) {
  return props.theme.textColor;
}, function (props) {
  return props.theme.layerConfigGroupLabelLabelFontSize;
});

var RangeInput = _styledComponents["default"].input(_templateObject4 || (_templateObject4 = (0, _taggedTemplateLiteral2["default"])(["\n  ", ";\n  font-size: ", ";\n  width: 44px;\n  overflow: auto;\n  height: 20px;\n  margin-top: 5px;\n"])), function (props) {
  return props.theme.input;
}, function (props) {
  return props.theme.sliderInputFontSize;
});

var LazyInput = function LazyInput(_ref) {
  var value = _ref.value,
      onChange = _ref.onChange,
      name = _ref.name;

  var _useState = (0, _react.useState)(value),
      _useState2 = (0, _slicedToArray2["default"])(_useState, 2),
      stateValue = _useState2[0],
      setValue = _useState2[1];

  var inputRef = (0, _react.useRef)(null);
  (0, _react.useEffect)(function () {
    setValue(value);
  }, [value]);
  var onKeyDown = (0, _react.useCallback)(function (e) {
    switch (e.keyCode) {
      case _constants.KeyEvent.DOM_VK_ENTER:
      case _constants.KeyEvent.DOM_VK_RETURN:
        onChange(stateValue);

        if (inputRef !== null) {
          // @ts-ignore
          inputRef === null || inputRef === void 0 ? void 0 : inputRef.current.blur();
        }

        break;

      default:
        break;
    }
  }, [onChange, stateValue]);

  var _onChange = (0, _react.useCallback)(function (e) {
    return setValue(e.target.value);
  }, [setValue]);

  var onBlur = (0, _react.useCallback)(function () {
    return onChange(name, stateValue);
  }, [onChange, name, stateValue]);
  return /*#__PURE__*/_react["default"].createElement(RangeInput, {
    type: "number",
    ref: inputRef,
    value: stateValue,
    onChange: _onChange,
    onBlur: onBlur,
    onKeyDown: onKeyDown,
    id: name
  });
};

var CustomInput = function CustomInput(_ref2) {
  var isRanged = _ref2.isRanged,
      value = _ref2.value,
      onChangeCustomInput = _ref2.onChangeCustomInput;
  var onChangeInput = (0, _react.useCallback)(function (name, v) {
    if (isRanged) onChangeCustomInput(name === 'value0' ? [v, value[1]] : [value[0], v]);else onChangeCustomInput(v);
  }, [isRanged, value, onChangeCustomInput]);
  return /*#__PURE__*/_react["default"].createElement(CustomInputWrapper, null, isRanged ? /*#__PURE__*/_react["default"].createElement(InputWrapper, null, /*#__PURE__*/_react["default"].createElement(CustomInputLabel, null, "min", /*#__PURE__*/_react["default"].createElement(LazyInput, {
    name: "value0",
    value: value[0],
    onChange: onChangeInput
  })), /*#__PURE__*/_react["default"].createElement(CustomInputLabel, null, "max", /*#__PURE__*/_react["default"].createElement(LazyInput, {
    name: "value1",
    value: value[1],
    onChange: onChangeInput
  }))) : /*#__PURE__*/_react["default"].createElement(InputWrapper, null, /*#__PURE__*/_react["default"].createElement(LazyInput, {
    name: "value",
    value: value,
    onChange: onChangeInput
  })));
};

VisConfigSliderFactory.deps = [_rangeSlider["default"]];

function VisConfigSliderFactory(RangeSlider) {
  var VisConfigSlider = function VisConfigSlider(_ref3) {
    var config = _ref3.layer.config,
        property = _ref3.property,
        label = _ref3.label,
        range = _ref3.range,
        step = _ref3.step,
        isRanged = _ref3.isRanged,
        allowCustomValue = _ref3.allowCustomValue,
        disabled = _ref3.disabled,
        _onChange4 = _ref3.onChange,
        inputTheme = _ref3.inputTheme;
    var value = config.visConfig[property];

    var _useState3 = (0, _react.useState)(false || !(0, _utils.isInRange)(value, range)),
        _useState4 = (0, _slicedToArray2["default"])(_useState3, 2),
        custom = _useState4[0],
        setCustom = _useState4[1];

    var onChangeCheckbox = (0, _react.useCallback)(function () {
      if (custom) {
        // we are swithcing from custom to not custom
        // adjust value to range
        var adjustedValue = isRanged ? [(0, _utils.clamp)(range, value[0]), (0, _utils.clamp)(range, value[1])] : (0, _utils.clamp)(range, value);

        _onChange4((0, _defineProperty2["default"])({}, property, adjustedValue));
      }

      setCustom(!custom);
    }, [_onChange4, property, isRanged, value, range, custom, setCustom]);
    return /*#__PURE__*/_react["default"].createElement(_styledComponents2.SidePanelSection, {
      disabled: Boolean(disabled)
    }, label ? /*#__PURE__*/_react["default"].createElement(_styledComponents2.PanelLabel, null, typeof label === 'string' ? /*#__PURE__*/_react["default"].createElement(_localization.FormattedMessage, {
      id: label
    }) : typeof label === 'function' ? /*#__PURE__*/_react["default"].createElement(_localization.FormattedMessage, {
      id: label(config)
    }) : /*#__PURE__*/_react["default"].createElement(_localization.FormattedMessage, {
      id: "property.".concat(property)
    })) : null, allowCustomValue ? /*#__PURE__*/_react["default"].createElement(InputWrapper, null, /*#__PURE__*/_react["default"].createElement(CustomInputLabel, null, "custom input"), /*#__PURE__*/_react["default"].createElement(_.Checkbox, {
      id: "property.".concat(property),
      checked: custom,
      onChange: onChangeCheckbox
    })) : null, !custom ? /*#__PURE__*/_react["default"].createElement(RangeSlider, {
      range: range,
      value0: isRanged ? value[0] : range[0],
      value1: isRanged ? value[1] : value,
      step: step,
      isRanged: Boolean(isRanged),
      onChange: function onChange(v) {
        return _onChange4((0, _defineProperty2["default"])({}, property, isRanged ? v : v[1]));
      },
      inputTheme: inputTheme,
      showInput: true
    }) : /*#__PURE__*/_react["default"].createElement(CustomInput, {
      isRanged: isRanged,
      value: value,
      onChangeCustomInput: function onChangeCustomInput(v) {
        return _onChange4((0, _defineProperty2["default"])({}, property, v));
      }
    }));
  };

  return VisConfigSlider;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zaWRlLXBhbmVsL2xheWVyLXBhbmVsL3Zpcy1jb25maWctc2xpZGVyLnRzeCJdLCJuYW1lcyI6WyJJbnB1dFdyYXBwZXIiLCJzdHlsZWQiLCJkaXYiLCJDdXN0b21JbnB1dFdyYXBwZXIiLCJDdXN0b21JbnB1dExhYmVsIiwibGFiZWwiLCJwcm9wcyIsInRoZW1lIiwidGV4dENvbG9yIiwibGF5ZXJDb25maWdHcm91cExhYmVsTGFiZWxGb250U2l6ZSIsIlJhbmdlSW5wdXQiLCJpbnB1dCIsInNsaWRlcklucHV0Rm9udFNpemUiLCJMYXp5SW5wdXQiLCJ2YWx1ZSIsIm9uQ2hhbmdlIiwibmFtZSIsInN0YXRlVmFsdWUiLCJzZXRWYWx1ZSIsImlucHV0UmVmIiwib25LZXlEb3duIiwiZSIsImtleUNvZGUiLCJLZXlFdmVudCIsIkRPTV9WS19FTlRFUiIsIkRPTV9WS19SRVRVUk4iLCJjdXJyZW50IiwiYmx1ciIsIl9vbkNoYW5nZSIsInRhcmdldCIsIm9uQmx1ciIsIkN1c3RvbUlucHV0IiwiaXNSYW5nZWQiLCJvbkNoYW5nZUN1c3RvbUlucHV0Iiwib25DaGFuZ2VJbnB1dCIsInYiLCJWaXNDb25maWdTbGlkZXJGYWN0b3J5IiwiZGVwcyIsIlJhbmdlU2xpZGVyRmFjdG9yeSIsIlJhbmdlU2xpZGVyIiwiVmlzQ29uZmlnU2xpZGVyIiwiY29uZmlnIiwibGF5ZXIiLCJwcm9wZXJ0eSIsInJhbmdlIiwic3RlcCIsImFsbG93Q3VzdG9tVmFsdWUiLCJkaXNhYmxlZCIsImlucHV0VGhlbWUiLCJ2aXNDb25maWciLCJjdXN0b20iLCJzZXRDdXN0b20iLCJvbkNoYW5nZUNoZWNrYm94IiwiYWRqdXN0ZWRWYWx1ZSIsIkJvb2xlYW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBR0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7Ozs7QUEyQkEsSUFBTUEsWUFBWSxHQUFHQyw2QkFBT0MsR0FBVix3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LE1BREQsZ0JBWUMsZ0NBQUMsV0FBRDtBQUNFLE1BQUEsUUFBUSxFQUFFaEIsUUFEWjtBQUVFLE1BQUEsS0FBSyxFQUFFbEIsS0FGVDtBQUdFLE1BQUEsbUJBQW1CLEVBQUUsNkJBQUFxQixDQUFDO0FBQUEsZUFBSXBCLFVBQVEsc0NBQUc0QixRQUFILEVBQWNSLENBQWQsRUFBWjtBQUFBO0FBSHhCLE1BaENKLENBREY7QUF5Q0QsR0FwRUQ7O0FBc0VBLFNBQU9LLGVBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIi8vIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVRcbi8vIENvcHlyaWdodCBjb250cmlidXRvcnMgdG8gdGhlIGtlcGxlci5nbCBwcm9qZWN0XG5cbmltcG9ydCBSZWFjdCwge3VzZVN0YXRlLCB1c2VDYWxsYmFjaywgdXNlRWZmZWN0LCB1c2VSZWZ9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBzdHlsZWQgZnJvbSAnc3R5bGVkLWNvbXBvbmVudHMnO1xuXG5pbXBvcnQge1BhbmVsTGFiZWwsIFNpZGVQYW5lbFNlY3Rpb259IGZyb20gJy4uLy4uL2NvbW1vbi9zdHlsZWQtY29tcG9uZW50cyc7XG5pbXBvcnQgUmFuZ2VTbGlkZXJGYWN0b3J5IGZyb20gJy4uLy4uL2NvbW1vbi9yYW5nZS1zbGlkZXInO1xuaW1wb3J0IHtGb3JtYXR0ZWRNZXNzYWdlfSBmcm9tICdAa2VwbGVyLmdsL2xvY2FsaXphdGlvbic7XG5pbXBvcnQge0tleUV2ZW50fSBmcm9tICdAa2VwbGVyLmdsL2NvbnN0YW50cyc7XG5pbXBvcnQge0NoZWNrYm94fSBmcm9tICcuLi8uLic7XG5pbXBvcnQge0xheWVyLCBMYXllckJhc2VDb25maWd9IGZyb20gJ0BrZXBsZXIuZ2wvbGF5ZXJzJztcbmltcG9ydCB7aXNJblJhbmdlLCBjbGFtcH0gZnJvbSAnQGtlcGxlci5nbC91dGlscyc7XG5cbnR5cGUgTGF6eUlucHV0UHJvcHMgPSB7XG4gIHZhbHVlOiBzdHJpbmcgfCBbc3RyaW5nLCBzdHJpbmddO1xuICBuYW1lOiBzdHJpbmc7XG4gIG9uQ2hhbmdlOiAobjogc3RyaW5nIHwgW3N0cmluZywgc3RyaW5nXSwgdj86IHN0cmluZyB8IFtzdHJpbmcsIHN0cmluZ10pID0+IHZvaWQ7XG59O1xuXG50eXBlIEN1c3RvbUlucHV0UHJvcHMgPSB7XG4gIHZhbHVlOiBzdHJpbmcgfCBbc3RyaW5nLCBzdHJpbmddO1xuICBpc1JhbmdlZDogYm9vbGVhbjtcbiAgb25DaGFuZ2VDdXN0b21JbnB1dDogKHY6IFtzdHJpbmcsIHN0cmluZ10pID0+IHZvaWQ7XG59O1xuXG50eXBlIFZpc0NvbmZpZ1NsaWRlclByb3BzID0ge1xuICBsYXllcjogTGF5ZXI7XG4gIHByb3BlcnR5OiBzdHJpbmc7XG4gIG9uQ2hhbmdlOiAodjogUmVjb3JkPHN0cmluZywgbnVtYmVyIHwgc3RyaW5nIHwgbnVtYmVyW10gfCBzdHJpbmdbXT4pID0+IHZvaWQ7XG4gIGxhYmVsPzogc3RyaW5nIHwgKChjOiBMYXllckJhc2VDb25maWcpID0+IHN0cmluZyk7XG4gIHJhbmdlOiBbbnVtYmVyLCBudW1iZXJdO1xuICBzdGVwPzogbnVtYmVyO1xuICBpc1JhbmdlZDogYm9vbGVhbjtcbiAgZGlzYWJsZWQ/OiBib29sZWFuO1xuICBpbnB1dFRoZW1lPzogc3RyaW5nO1xuICBhbGxvd0N1c3RvbVZhbHVlPzogYm9vbGVhbjtcbn07XG5cbmNvbnN0IElucHV0V3JhcHBlciA9IHN0eWxlZC5kaXZgXG4gIGRpc3BsYXk6IGZsZXg7XG4gIGxpbmUtaGVpZ2h0OiAxMnB4O1xuICBtYXJnaW4tYm90dG9tOiAxMnB4O1xuYDtcblxuY29uc3QgQ3VzdG9tSW5wdXRXcmFwcGVyID0gc3R5bGVkLmRpdmBcbiAgZGlzcGxheTogZmxleDtcbmA7XG5cbmNvbnN0IEN1c3RvbUlucHV0TGFiZWwgPSBzdHlsZWQubGFiZWxgXG4gIGNvbG9yOiAke3Byb3BzID0+IHByb3BzLnRoZW1lLnRleHRDb2xvcn07XG4gIGZvbnQtd2VpZ2h0OiA1MDA7XG4gIGxldHRlci1zcGFjaW5nOiAwLjJweDtcbiAgZm9udC1zaXplOiAke3Byb3BzID0+IHByb3BzLnRoZW1lLmxheWVyQ29uZmlnR3JvdXBMYWJlbExhYmVsRm9udFNpemV9O1xuICBwYWRkaW5nLXJpZ2h0OiAxNXB4O1xuXG4gICY6bGFzdC1jaGlsZCB7XG4gICAgcG9zaXRpb246IGFic29sdXRlO1xuICAgIHJpZ2h0OiAwO1xuICAgIHBhZGRpbmc6IDA7XG4gIH1cbmA7XG5cbmNvbnN0IFJhbmdlSW5wdXQgPSBzdHlsZWQuaW5wdXRgXG4gICR7cHJvcHMgPT4gcHJvcHMudGhlbWUuaW5wdXR9O1xuICBmb250LXNpemU6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUuc2xpZGVySW5wdXRGb250U2l6ZX07XG4gIHdpZHRoOiA0NHB4O1xuICBvdmVyZmxvdzogYXV0bztcbiAgaGVpZ2h0OiAyMHB4O1xuICBtYXJnaW4tdG9wOiA1cHg7XG5gO1xuXG5jb25zdCBMYXp5SW5wdXQ6IFJlYWN0LkZDPExhenlJbnB1dFByb3BzPiA9ICh7dmFsdWUsIG9uQ2hhbmdlLCBuYW1lfSkgPT4ge1xuICBjb25zdCBbc3RhdGVWYWx1ZSwgc2V0VmFsdWVdID0gdXNlU3RhdGUodmFsdWUpO1xuICBjb25zdCBpbnB1dFJlZiA9IHVzZVJlZihudWxsKTtcbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBzZXRWYWx1ZSh2YWx1ZSk7XG4gIH0sIFt2YWx1ZV0pO1xuXG4gIGNvbnN0IG9uS2V5RG93biA9IHVzZUNhbGxiYWNrKFxuICAgIGUgPT4ge1xuICAgICAgc3dpdGNoIChlLmtleUNvZGUpIHtcbiAgICAgICAgY2FzZSBLZXlFdmVudC5ET01fVktfRU5URVI6XG4gICAgICAgIGNhc2UgS2V5RXZlbnQuRE9NX1ZLX1JFVFVSTjpcbiAgICAgICAgICBvbkNoYW5nZShzdGF0ZVZhbHVlKTtcbiAgICAgICAgICBpZiAoaW5wdXRSZWYgIT09IG51bGwpIHtcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIGlucHV0UmVmPy5jdXJyZW50LmJsdXIoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfSxcbiAgICBbb25DaGFuZ2UsIHN0YXRlVmFsdWVdXG4gICk7XG5cbiAgY29uc3QgX29uQ2hhbmdlID0gdXNlQ2FsbGJhY2soZSA9PiBzZXRWYWx1ZShlLnRhcmdldC52YWx1ZSksIFtzZXRWYWx1ZV0pO1xuICBjb25zdCBvbkJsdXIgPSB1c2VDYWxsYmFjaygoKSA9PiBvbkNoYW5nZShuYW1lLCBzdGF0ZVZhbHVlKSwgW29uQ2hhbmdlLCBuYW1lLCBzdGF0ZVZhbHVlXSk7XG5cbiAgcmV0dXJuIChcbiAgICA8UmFuZ2VJbnB1dFxuICAgICAgdHlwZT1cIm51bWJlclwiXG4gICAgICByZWY9e2lucHV0UmVmfVxuICAgICAgdmFsdWU9e3N0YXRlVmFsdWV9XG4gICAgICBvbkNoYW5nZT17X29uQ2hhbmdlfVxuICAgICAgb25CbHVyPXtvbkJsdXJ9XG4gICAgICBvbktleURvd249e29uS2V5RG93bn1cbiAgICAgIGlkPXtuYW1lfVxuICAgIC8+XG4gICk7XG59O1xuXG5jb25zdCBDdXN0b21JbnB1dDogUmVhY3QuRkM8Q3VzdG9tSW5wdXRQcm9wcz4gPSAoe2lzUmFuZ2VkLCB2YWx1ZSwgb25DaGFuZ2VDdXN0b21JbnB1dH0pID0+IHtcbiAgY29uc3Qgb25DaGFuZ2VJbnB1dCA9IHVzZUNhbGxiYWNrKFxuICAgIChuYW1lLCB2KSA9PiB7XG4gICAgICBpZiAoaXNSYW5nZWQpIG9uQ2hhbmdlQ3VzdG9tSW5wdXQobmFtZSA9PT0gJ3ZhbHVlMCcgPyBbdiwgdmFsdWVbMV1dIDogW3ZhbHVlWzBdLCB2XSk7XG4gICAgICBlbHNlIG9uQ2hhbmdlQ3VzdG9tSW5wdXQodik7XG4gICAgfSxcbiAgICBbaXNSYW5nZWQsIHZhbHVlLCBvbkNoYW5nZUN1c3RvbUlucHV0XVxuICApO1xuXG4gIHJldHVybiAoXG4gICAgPEN1c3RvbUlucHV0V3JhcHBlcj5cbiAgICAgIHtpc1JhbmdlZCA/IChcbiAgICAgICAgPElucHV0V3JhcHBlcj5cbiAgICAgICAgICA8Q3VzdG9tSW5wdXRMYWJlbD5cbiAgICAgICAgICAgIG1pblxuICAgICAgICAgICAgPExhenlJbnB1dCBuYW1lPVwidmFsdWUwXCIgdmFsdWU9e3ZhbHVlWzBdfSBvbkNoYW5nZT17b25DaGFuZ2VJbnB1dH0gLz5cbiAgICAgICAgICA8L0N1c3RvbUlucHV0TGFiZWw+XG4gICAgICAgICAgPEN1c3RvbUlucHV0TGFiZWw+XG4gICAgICAgICAgICBtYXhcbiAgICAgICAgICAgIDxMYXp5SW5wdXQgbmFtZT1cInZhbHVlMVwiIHZhbHVlPXt2YWx1ZVsxXX0gb25DaGFuZ2U9e29uQ2hhbmdlSW5wdXR9IC8+XG4gICAgICAgICAgPC9DdXN0b21JbnB1dExhYmVsPlxuICAgICAgICA8L0lucHV0V3JhcHBlcj5cbiAgICAgICkgOiAoXG4gICAgICAgIDxJbnB1dFdyYXBwZXI+XG4gICAgICAgICAgPExhenlJbnB1dCBuYW1lPVwidmFsdWVcIiB2YWx1ZT17dmFsdWV9IG9uQ2hhbmdlPXtvbkNoYW5nZUlucHV0fSAvPlxuICAgICAgICA8L0lucHV0V3JhcHBlcj5cbiAgICAgICl9XG4gICAgPC9DdXN0b21JbnB1dFdyYXBwZXI+XG4gICk7XG59O1xuXG5WaXNDb25maWdTbGlkZXJGYWN0b3J5LmRlcHMgPSBbUmFuZ2VTbGlkZXJGYWN0b3J5XTtcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gVmlzQ29uZmlnU2xpZGVyRmFjdG9yeShSYW5nZVNsaWRlcjogUmV0dXJuVHlwZTx0eXBlb2YgUmFuZ2VTbGlkZXJGYWN0b3J5Pikge1xuICBjb25zdCBWaXNDb25maWdTbGlkZXI6IFJlYWN0LkZDPFZpc0NvbmZpZ1NsaWRlclByb3BzPiA9ICh7XG4gICAgbGF5ZXI6IHtjb25maWd9LFxuICAgIHByb3BlcnR5LFxuICAgIGxhYmVsLFxuICAgIHJhbmdlLFxuICAgIHN0ZXAsXG4gICAgaXNSYW5nZWQsXG4gICAgYWxsb3dDdXN0b21WYWx1ZSxcbiAgICBkaXNhYmxlZCxcbiAgICBvbkNoYW5nZSxcbiAgICBpbnB1dFRoZW1lXG4gIH0pID0+IHtcbiAgICBjb25zdCB2YWx1ZSA9IGNvbmZpZy52aXNDb25maWdbcHJvcGVydHldO1xuICAgIGNvbnN0IFtjdXN0b20sIHNldEN1c3RvbV0gPSB1c2VTdGF0ZShmYWxzZSB8fCAhaXNJblJhbmdlKHZhbHVlLCByYW5nZSkpO1xuXG4gICAgY29uc3Qgb25DaGFuZ2VDaGVja2JveCA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICAgIGlmIChjdXN0b20pIHtcbiAgICAgICAgLy8gd2UgYXJlIHN3aXRoY2luZyBmcm9tIGN1c3RvbSB0byBub3QgY3VzdG9tXG4gICAgICAgIC8vIGFkanVzdCB2YWx1ZSB0byByYW5nZVxuICAgICAgICBjb25zdCBhZGp1c3RlZFZhbHVlID0gaXNSYW5nZWRcbiAgICAgICAgICA/IFtjbGFtcChyYW5nZSwgdmFsdWVbMF0pLCBjbGFtcChyYW5nZSwgdmFsdWVbMV0pXVxuICAgICAgICAgIDogY2xhbXAocmFuZ2UsIHZhbHVlKTtcbiAgICAgICAgb25DaGFuZ2Uoe1twcm9wZXJ0eV06IGFkanVzdGVkVmFsdWV9KTtcbiAgICAgIH1cbiAgICAgIHNldEN1c3RvbSghY3VzdG9tKTtcbiAgICB9LCBbb25DaGFuZ2UsIHByb3BlcnR5LCBpc1JhbmdlZCwgdmFsdWUsIHJhbmdlLCBjdXN0b20sIHNldEN1c3RvbV0pO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIDxTaWRlUGFuZWxTZWN0aW9uIGRpc2FibGVkPXtCb29sZWFuKGRpc2FibGVkKX0+XG4gICAgICAgIHtsYWJlbCA/IChcbiAgICAgICAgICA8UGFuZWxMYWJlbD5cbiAgICAgICAgICAgIHt0eXBlb2YgbGFiZWwgPT09ICdzdHJpbmcnID8gKFxuICAgICAgICAgICAgICA8Rm9ybWF0dGVkTWVzc2FnZSBpZD17bGFiZWx9IC8+XG4gICAgICAgICAgICApIDogdHlwZW9mIGxhYmVsID09PSAnZnVuY3Rpb24nID8gKFxuICAgICAgICAgICAgICA8Rm9ybWF0dGVkTWVzc2FnZSBpZD17bGFiZWwoY29uZmlnKX0gLz5cbiAgICAgICAgICAgICkgOiAoXG4gICAgICAgICAgICAgIDxGb3JtYXR0ZWRNZXNzYWdlIGlkPXtgcHJvcGVydHkuJHtwcm9wZXJ0eX1gfSAvPlxuICAgICAgICAgICAgKX1cbiAgICAgICAgICA8L1BhbmVsTGFiZWw+XG4gICAgICAgICkgOiBudWxsfVxuXG4gICAgICAgIHthbGxvd0N1c3RvbVZhbHVlID8gKFxuICAgICAgICAgIDxJbnB1dFdyYXBwZXI+XG4gICAgICAgICAgICA8Q3VzdG9tSW5wdXRMYWJlbD5jdXN0b20gaW5wdXQ8L0N1c3RvbUlucHV0TGFiZWw+XG4gICAgICAgICAgICA8Q2hlY2tib3ggaWQ9e2Bwcm9wZXJ0eS4ke3Byb3BlcnR5fWB9IGNoZWNrZWQ9e2N1c3RvbX0gb25DaGFuZ2U9e29uQ2hhbmdlQ2hlY2tib3h9IC8+XG4gICAgICAgICAgPC9JbnB1dFdyYXBwZXI+XG4gICAgICAgICkgOiBudWxsfVxuXG4gICAgICAgIHshY3VzdG9tID8gKFxuICAgICAgICAgIDxSYW5nZVNsaWRlclxuICAgICAgICAgICAgcmFuZ2U9e3JhbmdlfVxuICAgICAgICAgICAgdmFsdWUwPXtpc1JhbmdlZCA/IHZhbHVlWzBdIDogcmFuZ2VbMF19XG4gICAgICAgICAgICB2YWx1ZTE9e2lzUmFuZ2VkID8gdmFsdWVbMV0gOiB2YWx1ZX1cbiAgICAgICAgICAgIHN0ZXA9e3N0ZXB9XG4gICAgICAgICAgICBpc1JhbmdlZD17Qm9vbGVhbihpc1JhbmdlZCl9XG4gICAgICAgICAgICBvbkNoYW5nZT17diA9PiBvbkNoYW5nZSh7W3Byb3BlcnR5XTogaXNSYW5nZWQgPyB2IDogdlsxXX0pfVxuICAgICAgICAgICAgaW5wdXRUaGVtZT17aW5wdXRUaGVtZX1cbiAgICAgICAgICAgIHNob3dJbnB1dFxuICAgICAgICAgIC8+XG4gICAgICAgICkgOiAoXG4gICAgICAgICAgPEN1c3RvbUlucHV0XG4gICAgICAgICAgICBpc1JhbmdlZD17aXNSYW5nZWR9XG4gICAgICAgICAgICB2YWx1ZT17dmFsdWV9XG4gICAgICAgICAgICBvbkNoYW5nZUN1c3RvbUlucHV0PXt2ID0+IG9uQ2hhbmdlKHtbcHJvcGVydHldOiB2fSl9XG4gICAgICAgICAgLz5cbiAgICAgICAgKX1cbiAgICAgIDwvU2lkZVBhbmVsU2VjdGlvbj5cbiAgICApO1xuICB9O1xuXG4gIHJldHVybiBWaXNDb25maWdTbGlkZXI7XG59XG4iXX0=