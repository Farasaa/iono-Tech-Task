"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.injector = injector;
exports.flattenDeps = flattenDeps;
exports.provideRecipesToInjector = provideRecipesToInjector;
exports.typeCheckRecipe = typeCheckRecipe;
exports.withState = withState;
exports.ERROR_MSG = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _react = _interopRequireDefault(require("react"));

var _reactRedux = require("react-redux");

var _redux = require("redux");

var _window = require("global/window");

var _context = _interopRequireDefault(require("./context"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var MissingComp = function MissingComp() {
  return /*#__PURE__*/_react["default"].createElement("div", null);
};

var ERROR_MSG = {
  wrongRecipeType: "injectComponents takes an array of factories replacement pairs as input, " + "each pair be a array as [originalFactory, replacement].",
  noDep: function noDep(fac, parent) {
    return "".concat(fac.name, " is required as a dependency of ").concat(parent.name, ", ") + "but is not provided to injectComponents. It will not be rendered.";
  },
  notFunc: 'factory and its replacement should be a function'
};
exports.ERROR_MSG = ERROR_MSG;

function injector() {
  var map = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : new Map();
  var cache = new Map(); // map<factory, factory -> ?>

  var get = function get(fac, parent) {
    var factory = map.get(fac); // factory is not injected

    if (!factory) {
      _window.console.error(ERROR_MSG.noDep(fac, parent));

      return MissingComp;
    } // check if custom factory deps is declared


    var instances = cache.get(factory) || factory.apply(void 0, (0, _toConsumableArray2["default"])(factory.deps ? factory.deps.map(function (dep) {
      return get(dep, factory);
    }) : []));
    cache.set(fac, instances);
    return instances;
  }; // if you have two functions that happen to have the exactly same text
  // it will be override: 2018-02-05


  return {
    provide: function provide(factory, replacement) {
      if (!typeCheckRecipe([factory, replacement])) {
        return injector(map);
      }

      return injector(new Map(map).set(factory, replacement));
    },
    get: get
  };
} // entryPoint


function flattenDeps(allDeps, factory) {
  var addToDeps = allDeps.concat([factory]);
  return Array.isArray(factory.deps) && factory.deps.length ? factory.deps.reduce(function (accu, dep) {
    return flattenDeps(accu, dep);
  }, addToDeps) : addToDeps;
}

function provideRecipesToInjector(recipes, appInjector) {
  var provided = new Map();
  return recipes.reduce(function (inj, recipe) {
    var _inj;

    if (!typeCheckRecipe(recipe)) {
      return inj;
    } // collect dependencies of custom factories, if there is any.
    // Add them to the appInjector


    var customDependencies = flattenDeps([], recipe[1]);
    inj = customDependencies.reduce(function (ij, factory) {
      if (provided.get(factory)) {
        _window.console.warn("".concat(factory.name, " already injected from ").concat(provided.get(factory).name, ", injecting ").concat(recipe[0].name, " after ").concat(provided.get(factory).name, " will override it"));
      }

      return ij.provide(factory, factory);
    }, inj);
    provided.set(recipe[0], recipe[1]);
    return (_inj = inj).provide.apply(_inj, (0, _toConsumableArray2["default"])(recipe));
  }, appInjector);
}

function typeCheckRecipe(recipe) {
  if (!Array.isArray(recipe) || recipe.length < 2) {
    _window.console.error('Error injecting [factory, replacement]', recipe);

    _window.console.error(ERROR_MSG.wrongRecipeType);

    return false;
  }

  var _recipe = (0, _slicedToArray2["default"])(recipe, 2),
      factory = _recipe[0],
      replacement = _recipe[1];

  if (typeof factory !== 'function') {
    _window.console.error('Error injecting factory: ', factory);

    _window.console.error(ERROR_MSG.notFunc);

    return false;
  } else if (typeof replacement !== 'function') {
    _window.console.error('Error injecting replacement for: ', factory);

    _window.console.error(ERROR_MSG.notFunc);

    return false;
  }

  return true;
}

var identity = function identity(state) {
  return state;
}; // Helper to add reducer state to custom component


function withState() {
  var lenses = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  var mapStateToProps = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : identity;
  var actions = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};
  return function (Component) {
    var WrappedComponent = function WrappedComponent(_ref) {
      var state = _ref.state,
          props = (0, _objectWithoutProperties2["default"])(_ref, ["state"]);
      return /*#__PURE__*/_react["default"].createElement(_context["default"].Consumer, null, function (context) {
        return /*#__PURE__*/_react["default"].createElement(Component, lenses.reduce(function (totalState, lens) {
          return _objectSpread(_objectSpread({}, totalState), lens(context.selector(state)));
        }, props));
      });
    };

    return (0, _reactRedux.connect)(function (state) {
      return _objectSpread(_objectSpread({}, mapStateToProps(state)), {}, {
        state: state
      });
    }, function (dispatch) {
      return Object.keys(actions).reduce(function (accu, key) {
        return _objectSpread(_objectSpread({}, accu), {}, (0, _defineProperty2["default"])({}, key, (0, _redux.bindActionCreators)(actions[key], dispatch)));
      }, {});
    })(WrappedComponent);
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmplY3Rvci50c3giXSwibmFtZXMiOlsiTWlzc2luZ0NvbXAiLCJFUlJPUl9NU0ciLCJ3cm9uZ1JlY2lwZVR5cGUiLCJub0RlcCIsImZhYyIsInBhcmVudCIsIm5hbWUiLCJub3RGdW5jIiwiaW5qZWN0b3IiLCJtYXAiLCJNYXAiLCJjYWNoZSIsImdldCIsImZhY3RvcnkiLCJDb25zb2xlIiwiZXJyb3IiLCJpbnN0YW5jZXMiLCJkZXBzIiwiZGVwIiwic2V0IiwicHJvdmlkZSIsInJlcGxhY2VtZW50IiwidHlwZUNoZWNrUmVjaXBlIiwiZmxhdHRlbkRlcHMiLCJhbGxEZXBzIiwiYWRkVG9EZXBzIiwiY29uY2F0IiwiQXJyYXkiLCJpc0FycmF5IiwibGVuZ3RoIiwicmVkdWNlIiwiYWNjdSIsInByb3ZpZGVSZWNpcGVzVG9JbmplY3RvciIsInJlY2lwZXMiLCJhcHBJbmplY3RvciIsInByb3ZpZGVkIiwiaW5qIiwicmVjaXBlIiwiY3VzdG9tRGVwZW5kZW5jaWVzIiwiaWoiLCJ3YXJuIiwiaWRlbnRpdHkiLCJzdGF0ZSIsIndpdGhTdGF0ZSIsImxlbnNlcyIsIm1hcFN0YXRlVG9Qcm9wcyIsImFjdGlvbnMiLCJDb21wb25lbnQiLCJXcmFwcGVkQ29tcG9uZW50IiwicHJvcHMiLCJjb250ZXh0IiwidG90YWxTdGF0ZSIsImxlbnMiLCJzZWxlY3RvciIsImRpc3BhdGNoIiwiT2JqZWN0Iiwia2V5cyIsImtleSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUdBOztBQUNBOztBQUNBOztBQU1BOztBQUNBOzs7Ozs7QUFZQSxJQUFNQSxXQUFXLEdBQUcsU0FBZEEsV0FBYztBQUFBLHNCQUFNLDRDQUFOO0FBQUEsQ0FBcEI7O0FBRU8sSUFBTUMsU0FBUyxHQUFHO0FBQ3ZCQyxFQUFBQSxlQUFlLEVBQ2IsdUlBRnFCO0FBS3ZCQyxFQUFBQSxLQUFLLEVBQUUsZUFBQ0MsR0FBRCxFQUFNQyxNQUFOO0FBQUEsV0FDTCxVQUFHRCxH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RUFFTCxVQUFBWSxRQUFRO0FBQUEsYUFDTkMsTUFBTSxDQUFDQyxJQUFQLENBQVlWLE9BQVosRUFBcUJoQixNQUFyQixDQUNFLFVBQUNDLElBQUQsRUFBTzBCLEdBQVA7QUFBQSwrQ0FDSzFCLElBREwsNENBRUcwQixHQUZILEVBRVMsK0JBQW1CWCxPQUFPLENBQUNXLEdBQUQsQ0FBMUIsRUFBaUNILFFBQWpDLENBRlQ7QUFBQSxPQURGLEVBS0UsRUFMRixDQURNO0FBQUEsS0FGSCxFQVVMTixnQkFWSyxDQUFQO0FBV0QsR0E1QkQ7QUE2QkQiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTUlUXG4vLyBDb3B5cmlnaHQgY29udHJpYnV0b3JzIHRvIHRoZSBrZXBsZXIuZ2wgcHJvamVjdFxuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHtjb25uZWN0fSBmcm9tICdyZWFjdC1yZWR1eCc7XG5pbXBvcnQge2JpbmRBY3Rpb25DcmVhdG9yc30gZnJvbSAncmVkdXgnO1xuaW1wb3J0IHtcbiAgTWFwU3RhdGVUb1Byb3BzUGFyYW0sXG4gIE1hcERpc3BhdGNoVG9Qcm9wc1BhcmFtLFxuICBJbmZlcmFibGVDb21wb25lbnRFbmhhbmNlcldpdGhQcm9wc1xufSBmcm9tICdyZWFjdC1yZWR1eCc7XG5pbXBvcnQge2NvbnNvbGUgYXMgQ29uc29sZX0gZnJvbSAnZ2xvYmFsL3dpbmRvdyc7XG5pbXBvcnQgS2VwbGVyR2xDb250ZXh0IGZyb20gJy4vY29udGV4dCc7XG5cbmV4cG9ydCB0eXBlIEZhY3RvcnlFbGVtZW50ID0gKC4uLmFyZ3MpID0+IFJlYWN0LkNvbXBvbmVudFR5cGU7XG5leHBvcnQgdHlwZSBGYWN0b3J5ID0gRmFjdG9yeUVsZW1lbnQgJiB7XG4gIGRlcHM6IEZhY3RvcnlFbGVtZW50W107XG59O1xuXG5leHBvcnQgdHlwZSBJbmplY3RvclR5cGUgPSB7XG4gIHByb3ZpZGU6IChmYWN0b3J5OiBhbnksIHJlcGxhY2VtZW50OiBhbnkpID0+IEluamVjdG9yVHlwZTtcbiAgZ2V0OiAoZmFjOiBhbnksIHBhcmVudD86IGFueSkgPT4gYW55O1xufTtcblxuY29uc3QgTWlzc2luZ0NvbXAgPSAoKSA9PiA8ZGl2IC8+O1xuXG5leHBvcnQgY29uc3QgRVJST1JfTVNHID0ge1xuICB3cm9uZ1JlY2lwZVR5cGU6XG4gICAgYGluamVjdENvbXBvbmVudHMgdGFrZXMgYW4gYXJyYXkgb2YgZmFjdG9yaWVzIHJlcGxhY2VtZW50IHBhaXJzIGFzIGlucHV0LCBgICtcbiAgICBgZWFjaCBwYWlyIGJlIGEgYXJyYXkgYXMgW29yaWdpbmFsRmFjdG9yeSwgcmVwbGFjZW1lbnRdLmAsXG5cbiAgbm9EZXA6IChmYWMsIHBhcmVudCkgPT5cbiAgICBgJHtmYWMubmFtZX0gaXMgcmVxdWlyZWQgYXMgYSBkZXBlbmRlbmN5IG9mICR7cGFyZW50Lm5hbWV9LCBgICtcbiAgICBgYnV0IGlzIG5vdCBwcm92aWRlZCB0byBpbmplY3RDb21wb25lbnRzLiBJdCB3aWxsIG5vdCBiZSByZW5kZXJlZC5gLFxuXG4gIG5vdEZ1bmM6ICdmYWN0b3J5IGFuZCBpdHMgcmVwbGFjZW1lbnQgc2hvdWxkIGJlIGEgZnVuY3Rpb24nXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gaW5qZWN0b3IobWFwID0gbmV3IE1hcCgpKTogSW5qZWN0b3JUeXBlIHtcbiAgY29uc3QgY2FjaGUgPSBuZXcgTWFwKCk7IC8vIG1hcDxmYWN0b3J5LCBmYWN0b3J5IC0+ID8+XG4gIGNvbnN0IGdldCA9IChmYWMsIHBhcmVudCkgPT4ge1xuICAgIGNvbnN0IGZhY3RvcnkgPSBtYXAuZ2V0KGZhYyk7XG4gICAgLy8gZmFjdG9yeSBpcyBub3QgaW5qZWN0ZWRcbiAgICBpZiAoIWZhY3RvcnkpIHtcbiAgICAgIENvbnNvbGUuZXJyb3IoRVJST1JfTVNHLm5vRGVwKGZhYywgcGFyZW50KSk7XG4gICAgICByZXR1cm4gTWlzc2luZ0NvbXA7XG4gICAgfVxuXG4gICAgLy8gY2hlY2sgaWYgY3VzdG9tIGZhY3RvcnkgZGVwcyBpcyBkZWNsYXJlZFxuICAgIGNvbnN0IGluc3RhbmNlcyA9XG4gICAgICBjYWNoZS5nZXQoZmFjdG9yeSkgfHxcbiAgICAgIGZhY3RvcnkoLi4uKGZhY3RvcnkuZGVwcyA/IGZhY3RvcnkuZGVwcy5tYXAoZGVwID0+IGdldChkZXAsIGZhY3RvcnkpKSA6IFtdKSk7XG5cbiAgICBjYWNoZS5zZXQoZmFjLCBpbnN0YW5jZXMpO1xuICAgIHJldHVybiBpbnN0YW5jZXM7XG4gIH07XG5cbiAgLy8gaWYgeW91IGhhdmUgdHdvIGZ1bmN0aW9ucyB0aGF0IGhhcHBlbiB0byBoYXZlIHRoZSBleGFjdGx5IHNhbWUgdGV4dFxuICAvLyBpdCB3aWxsIGJlIG92ZXJyaWRlOiAyMDE4LTAyLTA1XG4gIHJldHVybiB7XG4gICAgcHJvdmlkZTogKGZhY3RvcnksIHJlcGxhY2VtZW50KSA9PiB7XG4gICAgICBpZiAoIXR5cGVDaGVja1JlY2lwZShbZmFjdG9yeSwgcmVwbGFjZW1lbnRdKSkge1xuICAgICAgICByZXR1cm4gaW5qZWN0b3IobWFwKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBpbmplY3RvcihuZXcgTWFwKG1hcCkuc2V0KGZhY3RvcnksIHJlcGxhY2VtZW50KSk7XG4gICAgfSxcbiAgICBnZXRcbiAgfTtcbn1cblxuLy8gZW50cnlQb2ludFxuZXhwb3J0IGZ1bmN0aW9uIGZsYXR0ZW5EZXBzKGFsbERlcHM6IEZhY3RvcnlbXSwgZmFjdG9yeTogYW55KTogRmFjdG9yeVtdIHtcbiAgY29uc3QgYWRkVG9EZXBzID0gYWxsRGVwcy5jb25jYXQoW2ZhY3RvcnldKTtcbiAgcmV0dXJuIEFycmF5LmlzQXJyYXkoZmFjdG9yeS5kZXBzKSAmJiBmYWN0b3J5LmRlcHMubGVuZ3RoXG4gICAgPyBmYWN0b3J5LmRlcHMucmVkdWNlKChhY2N1LCBkZXApID0+IGZsYXR0ZW5EZXBzKGFjY3UsIGRlcCksIGFkZFRvRGVwcylcbiAgICA6IGFkZFRvRGVwcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByb3ZpZGVSZWNpcGVzVG9JbmplY3RvcihyZWNpcGVzOiBbRmFjdG9yeSwgRmFjdG9yeV1bXSwgYXBwSW5qZWN0b3I6IEluamVjdG9yVHlwZSkge1xuICBjb25zdCBwcm92aWRlZCA9IG5ldyBNYXAoKTtcblxuICByZXR1cm4gcmVjaXBlcy5yZWR1Y2UoKGluaiwgcmVjaXBlKSA9PiB7XG4gICAgaWYgKCF0eXBlQ2hlY2tSZWNpcGUocmVjaXBlKSkge1xuICAgICAgcmV0dXJuIGluajtcbiAgICB9XG5cbiAgICAvLyBjb2xsZWN0IGRlcGVuZGVuY2llcyBvZiBjdXN0b20gZmFjdG9yaWVzLCBpZiB0aGVyZSBpcyBhbnkuXG4gICAgLy8gQWRkIHRoZW0gdG8gdGhlIGFwcEluamVjdG9yXG4gICAgY29uc3QgY3VzdG9tRGVwZW5kZW5jaWVzID0gZmxhdHRlbkRlcHMoW10sIHJlY2lwZVsxXSk7XG4gICAgaW5qID0gY3VzdG9tRGVwZW5kZW5jaWVzLnJlZHVjZSgoaWosIGZhY3RvcnkpID0+IHtcbiAgICAgIGlmIChwcm92aWRlZC5nZXQoZmFjdG9yeSkpIHtcbiAgICAgICAgQ29uc29sZS53YXJuKFxuICAgICAgICAgIGAke2ZhY3RvcnkubmFtZX0gYWxyZWFkeSBpbmplY3RlZCBmcm9tICR7cHJvdmlkZWQuZ2V0KGZhY3RvcnkpLm5hbWV9LCBpbmplY3RpbmcgJHtcbiAgICAgICAgICAgIHJlY2lwZVswXS5uYW1lXG4gICAgICAgICAgfSBhZnRlciAke3Byb3ZpZGVkLmdldChmYWN0b3J5KS5uYW1lfSB3aWxsIG92ZXJyaWRlIGl0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGlqLnByb3ZpZGUoZmFjdG9yeSwgZmFjdG9yeSk7XG4gICAgfSwgaW5qKTtcblxuICAgIHByb3ZpZGVkLnNldChyZWNpcGVbMF0sIHJlY2lwZVsxXSk7XG4gICAgcmV0dXJuIGluai5wcm92aWRlKC4uLnJlY2lwZSk7XG4gIH0sIGFwcEluamVjdG9yKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHR5cGVDaGVja1JlY2lwZShyZWNpcGUpIHtcbiAgaWYgKCFBcnJheS5pc0FycmF5KHJlY2lwZSkgfHwgcmVjaXBlLmxlbmd0aCA8IDIpIHtcbiAgICBDb25zb2xlLmVycm9yKCdFcnJvciBpbmplY3RpbmcgW2ZhY3RvcnksIHJlcGxhY2VtZW50XScsIHJlY2lwZSk7XG4gICAgQ29uc29sZS5lcnJvcihFUlJPUl9NU0cud3JvbmdSZWNpcGVUeXBlKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBjb25zdCBbZmFjdG9yeSwgcmVwbGFjZW1lbnRdID0gcmVjaXBlO1xuICBpZiAodHlwZW9mIGZhY3RvcnkgIT09ICdmdW5jdGlvbicpIHtcbiAgICBDb25zb2xlLmVycm9yKCdFcnJvciBpbmplY3RpbmcgZmFjdG9yeTogJywgZmFjdG9yeSk7XG4gICAgQ29uc29sZS5lcnJvcihFUlJPUl9NU0cubm90RnVuYyk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9IGVsc2UgaWYgKHR5cGVvZiByZXBsYWNlbWVudCAhPT0gJ2Z1bmN0aW9uJykge1xuICAgIENvbnNvbGUuZXJyb3IoJ0Vycm9yIGluamVjdGluZyByZXBsYWNlbWVudCBmb3I6ICcsIGZhY3RvcnkpO1xuICAgIENvbnNvbGUuZXJyb3IoRVJST1JfTVNHLm5vdEZ1bmMpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHJldHVybiB0cnVlO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFdpdGhTdGF0ZTxSb290U3RhdGU+IHtcbiAgPFRTdGF0ZVByb3BzID0ge30sIFREaXNwYXRjaFByb3BzID0ge30sIFRPd25Qcm9wcyA9IHt9LCBTdGF0ZSA9IFJvb3RTdGF0ZT4oXG4gICAgbGVuc2VzOiBhbnlbXSxcbiAgICBtYXBTdGF0ZVRvUHJvcHM6IE1hcFN0YXRlVG9Qcm9wc1BhcmFtPFRTdGF0ZVByb3BzLCBUT3duUHJvcHMsIFN0YXRlPixcbiAgICBtYXBEaXNwYXRjaFRvUHJvcHM/OiBNYXBEaXNwYXRjaFRvUHJvcHNQYXJhbTxURGlzcGF0Y2hQcm9wcywgVE93blByb3BzPlxuICApOiBJbmZlcmFibGVDb21wb25lbnRFbmhhbmNlcldpdGhQcm9wczxUU3RhdGVQcm9wcyAmIFREaXNwYXRjaFByb3BzLCBUT3duUHJvcHM+O1xufVxuXG5jb25zdCBpZGVudGl0eSA9IHN0YXRlID0+IHN0YXRlO1xuLy8gSGVscGVyIHRvIGFkZCByZWR1Y2VyIHN0YXRlIHRvIGN1c3RvbSBjb21wb25lbnRcbmV4cG9ydCBmdW5jdGlvbiB3aXRoU3RhdGUobGVuc2VzOiBhbnlbXSA9IFtdLCBtYXBTdGF0ZVRvUHJvcHMgPSBpZGVudGl0eSwgYWN0aW9ucyA9IHt9KSB7XG4gIHJldHVybiBDb21wb25lbnQgPT4ge1xuICAgIGNvbnN0IFdyYXBwZWRDb21wb25lbnQgPSAoe3N0YXRlLCAuLi5wcm9wc30pID0+IChcbiAgICAgIDxLZXBsZXJHbENvbnRleHQuQ29uc3VtZXI+XG4gICAgICAgIHtjb250ZXh0ID0+IChcbiAgICAgICAgICA8Q29tcG9uZW50XG4gICAgICAgICAgICB7Li4ubGVuc2VzLnJlZHVjZShcbiAgICAgICAgICAgICAgKHRvdGFsU3RhdGUsIGxlbnMpID0+ICh7XG4gICAgICAgICAgICAgICAgLi4udG90YWxTdGF0ZSxcbiAgICAgICAgICAgICAgICAuLi5sZW5zKGNvbnRleHQuc2VsZWN0b3Ioc3RhdGUpKVxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgcHJvcHNcbiAgICAgICAgICAgICl9XG4gICAgICAgICAgLz5cbiAgICAgICAgKX1cbiAgICAgIDwvS2VwbGVyR2xDb250ZXh0LkNvbnN1bWVyPlxuICAgICk7XG5cbiAgICByZXR1cm4gY29ubmVjdChcbiAgICAgIHN0YXRlID0+ICh7Li4ubWFwU3RhdGVUb1Byb3BzKHN0YXRlKSwgc3RhdGV9KSxcbiAgICAgIGRpc3BhdGNoID0+XG4gICAgICAgIE9iamVjdC5rZXlzKGFjdGlvbnMpLnJlZHVjZShcbiAgICAgICAgICAoYWNjdSwga2V5KSA9PiAoe1xuICAgICAgICAgICAgLi4uYWNjdSxcbiAgICAgICAgICAgIFtrZXldOiBiaW5kQWN0aW9uQ3JlYXRvcnMoYWN0aW9uc1trZXldLCBkaXNwYXRjaClcbiAgICAgICAgICB9KSxcbiAgICAgICAgICB7fVxuICAgICAgICApXG4gICAgKShXcmFwcGVkQ29tcG9uZW50KTtcbiAgfTtcbn1cbiJdfQ==