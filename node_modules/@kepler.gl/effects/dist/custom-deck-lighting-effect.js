"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.insertBefore = insertBefore;
exports["default"] = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _get2 = _interopRequireDefault(require("@babel/runtime/helpers/get"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _window = require("global/window");

var _core = require("@deck.gl/core");

var _core2 = require("@luma.gl/core");

function _createForOfIteratorHelper(o, allowArrayLike) { var it; if (typeof Symbol === "undefined" || o[Symbol.iterator] == null) { if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === "number") { if (it) o = it; var i = 0; var F = function F() {}; return { s: F, n: function n() { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }, e: function e(_e) { throw _e; }, f: F }; } throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); } var normalCompletion = true, didErr = false, err; return { s: function s() { it = o[Symbol.iterator](); }, n: function n() { var step = it.next(); normalCompletion = step.done; return step; }, e: function e(_e2) { didErr = true; err = _e2; }, f: function f() { try { if (!normalCompletion && it["return"] != null) it["return"](); } finally { if (didErr) throw err; } } }; }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = (0, _getPrototypeOf2["default"])(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = (0, _getPrototypeOf2["default"])(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return (0, _possibleConstructorReturn2["default"])(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

/**
 * Inserts shader code before detected part.
 * @param {string} vs Original shader code.
 * @param {string} type Debug string.
 * @param {string} insertBeforeText Text chunk to insert before.
 * @param {string} textToInsert Text to insert.
 * @returns Modified shader code.
 */
function insertBefore(vs, type, insertBeforeText, textToInsert) {
  var at = vs.indexOf(insertBeforeText);

  if (at < 0) {
    _window.console.error("Cannot edit ".concat(type, " layer shader"));

    return vs;
  }

  return vs.slice(0, at) + textToInsert + vs.slice(at);
}

var CustomShadowModule = _core.shadow ? _objectSpread({}, _core.shadow) : undefined;
/**
 * Custom shadow module
 * 1) Add u_outputUniformShadow uniform
 * 2) always produce full shadow when the uniform is set to true.
 */

CustomShadowModule.fs = insertBefore(CustomShadowModule.fs, 'custom shadow #1', 'uniform vec4 shadow_uColor;', 'uniform bool u_outputUniformShadow;');
CustomShadowModule.fs = insertBefore(CustomShadowModule.fs, 'custom shadow #1', 'vec4 rgbaDepth = texture2D(shadowMap, position.xy);', 'if(u_outputUniformShadow) return 1.0;');

CustomShadowModule.getUniforms = function () {
  var opts = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var context = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

  var u = _core.shadow.getUniforms(opts, context);

  if (opts.outputUniformShadow !== undefined) {
    u['u_outputUniformShadow'] = opts.outputUniformShadow;
  }

  return u;
};
/**
 * Custom LightingEffect
 * 1) adds CustomShadowModule
 * 2) pass outputUniformShadow as module parameters
 * 3) properly removes CustomShadowModule
 */


var CustomDeckLightingEffect = /*#__PURE__*/function (_LightingEffect) {
  (0, _inherits2["default"])(CustomDeckLightingEffect, _LightingEffect);

  var _super = _createSuper(CustomDeckLightingEffect);

  function CustomDeckLightingEffect(props) {
    var _this;

    (0, _classCallCheck2["default"])(this, CustomDeckLightingEffect);
    _this = _super.call(this, props);
    _this.useOutputUniformShadow = false;
    return _this;
  }

  (0, _createClass2["default"])(CustomDeckLightingEffect, [{
    key: "preRender",
    value: function preRender(gl, _ref) {
      var layers = _ref.layers,
          layerFilter = _ref.layerFilter,
          viewports = _ref.viewports,
          onViewportActive = _ref.onViewportActive,
          views = _ref.views;
      if (!this.shadow) return; // create light matrix every frame to make sure always updated from light source

      this.shadowMatrices = this._calculateMatrices();

      if (this.shadowPasses.length === 0) {
        this._createShadowPasses(gl);
      }

      if (!this.programManager) {
        this.programManager = _core2.ProgramManager.getDefaultProgramManager(gl);

        if (CustomShadowModule) {
          this.programManager.addDefaultModule(CustomShadowModule);
        }
      }

      if (!this.dummyShadowMap) {
        this.dummyShadowMap = new _core2.Texture2D(gl, {
          width: 1,
          height: 1
        });
      }

      for (var i = 0; i < this.shadowPasses.length; i++) {
        var shadowPass = this.shadowPasses[i];
        shadowPass.render({
          layers: layers,
          layerFilter: layerFilter,
          viewports: viewports,
          onViewportActive: onViewportActive,
          views: views,
          moduleParameters: {
            shadowLightId: i,
            dummyShadowMap: this.dummyShadowMap,
            shadowMatrices: this.shadowMatrices,
            useOutputUniformShadow: false
          }
        });
      }
    }
  }, {
    key: "getModuleParameters",
    value: function getModuleParameters(layer) {
      var parameters = (0, _get2["default"])((0, _getPrototypeOf2["default"])(CustomDeckLightingEffect.prototype), "getModuleParameters", this).call(this, layer);
      parameters.outputUniformShadow = this.outputUniformShadow;
      return parameters;
    }
  }, {
    key: "cleanup",
    value: function cleanup() {
      var _iterator = _createForOfIteratorHelper(this.shadowPasses),
          _step;

      try {
        for (_iterator.s(); !(_step = _iterator.n()).done;) {
          var shadowPass = _step.value;
          shadowPass["delete"]();
        }
      } catch (err) {
        _iterator.e(err);
      } finally {
        _iterator.f();
      }

      this.shadowPasses.length = 0;
      this.shadowMaps.length = 0;

      if (this.dummyShadowMap) {
        this.dummyShadowMap["delete"]();
        this.dummyShadowMap = null;
      }

      if (this.shadow && this.programManager) {
        this.programManager.removeDefaultModule(CustomShadowModule);
        this.programManager = null;
      }
    }
  }]);
  return CustomDeckLightingEffect;
}(_core.LightingEffect);

var _default = CustomDeckLightingEffect;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jdXN0b20tZGVjay1saWdodGluZy1lZmZlY3QudHMiXSwibmFtZXMiOlsiaW5zZXJ0QmVmb3JlIiwidnMiLCJ0eXBlIiwiaW5zZXJ0QmVmb3JlVGV4dCIsInRleHRUb0luc2VydCIsImF0IiwiaW5kZXhPZiIsIkNvbnNvbGUiLCJlcnJvciIsInNsaWNlIiwiQ3VzdG9tU2hhZG93TW9kdWxlIiwic2hhZG93IiwidW5kZWZpbmVkIiwiZnMiLCJnZXRVbmlmb3JtcyIsIm9wdHMiLCJjb250ZXh0IiwidSIsIm91dHB1dFVuaWZvcm1TaGFkb3ciLCJDdXN0b21EZWNrTGlnaHRpbmdFZmZlY3QiLCJwcm9wcyIsInVzZU91dHB1dFVuaWZvcm1TaGFkb3ciLCJnbCIsImxheWVycyIsImxheWVyRmlsdGVyIiwidmlld3BvcnRzIiwib25WaWV3cG9ydEFjdGl2ZSIsInZpZXdzIiwic2hhZG93TWF0cmljZXMiLCJfY2FsY3VsYXRlTWF0cmljZXMiLCJzaGFkb3dQYXNzZXMiLCJsZW5ndGgiLCJfY3JlYXRlU2hhZG93UGFzc2VzIiwicHJvZ3JhbU1hbmFnZXIiLCJQcm9ncmFtTWFuYWdlciIsImdldERlZmF1bHRQcm9ncmFtTWFuYWdlciIsImFkZERlZmF1bHRNb2R1bGUiLCJkdW1teVNoYWRvd01hcCIsIlRleHR1cmUyRCIsIndpZHRoIiwiaGVpZ2h0IiwiaSIsInNoYWRvd1Bhc3MiLCJyZW5kZXIiLCJtb2R1bGVQYXJhbWV0ZXJzIiwic2hhZG93TGlnaHRJZCIsImxheWVyIiwicGFyYW1ldGVycyIsInNoYWRvd01hcHMiLCJyZW1vdmVEZWZhdWx0TW9kdWxlIiwiTGlnaHRpbmdFZmZlY3QiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUtBOztBQUNBOztBQUNBOzs7Ozs7Ozs7Ozs7Ozs7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNPLFNBQVNBLFlBQVQsQ0FBc0JDLEVBQXRCLEVBQTBCQyxJQUEx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YUFBS0EsY0FBTCxDQUFvQmdCLG1CQUFwQixDQUF3Q3ZDLGtCQUF4QztBQUNBLGFBQUt1QixjQUFMLEdBQXNCLElBQXRCO0FBQ0Q7QUFDRjs7O0VBckVvQ2lCLG9COztlQXdFeEIvQix3QiIsInNvdXJjZXNDb250ZW50IjpbIi8vIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVRcbi8vIENvcHlyaWdodCBjb250cmlidXRvcnMgdG8gdGhlIGtlcGxlci5nbCBwcm9qZWN0XG5cbi8vIEB0cy1ub2NoZWNrIFRoaXMgaXMgYSBoYWNrLCBkb24ndCBjaGVjayB0eXBlc1xuXG5pbXBvcnQge2NvbnNvbGUgYXMgQ29uc29sZX0gZnJvbSAnZ2xvYmFsL3dpbmRvdyc7XG5pbXBvcnQge0xpZ2h0aW5nRWZmZWN0LCBzaGFkb3d9IGZyb20gJ0BkZWNrLmdsL2NvcmUnO1xuaW1wb3J0IHtUZXh0dXJlMkQsIFByb2dyYW1NYW5hZ2VyfSBmcm9tICdAbHVtYS5nbC9jb3JlJztcblxuLyoqXG4gKiBJbnNlcnRzIHNoYWRlciBjb2RlIGJlZm9yZSBkZXRlY3RlZCBwYXJ0LlxuICogQHBhcmFtIHtzdHJpbmd9IHZzIE9yaWdpbmFsIHNoYWRlciBjb2RlLlxuICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgRGVidWcgc3RyaW5nLlxuICogQHBhcmFtIHtzdHJpbmd9IGluc2VydEJlZm9yZVRleHQgVGV4dCBjaHVuayB0byBpbnNlcnQgYmVmb3JlLlxuICogQHBhcmFtIHtzdHJpbmd9IHRleHRUb0luc2VydCBUZXh0IHRvIGluc2VydC5cbiAqIEByZXR1cm5zIE1vZGlmaWVkIHNoYWRlciBjb2RlLlxuICovXG5leHBvcnQgZnVuY3Rpb24gaW5zZXJ0QmVmb3JlKHZzLCB0eXBlLCBpbnNlcnRCZWZvcmVUZXh0LCB0ZXh0VG9JbnNlcnQpIHtcbiAgY29uc3QgYXQgPSB2cy5pbmRleE9mKGluc2VydEJlZm9yZVRleHQpO1xuICBpZiAoYXQgPCAwKSB7XG4gICAgQ29uc29sZS5lcnJvcihgQ2Fubm90IGVkaXQgJHt0eXBlfSBsYXllciBzaGFkZXJgKTtcbiAgICByZXR1cm4gdnM7XG4gIH1cblxuICByZXR1cm4gdnMuc2xpY2UoMCwgYXQpICsgdGV4dFRvSW5zZXJ0ICsgdnMuc2xpY2UoYXQpO1xufVxuXG5jb25zdCBDdXN0b21TaGFkb3dNb2R1bGUgPSBzaGFkb3cgPyB7Li4uc2hhZG93fSA6IHVuZGVmaW5lZDtcblxuLyoqXG4gKiBDdXN0b20gc2hhZG93IG1vZHVsZVxuICogMSkgQWRkIHVfb3V0cHV0VW5pZm9ybVNoYWRvdyB1bmlmb3JtXG4gKiAyKSBhbHdheXMgcHJvZHVjZSBmdWxsIHNoYWRvdyB3aGVuIHRoZSB1bmlmb3JtIGlzIHNldCB0byB0cnVlLlxuICovXG5DdXN0b21TaGFkb3dNb2R1bGUuZnMgPSBpbnNlcnRCZWZvcmUoXG4gIEN1c3RvbVNoYWRvd01vZHVsZS5mcyxcbiAgJ2N1c3RvbSBzaGFkb3cgIzEnLFxuICAndW5pZm9ybSB2ZWM0IHNoYWRvd191Q29sb3I7JyxcbiAgJ3VuaWZvcm0gYm9vbCB1X291dHB1dFVuaWZvcm1TaGFkb3c7J1xuKTtcblxuQ3VzdG9tU2hhZG93TW9kdWxlLmZzID0gaW5zZXJ0QmVmb3JlKFxuICBDdXN0b21TaGFkb3dNb2R1bGUuZnMsXG4gICdjdXN0b20gc2hhZG93ICMxJyxcbiAgJ3ZlYzQgcmdiYURlcHRoID0gdGV4dHVyZTJEKHNoYWRvd01hcCwgcG9zaXRpb24ueHkpOycsXG4gICdpZih1X291dHB1dFVuaWZvcm1TaGFkb3cpIHJldHVybiAxLjA7J1xuKTtcblxuQ3VzdG9tU2hhZG93TW9kdWxlLmdldFVuaWZvcm1zID0gKG9wdHMgPSB7fSwgY29udGV4dCA9IHt9KSA9PiB7XG4gIGNvbnN0IHUgPSBzaGFkb3cuZ2V0VW5pZm9ybXMob3B0cywgY29udGV4dCk7XG4gIGlmIChvcHRzLm91dHB1dFVuaWZvcm1TaGFkb3cgIT09IHVuZGVmaW5lZCkge1xuICAgIHVbJ3Vfb3V0cHV0VW5pZm9ybVNoYWRvdyddID0gb3B0cy5vdXRwdXRVbmlmb3JtU2hhZG93O1xuICB9XG4gIHJldHVybiB1O1xufTtcblxuLyoqXG4gKiBDdXN0b20gTGlnaHRpbmdFZmZlY3RcbiAqIDEpIGFkZHMgQ3VzdG9tU2hhZG93TW9kdWxlXG4gKiAyKSBwYXNzIG91dHB1dFVuaWZvcm1TaGFkb3cgYXMgbW9kdWxlIHBhcmFtZXRlcnNcbiAqIDMpIHByb3Blcmx5IHJlbW92ZXMgQ3VzdG9tU2hhZG93TW9kdWxlXG4gKi9cbmNsYXNzIEN1c3RvbURlY2tMaWdodGluZ0VmZmVjdCBleHRlbmRzIExpZ2h0aW5nRWZmZWN0IHtcbiAgY29uc3RydWN0b3IocHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcyk7XG4gICAgdGhpcy51c2VPdXRwdXRVbmlmb3JtU2hhZG93ID0gZmFsc2U7XG4gIH1cblxuICBwcmVSZW5kZXIoZ2wsIHtsYXllcnMsIGxheWVyRmlsdGVyLCB2aWV3cG9ydHMsIG9uVmlld3BvcnRBY3RpdmUsIHZpZXdzfSkge1xuICAgIGlmICghdGhpcy5zaGFkb3cpIHJldHVybjtcblxuICAgIC8vIGNyZWF0ZSBsaWdodCBtYXRyaXggZXZlcnkgZnJhbWUgdG8gbWFrZSBzdXJlIGFsd2F5cyB1cGRhdGVkIGZyb20gbGlnaHQgc291cmNlXG4gICAgdGhpcy5zaGFkb3dNYXRyaWNlcyA9IHRoaXMuX2NhbGN1bGF0ZU1hdHJpY2VzKCk7XG5cbiAgICBpZiAodGhpcy5zaGFkb3dQYXNzZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aGlzLl9jcmVhdGVTaGFkb3dQYXNzZXMoZ2wpO1xuICAgIH1cbiAgICBpZiAoIXRoaXMucHJvZ3JhbU1hbmFnZXIpIHtcbiAgICAgIHRoaXMucHJvZ3JhbU1hbmFnZXIgPSBQcm9ncmFtTWFuYWdlci5nZXREZWZhdWx0UHJvZ3JhbU1hbmFnZXIoZ2wpO1xuICAgICAgaWYgKEN1c3RvbVNoYWRvd01vZHVsZSkge1xuICAgICAgICB0aGlzLnByb2dyYW1NYW5hZ2VyLmFkZERlZmF1bHRNb2R1bGUoQ3VzdG9tU2hhZG93TW9kdWxlKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuZHVtbXlTaGFkb3dNYXApIHtcbiAgICAgIHRoaXMuZHVtbXlTaGFkb3dNYXAgPSBuZXcgVGV4dHVyZTJEKGdsLCB7XG4gICAgICAgIHdpZHRoOiAxLFxuICAgICAgICBoZWlnaHQ6IDFcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5zaGFkb3dQYXNzZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHNoYWRvd1Bhc3MgPSB0aGlzLnNoYWRvd1Bhc3Nlc1tpXTtcbiAgICAgIHNoYWRvd1Bhc3MucmVuZGVyKHtcbiAgICAgICAgbGF5ZXJzLFxuICAgICAgICBsYXllckZpbHRlcixcbiAgICAgICAgdmlld3BvcnRzLFxuICAgICAgICBvblZpZXdwb3J0QWN0aXZlLFxuICAgICAgICB2aWV3cyxcbiAgICAgICAgbW9kdWxlUGFyYW1ldGVyczoge1xuICAgICAgICAgIHNoYWRvd0xpZ2h0SWQ6IGksXG4gICAgICAgICAgZHVtbXlTaGFkb3dNYXA6IHRoaXMuZHVtbXlTaGFkb3dNYXAsXG4gICAgICAgICAgc2hhZG93TWF0cmljZXM6IHRoaXMuc2hhZG93TWF0cmljZXMsXG4gICAgICAgICAgdXNlT3V0cHV0VW5pZm9ybVNoYWRvdzogZmFsc2VcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0TW9kdWxlUGFyYW1ldGVycyhsYXllcikge1xuICAgIGNvbnN0IHBhcmFtZXRlcnMgPSBzdXBlci5nZXRNb2R1bGVQYXJhbWV0ZXJzKGxheWVyKTtcbiAgICBwYXJhbWV0ZXJzLm91dHB1dFVuaWZvcm1TaGFkb3cgPSB0aGlzLm91dHB1dFVuaWZvcm1TaGFkb3c7XG4gICAgcmV0dXJuIHBhcmFtZXRlcnM7XG4gIH1cblxuICBjbGVhbnVwKCkge1xuICAgIGZvciAoY29uc3Qgc2hhZG93UGFzcyBvZiB0aGlzLnNoYWRvd1Bhc3Nlcykge1xuICAgICAgc2hhZG93UGFzcy5kZWxldGUoKTtcbiAgICB9XG4gICAgdGhpcy5zaGFkb3dQYXNzZXMubGVuZ3RoID0gMDtcbiAgICB0aGlzLnNoYWRvd01hcHMubGVuZ3RoID0gMDtcblxuICAgIGlmICh0aGlzLmR1bW15U2hhZG93TWFwKSB7XG4gICAgICB0aGlzLmR1bW15U2hhZG93TWFwLmRlbGV0ZSgpO1xuICAgICAgdGhpcy5kdW1teVNoYWRvd01hcCA9IG51bGw7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuc2hhZG93ICYmIHRoaXMucHJvZ3JhbU1hbmFnZXIpIHtcbiAgICAgIHRoaXMucHJvZ3JhbU1hbmFnZXIucmVtb3ZlRGVmYXVsdE1vZHVsZShDdXN0b21TaGFkb3dNb2R1bGUpO1xuICAgICAgdGhpcy5wcm9ncmFtTWFuYWdlciA9IG51bGw7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEN1c3RvbURlY2tMaWdodGluZ0VmZmVjdDtcbiJdfQ==