"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _window = _interopRequireDefault(require("global/window"));

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = (0, _getPrototypeOf2["default"])(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = (0, _getPrototypeOf2["default"])(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return (0, _possibleConstructorReturn2["default"])(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }

/** @typedef {import('./file-drop').FileDropProps} FileDropProps */

/** @augments React.PureComponent<FileDropProps> */
var FileDrop = /*#__PURE__*/function (_React$PureComponent) {
  (0, _inherits2["default"])(FileDrop, _React$PureComponent);

  var _super = _createSuper(FileDrop);

  function FileDrop() {
    var _this;

    (0, _classCallCheck2["default"])(this, FileDrop);

    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    _this = _super.call.apply(_super, [this].concat(args));
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "frameDragCounter", 0);
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "state", {
      draggingOverFrame: false,
      draggingOverTarget: false
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "resetDragging", function () {
      _this.frameDragCounter = 0;

      _this.setState({
        draggingOverFrame: false,
        draggingOverTarget: false
      });
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "handleWindowDragOverOrDrop", function (event) {
      // This prevents the browser from trying to load whatever file the user dropped on the window
      event.preventDefault();
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "handleFrameDrag", function (event) {
      // Only allow dragging of files
      if (!FileDrop.eventHasFiles(event)) return; // We are listening for events on the 'frame', so every time the user drags over any element in the frame's tree,
      // the event bubbles up to the frame. By keeping count of how many "dragenters" we get, we can tell if they are still
      // "draggingOverFrame" (b/c you get one "dragenter" initially, and one "dragenter"/one "dragleave" for every bubble)
      // This is far better than a "dragover" handler, which would be calling `setState` continuously.

      _this.frameDragCounter += event.type === 'dragenter' ? 1 : -1;

      if (_this.frameDragCounter === 1) {
        _this.setState({
          draggingOverFrame: true
        });

        if (_this.props.onFrameDragEnter) _this.props.onFrameDragEnter(event);
        return;
      }

      if (_this.frameDragCounter === 0) {
        _this.setState({
          draggingOverFrame: false
        });

        if (_this.props.onFrameDragLeave) _this.props.onFrameDragLeave(event);
        return;
      }
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "handleFrameDrop", function (event) {
      event.preventDefault();

      if (!_this.state.draggingOverTarget) {
        _this.resetDragging();

        if (_this.props.onFrameDrop) _this.props.onFrameDrop(event);
      }
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "handleDragOver", function (event) {
      if (FileDrop.eventHasFiles(event)) {
        _this.setState({
          draggingOverTarget: true
        });

        if (!FileDrop.isIE() && _this.props.dropEffect) event.dataTransfer.dropEffect = _this.props.dropEffect;
        if (_this.props.onDragOver) _this.props.onDragOver(event);
      }
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "handleDragLeave", function (event) {
      _this.setState({
        draggingOverTarget: false
      });

      if (_this.props.onDragLeave) _this.props.onDragLeave(event);
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "handleDrop", function (event) {
      if (_this.props.onDrop && FileDrop.eventHasFiles(event)) {
        var files = event.dataTransfer ? event.dataTransfer.files : null;

        _this.props.onDrop(files, event);
      }

      _this.resetDragging();
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "stopFrameListeners", function (frame) {
      if (frame) {
        frame.removeEventListener('dragenter', _this.handleFrameDrag);
        frame.removeEventListener('dragleave', _this.handleFrameDrag);
        frame.removeEventListener('drop', _this.handleFrameDrop);
      }
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "startFrameListeners", function (frame) {
      if (frame) {
        frame.addEventListener('dragenter', _this.handleFrameDrag);
        frame.addEventListener('dragleave', _this.handleFrameDrag);
        frame.addEventListener('drop', _this.handleFrameDrop);
      }
    });
    return _this;
  }

  (0, _createClass2["default"])(FileDrop, [{
    key: "componentDidMount",
    value: function componentDidMount() {
      this.startFrameListeners(this.props.frame);
      this.resetDragging();

      _window["default"].addEventListener('dragover', this.handleWindowDragOverOrDrop);

      _window["default"].addEventListener('drop', this.handleWindowDragOverOrDrop);
    }
  }, {
    key: "componentDidUpdate",
    value: function componentDidUpdate(prevProps) {
      if (prevProps.frame !== this.props.frame) {
        this.resetDragging();
        this.stopFrameListeners(prevProps.frame);
        this.startFrameListeners(this.props.frame);
      }
    }
  }, {
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      this.stopFrameListeners(this.props.frame);

      _window["default"].removeEventListener('dragover', this.handleWindowDragOverOrDrop);

      _window["default"].removeEventListener('drop', this.handleWindowDragOverOrDrop);
    }
  }, {
    key: "render",
    value: function render() {
      var _this$props = this.props,
          children = _this$props.children,
          className = _this$props.className,
          targetClassName = _this$props.targetClassName,
          draggingOverFrameClassName = _this$props.draggingOverFrameClassName,
          draggingOverTargetClassName = _this$props.draggingOverTargetClassName;
      var _this$state = this.state,
          draggingOverTarget = _this$state.draggingOverTarget,
          draggingOverFrame = _this$state.draggingOverFrame;
      var fileDropTargetClassName = targetClassName;
      if (draggingOverFrame) fileDropTargetClassName += " ".concat(draggingOverFrameClassName);
      if (draggingOverTarget) fileDropTargetClassName += " ".concat(draggingOverTargetClassName);
      return /*#__PURE__*/_react["default"].createElement("div", {
        className: className,
        onDragOver: this.handleDragOver,
        onDragLeave: this.handleDragLeave,
        onDrop: this.handleDrop
      }, /*#__PURE__*/_react["default"].createElement("div", {
        className: fileDropTargetClassName
      }, children));
    }
  }]);
  return FileDrop;
}(_react["default"].PureComponent);

(0, _defineProperty2["default"])(FileDrop, "isIE", function () {
  return _window["default"] && _window["default"].navigator && ((_window["default"].navigator.userAgent || []).includes('MSIE') || (_window["default"].navigator.appVersion || []).includes('Trident/'));
});
(0, _defineProperty2["default"])(FileDrop, "eventHasFiles", function (event) {
  // In most browsers this is an array, but in IE11 it's an Object :(
  var hasFiles = false;

  if (event.dataTransfer) {
    var types = event.dataTransfer.types;

    for (var keyOrIndex in types) {
      if (types[keyOrIndex] === 'Files') {
        hasFiles = true;
        break;
      }
    }
  }

  return hasFiles;
});
(0, _defineProperty2["default"])(FileDrop, "defaultProps", {
  dropEffect: 'copy',
  frame: _window["default"] ? _window["default"].document : undefined,
  className: 'file-drop',
  targetClassName: 'file-drop-target',
  draggingOverFrameClassName: 'file-drop-dragging-over-frame',
  draggingOverTargetClassName: 'file-drop-dragging-over-target'
});
var _default = FileDrop;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21tb24vZmlsZS11cGxvYWRlci9maWxlLWRyb3AudHN4Il0sIm5hbWVzIjpbIkZpbGVEcm9wIiwiZHJhZ2dpbmdPdmVyRnJhbWUiLCJkcmFnZ2luZ092ZXJUYXJnZXQiLCJmcmFtZURyYWdDb3VudGVyIiwic2V0U3RhdGUiLCJldmVudCIsInByZXZlbnREZWZhdWx0IiwiZXZlbnRIYXNGaWxlcyIsInR5cGUiLCJwcm9wcyIsIm9uRnJhbWVEcmFnRW50ZXIiLCJvbkZyYW1lRHJhZ0xlYXZlIiwic3RhdGUiLCJyZXNldERyYWdnaW5nIiwib25GcmFtZURyb3AiLCJpc0lFIiwiZHJvcEVmZmVjdCIsImRhdGFUcmFuc2ZlciIsIm9uRHJhZ092ZXIiLCJvbkRyYWdMZWF2ZSIsIm9uRHJvcCIsImZpbGVzIiwiZnJhbWUiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwiaGFuZGxlRnJhbWVEcmFnIiwiaGFuZGxlRnJhbWVEcm9wIiwiYWRkRXZlbnRMaXN0ZW5lciIsInN0YXJ0RnJhbWVMaXN0ZW5lcnMiLCJ3aW5kb3ciLCJoYW5kbGVXaW5kb3dEcmFnT3Zlck9yRHJvcCIsInByZXZQcm9wcyIsInN0b3BGcmFtZUxpc3RlbmVycyIsImNoaWxkcmVuIiwiY2xhc3NOYW1lIiwidGFyZ2V0Q2xhc3NOYW1lIiwiZHJhZ2dpbmdPdmVyRnJhbWVDbGFzc05hbWUiLCJkcmFnZ2luZ092ZXJUYXJnZXRDbGFzc05hbWUiLCJmaWxlRHJvcFRhcmdldENsYXNzTmFtZSIsImhhbmRsZURyYWdPdmVyIiwiaGFuZGxlRHJhZ0xlYXZlIiwiaGFuZGxlRHJvcCIsIlJlYWN0IiwiUHVyZUNvbXBvbmVudCIsIm5hdmlnYXRvciIsInVzZXJBZ2VudCIsImluY2x1ZGVzIiwiYXBwVmVyc2lvbiIsImhhc0ZpbGVzIiwidHlwZXMiLCJrZXlPckluZGV4IiwiZG9jdW1lbnQiLCJ1bmRlZmluZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBT0E7O0FB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U0FBakIsSUFBOEIsRUFBL0IsRUFBbUNDLFFBQW5DLENBQTRDLE1BQTVDLEtBQ0MsQ0FBQ2pCLG1CQUFPZSxTQUFQLENBQWlCRyxVQUFqQixJQUErQixFQUFoQyxFQUFvQ0QsUUFBcEMsQ0FBNkMsVUFBN0MsQ0FIRixDQURZO0FBQUEsQztpQ0FEVjdDLFEsbUJBT21CLFVBQUFLLEtBQUssRUFBSTtBQUM5QjtBQUVBLE1BQUkwQyxRQUFRLEdBQUcsS0FBZjs7QUFDQSxNQUFJMUMsS0FBSyxDQUFDWSxZQUFWLEVBQXdCO0FBQ3RCLFFBQU0rQixLQUFLLEdBQUczQyxLQUFLLENBQUNZLFlBQU4sQ0FBbUIrQixLQUFqQzs7QUFDQSxTQUFLLElBQU1DLFVBQVgsSUFBeUJELEtBQXpCLEVBQWdDO0FBQzlCLFVBQUlBLEtBQUssQ0FBQ0MsVUFBRCxDQUFMLEtBQXNCLE9BQTFCLEVBQW1DO0FBQ2pDRixRQUFBQSxRQUFRLEdBQUcsSUFBWDtBQUNBO0FBQ0Q7QUFDRjtBQUNGOztBQUNELFNBQU9BLFFBQVA7QUFDRCxDO2lDQXJCRy9DLFEsa0JBdUJrQjtBQUNwQmdCLEVBQUFBLFVBQVUsRUFBRSxNQURRO0FBRXBCTSxFQUFBQSxLQUFLLEVBQUVNLHFCQUFTQSxtQkFBT3NCLFFBQWhCLEdBQTJCQyxTQUZkO0FBR3BCbEIsRUFBQUEsU0FBUyxFQUFFLFdBSFM7QUFJcEJDLEVBQUFBLGVBQWUsRUFBRSxrQkFKRztBQUtwQkMsRUFBQUEsMEJBQTBCLEVBQUUsK0JBTFI7QUFNcEJDLEVBQUFBLDJCQUEyQixFQUFFO0FBTlQsQztlQTJJVHBDLFEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTUlUXG4vLyBDb3B5cmlnaHQgY29udHJpYnV0b3JzIHRvIHRoZSBrZXBsZXIuZ2wgcHJvamVjdFxuXG4vKipcbiAqIENvcGllZCBmcm9tIGh0dHBzOi8vZ2l0aHViLmNvbS9zYXJpbmsvcmVhY3QtZmlsZS1kcm9wXG4gKiBGb3IgUmVhY3QgMTYuOCBjb21wYXRpYmlsaXR5XG4gKi9cbmltcG9ydCBSZWFjdCwge1JlYWN0Tm9kZX0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHdpbmRvdyBmcm9tICdnbG9iYWwvd2luZG93JztcblxuZXhwb3J0IHR5cGUgRmlsZURyb3BQcm9wcyA9IHtcbiAgZHJvcEVmZmVjdD86ICdjb3B5JyB8ICdtb3ZlJyB8ICdsaW5rJyB8ICdub25lJztcbiAgZnJhbWU/OiB0eXBlb2YgZG9jdW1lbnQgfCB0eXBlb2Ygd2luZG93IHwgSFRNTEVsZW1lbnQ7XG4gIGNsYXNzTmFtZT86IHN0cmluZztcbiAgdGFyZ2V0Q2xhc3NOYW1lPzogc3RyaW5nO1xuICBkcmFnZ2luZ092ZXJGcmFtZUNsYXNzTmFtZT86IHN0cmluZztcbiAgZHJhZ2dpbmdPdmVyVGFyZ2V0Q2xhc3NOYW1lPzogc3RyaW5nO1xuICBvbkRyYWdPdmVyPzogKGV2ZW50OiBhbnkpID0+IHZvaWQ7XG4gIG9uRHJhZ0xlYXZlPzogKGV2ZW50OiBhbnkpID0+IHZvaWQ7XG4gIG9uRHJvcD86IChmaWxlTGlzdDogRmlsZUxpc3QsIGV2ZW50OiBhbnkpID0+IHZvaWQ7XG4gIG9uRnJhbWVEcmFnRW50ZXI/OiAoZXZlbnQ6IGFueSkgPT4gdm9pZDtcbiAgb25GcmFtZURyYWdMZWF2ZT86IChldmVudDogYW55KSA9PiB2b2lkO1xuICBvbkZyYW1lRHJvcD86IChldmVudDogYW55KSA9PiB2b2lkO1xuICBjaGlsZHJlbj86IFJlYWN0Tm9kZTtcbn07XG5cbi8qKiBAdHlwZWRlZiB7aW1wb3J0KCcuL2ZpbGUtZHJvcCcpLkZpbGVEcm9wUHJvcHN9IEZpbGVEcm9wUHJvcHMgKi9cblxuLyoqIEBhdWdtZW50cyBSZWFjdC5QdXJlQ29tcG9uZW50PEZpbGVEcm9wUHJvcHM+ICovXG5jbGFzcyBGaWxlRHJvcCBleHRlbmRzIFJlYWN0LlB1cmVDb21wb25lbnQ8RmlsZURyb3BQcm9wcz4ge1xuICBzdGF0aWMgaXNJRSA9ICgpID0+XG4gICAgd2luZG93ICYmXG4gICAgd2luZG93Lm5hdmlnYXRvciAmJlxuICAgICgod2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQgfHwgW10pLmluY2x1ZGVzKCdNU0lFJykgfHxcbiAgICAgICh3aW5kb3cubmF2aWdhdG9yLmFwcFZlcnNpb24gfHwgW10pLmluY2x1ZGVzKCdUcmlkZW50LycpKTtcblxuICBzdGF0aWMgZXZlbnRIYXNGaWxlcyA9IGV2ZW50ID0+IHtcbiAgICAvLyBJbiBtb3N0IGJyb3dzZXJzIHRoaXMgaXMgYW4gYXJyYXksIGJ1dCBpbiBJRTExIGl0J3MgYW4gT2JqZWN0IDooXG5cbiAgICBsZXQgaGFzRmlsZXMgPSBmYWxzZTtcbiAgICBpZiAoZXZlbnQuZGF0YVRyYW5zZmVyKSB7XG4gICAgICBjb25zdCB0eXBlcyA9IGV2ZW50LmRhdGFUcmFuc2Zlci50eXBlcztcbiAgICAgIGZvciAoY29uc3Qga2V5T3JJbmRleCBpbiB0eXBlcykge1xuICAgICAgICBpZiAodHlwZXNba2V5T3JJbmRleF0gPT09ICdGaWxlcycpIHtcbiAgICAgICAgICBoYXNGaWxlcyA9IHRydWU7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGhhc0ZpbGVzO1xuICB9O1xuXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgZHJvcEVmZmVjdDogJ2NvcHknLFxuICAgIGZyYW1lOiB3aW5kb3cgPyB3aW5kb3cuZG9jdW1lbnQgOiB1bmRlZmluZWQsXG4gICAgY2xhc3NOYW1lOiAnZmlsZS1kcm9wJyxcbiAgICB0YXJnZXRDbGFzc05hbWU6ICdmaWxlLWRyb3AtdGFyZ2V0JyxcbiAgICBkcmFnZ2luZ092ZXJGcmFtZUNsYXNzTmFtZTogJ2ZpbGUtZHJvcC1kcmFnZ2luZy1vdmVyLWZyYW1lJyxcbiAgICBkcmFnZ2luZ092ZXJUYXJnZXRDbGFzc05hbWU6ICdmaWxlLWRyb3AtZHJhZ2dpbmctb3Zlci10YXJnZXQnXG4gIH07XG5cbiAgZnJhbWVEcmFnQ291bnRlciA9IDA7XG4gIHN0YXRlID0ge2RyYWdnaW5nT3ZlckZyYW1lOiBmYWxzZSwgZHJhZ2dpbmdPdmVyVGFyZ2V0OiBmYWxzZX07XG5cbiAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgdGhpcy5zdGFydEZyYW1lTGlzdGVuZXJzKHRoaXMucHJvcHMuZnJhbWUpO1xuICAgIHRoaXMucmVzZXREcmFnZ2luZygpO1xuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdkcmFnb3ZlcicsIHRoaXMuaGFuZGxlV2luZG93RHJhZ092ZXJPckRyb3ApO1xuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdkcm9wJywgdGhpcy5oYW5kbGVXaW5kb3dEcmFnT3Zlck9yRHJvcCk7XG4gIH1cblxuICBjb21wb25lbnREaWRVcGRhdGUocHJldlByb3BzKSB7XG4gICAgaWYgKHByZXZQcm9wcy5mcmFtZSAhPT0gdGhpcy5wcm9wcy5mcmFtZSkge1xuICAgICAgdGhpcy5yZXNldERyYWdnaW5nKCk7XG4gICAgICB0aGlzLnN0b3BGcmFtZUxpc3RlbmVycyhwcmV2UHJvcHMuZnJhbWUpO1xuICAgICAgdGhpcy5zdGFydEZyYW1lTGlzdGVuZXJzKHRoaXMucHJvcHMuZnJhbWUpO1xuICAgIH1cbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIHRoaXMuc3RvcEZyYW1lTGlzdGVuZXJzKHRoaXMucHJvcHMuZnJhbWUpO1xuICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdkcmFnb3ZlcicsIHRoaXMuaGFuZGxlV2luZG93RHJhZ092ZXJPckRyb3ApO1xuICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdkcm9wJywgdGhpcy5oYW5kbGVXaW5kb3dEcmFnT3Zlck9yRHJvcCk7XG4gIH1cblxuICByZXNldERyYWdnaW5nID0gKCkgPT4ge1xuICAgIHRoaXMuZnJhbWVEcmFnQ291bnRlciA9IDA7XG4gICAgdGhpcy5zZXRTdGF0ZSh7ZHJhZ2dpbmdPdmVyRnJhbWU6IGZhbHNlLCBkcmFnZ2luZ092ZXJUYXJnZXQ6IGZhbHNlfSk7XG4gIH07XG5cbiAgaGFuZGxlV2luZG93RHJhZ092ZXJPckRyb3AgPSBldmVudCA9PiB7XG4gICAgLy8gVGhpcyBwcmV2ZW50cyB0aGUgYnJvd3NlciBmcm9tIHRyeWluZyB0byBsb2FkIHdoYXRldmVyIGZpbGUgdGhlIHVzZXIgZHJvcHBlZCBvbiB0aGUgd2luZG93XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgfTtcblxuICBoYW5kbGVGcmFtZURyYWcgPSBldmVudCA9PiB7XG4gICAgLy8gT25seSBhbGxvdyBkcmFnZ2luZyBvZiBmaWxlc1xuICAgIGlmICghRmlsZURyb3AuZXZlbnRIYXNGaWxlcyhldmVudCkpIHJldHVybjtcblxuICAgIC8vIFdlIGFyZSBsaXN0ZW5pbmcgZm9yIGV2ZW50cyBvbiB0aGUgJ2ZyYW1lJywgc28gZXZlcnkgdGltZSB0aGUgdXNlciBkcmFncyBvdmVyIGFueSBlbGVtZW50IGluIHRoZSBmcmFtZSdzIHRyZWUsXG4gICAgLy8gdGhlIGV2ZW50IGJ1YmJsZXMgdXAgdG8gdGhlIGZyYW1lLiBCeSBrZWVwaW5nIGNvdW50IG9mIGhvdyBtYW55IFwiZHJhZ2VudGVyc1wiIHdlIGdldCwgd2UgY2FuIHRlbGwgaWYgdGhleSBhcmUgc3RpbGxcbiAgICAvLyBcImRyYWdnaW5nT3ZlckZyYW1lXCIgKGIvYyB5b3UgZ2V0IG9uZSBcImRyYWdlbnRlclwiIGluaXRpYWxseSwgYW5kIG9uZSBcImRyYWdlbnRlclwiL29uZSBcImRyYWdsZWF2ZVwiIGZvciBldmVyeSBidWJibGUpXG4gICAgLy8gVGhpcyBpcyBmYXIgYmV0dGVyIHRoYW4gYSBcImRyYWdvdmVyXCIgaGFuZGxlciwgd2hpY2ggd291bGQgYmUgY2FsbGluZyBgc2V0U3RhdGVgIGNvbnRpbnVvdXNseS5cbiAgICB0aGlzLmZyYW1lRHJhZ0NvdW50ZXIgKz0gZXZlbnQudHlwZSA9PT0gJ2RyYWdlbnRlcicgPyAxIDogLTE7XG5cbiAgICBpZiAodGhpcy5mcmFtZURyYWdDb3VudGVyID09PSAxKSB7XG4gICAgICB0aGlzLnNldFN0YXRlKHtkcmFnZ2luZ092ZXJGcmFtZTogdHJ1ZX0pO1xuICAgICAgaWYgKHRoaXMucHJvcHMub25GcmFtZURyYWdFbnRlcikgdGhpcy5wcm9wcy5vbkZyYW1lRHJhZ0VudGVyKGV2ZW50KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5mcmFtZURyYWdDb3VudGVyID09PSAwKSB7XG4gICAgICB0aGlzLnNldFN0YXRlKHtkcmFnZ2luZ092ZXJGcmFtZTogZmFsc2V9KTtcbiAgICAgIGlmICh0aGlzLnByb3BzLm9uRnJhbWVEcmFnTGVhdmUpIHRoaXMucHJvcHMub25GcmFtZURyYWdMZWF2ZShldmVudCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9O1xuXG4gIGhhbmRsZUZyYW1lRHJvcCA9IGV2ZW50ID0+IHtcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGlmICghdGhpcy5zdGF0ZS5kcmFnZ2luZ092ZXJUYXJnZXQpIHtcbiAgICAgIHRoaXMucmVzZXREcmFnZ2luZygpO1xuICAgICAgaWYgKHRoaXMucHJvcHMub25GcmFtZURyb3ApIHRoaXMucHJvcHMub25GcmFtZURyb3AoZXZlbnQpO1xuICAgIH1cbiAgfTtcblxuICBoYW5kbGVEcmFnT3ZlciA9IGV2ZW50ID0+IHtcbiAgICBpZiAoRmlsZURyb3AuZXZlbnRIYXNGaWxlcyhldmVudCkpIHtcbiAgICAgIHRoaXMuc2V0U3RhdGUoe2RyYWdnaW5nT3ZlclRhcmdldDogdHJ1ZX0pO1xuICAgICAgaWYgKCFGaWxlRHJvcC5pc0lFKCkgJiYgdGhpcy5wcm9wcy5kcm9wRWZmZWN0KVxuICAgICAgICBldmVudC5kYXRhVHJhbnNmZXIuZHJvcEVmZmVjdCA9IHRoaXMucHJvcHMuZHJvcEVmZmVjdDtcbiAgICAgIGlmICh0aGlzLnByb3BzLm9uRHJhZ092ZXIpIHRoaXMucHJvcHMub25EcmFnT3ZlcihldmVudCk7XG4gICAgfVxuICB9O1xuXG4gIGhhbmRsZURyYWdMZWF2ZSA9IGV2ZW50ID0+IHtcbiAgICB0aGlzLnNldFN0YXRlKHtkcmFnZ2luZ092ZXJUYXJnZXQ6IGZhbHNlfSk7XG4gICAgaWYgKHRoaXMucHJvcHMub25EcmFnTGVhdmUpIHRoaXMucHJvcHMub25EcmFnTGVhdmUoZXZlbnQpO1xuICB9O1xuXG4gIGhhbmRsZURyb3AgPSBldmVudCA9PiB7XG4gICAgaWYgKHRoaXMucHJvcHMub25Ecm9wICYmIEZpbGVEcm9wLmV2ZW50SGFzRmlsZXMoZXZlbnQpKSB7XG4gICAgICBjb25zdCBmaWxlcyA9IGV2ZW50LmRhdGFUcmFuc2ZlciA/IGV2ZW50LmRhdGFUcmFuc2Zlci5maWxlcyA6IG51bGw7XG4gICAgICB0aGlzLnByb3BzLm9uRHJvcChmaWxlcywgZXZlbnQpO1xuICAgIH1cbiAgICB0aGlzLnJlc2V0RHJhZ2dpbmcoKTtcbiAgfTtcblxuICBzdG9wRnJhbWVMaXN0ZW5lcnMgPSBmcmFtZSA9PiB7XG4gICAgaWYgKGZyYW1lKSB7XG4gICAgICBmcmFtZS5yZW1vdmVFdmVudExpc3RlbmVyKCdkcmFnZW50ZXInLCB0aGlzLmhhbmRsZUZyYW1lRHJhZyk7XG4gICAgICBmcmFtZS5yZW1vdmVFdmVudExpc3RlbmVyKCdkcmFnbGVhdmUnLCB0aGlzLmhhbmRsZUZyYW1lRHJhZyk7XG4gICAgICBmcmFtZS5yZW1vdmVFdmVudExpc3RlbmVyKCdkcm9wJywgdGhpcy5oYW5kbGVGcmFtZURyb3ApO1xuICAgIH1cbiAgfTtcblxuICBzdGFydEZyYW1lTGlzdGVuZXJzID0gZnJhbWUgPT4ge1xuICAgIGlmIChmcmFtZSkge1xuICAgICAgZnJhbWUuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ2VudGVyJywgdGhpcy5oYW5kbGVGcmFtZURyYWcpO1xuICAgICAgZnJhbWUuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ2xlYXZlJywgdGhpcy5oYW5kbGVGcmFtZURyYWcpO1xuICAgICAgZnJhbWUuYWRkRXZlbnRMaXN0ZW5lcignZHJvcCcsIHRoaXMuaGFuZGxlRnJhbWVEcm9wKTtcbiAgICB9XG4gIH07XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHtcbiAgICAgIGNoaWxkcmVuLFxuICAgICAgY2xhc3NOYW1lLFxuICAgICAgdGFyZ2V0Q2xhc3NOYW1lLFxuICAgICAgZHJhZ2dpbmdPdmVyRnJhbWVDbGFzc05hbWUsXG4gICAgICBkcmFnZ2luZ092ZXJUYXJnZXRDbGFzc05hbWVcbiAgICB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCB7ZHJhZ2dpbmdPdmVyVGFyZ2V0LCBkcmFnZ2luZ092ZXJGcmFtZX0gPSB0aGlzLnN0YXRlO1xuXG4gICAgbGV0IGZpbGVEcm9wVGFyZ2V0Q2xhc3NOYW1lID0gdGFyZ2V0Q2xhc3NOYW1lO1xuICAgIGlmIChkcmFnZ2luZ092ZXJGcmFtZSkgZmlsZURyb3BUYXJnZXRDbGFzc05hbWUgKz0gYCAke2RyYWdnaW5nT3ZlckZyYW1lQ2xhc3NOYW1lfWA7XG4gICAgaWYgKGRyYWdnaW5nT3ZlclRhcmdldCkgZmlsZURyb3BUYXJnZXRDbGFzc05hbWUgKz0gYCAke2RyYWdnaW5nT3ZlclRhcmdldENsYXNzTmFtZX1gO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXZcbiAgICAgICAgY2xhc3NOYW1lPXtjbGFzc05hbWV9XG4gICAgICAgIG9uRHJhZ092ZXI9e3RoaXMuaGFuZGxlRHJhZ092ZXJ9XG4gICAgICAgIG9uRHJhZ0xlYXZlPXt0aGlzLmhhbmRsZURyYWdMZWF2ZX1cbiAgICAgICAgb25Ecm9wPXt0aGlzLmhhbmRsZURyb3B9XG4gICAgICA+XG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPXtmaWxlRHJvcFRhcmdldENsYXNzTmFtZX0+e2NoaWxkcmVufTwvZGl2PlxuICAgICAgPC9kaXY+XG4gICAgKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBGaWxlRHJvcDtcbiJdfQ==