"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.findFieldsToShow = findFieldsToShow;
exports.getTooltipDisplayDeltaValue = getTooltipDisplayDeltaValue;
exports.getTooltipDisplayValue = getTooltipDisplayValue;
exports.BRUSH_CONFIG = exports.NEGATIVE_SIGNS = exports.TOOLTIP_MINUS_SIGN = void 0;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _constants = require("@kepler.gl/constants");

var _utils = require("@kepler.gl/utils");

// SPDX-License-Identifier: MIT
// Copyright contributors to the kepler.gl project

/**
 * Minus sign used in tooltip formatting.
 * \u2212 or \u002D is the minus sign that d3-format uses for decimal number formatting
 * d3-format 2.0 uses \u002D
 */
var TOOLTIP_MINUS_SIGN = "\u2212"; // both are posible negative signs

exports.TOOLTIP_MINUS_SIGN = TOOLTIP_MINUS_SIGN;
var NEGATIVE_SIGNS = ["-", "\u2212"];
exports.NEGATIVE_SIGNS = NEGATIVE_SIGNS;
var BRUSH_CONFIG = {
  range: [0, 50]
};
exports.BRUSH_CONFIG = BRUSH_CONFIG;

function findFieldsToShow(_ref) {
  var fields = _ref.fields,
      id = _ref.id,
      maxDefaultTooltips = _ref.maxDefaultTooltips;

  // first find default tooltip fields for trips
  var fieldsToShow = _constants.DEFAULT_TOOLTIP_FIELDS.reduce(function (prev, curr) {
    if (fields.find(function (_ref2) {
      var name = _ref2.name;
      return curr.name === name;
    })) {
      // @ts-ignore
      prev.push(curr);
    }

    return prev;
  }, []);

  return (0, _defineProperty2["default"])({}, id, fieldsToShow.length ? fieldsToShow : autoFindTooltipFields(fields, maxDefaultTooltips));
}

function autoFindTooltipFields(fields, maxDefaultTooltips) {
  var ptFields = _mergeFieldPairs(_constants.TRIP_POINT_FIELDS); // filter out the default fields that contains lat and lng and any geometry


  var fieldsToShow = fields.filter(function (_ref4) {
    var name = _ref4.name,
        type = _ref4.type;
    return name.replace(/[_,.]+/g, ' ').trim().split(' ').every(function (seg) {
      return !ptFields.includes(seg);
    }) && type !== _constants.ALL_FIELD_TYPES.geojson && type !== _constants.ALL_FIELD_TYPES.geoarrow && type !== 'object';
  });
  return fieldsToShow.slice(0, maxDefaultTooltips).map(function (_ref5) {
    var name = _ref5.name;
    return {
      name: name,
      format: null
    };
  });
}

function _mergeFieldPairs(pairs) {
  return pairs.reduce(function (prev, pair) {
    return [].concat((0, _toConsumableArray2["default"])(prev), (0, _toConsumableArray2["default"])(pair));
  }, []);
}

function getTooltipDisplayDeltaValue(_ref6) {
  var primaryData = _ref6.primaryData,
      field = _ref6.field,
      compareType = _ref6.compareType,
      data = _ref6.data,
      fieldIdx = _ref6.fieldIdx;
  var displayDeltaValue = null;

  if (primaryData && ( // comparison mode only works for numeric field
  field.type === _constants.ALL_FIELD_TYPES.integer || field.type === _constants.ALL_FIELD_TYPES.real)) {
    var baseDp = primaryData.valueAt(fieldIdx);
    var dp = data.valueAt(fieldIdx);

    if ((0, _utils.isNumber)(baseDp) && (0, _utils.isNumber)(dp)) {
      var deltaValue = compareType === _constants.COMPARE_TYPES.RELATIVE ? dp / baseDp - 1 : dp - baseDp;
      var deltaFormat = compareType === _constants.COMPARE_TYPES.RELATIVE ? _constants.TOOLTIP_FORMATS.DECIMAL_PERCENT_FULL_2[_constants.TOOLTIP_KEY] : field.displayFormat || _constants.TOOLTIP_FORMATS.DECIMAL_DECIMAL_FIXED_3[_constants.TOOLTIP_KEY];
      displayDeltaValue = (0, _utils.getFormatter)(deltaFormat, field)(deltaValue); // safely cast string

      displayDeltaValue = (0, _utils.defaultFormatter)(displayDeltaValue);
      var deltaFirstChar = displayDeltaValue.charAt(0);

      if (deltaFirstChar !== '+' && !NEGATIVE_SIGNS.includes(deltaFirstChar)) {
        displayDeltaValue = "+".concat(displayDeltaValue);
      }
    } else {
      displayDeltaValue = TOOLTIP_MINUS_SIGN;
    }
  }

  return displayDeltaValue;
}

function getTooltipDisplayValue(_ref7) {
  var item = _ref7.item,
      field = _ref7.field,
      value = _ref7.value;

  if (!(0, _utils.notNullorUndefined)(value)) {
    return '';
  }

  return item !== null && item !== void 0 && item.format ? (0, _utils.getFormatter)(item === null || item === void 0 ? void 0 : item.format, field)(value) : field.displayFormat ? (0, _utils.getFormatter)(field.displayFormat, field)(value) : (0, _utils.parseFieldValue)(value, field.type);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbnRlcmFjdGlvbi11dGlscy50cyJdLCJuYW1lcyI6WyJUT09MVElQX01JTlVTX1NJR04iLCJORUdBVElWRV9TSUdOUyIsIkJSVVNIX0NPTkZJRyIsInJhbmdlIiwiZmluZEZpZWxkc1RvU2hvdyIsImZpZWxkcyIsImlkIiwibWF4RGVmYXVsdFRvb2x0aXBzIiwiZmllbGRzVG9TaG93IiwiREVGQVVMVF9UT09MVElQX0ZJRUxEUyIsInJlZHVjZSIsInByZXYiLCJjdXJyIiwiZmluZCIsIm5hbWUiLCJwdXNoIiwibGVuZ3RoIiwiYXV0b0ZpbmRUb29sdGlwRmllbGRzIiwicHRGaWVsZHMiLCJfbWVyZ2VGaWVsZFBhaXJzIiwiVFJJUF9QT0lOVF9GSUVMRFMiLCJmaWx0ZXIiLCJ0eXBlIiwicmVwbGFjZSIsInRyaW0iLCJzcGxpdCIsImV2ZXJ5Iiwic2VnIiwiaW5jbHVkZXMiLCJBTExfRklFTERfVFlQRVMiLCJnZW9qc29uIiwiZ2VvYXJyb3ciLCJzbGljZSIsIm1hcCIsImZvcm1hdCIsInBhaXJzIiwicGFpciIsImdldFRvb2x0aXBEaXNwbGF5RGVsdGFWYWx1ZSIsInByaW1hcnlEYXRhIiwiZmllbGQiLCJjb21wYXJlVHlwZSIsImRhdGEiLCJmaWVsZElkeCIsImRpc3BsYXlEZWx0YVZhbHVlIiwiaW50ZWdlciIsInJlYWwiLCJiYXNlRHAiLCJ2YWx1ZUF0IiwiZHAiLCJkZWx0YVZhbHVlIiwiQ09NUEFSRV9UWVBFUyIsIlJFTEFUSVZFIiwiZGVsdGFGb3JtYXQiLCJUT09MVElQX0ZPUk1BVFMiLCJERUNJTUFMX1BFUkNFTlRfRlVMTF8yIiwiVE9PTFRJUF9LRVkiLCJkaXNwbGF5Rm9ybWF0IiwiREVDSU1BTF9ERUNJTUFMX0ZJWEVEXzMiLCJkZWx0YUZpcnN0Q2hhciIsImNoYXJBdCIsImdldFRvb2x0aXBEaXNwbGF5VmFsdWUiLCJpdGVtIiwidmFsdWUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFHQTs7QUFVQTs7QUFiQTtB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QVQsUUFRSTtBQUFBLE1BUFRDLElBT1MsU0FQVEEsSUFPUztBQUFBLE1BTlR0QixLQU1TLFNBTlRBLEtBTVM7QUFBQSxNQUxUdUIsS0FLUyxTQUxUQSxLQUtTOztBQUNULE1BQUksQ0FBQywrQkFBbUJBLEtBQW5CLENBQUwsRUFBZ0M7QUFDOUIsV0FBTyxFQUFQO0FBQ0Q7O0FBRUQsU0FBT0QsSUFBSSxTQUFKLElBQUFBLElBQUksV0FBSixJQUFBQSxJQUFJLENBQUUzQixNQUFOLEdBQ0gseUJBQWEyQixJQUFiLGFBQWFBLElBQWIsdUJBQWFBLElBQUksQ0FBRTNCLE1BQW5CLEVBQTJCSyxLQUEzQixFQUFrQ3VCLEtBQWxDLENBREcsR0FFSHZCLEtBQUssQ0FBQ2lCLGFBQU4sR0FDQSx5QkFBYWpCLEtBQUssQ0FBQ2lCLGFBQW5CLEVBQWtDakIsS0FBbEMsRUFBeUN1QixLQUF6QyxDQURBLEdBRUEsNEJBQWdCQSxLQUFoQixFQUF1QnZCLEtBQUssQ0FBQ2pCLElBQTdCLENBSko7QUFLRCIsInNvdXJjZXNDb250ZW50IjpbIi8vIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVRcbi8vIENvcHlyaWdodCBjb250cmlidXRvcnMgdG8gdGhlIGtlcGxlci5nbCBwcm9qZWN0XG5cbmltcG9ydCB7XG4gIERFRkFVTFRfVE9PTFRJUF9GSUVMRFMsXG4gIEFMTF9GSUVMRF9UWVBFUyxcbiAgVFJJUF9QT0lOVF9GSUVMRFMsXG4gIFRPT0xUSVBfRk9STUFUUyxcbiAgVE9PTFRJUF9LRVksXG4gIENPTVBBUkVfVFlQRVNcbn0gZnJvbSAnQGtlcGxlci5nbC9jb25zdGFudHMnO1xuXG5pbXBvcnQge0ZpZWxkLCBUb29sdGlwRmllbGQsIENvbXBhcmVUeXBlfSBmcm9tICdAa2VwbGVyLmdsL3R5cGVzJztcbmltcG9ydCB7XG4gIERhdGFSb3csXG4gIHBhcnNlRmllbGRWYWx1ZSxcbiAgZ2V0Rm9ybWF0dGVyLFxuICBpc051bWJlcixcbiAgZGVmYXVsdEZvcm1hdHRlcixcbiAgbm90TnVsbG9yVW5kZWZpbmVkXG59IGZyb20gJ0BrZXBsZXIuZ2wvdXRpbHMnO1xuXG4vKipcbiAqIE1pbnVzIHNpZ24gdXNlZCBpbiB0b29sdGlwIGZvcm1hdHRpbmcuXG4gKiBcXHUyMjEyIG9yIFxcdTAwMkQgaXMgdGhlIG1pbnVzIHNpZ24gdGhhdCBkMy1mb3JtYXQgdXNlcyBmb3IgZGVjaW1hbCBudW1iZXIgZm9ybWF0dGluZ1xuICogZDMtZm9ybWF0IDIuMCB1c2VzIFxcdTAwMkRcbiAqL1xuZXhwb3J0IGNvbnN0IFRPT0xUSVBfTUlOVVNfU0lHTiA9ICdcXHUyMjEyJztcbi8vIGJvdGggYXJlIHBvc2libGUgbmVnYXRpdmUgc2lnbnNcbmV4cG9ydCBjb25zdCBORUdBVElWRV9TSUdOUyA9IFsnXFx1MDAyRCcsICdcXHUyMjEyJ107XG5cbmV4cG9ydCBjb25zdCBCUlVTSF9DT05GSUc6IHtcbiAgcmFuZ2U6IFtudW1iZXIsIG51bWJlcl07XG59ID0ge1xuICByYW5nZTogWzAsIDUwXVxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRGaWVsZHNUb1Nob3coe1xuICBmaWVsZHMsXG4gIGlkLFxuICBtYXhEZWZhdWx0VG9vbHRpcHNcbn06IHtcbiAgZmllbGRzOiBGaWVsZFtdO1xuICBpZDogc3RyaW5nO1xuICBtYXhEZWZhdWx0VG9vbHRpcHM6IG51bWJlcjtcbn0pOiB7XG4gIFtrZXk6IHN0cmluZ106IHN0cmluZ1tdO1xufSB7XG4gIC8vIGZpcnN0IGZpbmQgZGVmYXVsdCB0b29sdGlwIGZpZWxkcyBmb3IgdHJpcHNcbiAgY29uc3QgZmllbGRzVG9TaG93ID0gREVGQVVMVF9UT09MVElQX0ZJRUxEUy5yZWR1Y2UoKHByZXYsIGN1cnIpID0+IHtcbiAgICBpZiAoZmllbGRzLmZpbmQoKHtuYW1lfSkgPT4gY3Vyci5uYW1lID09PSBuYW1lKSkge1xuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgcHJldi5wdXNoKGN1cnIpO1xuICAgIH1cbiAgICByZXR1cm4gcHJldjtcbiAgfSwgW10pO1xuXG4gIHJldHVybiB7XG4gICAgW2lkXTogZmllbGRzVG9TaG93Lmxlbmd0aCA/IGZpZWxkc1RvU2hvdyA6IGF1dG9GaW5kVG9vbHRpcEZpZWxkcyhmaWVsZHMsIG1heERlZmF1bHRUb29sdGlwcylcbiAgfTtcbn1cblxuZnVuY3Rpb24gYXV0b0ZpbmRUb29sdGlwRmllbGRzKGZpZWxkcywgbWF4RGVmYXVsdFRvb2x0aXBzKSB7XG4gIGNvbnN0IHB0RmllbGRzID0gX21lcmdlRmllbGRQYWlycyhUUklQX1BPSU5UX0ZJRUxEUyk7XG4gIC8vIGZpbHRlciBvdXQgdGhlIGRlZmF1bHQgZmllbGRzIHRoYXQgY29udGFpbnMgbGF0IGFuZCBsbmcgYW5kIGFueSBnZW9tZXRyeVxuICBjb25zdCBmaWVsZHNUb1Nob3cgPSBmaWVsZHMuZmlsdGVyKFxuICAgICh7bmFtZSwgdHlwZX0pID0+XG4gICAgICBuYW1lXG4gICAgICAgIC5yZXBsYWNlKC9bXywuXSsvZywgJyAnKVxuICAgICAgICAudHJpbSgpXG4gICAgICAgIC5zcGxpdCgnICcpXG4gICAgICAgIC5ldmVyeShzZWcgPT4gIXB0RmllbGRzLmluY2x1ZGVzKHNlZykpICYmXG4gICAgICB0eXBlICE9PSBBTExfRklFTERfVFlQRVMuZ2VvanNvbiAmJlxuICAgICAgdHlwZSAhPT0gQUxMX0ZJRUxEX1RZUEVTLmdlb2Fycm93ICYmXG4gICAgICB0eXBlICE9PSAnb2JqZWN0J1xuICApO1xuXG4gIHJldHVybiBmaWVsZHNUb1Nob3cuc2xpY2UoMCwgbWF4RGVmYXVsdFRvb2x0aXBzKS5tYXAoKHtuYW1lfSkgPT4ge1xuICAgIHJldHVybiB7XG4gICAgICBuYW1lLFxuICAgICAgZm9ybWF0OiBudWxsXG4gICAgfTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIF9tZXJnZUZpZWxkUGFpcnMocGFpcnMpIHtcbiAgcmV0dXJuIHBhaXJzLnJlZHVjZSgocHJldiwgcGFpcikgPT4gWy4uLnByZXYsIC4uLnBhaXJdLCBbXSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRUb29sdGlwRGlzcGxheURlbHRhVmFsdWUoe1xuICBwcmltYXJ5RGF0YSxcbiAgZmllbGQsXG4gIGNvbXBhcmVUeXBlLFxuICBkYXRhLFxuICBmaWVsZElkeFxufToge1xuICBmaWVsZDogRmllbGQ7XG4gIGRhdGE6IERhdGFSb3c7XG4gIGZpZWxkSWR4OiBudW1iZXI7XG4gIHByaW1hcnlEYXRhOiBEYXRhUm93O1xuICBjb21wYXJlVHlwZTogQ29tcGFyZVR5cGU7XG59KTogc3RyaW5nIHwgbnVsbCB7XG4gIGxldCBkaXNwbGF5RGVsdGFWYWx1ZTogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG5cbiAgaWYgKFxuICAgIHByaW1hcnlEYXRhICYmXG4gICAgLy8gY29tcGFyaXNvbiBtb2RlIG9ubHkgd29ya3MgZm9yIG51bWVyaWMgZmllbGRcbiAgICAoZmllbGQudHlwZSA9PT0gQUxMX0ZJRUxEX1RZUEVTLmludGVnZXIgfHwgZmllbGQudHlwZSA9PT0gQUxMX0ZJRUxEX1RZUEVTLnJlYWwpXG4gICkge1xuICAgIGNvbnN0IGJhc2VEcCA9IHByaW1hcnlEYXRhLnZhbHVlQXQoZmllbGRJZHgpO1xuICAgIGNvbnN0IGRwID0gZGF0YS52YWx1ZUF0KGZpZWxkSWR4KTtcbiAgICBpZiAoaXNOdW1iZXIoYmFzZURwKSAmJiBpc051bWJlcihkcCkpIHtcbiAgICAgIGNvbnN0IGRlbHRhVmFsdWUgPSBjb21wYXJlVHlwZSA9PT0gQ09NUEFSRV9UWVBFUy5SRUxBVElWRSA/IGRwIC8gYmFzZURwIC0gMSA6IGRwIC0gYmFzZURwO1xuICAgICAgY29uc3QgZGVsdGFGb3JtYXQgPVxuICAgICAgICBjb21wYXJlVHlwZSA9PT0gQ09NUEFSRV9UWVBFUy5SRUxBVElWRVxuICAgICAgICAgID8gVE9PTFRJUF9GT1JNQVRTLkRFQ0lNQUxfUEVSQ0VOVF9GVUxMXzJbVE9PTFRJUF9LRVldXG4gICAgICAgICAgOiBmaWVsZC5kaXNwbGF5Rm9ybWF0IHx8IFRPT0xUSVBfRk9STUFUUy5ERUNJTUFMX0RFQ0lNQUxfRklYRURfM1tUT09MVElQX0tFWV07XG5cbiAgICAgIGRpc3BsYXlEZWx0YVZhbHVlID0gZ2V0Rm9ybWF0dGVyKGRlbHRhRm9ybWF0LCBmaWVsZCkoZGVsdGFWYWx1ZSk7XG5cbiAgICAgIC8vIHNhZmVseSBjYXN0IHN0cmluZ1xuICAgICAgZGlzcGxheURlbHRhVmFsdWUgPSBkZWZhdWx0Rm9ybWF0dGVyKGRpc3BsYXlEZWx0YVZhbHVlKSBhcyBzdHJpbmc7XG4gICAgICBjb25zdCBkZWx0YUZpcnN0Q2hhciA9IGRpc3BsYXlEZWx0YVZhbHVlLmNoYXJBdCgwKTtcblxuICAgICAgaWYgKGRlbHRhRmlyc3RDaGFyICE9PSAnKycgJiYgIU5FR0FUSVZFX1NJR05TLmluY2x1ZGVzKGRlbHRhRmlyc3RDaGFyKSkge1xuICAgICAgICBkaXNwbGF5RGVsdGFWYWx1ZSA9IGArJHtkaXNwbGF5RGVsdGFWYWx1ZX1gO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBkaXNwbGF5RGVsdGFWYWx1ZSA9IFRPT0xUSVBfTUlOVVNfU0lHTjtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gZGlzcGxheURlbHRhVmFsdWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRUb29sdGlwRGlzcGxheVZhbHVlKHtcbiAgaXRlbSxcbiAgZmllbGQsXG4gIHZhbHVlXG59OiB7XG4gIGl0ZW06IFRvb2x0aXBGaWVsZCB8IHVuZGVmaW5lZDtcbiAgZmllbGQ6IEZpZWxkO1xuICB2YWx1ZTogYW55O1xufSk6IHN0cmluZyB7XG4gIGlmICghbm90TnVsbG9yVW5kZWZpbmVkKHZhbHVlKSkge1xuICAgIHJldHVybiAnJztcbiAgfVxuXG4gIHJldHVybiBpdGVtPy5mb3JtYXRcbiAgICA/IGdldEZvcm1hdHRlcihpdGVtPy5mb3JtYXQsIGZpZWxkKSh2YWx1ZSlcbiAgICA6IGZpZWxkLmRpc3BsYXlGb3JtYXRcbiAgICA/IGdldEZvcm1hdHRlcihmaWVsZC5kaXNwbGF5Rm9ybWF0LCBmaWVsZCkodmFsdWUpXG4gICAgOiBwYXJzZUZpZWxkVmFsdWUodmFsdWUsIGZpZWxkLnR5cGUpO1xufVxuIl19