{"version":3,"file":"table-batch-builder.js","names":["BaseTableBatchAggregator","RowTableBatchAggregator","ColumnarTableBatchAggregator","DEFAULT_OPTIONS","shape","undefined","batchSize","batchDebounceMs","limit","_limitMB","ERR_MESSAGE","TableBatchBuilder","constructor","schema","options","aggregator","batchCount","bytesUsed","isChunkComplete","lastBatchEmittedMs","Date","now","totalLength","totalBytes","rowBytes","limitReached","_this$options","_this$options2","Boolean","addRow","row","_estimateRowMB","Array","isArray","addArrayRow","addObjectRow","TableBatchType","_getTableBatchType","chunkComplete","chunk","ArrayBuffer","byteLength","length","getFullBatch","_isFull","_getBatch","getFinalBatch","Object","keys","rowCount","normalizedBatch","getBatch","count","assign","ArrowBatch","Error"],"sources":["../../../../src/lib/table/batches/table-batch-builder.ts"],"sourcesContent":["// loaders.gl\n// SPDX-License-Identifier: MIT\n// Copyright (c) vis.gl contributors\n\nimport type {Schema} from '../../../types/schema';\nimport type {TableBatch} from '../../../types/category-table';\nimport type {TableBatchAggregator, TableBatchConstructor} from './table-batch-aggregator';\nimport {BaseTableBatchAggregator} from './base-table-batch-aggregator';\nimport {RowTableBatchAggregator} from './row-table-batch-aggregator';\nimport {ColumnarTableBatchAggregator} from './columnar-table-batch-aggregator';\n\n// TODO define interface instead\ntype TableBatchBuilderOptions = {\n  shape?: 'array-row-table' | 'object-row-table' | 'columnar-table' | 'arrow-table';\n  batchSize?: number | 'auto';\n  batchDebounceMs?: number;\n  limit?: number;\n  _limitMB?: number;\n};\n\ntype GetBatchOptions = {\n  bytesUsed?: number;\n  [key: string]: any;\n};\n\nconst DEFAULT_OPTIONS: Required<TableBatchBuilderOptions> = {\n  shape: undefined!,\n  batchSize: 'auto',\n  batchDebounceMs: 0,\n  limit: 0,\n  _limitMB: 0\n};\n\nconst ERR_MESSAGE = 'TableBatchBuilder';\n\n/** Incrementally builds batches from a stream of rows */\nexport class TableBatchBuilder {\n  schema: Schema;\n  options: Required<TableBatchBuilderOptions>;\n\n  private aggregator: TableBatchAggregator | null = null;\n  private batchCount: number = 0;\n  private bytesUsed: number = 0;\n  private isChunkComplete: boolean = false;\n  private lastBatchEmittedMs: number = Date.now();\n  private totalLength: number = 0;\n  private totalBytes: number = 0;\n  private rowBytes: number = 0;\n\n  static ArrowBatch?: TableBatchConstructor;\n\n  constructor(schema: Schema, options?: TableBatchBuilderOptions) {\n    this.schema = schema;\n    this.options = {...DEFAULT_OPTIONS, ...options};\n  }\n\n  limitReached(): boolean {\n    if (Boolean(this.options?.limit) && this.totalLength >= this.options.limit) {\n      return true;\n    }\n    if (Boolean(this.options?._limitMB) && this.totalBytes / 1e6 >= this.options._limitMB) {\n      return true;\n    }\n    return false;\n  }\n\n  /** @deprecated Use addArrayRow or addObjectRow */\n  addRow(row: any[] | {[columnName: string]: any}): void {\n    if (this.limitReached()) {\n      return;\n    }\n    this.totalLength++;\n    this.rowBytes = this.rowBytes || this._estimateRowMB(row);\n    this.totalBytes += this.rowBytes;\n    if (Array.isArray(row)) {\n      this.addArrayRow(row);\n    } else {\n      this.addObjectRow(row);\n    }\n  }\n\n  /** Add one row to the batch */\n  protected addArrayRow(row: any[]) {\n    if (!this.aggregator) {\n      const TableBatchType = this._getTableBatchType();\n      this.aggregator = new TableBatchType(this.schema, this.options);\n    }\n    this.aggregator.addArrayRow(row);\n  }\n\n  /** Add one row to the batch */\n  protected addObjectRow(row: {[columnName: string]: any}): void {\n    if (!this.aggregator) {\n      const TableBatchType = this._getTableBatchType();\n      this.aggregator = new TableBatchType(this.schema, this.options);\n    }\n    this.aggregator.addObjectRow(row);\n  }\n\n  /** Mark an incoming raw memory chunk has completed */\n  chunkComplete(chunk: ArrayBuffer | string): void {\n    if (chunk instanceof ArrayBuffer) {\n      this.bytesUsed += chunk.byteLength;\n    }\n    if (typeof chunk === 'string') {\n      this.bytesUsed += chunk.length;\n    }\n    this.isChunkComplete = true;\n  }\n\n  getFullBatch(options?: GetBatchOptions): TableBatch | null {\n    return this._isFull() ? this._getBatch(options) : null;\n  }\n\n  getFinalBatch(options?: GetBatchOptions): TableBatch | null {\n    return this._getBatch(options);\n  }\n\n  // INTERNAL\n\n  _estimateRowMB(row: any[] | object): number {\n    return Array.isArray(row) ? row.length * 8 : Object.keys(row).length * 8;\n  }\n\n  private _isFull(): boolean {\n    // No batch, not ready\n    if (!this.aggregator || this.aggregator.rowCount() === 0) {\n      return false;\n    }\n\n    // if batchSize === 'auto' we wait for chunk to complete\n    // if batchSize === number, ensure we have enough rows\n    if (this.options.batchSize === 'auto') {\n      if (!this.isChunkComplete) {\n        return false;\n      }\n    } else if (this.options.batchSize > this.aggregator.rowCount()) {\n      return false;\n    }\n\n    // Debounce batches\n    if (this.options.batchDebounceMs > Date.now() - this.lastBatchEmittedMs) {\n      return false;\n    }\n\n    // Emit batch\n    this.isChunkComplete = false;\n    this.lastBatchEmittedMs = Date.now();\n    return true;\n  }\n\n  /**\n   * bytesUsed can be set via chunkComplete or via getBatch*\n   */\n  private _getBatch(options?: GetBatchOptions): TableBatch | null {\n    if (!this.aggregator) {\n      return null;\n    }\n\n    // TODO - this can overly increment bytes used?\n    if (options?.bytesUsed) {\n      this.bytesUsed = options.bytesUsed;\n    }\n    const normalizedBatch = this.aggregator.getBatch() as TableBatch;\n    normalizedBatch.count = this.batchCount;\n    normalizedBatch.bytesUsed = this.bytesUsed;\n    Object.assign(normalizedBatch, options);\n\n    this.batchCount++;\n    this.aggregator = null;\n    return normalizedBatch;\n  }\n\n  private _getTableBatchType(): TableBatchConstructor {\n    switch (this.options.shape) {\n      case 'array-row-table':\n      case 'object-row-table':\n        return RowTableBatchAggregator;\n      case 'columnar-table':\n        return ColumnarTableBatchAggregator;\n      case 'arrow-table':\n        if (!TableBatchBuilder.ArrowBatch) {\n          throw new Error(ERR_MESSAGE);\n        }\n        return TableBatchBuilder.ArrowBatch;\n      default:\n        return BaseTableBatchAggregator;\n    }\n  }\n}\n"],"mappings":"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"}