"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _react = _interopRequireWildcard(require("react"));

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _localization = require("@kepler.gl/localization");

var _react2 = _interopRequireDefault(require("@tippyjs/react"));

var _icons = require("../common/icons");

var _styledComponents2 = require("../common/styled-components");

var _typeahead = _interopRequireDefault(require("../common/item-selector/typeahead"));

var _accessor = _interopRequireDefault(require("../common/item-selector/accessor"));

var _reactIntl = require("react-intl");

var _context = require("../context");

var _templateObject, _templateObject2, _templateObject3;

var DropdownContainer = _styledComponents["default"].div.attrs({
  className: 'add-layer-menu-dropdown'
})(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2["default"])(["\n  .list-selector {\n    border-top: 1px solid ", ";\n    width: 100%;\n    /* disable scrolling, currently set to 280px internally */\n    max-height: unset;\n  }\n  .list__item > div {\n    display: flex;\n    flex-direction: row;\n    justify-content: flex-start;\n    line-height: 18px;\n    padding: 0;\n    svg {\n      margin-right: 10px;\n    }\n  }\n"])), function (props) {
  return props.theme.secondaryInputBorderColor;
});

var DropdownMenu = _styledComponents["default"].div.attrs({
  className: 'dropdown-menu'
})(_templateObject2 || (_templateObject2 = (0, _taggedTemplateLiteral2["default"])(["\n  display: flex;\n  flex-direction: column;\n  min-width: 240px;\n  max-width: 240px;\n  position: absolute;\n  top: 100%;\n  left: -53px;\n  z-index: 5;\n"])));

var ListItemWrapper = _styledComponents["default"].div.attrs({
  className: 'dropdown-menu-list-item-wrapper'
})(_templateObject3 || (_templateObject3 = (0, _taggedTemplateLiteral2["default"])(["\n  display: flex;\n  color: ", ";\n  font-size: 11px;\n  letter-spacing: 0.2px;\n  overflow: auto;\n  .dataset-color {\n    flex-shrink: 0;\n    margin-top: 3px;\n  }\n  .dataset-name {\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n"])), function (props) {
  return props.theme.textColor;
});

var TYPEAHEAD_CLASS = 'typeahead';
var TYPEAHEAD_INPUT_CLASS = 'typeahead__input';

var ListItem = function ListItem(_ref) {
  var value = _ref.value;
  return /*#__PURE__*/_react["default"].createElement(ListItemWrapper, null, /*#__PURE__*/_react["default"].createElement(_styledComponents2.DatasetSquare, {
    className: "dataset-color",
    backgroundColor: value.color
  }), /*#__PURE__*/_react["default"].createElement("div", {
    className: "dataset-name",
    title: value.label
  }, value.label));
};

var AddByDatasetButton = function AddByDatasetButton(_ref2) {
  var datasets = _ref2.datasets,
      onAdd = _ref2.onAdd,
      buttonIntlId = _ref2.buttonIntlId,
      width = _ref2.width,
      className = _ref2.className,
      inactive = _ref2.inactive;

  var _useState = (0, _react.useState)(),
      _useState2 = (0, _slicedToArray2["default"])(_useState, 2),
      tippyInstance = _useState2[0],
      setTippyInstance = _useState2[1];

  var options = (0, _react.useMemo)(function () {
    return Object.values(datasets).map(function (ds) {
      return {
        label: ds.label,
        value: ds.id,
        color: ds.color
      };
    });
  }, [datasets]);
  var onClickBtn = (0, _react.useCallback)(function () {
    if (options.length === 1) {
      onAdd(options[0].value);
    }

    return;
  }, [options, onAdd]);
  var onOptionSelected = (0, _react.useCallback)(function (option) {
    onAdd(option.value);

    if (tippyInstance) {
      // @ts-ignore
      tippyInstance.hide();
    }
  }, [onAdd, tippyInstance]);
  var intl = (0, _reactIntl.useIntl)();

  var buttonRendered = /*#__PURE__*/_react["default"].createElement(_styledComponents2.Button, {
    tabIndex: -1,
    className: className || 'add-by-dataset-button',
    width: width,
    onClick: onClickBtn,
    disabled: !options.length || inactive
  }, /*#__PURE__*/_react["default"].createElement(_icons.Add, {
    height: "12px"
  }), /*#__PURE__*/_react["default"].createElement(_localization.FormattedMessage, {
    id: buttonIntlId
  }));

  return options.length === 1 ? buttonRendered : /*#__PURE__*/_react["default"].createElement(_context.RootContext.Consumer, null, function (context) {
    return /*#__PURE__*/_react["default"].createElement(_react2["default"], {
      trigger: "click",
      arrow: false,
      interactive: true,
      placement: "bottom",
      appendTo: (context === null || context === void 0 ? void 0 : context.current) || 'parent' // @ts-ignore
      ,
      onCreate: setTippyInstance,
      duration: 0,
      content: /*#__PURE__*/_react["default"].createElement(DropdownMenu, null, /*#__PURE__*/_react["default"].createElement(DropdownContainer, null, /*#__PURE__*/_react["default"].createElement(_typeahead["default"], {
        className: TYPEAHEAD_CLASS,
        customClasses: {
          results: 'list-selector',
          input: TYPEAHEAD_INPUT_CLASS,
          listItem: 'list__item'
        },
        placeholder: intl ? intl.formatMessage({
          id: 'placeholder.search'
        }) : 'Search',
        selectedItems: null,
        options: options,
        displayOption: _accessor["default"].generateOptionToStringFor('label'),
        filterOption: 'label',
        searchable: true,
        onOptionSelected: onOptionSelected,
        customListItemComponent: ListItem
      })))
    }, buttonRendered);
  });
};

var _default = AddByDatasetButton;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zaWRlLXBhbmVsL2FkZC1ieS1kYXRhc2V0LWJ1dHRvbi50c3giXSwibmFtZXMiOlsiRHJvcGRvd25Db250YWluZXIiLCJzdHlsZWQiLCJkaXYiLCJhdHRycyIsImNsYXNzTmFtZSIsInByb3BzIiwidGhlbWUiLCJzZWNvbmRhcnlJbnB1dEJvcmRlckNvbG9yIiwiRHJvcGRvd25NZW51IiwiTGlzdEl0ZW1XcmFwcGVyIiwidGV4dENvbG9yIiwiVFlQRUFIRUFEX0NMQVNTIiwiVFlQRUFIRUFEX0lOUFVUX0NMQVNTIiwiTGlzdEl0ZW0iLCJ2YWx1ZSIsImNvbG9yIiwibGFiZWwiLCJBZGRCeURhdGFzZXRCdXR0b24iLCJkYXRhc2V0cyIsIm9uQWRkIiwiYnV0dG9uSW50bElkIiwid2lkdGgiLCJpbmFjdGl2ZSIsInRpcHB5SW5zdGFuY2UiLCJzZXRUaXBweUluc3RhbmNlIiwib3B0aW9ucyIsIk9iamVjdCIsInZhbHVlcyIsIm1hcCIsImRzIiwiaWQiLCJvbkNsaWNrQnRuIiwibGVuZ3RoIiwib25PcHRpb25TZWxlY3RlZCIsIm9wdGlvbiIsImhpZGUiLCJpbnRsIiwiYnV0dG9uUmVuZGVyZWQiLCJjb250ZXh0IiwiY3VycmVudCIsInJlc3VsdHMiLCJpbnB1dCIsImxpc3RJdGVtIiwiZm9ybWF0TWVzc2FnZSIsIkFjY2Vzc29yIiwiZ2VuZXJhdGVPcHRpb25Ub1N0cmluZ0ZvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxJQUFNQSxpQkFBaUIsR0FBR0MsNkJBQU9DLEdBQVAsQ0FBV0MsS0FBWCxDQUFpQjtBQUN6Q0MsRUFBQUEsU0FBUyxFQUFFO0FBRDhCLENBQWpCLENBQUgsK2JBSUssVUFBQUMsS0FBSztBQUFBLFNBQUlBLEtBQUssQ0FBQ0MsS0FBTixDQUFZQyx5QkFBaEI7QUFBQSxDQUpWLENBQXZCOztB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LEVBQUUsT0FYaEI7QUFZRSxRQUFBLFVBQVUsTUFaWjtBQWFFLFFBQUEsZ0JBQWdCLEVBQUVaLGdCQWJwQjtBQWNFLFFBQUEsdUJBQXVCLEVBQUVwQjtBQWQzQixRQURGLENBREY7QUFWSixPQWdDR3dCLGNBaENILENBRE07QUFBQSxHQURWLENBSEY7QUEwQ0QsQ0E5RkQ7O2VBZ0dlcEIsa0IiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTUlUXG4vLyBDb3B5cmlnaHQgY29udHJpYnV0b3JzIHRvIHRoZSBrZXBsZXIuZ2wgcHJvamVjdFxuXG5pbXBvcnQgUmVhY3QsIHt1c2VDYWxsYmFjaywgdXNlTWVtbywgdXNlU3RhdGV9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBzdHlsZWQgZnJvbSAnc3R5bGVkLWNvbXBvbmVudHMnO1xuaW1wb3J0IHtGb3JtYXR0ZWRNZXNzYWdlfSBmcm9tICdAa2VwbGVyLmdsL2xvY2FsaXphdGlvbic7XG5pbXBvcnQge0RhdGFzZXRzfSBmcm9tICdAa2VwbGVyLmdsL3RhYmxlJztcblxuaW1wb3J0IFRpcHB5IGZyb20gJ0B0aXBweWpzL3JlYWN0JztcbmltcG9ydCB7QWRkfSBmcm9tICcuLi9jb21tb24vaWNvbnMnO1xuaW1wb3J0IHtCdXR0b24sIERhdGFzZXRTcXVhcmV9IGZyb20gJy4uL2NvbW1vbi9zdHlsZWQtY29tcG9uZW50cyc7XG5pbXBvcnQgVHlwZWFoZWFkIGZyb20gJy4uL2NvbW1vbi9pdGVtLXNlbGVjdG9yL3R5cGVhaGVhZCc7XG5pbXBvcnQgQWNjZXNzb3IgZnJvbSAnLi4vY29tbW9uL2l0ZW0tc2VsZWN0b3IvYWNjZXNzb3InO1xuaW1wb3J0IHt1c2VJbnRsfSBmcm9tICdyZWFjdC1pbnRsJztcbmltcG9ydCB7Um9vdENvbnRleHR9IGZyb20gJy4uL2NvbnRleHQnO1xuXG5jb25zdCBEcm9wZG93bkNvbnRhaW5lciA9IHN0eWxlZC5kaXYuYXR0cnMoe1xuICBjbGFzc05hbWU6ICdhZGQtbGF5ZXItbWVudS1kcm9wZG93bidcbn0pYFxuICAubGlzdC1zZWxlY3RvciB7XG4gICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkICR7cHJvcHMgPT4gcHJvcHMudGhlbWUuc2Vjb25kYXJ5SW5wdXRCb3JkZXJDb2xvcn07XG4gICAgd2lkdGg6IDEwMCU7XG4gICAgLyogZGlzYWJsZSBzY3JvbGxpbmcsIGN1cnJlbnRseSBzZXQgdG8gMjgwcHggaW50ZXJuYWxseSAqL1xuICAgIG1heC1oZWlnaHQ6IHVuc2V0O1xuICB9XG4gIC5saXN0X19pdGVtID4gZGl2IHtcbiAgICBkaXNwbGF5OiBmbGV4O1xuICAgIGZsZXgtZGlyZWN0aW9uOiByb3c7XG4gICAganVzdGlmeS1jb250ZW50OiBmbGV4LXN0YXJ0O1xuICAgIGxpbmUtaGVpZ2h0OiAxOHB4O1xuICAgIHBhZGRpbmc6IDA7XG4gICAgc3ZnIHtcbiAgICAgIG1hcmdpbi1yaWdodDogMTBweDtcbiAgICB9XG4gIH1cbmA7XG5cbmNvbnN0IERyb3Bkb3duTWVudSA9IHN0eWxlZC5kaXYuYXR0cnMoe1xuICBjbGFzc05hbWU6ICdkcm9wZG93bi1tZW51J1xufSlgXG4gIGRpc3BsYXk6IGZsZXg7XG4gIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47XG4gIG1pbi13aWR0aDogMjQwcHg7XG4gIG1heC13aWR0aDogMjQwcHg7XG4gIHBvc2l0aW9uOiBhYnNvbHV0ZTtcbiAgdG9wOiAxMDAlO1xuICBsZWZ0OiAtNTNweDtcbiAgei1pbmRleDogNTtcbmA7XG5cbmNvbnN0IExpc3RJdGVtV3JhcHBlciA9IHN0eWxlZC5kaXYuYXR0cnMoe1xuICBjbGFzc05hbWU6ICdkcm9wZG93bi1tZW51LWxpc3QtaXRlbS13cmFwcGVyJ1xufSlgXG4gIGRpc3BsYXk6IGZsZXg7XG4gIGNvbG9yOiAke3Byb3BzID0+IHByb3BzLnRoZW1lLnRleHRDb2xvcn07XG4gIGZvbnQtc2l6ZTogMTFweDtcbiAgbGV0dGVyLXNwYWNpbmc6IDAuMnB4O1xuICBvdmVyZmxvdzogYXV0bztcbiAgLmRhdGFzZXQtY29sb3Ige1xuICAgIGZsZXgtc2hyaW5rOiAwO1xuICAgIG1hcmdpbi10b3A6IDNweDtcbiAgfVxuICAuZGF0YXNldC1uYW1lIHtcbiAgICB3aGl0ZS1zcGFjZTogbm93cmFwO1xuICAgIG92ZXJmbG93OiBoaWRkZW47XG4gICAgdGV4dC1vdmVyZmxvdzogZWxsaXBzaXM7XG4gIH1cbmA7XG5cbmNvbnN0IFRZUEVBSEVBRF9DTEFTUyA9ICd0eXBlYWhlYWQnO1xuY29uc3QgVFlQRUFIRUFEX0lOUFVUX0NMQVNTID0gJ3R5cGVhaGVhZF9faW5wdXQnO1xuXG5leHBvcnQgdHlwZSBBZGRCeURhdGFzZXRCdXR0b25Qcm9wcyA9IHtcbiAgZGF0YXNldHM6IERhdGFzZXRzO1xuICBvbkFkZDogKGRhdGFJZDogc3RyaW5nKSA9PiB2b2lkO1xuICB3aWR0aDogc3RyaW5nO1xuICBidXR0b25JbnRsSWQ6IHN0cmluZztcbiAgaW5hY3RpdmU/OiBib29sZWFuO1xuICBjbGFzc05hbWU/OiBzdHJpbmc7XG59O1xuXG5jb25zdCBMaXN0SXRlbSA9ICh7dmFsdWV9KSA9PiAoXG4gIDxMaXN0SXRlbVdyYXBwZXI+XG4gICAgPERhdGFzZXRTcXVhcmUgY2xhc3NOYW1lPVwiZGF0YXNldC1jb2xvclwiIGJhY2tncm91bmRDb2xvcj17dmFsdWUuY29sb3J9IC8+XG4gICAgPGRpdiBjbGFzc05hbWU9XCJkYXRhc2V0LW5hbWVcIiB0aXRsZT17dmFsdWUubGFiZWx9PlxuICAgICAge3ZhbHVlLmxhYmVsfVxuICAgIDwvZGl2PlxuICA8L0xpc3RJdGVtV3JhcHBlcj5cbik7XG5cbmNvbnN0IEFkZEJ5RGF0YXNldEJ1dHRvbjogUmVhY3QuRkM8QWRkQnlEYXRhc2V0QnV0dG9uUHJvcHM+ID0gKHtcbiAgZGF0YXNldHMsXG4gIG9uQWRkLFxuICBidXR0b25JbnRsSWQsXG4gIHdpZHRoLFxuICBjbGFzc05hbWUsXG4gIGluYWN0aXZlXG59KSA9PiB7XG4gIGNvbnN0IFt0aXBweUluc3RhbmNlLCBzZXRUaXBweUluc3RhbmNlXSA9IHVzZVN0YXRlKCk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IHVzZU1lbW8oKCkgPT4ge1xuICAgIHJldHVybiBPYmplY3QudmFsdWVzKGRhdGFzZXRzKS5tYXAoZHMgPT4gKHtcbiAgICAgIGxhYmVsOiBkcy5sYWJlbCxcbiAgICAgIHZhbHVlOiBkcy5pZCxcbiAgICAgIGNvbG9yOiBkcy5jb2xvclxuICAgIH0pKTtcbiAgfSwgW2RhdGFzZXRzXSk7XG5cbiAgY29uc3Qgb25DbGlja0J0biA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBpZiAob3B0aW9ucy5sZW5ndGggPT09IDEpIHtcbiAgICAgIG9uQWRkKG9wdGlvbnNbMF0udmFsdWUpO1xuICAgIH1cblxuICAgIHJldHVybjtcbiAgfSwgW29wdGlvbnMsIG9uQWRkXSk7XG5cbiAgY29uc3Qgb25PcHRpb25TZWxlY3RlZCA9IHVzZUNhbGxiYWNrKFxuICAgIG9wdGlvbiA9PiB7XG4gICAgICBvbkFkZChvcHRpb24udmFsdWUpO1xuICAgICAgaWYgKHRpcHB5SW5zdGFuY2UpIHtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICB0aXBweUluc3RhbmNlLmhpZGUoKTtcbiAgICAgIH1cbiAgICB9LFxuICAgIFtvbkFkZCwgdGlwcHlJbnN0YW5jZV1cbiAgKTtcblxuICBjb25zdCBpbnRsID0gdXNlSW50bCgpO1xuXG4gIGNvbnN0IGJ1dHRvblJlbmRlcmVkID0gKFxuICAgIDxCdXR0b25cbiAgICAgIHRhYkluZGV4PXstMX1cbiAgICAgIGNsYXNzTmFtZT17Y2xhc3NOYW1lIHx8ICdhZGQtYnktZGF0YXNldC1idXR0b24nfVxuICAgICAgd2lkdGg9e3dpZHRofVxuICAgICAgb25DbGljaz17b25DbGlja0J0bn1cbiAgICAgIGRpc2FibGVkPXshb3B0aW9ucy5sZW5ndGggfHwgaW5hY3RpdmV9XG4gICAgPlxuICAgICAgPEFkZCBoZWlnaHQ9XCIxMnB4XCIgLz5cbiAgICAgIDxGb3JtYXR0ZWRNZXNzYWdlIGlkPXtidXR0b25JbnRsSWR9IC8+XG4gICAgPC9CdXR0b24+XG4gICk7XG5cbiAgcmV0dXJuIG9wdGlvbnMubGVuZ3RoID09PSAxID8gKFxuICAgIGJ1dHRvblJlbmRlcmVkXG4gICkgOiAoXG4gICAgPFJvb3RDb250ZXh0LkNvbnN1bWVyPlxuICAgICAge2NvbnRleHQgPT4gKFxuICAgICAgICA8VGlwcHlcbiAgICAgICAgICB0cmlnZ2VyPVwiY2xpY2tcIlxuICAgICAgICAgIGFycm93PXtmYWxzZX1cbiAgICAgICAgICBpbnRlcmFjdGl2ZVxuICAgICAgICAgIHBsYWNlbWVudD1cImJvdHRvbVwiXG4gICAgICAgICAgYXBwZW5kVG89e2NvbnRleHQ/LmN1cnJlbnQgfHwgJ3BhcmVudCd9XG4gICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgIG9uQ3JlYXRlPXtzZXRUaXBweUluc3RhbmNlfVxuICAgICAgICAgIGR1cmF0aW9uPXswfVxuICAgICAgICAgIGNvbnRlbnQ9e1xuICAgICAgICAgICAgPERyb3Bkb3duTWVudT5cbiAgICAgICAgICAgICAgPERyb3Bkb3duQ29udGFpbmVyPlxuICAgICAgICAgICAgICAgIDxUeXBlYWhlYWRcbiAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT17VFlQRUFIRUFEX0NMQVNTfVxuICAgICAgICAgICAgICAgICAgY3VzdG9tQ2xhc3Nlcz17e1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRzOiAnbGlzdC1zZWxlY3RvcicsXG4gICAgICAgICAgICAgICAgICAgIGlucHV0OiBUWVBFQUhFQURfSU5QVVRfQ0xBU1MsXG4gICAgICAgICAgICAgICAgICAgIGxpc3RJdGVtOiAnbGlzdF9faXRlbSdcbiAgICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcj17aW50bCA/IGludGwuZm9ybWF0TWVzc2FnZSh7aWQ6ICdwbGFjZWhvbGRlci5zZWFyY2gnfSkgOiAnU2VhcmNoJ31cbiAgICAgICAgICAgICAgICAgIHNlbGVjdGVkSXRlbXM9e251bGx9XG4gICAgICAgICAgICAgICAgICBvcHRpb25zPXtvcHRpb25zfVxuICAgICAgICAgICAgICAgICAgZGlzcGxheU9wdGlvbj17QWNjZXNzb3IuZ2VuZXJhdGVPcHRpb25Ub1N0cmluZ0ZvcignbGFiZWwnKX1cbiAgICAgICAgICAgICAgICAgIGZpbHRlck9wdGlvbj17J2xhYmVsJ31cbiAgICAgICAgICAgICAgICAgIHNlYXJjaGFibGVcbiAgICAgICAgICAgICAgICAgIG9uT3B0aW9uU2VsZWN0ZWQ9e29uT3B0aW9uU2VsZWN0ZWR9XG4gICAgICAgICAgICAgICAgICBjdXN0b21MaXN0SXRlbUNvbXBvbmVudD17TGlzdEl0ZW19XG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgPC9Ecm9wZG93bkNvbnRhaW5lcj5cbiAgICAgICAgICAgIDwvRHJvcGRvd25NZW51PlxuICAgICAgICAgIH1cbiAgICAgICAgPlxuICAgICAgICAgIHtidXR0b25SZW5kZXJlZH1cbiAgICAgICAgPC9UaXBweT5cbiAgICAgICl9XG4gICAgPC9Sb290Q29udGV4dC5Db25zdW1lcj5cbiAgKTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IEFkZEJ5RGF0YXNldEJ1dHRvbjtcbiJdfQ==