"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.pointColResolver = exports.mapboxRequiredColumns = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _baseLayer = _interopRequireWildcard(require("./base-layer"));

var _reselect = require("reselect");

var _mapboxUtils = require("./mapbox-utils");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = (0, _getPrototypeOf2["default"])(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = (0, _getPrototypeOf2["default"])(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return (0, _possibleConstructorReturn2["default"])(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }

var mapboxRequiredColumns = ['lat', 'lng'];
exports.mapboxRequiredColumns = mapboxRequiredColumns;

var pointColResolver = function pointColResolver(_ref) {
  var lat = _ref.lat,
      lng = _ref.lng;
  return "".concat(lat.fieldIdx, "-").concat(lng.fieldIdx);
};

exports.pointColResolver = pointColResolver;

var MapboxLayerGL = /*#__PURE__*/function (_Layer) {
  (0, _inherits2["default"])(MapboxLayerGL, _Layer);

  var _super = _createSuper(MapboxLayerGL);

  function MapboxLayerGL() {
    var _this;

    (0, _classCallCheck2["default"])(this, MapboxLayerGL);

    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    _this = _super.call.apply(_super, [this].concat(args));
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "datasetSelector", function (config) {
      return config.dataId;
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "gpuFilterSelector", function (config, datasets) {
      return (config.dataId && datasets[config.dataId] || {}).gpuFilter;
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "columnsSelector", function (config) {
      return pointColResolver(config.columns);
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "sourceSelector", (0, _reselect.createSelector)(_this.datasetSelector, _this.columnsSelector, function (datasetId, columns) {
      return "".concat(datasetId, "-").concat(columns);
    }));
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "filterSelector", (0, _reselect.createSelector)(_this.gpuFilterSelector, function (gpuFilter) {
      return (0, _mapboxUtils.gpuFilterToMapboxFilter)(gpuFilter);
    }));
    return _this;
  }

  (0, _createClass2["default"])(MapboxLayerGL, [{
    key: "overlayType",
    get: function get() {
      return _baseLayer.OVERLAY_TYPE_CONST.mapboxgl;
    }
  }, {
    key: "type",
    get: function get() {
      return null;
    }
  }, {
    key: "isAggregated",
    get: function get() {
      return true;
    }
  }, {
    key: "requiredLayerColumns",
    get: function get() {
      return mapboxRequiredColumns;
    }
  }, {
    key: "columnPairs",
    get: function get() {
      return this.defaultPointColumnPairs;
    }
  }, {
    key: "noneLayerDataAffectingProps",
    get: function get() {
      return [];
    }
  }, {
    key: "visualChannels",
    get: function get() {
      return {};
    }
  }, {
    key: "isValidFilter",
    value: function isValidFilter(filter) {
      // mapbox will crash if filter is not an array or empty
      return Array.isArray(filter) && filter.length;
    }
  }, {
    key: "getDataUpdateTriggers",
    value: function getDataUpdateTriggers(_ref2) {
      var _this2 = this;

      var filteredIndex = _ref2.filteredIndex,
          gpuFilter = _ref2.gpuFilter,
          id = _ref2.id;
      var columns = this.config.columns;
      var visualChannelFields = Object.values(this.visualChannels).reduce(function (accu, v) {
        return _objectSpread(_objectSpread({}, accu), _this2.config[v.field] ? (0, _defineProperty2["default"])({}, v.field, _this2.config[v.field].name) : {});
      }, {});
      var updateTriggers = {
        getData: _objectSpread(_objectSpread({
          datasetId: id,
          columns: columns,
          filteredIndex: filteredIndex
        }, visualChannelFields), gpuFilter.filterValueUpdateTriggers),
        getMeta: {
          datasetId: id,
          columns: columns
        }
      };
      return updateTriggers;
    }
  }, {
    key: "getGeometry",
    value: function getGeometry(position) {
      return position.every(Number.isFinite) ? {
        type: 'Point',
        coordinates: position
      } : null;
    }
  }, {
    key: "calculateDataAttribute",
    value: function calculateDataAttribute(_ref4, getPosition) {
      var _this3 = this;

      var dataContainer = _ref4.dataContainer,
          filteredIndex = _ref4.filteredIndex,
          gpuFilter = _ref4.gpuFilter;

      var getGeometry = function getGeometry(d) {
        return _this3.getGeometry(getPosition(d));
      };

      var vcFields = Object.values(this.visualChannels).map(function (v) {
        return _this3.config[v.field];
      }).filter(function (v) {
        return v;
      });
      var getPropertyFromVisualChanel = vcFields.length ? function (d) {
        return vcFields.reduce(function (accu, field) {
          return _objectSpread(_objectSpread({}, accu), {}, (0, _defineProperty2["default"])({}, field.name, field.valueAccessor(d)));
        }, {});
      } : function (d) {
        return {};
      };
      var filterValueUpdateTriggers = gpuFilter.filterValueUpdateTriggers,
          filterValueAccessor = gpuFilter.filterValueAccessor; // gpuField To property

      var hasFilter = Object.values(filterValueUpdateTriggers).filter(function (d) {
        return d;
      }).length;
      var valueAccessor = filterValueAccessor(dataContainer)();
      var getPropertyFromFilter = hasFilter ? function (d) {
        var filterValue = valueAccessor(d);
        return Object.values(filterValueUpdateTriggers).reduce(function (accu, name, i) {
          return _objectSpread(_objectSpread({}, accu), name ? (0, _defineProperty2["default"])({}, (0, _mapboxUtils.prefixGpuField)(name), filterValue[i]) : {});
        }, {});
      } : function (d) {
        return {};
      };

      var getProperties = function getProperties(d) {
        return _objectSpread(_objectSpread({}, getPropertyFromVisualChanel(d)), getPropertyFromFilter(d));
      };

      return (0, _mapboxUtils.geoJsonFromData)(filteredIndex, getGeometry, getProperties);
    } // this layer is rendered at mapbox level
    // todo: maybe need to find a better solution for this one

  }, {
    key: "shouldRenderLayer",
    value: function shouldRenderLayer() {
      return typeof this.type === 'string' && this.config.isVisible && this.hasAllColumns();
    }
  }]);
  return MapboxLayerGL;
}(_baseLayer["default"]);

var _default = MapboxLayerGL;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYXBib3hnbC1sYXllci50cyJdLCJuYW1lcyI6WyJtYXBib3hSZXF1aXJlZENvbHVtbnMiLCJwb2ludENvbFJlc29sdmVyIiwibGF0IiwibG5nIiwiZmllbGRJZHgiLCJNYXBib3hMYXllckdMIiwiY29uZmlnIiwiZGF0YUlkIiwiZGF0YXNldHMiLCJncHVGaWx0ZXIiLCJjb2x1bW5zIiwiZGF0YXNldFNlbGVjdG9yIiwiY29sdW1uc1NlbGVjdG9yIiwiZGF0YXNldElkIiwiZ3B1RmlsdGVyU2VsZWN0b3IiLCJPVkVSTEFZX1RZUEVfQ09OU1QiLCJtYXBib3hnbCIsImRlZmF1bHRQb2ludENvbHVtblBhaXJzIiwiZmlsdGVyIiwiQXJyYXkiLCJpc0FycmF5IiwibGVuZ3RoIiwiZmlsdGVyZWRJbmRleCIsImlkIiwidmlzdWFsQ2hhbm5lbEZpZWxkcyIsIk9iamVjdCIsInZhbHVlcyIsInZpc3VhbENoYW5uZWxzIiwicmVkdWNlIiwiYWNjdSIsInYiLCJmaWVsZCIsIm5hbWUiLCJ1cGRhdGVUcmlnZ2VycyIsImdldERhdGEiLCJmaWx0ZXJWYWx1ZVVwZGF0ZVRyaWdnZXJzIiwiZ2V0TWV0YSIsInBvc2l0aW9uIiwiZXZlcnkiLCJOdW1iZXIiLCJpc0Zpbml0ZSIsInR5cGUiLCJjb29yZGluYXRlcyIsImdldFBvc2l0aW9uIiwiZGF0YUNvbnRhaW5lciIsImdldEdlb21ldHJ5IiwiZCIsInZjRmllbGRzIiwibWFwIiwiZ2V0UHJvcGVydHlGcm9tVmlzdWFsQ2hhbmVsIiwidmFsdWVBY2Nlc3NvciIsImZpbHRlclZhbHVlQWNjZXNzb3IiLCJoYXNGaWx0ZXIiLCJnZXRQcm9wZXJ0eUZyb21GaWx0ZXIiLCJmaWx0ZXJWYWx1ZSIsImkiLCJnZXRQcm9wZXJ0aWVzIiwiaXNWaXNpYmxlIiwiaGFzQWxsQ29sdW1ucyIsIkxheWVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBR0E7O0FBTUE7O0FBRUE7Ozs7Ozs7Ozs7QUFX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QUEwRCxLQUFLQyxhQUFMLEVBQWpFO0FBQ0Q7OztFQXJJeUJDLHFCOztlQXdJYnRELGEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTUlUXG4vLyBDb3B5cmlnaHQgY29udHJpYnV0b3JzIHRvIHRoZSBrZXBsZXIuZ2wgcHJvamVjdFxuXG5pbXBvcnQgTGF5ZXIsIHtcbiAgTGF5ZXJCYXNlQ29uZmlnLFxuICBMYXllckNvbHVtbixcbiAgT1ZFUkxBWV9UWVBFX0NPTlNULFxuICBWaXN1YWxDaGFubmVsc1xufSBmcm9tICcuL2Jhc2UtbGF5ZXInO1xuaW1wb3J0IHtjcmVhdGVTZWxlY3Rvcn0gZnJvbSAncmVzZWxlY3QnO1xuXG5pbXBvcnQge2dlb0pzb25Gcm9tRGF0YSwgcHJlZml4R3B1RmllbGQsIGdwdUZpbHRlclRvTWFwYm94RmlsdGVyfSBmcm9tICcuL21hcGJveC11dGlscyc7XG5pbXBvcnQge2RlZmF1bHQgYXMgS2VwbGVyVGFibGV9IGZyb20gJ0BrZXBsZXIuZ2wvdGFibGUnO1xuaW1wb3J0IHtNZXJnZX0gZnJvbSAnQGtlcGxlci5nbC90eXBlcyc7XG5cbnR5cGUgTWFwYm94TGF5ZXJHTENvbHVtbnMgPSB7XG4gIGxhdDogTGF5ZXJDb2x1bW47XG4gIGxuZzogTGF5ZXJDb2x1bW47XG59O1xuXG5leHBvcnQgdHlwZSBNYXBib3hMYXllckdMQ29uZmlnID0gTWVyZ2U8TGF5ZXJCYXNlQ29uZmlnLCB7Y29sdW1uczogTWFwYm94TGF5ZXJHTENvbHVtbnN9PjtcblxuZXhwb3J0IGNvbnN0IG1hcGJveFJlcXVpcmVkQ29sdW1uczogWydsYXQnLCAnbG5nJ10gPSBbJ2xhdCcsICdsbmcnXTtcblxuZXhwb3J0IGNvbnN0IHBvaW50Q29sUmVzb2x2ZXIgPSAoe2xhdCwgbG5nfTogTWFwYm94TGF5ZXJHTENvbHVtbnMpID0+XG4gIGAke2xhdC5maWVsZElkeH0tJHtsbmcuZmllbGRJZHh9YDtcblxuY2xhc3MgTWFwYm94TGF5ZXJHTCBleHRlbmRzIExheWVyIHtcbiAgZGVjbGFyZSBjb25maWc6IE1hcGJveExheWVyR0xDb25maWc7XG5cbiAgZ2V0IG92ZXJsYXlUeXBlKCkge1xuICAgIHJldHVybiBPVkVSTEFZX1RZUEVfQ09OU1QubWFwYm94Z2w7XG4gIH1cblxuICBnZXQgdHlwZSgpOiBzdHJpbmcgfCBudWxsIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGdldCBpc0FnZ3JlZ2F0ZWQoKTogdHJ1ZSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBnZXQgcmVxdWlyZWRMYXllckNvbHVtbnMoKSB7XG4gICAgcmV0dXJuIG1hcGJveFJlcXVpcmVkQ29sdW1ucztcbiAgfVxuXG4gIGdldCBjb2x1bW5QYWlycygpIHtcbiAgICByZXR1cm4gdGhpcy5kZWZhdWx0UG9pbnRDb2x1bW5QYWlycztcbiAgfVxuXG4gIGdldCBub25lTGF5ZXJEYXRhQWZmZWN0aW5nUHJvcHMoKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgZ2V0IHZpc3VhbENoYW5uZWxzKCk6IFZpc3VhbENoYW5uZWxzIHtcbiAgICByZXR1cm4ge307XG4gIH1cbiAgZGF0YXNldFNlbGVjdG9yID0gKGNvbmZpZzogTWFwYm94TGF5ZXJHTENvbmZpZykgPT4gY29uZmlnLmRhdGFJZDtcbiAgZ3B1RmlsdGVyU2VsZWN0b3IgPSAoY29uZmlnOiBNYXBib3hMYXllckdMQ29uZmlnLCBkYXRhc2V0cykgPT5cbiAgICAoKGNvbmZpZy5kYXRhSWQgJiYgZGF0YXNldHNbY29uZmlnLmRhdGFJZF0pIHx8IHt9KS5ncHVGaWx0ZXI7XG4gIGNvbHVtbnNTZWxlY3RvciA9IChjb25maWc6IE1hcGJveExheWVyR0xDb25maWcpID0+IHBvaW50Q29sUmVzb2x2ZXIoY29uZmlnLmNvbHVtbnMpO1xuXG4gIHNvdXJjZVNlbGVjdG9yID0gY3JlYXRlU2VsZWN0b3IoXG4gICAgdGhpcy5kYXRhc2V0U2VsZWN0b3IsXG4gICAgdGhpcy5jb2x1bW5zU2VsZWN0b3IsXG4gICAgKGRhdGFzZXRJZCwgY29sdW1ucykgPT4gYCR7ZGF0YXNldElkfS0ke2NvbHVtbnN9YFxuICApO1xuXG4gIGZpbHRlclNlbGVjdG9yID0gY3JlYXRlU2VsZWN0b3IodGhpcy5ncHVGaWx0ZXJTZWxlY3RvciwgZ3B1RmlsdGVyID0+XG4gICAgZ3B1RmlsdGVyVG9NYXBib3hGaWx0ZXIoZ3B1RmlsdGVyKVxuICApO1xuXG4gIGlzVmFsaWRGaWx0ZXIoZmlsdGVyKSB7XG4gICAgLy8gbWFwYm94IHdpbGwgY3Jhc2ggaWYgZmlsdGVyIGlzIG5vdCBhbiBhcnJheSBvciBlbXB0eVxuICAgIHJldHVybiBBcnJheS5pc0FycmF5KGZpbHRlcikgJiYgZmlsdGVyLmxlbmd0aDtcbiAgfVxuXG4gIGdldERhdGFVcGRhdGVUcmlnZ2Vycyh7ZmlsdGVyZWRJbmRleCwgZ3B1RmlsdGVyLCBpZH06IEtlcGxlclRhYmxlKTogYW55IHtcbiAgICBjb25zdCB7Y29sdW1uc30gPSB0aGlzLmNvbmZpZztcblxuICAgIGNvbnN0IHZpc3VhbENoYW5uZWxGaWVsZHMgPSBPYmplY3QudmFsdWVzKHRoaXMudmlzdWFsQ2hhbm5lbHMpLnJlZHVjZShcbiAgICAgIChhY2N1LCB2KSA9PiAoe1xuICAgICAgICAuLi5hY2N1LFxuICAgICAgICAuLi4odGhpcy5jb25maWdbdi5maWVsZF0gPyB7W3YuZmllbGRdOiB0aGlzLmNvbmZpZ1t2LmZpZWxkXS5uYW1lfSA6IHt9KVxuICAgICAgfSksXG4gICAgICB7fVxuICAgICk7XG5cbiAgICBjb25zdCB1cGRhdGVUcmlnZ2VycyA9IHtcbiAgICAgIGdldERhdGE6IHtcbiAgICAgICAgZGF0YXNldElkOiBpZCxcbiAgICAgICAgY29sdW1ucyxcbiAgICAgICAgZmlsdGVyZWRJbmRleCxcbiAgICAgICAgLi4udmlzdWFsQ2hhbm5lbEZpZWxkcyxcbiAgICAgICAgLi4uZ3B1RmlsdGVyLmZpbHRlclZhbHVlVXBkYXRlVHJpZ2dlcnNcbiAgICAgIH0sXG4gICAgICBnZXRNZXRhOiB7ZGF0YXNldElkOiBpZCwgY29sdW1uc31cbiAgICB9O1xuXG4gICAgcmV0dXJuIHVwZGF0ZVRyaWdnZXJzO1xuICB9XG5cbiAgZ2V0R2VvbWV0cnkocG9zaXRpb24pIHtcbiAgICByZXR1cm4gcG9zaXRpb24uZXZlcnkoTnVtYmVyLmlzRmluaXRlKVxuICAgICAgPyB7XG4gICAgICAgICAgdHlwZTogJ1BvaW50JyxcbiAgICAgICAgICBjb29yZGluYXRlczogcG9zaXRpb25cbiAgICAgICAgfVxuICAgICAgOiBudWxsO1xuICB9XG5cbiAgY2FsY3VsYXRlRGF0YUF0dHJpYnV0ZSh7ZGF0YUNvbnRhaW5lciwgZmlsdGVyZWRJbmRleCwgZ3B1RmlsdGVyfTogS2VwbGVyVGFibGUsIGdldFBvc2l0aW9uKSB7XG4gICAgY29uc3QgZ2V0R2VvbWV0cnkgPSBkID0+IHRoaXMuZ2V0R2VvbWV0cnkoZ2V0UG9zaXRpb24oZCkpO1xuXG4gICAgY29uc3QgdmNGaWVsZHMgPSBPYmplY3QudmFsdWVzKHRoaXMudmlzdWFsQ2hhbm5lbHMpXG4gICAgICAubWFwKHYgPT4gdGhpcy5jb25maWdbdi5maWVsZF0pXG4gICAgICAuZmlsdGVyKHYgPT4gdik7XG5cbiAgICBjb25zdCBnZXRQcm9wZXJ0eUZyb21WaXN1YWxDaGFuZWwgPSB2Y0ZpZWxkcy5sZW5ndGhcbiAgICAgID8gZCA9PlxuICAgICAgICAgIHZjRmllbGRzLnJlZHVjZShcbiAgICAgICAgICAgIChhY2N1LCBmaWVsZCkgPT4gKHtcbiAgICAgICAgICAgICAgLi4uYWNjdSxcbiAgICAgICAgICAgICAgW2ZpZWxkLm5hbWVdOiBmaWVsZC52YWx1ZUFjY2Vzc29yKGQpXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIHt9XG4gICAgICAgICAgKVxuICAgICAgOiBkID0+ICh7fSk7XG5cbiAgICBjb25zdCB7ZmlsdGVyVmFsdWVVcGRhdGVUcmlnZ2VycywgZmlsdGVyVmFsdWVBY2Nlc3Nvcn0gPSBncHVGaWx0ZXI7XG5cbiAgICAvLyBncHVGaWVsZCBUbyBwcm9wZXJ0eVxuICAgIGNvbnN0IGhhc0ZpbHRlciA9IE9iamVjdC52YWx1ZXMoZmlsdGVyVmFsdWVVcGRhdGVUcmlnZ2VycykuZmlsdGVyKGQgPT4gZCkubGVuZ3RoO1xuICAgIGNvbnN0IHZhbHVlQWNjZXNzb3IgPSBmaWx0ZXJWYWx1ZUFjY2Vzc29yKGRhdGFDb250YWluZXIpKCk7XG5cbiAgICBjb25zdCBnZXRQcm9wZXJ0eUZyb21GaWx0ZXIgPSBoYXNGaWx0ZXJcbiAgICAgID8gZCA9PiB7XG4gICAgICAgICAgY29uc3QgZmlsdGVyVmFsdWUgPSB2YWx1ZUFjY2Vzc29yKGQpO1xuICAgICAgICAgIHJldHVybiBPYmplY3QudmFsdWVzKGZpbHRlclZhbHVlVXBkYXRlVHJpZ2dlcnMpLnJlZHVjZShcbiAgICAgICAgICAgIChhY2N1OiBhbnksIG5hbWUsIGkpID0+ICh7XG4gICAgICAgICAgICAgIC4uLmFjY3UsXG4gICAgICAgICAgICAgIC4uLihuYW1lID8ge1twcmVmaXhHcHVGaWVsZChuYW1lKV06IGZpbHRlclZhbHVlW2ldfSA6IHt9KVxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICB7fVxuICAgICAgICAgICkgYXMgYW55O1xuICAgICAgICB9XG4gICAgICA6IGQgPT4gKHt9IGFzIGFueSk7XG5cbiAgICBjb25zdCBnZXRQcm9wZXJ0aWVzID0gZCA9PiAoe1xuICAgICAgLi4uZ2V0UHJvcGVydHlGcm9tVmlzdWFsQ2hhbmVsKGQpLFxuICAgICAgLi4uZ2V0UHJvcGVydHlGcm9tRmlsdGVyKGQpXG4gICAgfSk7XG5cbiAgICByZXR1cm4gZ2VvSnNvbkZyb21EYXRhKGZpbHRlcmVkSW5kZXgsIGdldEdlb21ldHJ5LCBnZXRQcm9wZXJ0aWVzKTtcbiAgfVxuXG4gIC8vIHRoaXMgbGF5ZXIgaXMgcmVuZGVyZWQgYXQgbWFwYm94IGxldmVsXG4gIC8vIHRvZG86IG1heWJlIG5lZWQgdG8gZmluZCBhIGJldHRlciBzb2x1dGlvbiBmb3IgdGhpcyBvbmVcbiAgc2hvdWxkUmVuZGVyTGF5ZXIoKSB7XG4gICAgcmV0dXJuIHR5cGVvZiB0aGlzLnR5cGUgPT09ICdzdHJpbmcnICYmIHRoaXMuY29uZmlnLmlzVmlzaWJsZSAmJiB0aGlzLmhhc0FsbENvbHVtbnMoKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBNYXBib3hMYXllckdMO1xuIl19