{"version":3,"file":"kepler-animation.js","names":["noop","findLayer","layers","layerKeyframe","find","layer","id","config","label","findFilterIdx","filters","filterKeyframe","Number","isFinite","filterIdx","findIndex","filter","KeplerAnimation","layerKeyframes","filterKeyframes","getTimeRangeFilterKeyframes","undefined","animationConfig","tripKeyframe","cameraKeyframe","onTripFrameUpdate","onFilterFrameUpdate","onLayerFrameUpdate","onCameraFrameUpdate","setKeyframes","draw","timeline","set","KeplerTripKeyframes","unattachedKeyframes","push","CameraKeyframes","length","reduce","acc","KeplerLayerKeyframes","KeplerFilterKeyframes","attachKeyframes","animation","getFrame","currentTime","Object","values","Animation"],"sources":["../../../src/animations/kepler-animation.js"],"sourcesContent":["// Copyright (c) 2021 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport {\n  CameraKeyframes,\n  KeplerFilterKeyframes,\n  KeplerLayerKeyframes,\n  KeplerTripKeyframes\n} from '../keyframes';\nimport Animation from './animation';\n\nfunction noop() {}\n\nexport function findLayer({layers, layerKeyframe}) {\n  // Either find layer using id or label.\n  return (\n    layers.find(layer => layer.id === layerKeyframe.id) ||\n    layers.find(layer => layer.config.label === layerKeyframe.label)\n  );\n}\n\nexport function findFilterIdx({filters, filterKeyframe}) {\n  // Either find filter using index or id.\n  return Number.isFinite(filterKeyframe.filterIdx)\n    ? filterKeyframe.filterIdx\n    : filters.findIndex(filter => filter.id === filterKeyframe.id);\n}\n\nexport default class KeplerAnimation extends Animation {\n  cameraKeyframe;\n  layerKeyframes = {};\n  filterKeyframes = {};\n  tripKeyframe = undefined;\n\n  constructor({\n    id = 'kepler',\n    layers = [],\n    layerKeyframes = [],\n    filters = [],\n    filterKeyframes = [],\n    getTimeRangeFilterKeyframes = undefined,\n    animationConfig = undefined,\n    tripKeyframe = undefined,\n    cameraKeyframe = undefined,\n    onTripFrameUpdate = noop,\n    onFilterFrameUpdate = noop,\n    onLayerFrameUpdate = noop,\n    onCameraFrameUpdate = noop\n  }) {\n    super({id});\n    this.onTripFrameUpdate = onTripFrameUpdate;\n    this.onFilterFrameUpdate = onFilterFrameUpdate;\n    this.onLayerFrameUpdate = onLayerFrameUpdate;\n    this.onCameraFrameUpdate = onCameraFrameUpdate;\n    this.layerKeyframes = {};\n    this.filterKeyframes = {};\n    this.setKeyframes({\n      layers,\n      layerKeyframes,\n      filters,\n      filterKeyframes,\n      cameraKeyframe,\n      animationConfig,\n      tripKeyframe,\n      getTimeRangeFilterKeyframes\n    });\n    this.draw();\n  }\n\n  setKeyframes({\n    layers = [],\n    layerKeyframes = [],\n    filters = [],\n    filterKeyframes = [],\n    getTimeRangeFilterKeyframes = undefined,\n    animationConfig = undefined,\n    tripKeyframe = undefined,\n    cameraKeyframe = undefined,\n    timeline = undefined\n  }) {\n    if (this.tripKeyframe && tripKeyframe) {\n      this.tripKeyframe.set({animationConfig, ...tripKeyframe});\n    } else if (tripKeyframe) {\n      this.tripKeyframe = new KeplerTripKeyframes({animationConfig, ...tripKeyframe});\n      this.unattachedKeyframes.push(this.tripKeyframe);\n    }\n\n    if (this.cameraKeyframe && cameraKeyframe) {\n      this.cameraKeyframe.set(cameraKeyframe);\n    } else if (cameraKeyframe) {\n      this.cameraKeyframe = new CameraKeyframes(cameraKeyframe);\n      this.unattachedKeyframes.push(this.cameraKeyframe);\n    }\n\n    if (layerKeyframes.length > 0) {\n      this.layerKeyframes = layerKeyframes.reduce((acc, layerKeyframe) => {\n        // Either find layer using id or label.\n        const layer = findLayer({layers, layerKeyframe});\n        if (layer) {\n          if (acc[layer.id]) {\n            acc[layer.id].set({layer, ...layerKeyframe});\n          } else {\n            acc[layer.id] = new KeplerLayerKeyframes({layer, ...layerKeyframe});\n            this.unattachedKeyframes.push(acc[layer.id]);\n          }\n        }\n        return acc;\n      }, this.layerKeyframes);\n    }\n\n    if (filterKeyframes.length > 0) {\n      this.filterKeyframes = filterKeyframes.reduce((acc, filterKeyframe) => {\n        const filterIdx = findFilterIdx({filters, filterKeyframe});\n        const filter = filters[filterIdx];\n        if (filter) {\n          if (acc[filter.id]) {\n            acc[filter.id].set({filter, ...filterKeyframe});\n          } else {\n            acc[filter.id] = new KeplerFilterKeyframes({\n              filter,\n              filterIdx,\n              getTimeRangeFilterKeyframes,\n              ...filterKeyframe\n            });\n            this.unattachedKeyframes.push(acc[filter.id]);\n          }\n        }\n        return acc;\n      }, this.filterKeyframes);\n    }\n\n    if (timeline) {\n      this.attachKeyframes(timeline);\n    }\n  }\n\n  getKeyframes() {\n    return {\n      cameraKeyframe: this.cameraKeyframe,\n      layerKeyframes: this.layerKeyframes,\n      filterKeyframes: this.filterKeyframes,\n      tripKeyframe: this.tripKeyframe\n    };\n  }\n\n  animator(animation) {\n    if (animation.cameraKeyframe) {\n      animation.onCameraFrameUpdate(animation.cameraKeyframe.getFrame());\n    }\n    if (animation.tripKeyframe) {\n      animation.onTripFrameUpdate(animation.tripKeyframe.getFrame().currentTime);\n    }\n    for (const filterKeyframe of Object.values(animation.filterKeyframes)) {\n      animation.onFilterFrameUpdate(filterKeyframe.filterIdx, 'value', filterKeyframe.getFrame());\n    }\n    for (const layerKeyframe of Object.values(animation.layerKeyframes)) {\n      animation.onLayerFrameUpdate(layerKeyframe.layer, layerKeyframe.getFrame());\n    }\n  }\n}\n"],"mappings":"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"}