"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _react = _interopRequireWildcard(require("react"));

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _classnames3 = _interopRequireDefault(require("classnames"));

var _sortable = require("@dnd-kit/sortable");

var _utilities = require("@dnd-kit/utilities");

var _layerPanel = _interopRequireDefault(require("./layer-panel"));

var _utils = require("@kepler.gl/utils");

var _constants = require("@kepler.gl/constants");

var _templateObject, _templateObject2;

// make sure the element is always visible while is being dragged
// item being dragged is appended in body, here to reset its global style
var Container = _styledComponents["default"].div(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2["default"])(["\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n"])));

var SortableStyledItem = _styledComponents["default"].div(_templateObject2 || (_templateObject2 = (0, _taggedTemplateLiteral2["default"])(["\n  z-index: ", ";\n  transition: ", ";\n  transform: ", ";\n  &.sorting {\n    opacity: 0.3;\n    pointer-events: none;\n  }\n  &.sorting-layers .layer-panel__header {\n    background-color: ", ";\n    font-family: ", ";\n    font-weight: ", ";\n    font-size: ", ";\n    line-height: ", ";\n    *,\n    *:before,\n    *:after {\n      box-sizing: border-box;\n    }\n    .layer__drag-handle {\n      opacity: 1;\n      color: ", ";\n    }\n  }\n"])), function (props) {
  return props.theme.dropdownWrapperZ + 1;
}, function (props) {
  return props.transition;
}, function (props) {
  return props.transform;
}, function (props) {
  return props.theme.panelBackgroundHover;
}, function (props) {
  return props.theme.fontFamily;
}, function (props) {
  return props.theme.fontWeight;
}, function (props) {
  return props.theme.fontSize;
}, function (props) {
  return props.theme.lineHeight;
}, function (props) {
  return props.theme.textColorHl;
});

var INITIAL_LAYERS_TO_SHOW = [];
LayerListFactory.deps = [_layerPanel["default"]];

function LayerListFactory(LayerPanel) {
  // By wrapping layer panel using a sortable element we don't have to implement the drag and drop logic into the panel itself;
  // Developers can provide any layer panel implementation and it will still be sortable
  var SortableItem = function SortableItem(_ref) {
    var layer = _ref.layer,
        idx = _ref.idx,
        panelProps = _ref.panelProps,
        layerActions = _ref.layerActions,
        disabled = _ref.disabled;

    var _useSortable = (0, _sortable.useSortable)({
      id: layer.id,
      data: {
        type: _constants.SORTABLE_LAYER_TYPE,
        parent: _constants.SORTABLE_SIDE_PANEL_TYPE
      },
      disabled: disabled
    }),
        attributes = _useSortable.attributes,
        listeners = _useSortable.listeners,
        setNodeRef = _useSortable.setNodeRef,
        isDragging = _useSortable.isDragging,
        transform = _useSortable.transform,
        transition = _useSortable.transition;

    return /*#__PURE__*/_react["default"].createElement(SortableStyledItem, (0, _extends2["default"])({
      ref: setNodeRef,
      className: (0, _classnames3["default"])((0, _defineProperty2["default"])({}, _constants.dataTestIds.sortableLayerItem, !disabled), (0, _defineProperty2["default"])({}, _constants.dataTestIds.staticLayerItem, disabled), {
        sorting: isDragging
      }),
      "data-testid": disabled ? _constants.dataTestIds.staticLayerItem : _constants.dataTestIds.sortableLayerItem,
      transform: _utilities.CSS.Transform.toString(transform),
      transition: transition
    }, attributes), /*#__PURE__*/_react["default"].createElement(LayerPanel, (0, _extends2["default"])({}, panelProps, layerActions, {
      key: layer.id,
      idx: idx,
      layer: layer,
      listeners: listeners,
      isDraggable: !disabled
    })));
  };

  var LayerList = function LayerList(props) {
    var layers = props.layers,
        datasets = props.datasets,
        layerOrder = props.layerOrder,
        uiStateActions = props.uiStateActions,
        visStateActions = props.visStateActions,
        layerClasses = props.layerClasses,
        _props$isSortable = props.isSortable,
        isSortable = _props$isSortable === void 0 ? true : _props$isSortable;
    var openModal = uiStateActions.toggleModal;
    var layersToShow = (0, _react.useMemo)(function () {
      return layerOrder.reduce(function (acc, layerId) {
        var layer = (0, _utils.findById)(layerId)(layers.filter(Boolean));

        if (!layer) {
          return acc;
        }

        return !layer.config.hidden ? [].concat((0, _toConsumableArray2["default"])(acc), [layer]) : acc;
      }, INITIAL_LAYERS_TO_SHOW);
    }, [layers, layerOrder]);
    var sidePanelDndItems = (0, _react.useMemo)(function () {
      return layersToShow.map(function (_ref2) {
        var id = _ref2.id;
        return id;
      });
    }, [layersToShow]);
    var layerTypeOptions = (0, _react.useMemo)(function () {
      return Object.keys(layerClasses).map(function (key) {
        var layer = new layerClasses[key]({
          dataId: ''
        });
        return {
          id: key,
          label: layer.name,
          icon: layer.layerIcon,
          requireData: layer.requireData
        };
      });
    }, [layerClasses]);
    var layerActions = (0, _react.useMemo)(function () {
      return {
        layerColorUIChange: visStateActions.layerColorUIChange,
        layerConfigChange: visStateActions.layerConfigChange,
        layerVisualChannelConfigChange: visStateActions.layerVisualChannelConfigChange,
        layerTypeChange: visStateActions.layerTypeChange,
        layerVisConfigChange: visStateActions.layerVisConfigChange,
        layerTextLabelChange: visStateActions.layerTextLabelChange,
        removeLayer: visStateActions.removeLayer,
        duplicateLayer: visStateActions.duplicateLayer,
        layerSetIsValid: visStateActions.layerSetIsValid
      };
    }, [visStateActions]);
    var panelProps = (0, _react.useMemo)(function () {
      return {
        datasets: datasets,
        openModal: openModal,
        layerTypeOptions: layerTypeOptions
      };
    }, [datasets, openModal, layerTypeOptions]);
    return /*#__PURE__*/_react["default"].createElement(Container, null, /*#__PURE__*/_react["default"].createElement(_sortable.SortableContext, {
      id: _constants.SORTABLE_SIDE_PANEL_TYPE,
      items: sidePanelDndItems,
      strategy: _sortable.verticalListSortingStrategy,
      disabled: !isSortable
    }, layersToShow.map(function (layer) {
      return /*#__PURE__*/_react["default"].createElement(SortableItem, {
        key: layer.id,
        layer: layer,
        idx: layers.findIndex(function (l) {
          return (l === null || l === void 0 ? void 0 : l.id) === layer.id;
        }),
        panelProps: panelProps,
        layerActions: layerActions,
        disabled: !isSortable
      });
    })));
  };

  return LayerList;
}

var _default = LayerListFactory;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zaWRlLXBhbmVsL2xheWVyLXBhbmVsL2xheWVyLWxpc3QudHN4Il0sIm5hbWVzIjpbIkNvbnRhaW5lciIsInN0eWxlZCIsImRpdiIsIlNvcnRhYmxlU3R5bGVkSXRlbSIsInByb3BzIiwidGhlbWUiLCJkcm9wZG93bldyYXBwZXJaIiwidHJhbnNpdGlvbiIsInRyYW5zZm9ybSIsInBhbmVsQmFja2dyb3VuZEhvdmVyIiwiZm9udEZhbWlseSIsImZvbnRXZWlnaHQiLCJmb250U2l6ZSIsImxpbmVIZWlnaHQiLCJ0ZXh0Q29sb3JIbCIsIklOSVRJQUxfTEFZRVJTX1RPX1NIT1ciLCJMYXllckxpc3RGYWN0b3J5IiwiZGVwcyIsIkxheWVyUGFuZWxGYWN0b3J5IiwiTGF5ZXJQYW5lbCIsIlNvcnRhYmxlSXRlbSIsImxheWVyIiwiaWR4IiwicGFuZWxQcm9wcyIsImxheWVyQWN0aW9ucyIsImRpc2FibGVkIiwiaWQiLCJkYXRhIiwidHlwZSIsIlNPUlRBQkxFX0xBWUVSX1RZUEUiLCJwYXJlbnQiLCJTT1JUQUJMRV9TSURFX1BBTkVMX1RZUEUiLCJhdHRyaWJ1dGVzIiwibGlzdGVuZXJzIiwic2V0Tm9kZVJlZiIsImlzRHJhZ2dpbmciLCJkYXRhVGVzdElkcyIsInNvcnRhYmxlTGF5ZXJJdGVtIiwic3RhdGljTGF5ZXJJdGVtIiwic29ydGluZyIsIkNTUyIsIlRyYW5zZm9ybSIsInRvU3RyaW5nIiwiTGF5ZXJMaXN0IiwibGF5ZXJzIiwiZGF0YXNldHMiLCJsYXllck9yZGVyIiwidWlTdGF0ZUFjdGlvbnMiLCJ2aXNTdGF0ZUFjdGlvbnMiLCJsYXllckNsYXNzZXMiLCJpc1NvcnRhYmxlIiwib3Blbk1vZGFsIiwidG9nZ2xlTW9kYWwiLCJsYXllcnNUb1Nob3ciLCJyZWR1Y2UiLCJhY2MiLCJsYXllcklkIiwiZmlsdGVyIiwiQm9vbGVhbiIsImNvbmZpZyIsImhpZGRlbiIsInNpZGVQYW5lbERuZEl0ZW1zIiwibWFwIiwibGF5ZXJUeXBlT3B0aW9ucyIsIk9iamVjdCIsImtleXMiLCJrZXkiLCJkYXRhSWQiLCJsYWJlbCIsIm5hbWUiLCJpY29uIiwibGF5ZXJJY29uIiwicmVxdWlyZURhdGEiLCJsYXllckNvbG9yVUlDaGFuZ2UiLCJsYXllckNvbmZpZ0NoYW5nZSIsImxheWVyVmlzdWFsQ2hhbm5lbENvbmZpZ0NoYW5nZSIsImxheWVyVHlwZUNoYW5nZSIsImxheWVyVmlzQ29uZmlnQ2hhbmdlIiwibGF5ZXJUZXh0TGFiZWxDaGFuZ2UiLCJyZW1vdmVMYXllciIsImR1cGxpY2F0ZUxheWVyIiwibGF5ZXJTZXRJc1ZhbGlkIiwidmVydGljYWxMaXN0U29ydGluZ1N0cmF0ZWd5IiwiZmluZEluZGV4IiwibCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUdBOztBQUNBOztBQUNBOztBQU1BOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBY0E7QUFDQTtBQUVBLElBQU1BLFNBQVMsR0FBR0MsNkJBQU9DLEdBQVYsa0pBQWY7O0FBV0EsSUFBTUMsa0JBQWtCLEdBQUdGLDZCQUFPQyxHQUFWLHdoQkFDWCxVQUFBRSxLQUFLO0FBQUEsU0FBSUEsS0FBSyxDQUFDQyxLQUFOLENBQVlDLGdCQUFaLEdBQStCLENBQW5DO0FBQUEsQ0FETSxFQUVSLFVBQUFGLEtBQUs7QUFBQSxTQUFJQSxLQUFLLENBQUNHLFVBQVY7QUFBQSxDQUZHLEVBR1QsVUFBQUgsS0FBSztBQUFBLFNBQUlBLEtBQUssQ0FBQ0ksU0FBVjtBQUFBLENBSEksRUFTQSxVQUFBSixLQUFLO0FBQUEsU0FBSUEsS0FBSyxDQUFDQyxLQUFOLENBQVlJLG9CQUFoQjtBQUFBLENBVEwsRUFVTCxVQUFBTCxLQUFLO0FBQUEsU0FBSUEsS0FBSyxDQUFDQyxLQUFOLENBQVlLLFVBQWhCO0FBQUEsQ0FWQSxFQVdMLFVBQUFOLEtBQUs7QUFBQSxTQUFJQSxLQUFLLENBQUNDLEtBQU4sQ0FBWU0sVUFBaEI7QUFBQSxDQVhBLEVBWVAsVUFBQVAsS0FBSztBQUFBLFNBQUlBLEtB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S0FBSyxFQUFFOEIsaUJBRlQ7QUFHRSxNQUFBLFFBQVEsRUFBRXFCLHFDQUhaO0FBSUUsTUFBQSxRQUFRLEVBQUUsQ0FBQ2hDO0FBSmIsT0FPR0csWUFBWSxDQUFDUyxHQUFiLENBQWlCLFVBQUF6QyxLQUFLO0FBQUEsMEJBQ3JCLGdDQUFDLFlBQUQ7QUFDRSxRQUFBLEdBQUcsRUFBRUEsS0FBSyxDQUFDSyxFQURiO0FBRUUsUUFBQSxLQUFLLEVBQUVMLEtBRlQ7QUFHRSxRQUFBLEdBQUcsRUFBRXVCLE1BQU0sQ0FBQ3VDLFNBQVAsQ0FBaUIsVUFBQUMsQ0FBQztBQUFBLGlCQUFJLENBQUFBLENBQUMsU0FBRCxJQUFBQSxDQUFDLFdBQUQsWUFBQUEsQ0FBQyxDQUFFMUQsRUFBSCxNQUFVTCxLQUFLLENBQUNLLEVBQXBCO0FBQUEsU0FBbEIsQ0FIUDtBQUlFLFFBQUEsVUFBVSxFQUFFSCxVQUpkO0FBS0UsUUFBQSxZQUFZLEVBQUVDLFlBTGhCO0FBTUUsUUFBQSxRQUFRLEVBQUUsQ0FBQzBCO0FBTmIsUUFEcUI7QUFBQSxLQUF0QixDQVBILENBREYsQ0FERjtBQXNCRCxHQXRGRDs7QUF1RkEsU0FBT1AsU0FBUDtBQUNEOztlQUNjM0IsZ0IiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTUlUXG4vLyBDb3B5cmlnaHQgY29udHJpYnV0b3JzIHRvIHRoZSBrZXBsZXIuZ2wgcHJvamVjdFxuXG5pbXBvcnQgUmVhY3QsIHt1c2VNZW1vfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgc3R5bGVkIGZyb20gJ3N0eWxlZC1jb21wb25lbnRzJztcbmltcG9ydCBjbGFzc25hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xuXG5pbXBvcnQge0xheWVyLCBMYXllckNsYXNzZXNUeXBlfSBmcm9tICdAa2VwbGVyLmdsL2xheWVycyc7XG5pbXBvcnQge0RhdGFzZXRzfSBmcm9tICdAa2VwbGVyLmdsL3RhYmxlJztcbmltcG9ydCB7VUlTdGF0ZUFjdGlvbnMsIFZpc1N0YXRlQWN0aW9uc30gZnJvbSAnQGtlcGxlci5nbC9hY3Rpb25zJztcblxuaW1wb3J0IHt1c2VTb3J0YWJsZSwgU29ydGFibGVDb250ZXh0LCB2ZXJ0aWNhbExpc3RTb3J0aW5nU3RyYXRlZ3l9IGZyb20gJ0BkbmQta2l0L3NvcnRhYmxlJztcbmltcG9ydCB7Q1NTfSBmcm9tICdAZG5kLWtpdC91dGlsaXRpZXMnO1xuaW1wb3J0IExheWVyUGFuZWxGYWN0b3J5IGZyb20gJy4vbGF5ZXItcGFuZWwnO1xuaW1wb3J0IHtmaW5kQnlJZH0gZnJvbSAnQGtlcGxlci5nbC91dGlscyc7XG5pbXBvcnQge2RhdGFUZXN0SWRzLCBTT1JUQUJMRV9MQVlFUl9UWVBFLCBTT1JUQUJMRV9TSURFX1BBTkVMX1RZUEV9IGZyb20gJ0BrZXBsZXIuZ2wvY29uc3RhbnRzJztcblxuZXhwb3J0IHR5cGUgTGF5ZXJMaXN0UHJvcHMgPSB7XG4gIGRhdGFzZXRzOiBEYXRhc2V0cztcbiAgbGF5ZXJzOiBMYXllcltdO1xuICBsYXllck9yZGVyOiBzdHJpbmdbXTtcbiAgbGF5ZXJDbGFzc2VzOiBMYXllckNsYXNzZXNUeXBlO1xuICBpc1NvcnRhYmxlPzogYm9vbGVhbjtcbiAgdWlTdGF0ZUFjdGlvbnM6IHR5cGVvZiBVSVN0YXRlQWN0aW9ucztcbiAgdmlzU3RhdGVBY3Rpb25zOiB0eXBlb2YgVmlzU3RhdGVBY3Rpb25zO1xufTtcblxuZXhwb3J0IHR5cGUgTGF5ZXJMaXN0RmFjdG9yeURlcHMgPSBbdHlwZW9mIExheWVyUGFuZWxGYWN0b3J5XTtcblxuLy8gbWFrZSBzdXJlIHRoZSBlbGVtZW50IGlzIGFsd2F5cyB2aXNpYmxlIHdoaWxlIGlzIGJlaW5nIGRyYWdnZWRcbi8vIGl0ZW0gYmVpbmcgZHJhZ2dlZCBpcyBhcHBlbmRlZCBpbiBib2R5LCBoZXJlIHRvIHJlc2V0IGl0cyBnbG9iYWwgc3R5bGVcblxuY29uc3QgQ29udGFpbmVyID0gc3R5bGVkLmRpdmBcbiAgZGlzcGxheTogZmxleDtcbiAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjtcbiAgZ2FwOiA4cHg7XG5gO1xuXG5pbnRlcmZhY2UgU29ydGFibGVTdHlsZWRJdGVtUHJvcHMge1xuICB0cmFuc2l0aW9uPzogc3RyaW5nO1xuICB0cmFuc2Zvcm0/OiBzdHJpbmc7XG59XG5cbmNvbnN0IFNvcnRhYmxlU3R5bGVkSXRlbSA9IHN0eWxlZC5kaXY8U29ydGFibGVTdHlsZWRJdGVtUHJvcHM+YFxuICB6LWluZGV4OiAke3Byb3BzID0+IHByb3BzLnRoZW1lLmRyb3Bkb3duV3JhcHBlclogKyAxfTtcbiAgdHJhbnNpdGlvbjogJHtwcm9wcyA9PiBwcm9wcy50cmFuc2l0aW9ufTtcbiAgdHJhbnNmb3JtOiAke3Byb3BzID0+IHByb3BzLnRyYW5zZm9ybX07XG4gICYuc29ydGluZyB7XG4gICAgb3BhY2l0eTogMC4zO1xuICAgIHBvaW50ZXItZXZlbnRzOiBub25lO1xuICB9XG4gICYuc29ydGluZy1sYXllcnMgLmxheWVyLXBhbmVsX19oZWFkZXIge1xuICAgIGJhY2tncm91bmQtY29sb3I6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUucGFuZWxCYWNrZ3JvdW5kSG92ZXJ9O1xuICAgIGZvbnQtZmFtaWx5OiAke3Byb3BzID0+IHByb3BzLnRoZW1lLmZvbnRGYW1pbHl9O1xuICAgIGZvbnQtd2VpZ2h0OiAke3Byb3BzID0+IHByb3BzLnRoZW1lLmZvbnRXZWlnaHR9O1xuICAgIGZvbnQtc2l6ZTogJHtwcm9wcyA9PiBwcm9wcy50aGVtZS5mb250U2l6ZX07XG4gICAgbGluZS1oZWlnaHQ6ICR7cHJvcHMgPT4gcHJvcHMudGhlbWUubGluZUhlaWdodH07XG4gICAgKixcbiAgICAqOmJlZm9yZSxcbiAgICAqOmFmdGVyIHtcbiAgICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7XG4gICAgfVxuICAgIC5sYXllcl9fZHJhZy1oYW5kbGUge1xuICAgICAgb3BhY2l0eTogMTtcbiAgICAgIGNvbG9yOiAke3Byb3BzID0+IHByb3BzLnRoZW1lLnRleHRDb2xvckhsfTtcbiAgICB9XG4gIH1cbmA7XG5cbmNvbnN0IElOSVRJQUxfTEFZRVJTX1RPX1NIT1c6IExheWVyW10gPSBbXTtcblxuTGF5ZXJMaXN0RmFjdG9yeS5kZXBzID0gW0xheWVyUGFuZWxGYWN0b3J5XTtcblxuZnVuY3Rpb24gTGF5ZXJMaXN0RmFjdG9yeShMYXllclBhbmVsOiBSZXR1cm5UeXBlPHR5cGVvZiBMYXllclBhbmVsRmFjdG9yeT4pIHtcbiAgLy8gQnkgd3JhcHBpbmcgbGF5ZXIgcGFuZWwgdXNpbmcgYSBzb3J0YWJsZSBlbGVtZW50IHdlIGRvbid0IGhhdmUgdG8gaW1wbGVtZW50IHRoZSBkcmFnIGFuZCBkcm9wIGxvZ2ljIGludG8gdGhlIHBhbmVsIGl0c2VsZjtcbiAgLy8gRGV2ZWxvcGVycyBjYW4gcHJvdmlkZSBhbnkgbGF5ZXIgcGFuZWwgaW1wbGVtZW50YXRpb24gYW5kIGl0IHdpbGwgc3RpbGwgYmUgc29ydGFibGVcbiAgY29uc3QgU29ydGFibGVJdGVtID0gKHtsYXllciwgaWR4LCBwYW5lbFByb3BzLCBsYXllckFjdGlvbnMsIGRpc2FibGVkfSkgPT4ge1xuICAgIGNvbnN0IHthdHRyaWJ1dGVzLCBsaXN0ZW5lcnMsIHNldE5vZGVSZWYsIGlzRHJhZ2dpbmcsIHRyYW5zZm9ybSwgdHJhbnNpdGlvbn0gPSB1c2VTb3J0YWJsZSh7XG4gICAgICBpZDogbGF5ZXIuaWQsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIHR5cGU6IFNPUlRBQkxFX0xBWUVSX1RZUEUsXG4gICAgICAgIHBhcmVudDogU09SVEFCTEVfU0lERV9QQU5FTF9UWVBFXG4gICAgICB9LFxuICAgICAgZGlzYWJsZWRcbiAgICB9KTtcblxuICAgIHJldHVybiAoXG4gICAgICA8U29ydGFibGVTdHlsZWRJdGVtXG4gICAgICAgIHJlZj17c2V0Tm9kZVJlZn1cbiAgICAgICAgY2xhc3NOYW1lPXtjbGFzc25hbWVzKFxuICAgICAgICAgIHtbZGF0YVRlc3RJZHMuc29ydGFibGVMYXllckl0ZW1dOiAhZGlzYWJsZWR9LFxuICAgICAgICAgIHtbZGF0YVRlc3RJZHMuc3RhdGljTGF5ZXJJdGVtXTogZGlzYWJsZWR9LFxuICAgICAgICAgIHtzb3J0aW5nOiBpc0RyYWdnaW5nfVxuICAgICAgICApfVxuICAgICAgICBkYXRhLXRlc3RpZD17ZGlzYWJsZWQgPyBkYXRhVGVzdElkcy5zdGF0aWNMYXllckl0ZW0gOiBkYXRhVGVzdElkcy5zb3J0YWJsZUxheWVySXRlbX1cbiAgICAgICAgdHJhbnNmb3JtPXtDU1MuVHJhbnNmb3JtLnRvU3RyaW5nKHRyYW5zZm9ybSl9XG4gICAgICAgIHRyYW5zaXRpb249e3RyYW5zaXRpb259XG4gICAgICAgIHsuLi5hdHRyaWJ1dGVzfVxuICAgICAgPlxuICAgICAgICA8TGF5ZXJQYW5lbFxuICAgICAgICAgIHsuLi5wYW5lbFByb3BzfVxuICAgICAgICAgIHsuLi5sYXllckFjdGlvbnN9XG4gICAgICAgICAga2V5PXtsYXllci5pZH1cbiAgICAgICAgICBpZHg9e2lkeH1cbiAgICAgICAgICBsYXllcj17bGF5ZXJ9XG4gICAgICAgICAgbGlzdGVuZXJzPXtsaXN0ZW5lcnN9XG4gICAgICAgICAgaXNEcmFnZ2FibGU9eyFkaXNhYmxlZH1cbiAgICAgICAgLz5cbiAgICAgIDwvU29ydGFibGVTdHlsZWRJdGVtPlxuICAgICk7XG4gIH07XG5cbiAgY29uc3QgTGF5ZXJMaXN0OiBSZWFjdC5GQzxMYXllckxpc3RQcm9wcz4gPSBwcm9wcyA9PiB7XG4gICAgY29uc3Qge1xuICAgICAgbGF5ZXJzLFxuICAgICAgZGF0YXNldHMsXG4gICAgICBsYXllck9yZGVyLFxuICAgICAgdWlTdGF0ZUFjdGlvbnMsXG4gICAgICB2aXNTdGF0ZUFjdGlvbnMsXG4gICAgICBsYXllckNsYXNzZXMsXG4gICAgICBpc1NvcnRhYmxlID0gdHJ1ZVxuICAgIH0gPSBwcm9wcztcbiAgICBjb25zdCB7dG9nZ2xlTW9kYWw6IG9wZW5Nb2RhbH0gPSB1aVN0YXRlQWN0aW9ucztcblxuICAgIGNvbnN0IGxheWVyc1RvU2hvdyA9IHVzZU1lbW8oKCkgPT4ge1xuICAgICAgcmV0dXJuIGxheWVyT3JkZXIucmVkdWNlKChhY2MsIGxheWVySWQpID0+IHtcbiAgICAgICAgY29uc3QgbGF5ZXIgPSBmaW5kQnlJZChsYXllcklkKShsYXllcnMuZmlsdGVyKEJvb2xlYW4pKTtcbiAgICAgICAgaWYgKCFsYXllcikge1xuICAgICAgICAgIHJldHVybiBhY2M7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICFsYXllci5jb25maWcuaGlkZGVuID8gWy4uLmFjYywgbGF5ZXJdIDogYWNjO1xuICAgICAgfSwgSU5JVElBTF9MQVlFUlNfVE9fU0hPVyk7XG4gICAgfSwgW2xheWVycywgbGF5ZXJPcmRlcl0pO1xuXG4gICAgY29uc3Qgc2lkZVBhbmVsRG5kSXRlbXMgPSB1c2VNZW1vKCgpID0+IHtcbiAgICAgIHJldHVybiBsYXllcnNUb1Nob3cubWFwKCh7aWR9KSA9PiBpZCk7XG4gICAgfSwgW2xheWVyc1RvU2hvd10pO1xuXG4gICAgY29uc3QgbGF5ZXJUeXBlT3B0aW9ucyA9IHVzZU1lbW8oXG4gICAgICAoKSA9PlxuICAgICAgICBPYmplY3Qua2V5cyhsYXllckNsYXNzZXMpLm1hcChrZXkgPT4ge1xuICAgICAgICAgIGNvbnN0IGxheWVyID0gbmV3IGxheWVyQ2xhc3Nlc1trZXldKHtkYXRhSWQ6ICcnfSk7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGlkOiBrZXksXG4gICAgICAgICAgICBsYWJlbDogbGF5ZXIubmFtZSxcbiAgICAgICAgICAgIGljb246IGxheWVyLmxheWVySWNvbixcbiAgICAgICAgICAgIHJlcXVpcmVEYXRhOiBsYXllci5yZXF1aXJlRGF0YVxuICAgICAgICAgIH07XG4gICAgICAgIH0pLFxuICAgICAgW2xheWVyQ2xhc3Nlc11cbiAgICApO1xuXG4gICAgY29uc3QgbGF5ZXJBY3Rpb25zID0gdXNlTWVtbyhcbiAgICAgICgpID0+ICh7XG4gICAgICAgIGxheWVyQ29sb3JVSUNoYW5nZTogdmlzU3RhdGVBY3Rpb25zLmxheWVyQ29sb3JVSUNoYW5nZSxcbiAgICAgICAgbGF5ZXJDb25maWdDaGFuZ2U6IHZpc1N0YXRlQWN0aW9ucy5sYXllckNvbmZpZ0NoYW5nZSxcbiAgICAgICAgbGF5ZXJWaXN1YWxDaGFubmVsQ29uZmlnQ2hhbmdlOiB2aXNTdGF0ZUFjdGlvbnMubGF5ZXJWaXN1YWxDaGFubmVsQ29uZmlnQ2hhbmdlLFxuICAgICAgICBsYXllclR5cGVDaGFuZ2U6IHZpc1N0YXRlQWN0aW9ucy5sYXllclR5cGVDaGFuZ2UsXG4gICAgICAgIGxheWVyVmlzQ29uZmlnQ2hhbmdlOiB2aXNTdGF0ZUFjdGlvbnMubGF5ZXJWaXNDb25maWdDaGFuZ2UsXG4gICAgICAgIGxheWVyVGV4dExhYmVsQ2hhbmdlOiB2aXNTdGF0ZUFjdGlvbnMubGF5ZXJUZXh0TGFiZWxDaGFuZ2UsXG4gICAgICAgIHJlbW92ZUxheWVyOiB2aXNTdGF0ZUFjdGlvbnMucmVtb3ZlTGF5ZXIsXG4gICAgICAgIGR1cGxpY2F0ZUxheWVyOiB2aXNTdGF0ZUFjdGlvbnMuZHVwbGljYXRlTGF5ZXIsXG4gICAgICAgIGxheWVyU2V0SXNWYWxpZDogdmlzU3RhdGVBY3Rpb25zLmxheWVyU2V0SXNWYWxpZFxuICAgICAgfSksXG4gICAgICBbdmlzU3RhdGVBY3Rpb25zXVxuICAgICk7XG5cbiAgICBjb25zdCBwYW5lbFByb3BzID0gdXNlTWVtbyhcbiAgICAgICgpID0+ICh7XG4gICAgICAgIGRhdGFzZXRzLFxuICAgICAgICBvcGVuTW9kYWwsXG4gICAgICAgIGxheWVyVHlwZU9wdGlvbnNcbiAgICAgIH0pLFxuICAgICAgW2RhdGFzZXRzLCBvcGVuTW9kYWwsIGxheWVyVHlwZU9wdGlvbnNdXG4gICAgKTtcblxuICAgIHJldHVybiAoXG4gICAgICA8Q29udGFpbmVyPlxuICAgICAgICA8U29ydGFibGVDb250ZXh0XG4gICAgICAgICAgaWQ9e1NPUlRBQkxFX1NJREVfUEFORUxfVFlQRX1cbiAgICAgICAgICBpdGVtcz17c2lkZVBhbmVsRG5kSXRlbXN9XG4gICAgICAgICAgc3RyYXRlZ3k9e3ZlcnRpY2FsTGlzdFNvcnRpbmdTdHJhdGVneX1cbiAgICAgICAgICBkaXNhYmxlZD17IWlzU29ydGFibGV9XG4gICAgICAgID5cbiAgICAgICAgICB7Lyogd2FybmluZzogY29udGFpbmVySWQgc2hvdWxkIGJlIHNpbWlsYXIgdG8gdGhlIGZpcnN0IGtleSBpbiBkbmRJdGVtcyBkZWZpbmVkIGluIGtlcGxlci1nbC5qcyovfVxuICAgICAgICAgIHtsYXllcnNUb1Nob3cubWFwKGxheWVyID0+IChcbiAgICAgICAgICAgIDxTb3J0YWJsZUl0ZW1cbiAgICAgICAgICAgICAga2V5PXtsYXllci5pZH1cbiAgICAgICAgICAgICAgbGF5ZXI9e2xheWVyfVxuICAgICAgICAgICAgICBpZHg9e2xheWVycy5maW5kSW5kZXgobCA9PiBsPy5pZCA9PT0gbGF5ZXIuaWQpfVxuICAgICAgICAgICAgICBwYW5lbFByb3BzPXtwYW5lbFByb3BzfVxuICAgICAgICAgICAgICBsYXllckFjdGlvbnM9e2xheWVyQWN0aW9uc31cbiAgICAgICAgICAgICAgZGlzYWJsZWQ9eyFpc1NvcnRhYmxlfVxuICAgICAgICAgICAgLz5cbiAgICAgICAgICApKX1cbiAgICAgICAgPC9Tb3J0YWJsZUNvbnRleHQ+XG4gICAgICA8L0NvbnRhaW5lcj5cbiAgICApO1xuICB9O1xuICByZXR1cm4gTGF5ZXJMaXN0O1xufVxuZXhwb3J0IGRlZmF1bHQgTGF5ZXJMaXN0RmFjdG9yeTtcbiJdfQ==