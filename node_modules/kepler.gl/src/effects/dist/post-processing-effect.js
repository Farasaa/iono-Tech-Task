"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.getDefaultValueForParameter = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _get2 = _interopRequireDefault(require("@babel/runtime/helpers/get"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _core = require("@deck.gl/core");

var _shadertools = require("@luma.gl/shadertools");

var _constants = require("@kepler.gl/constants");

var _effect = _interopRequireDefault(require("./effect"));

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = (0, _getPrototypeOf2["default"])(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = (0, _getPrototypeOf2["default"])(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return (0, _possibleConstructorReturn2["default"])(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var POSTPROCESSING_EFFECTS_DESCS = [_objectSpread(_objectSpread({}, _constants.POSTPROCESSING_EFFECTS.ink), {}, {
  "class": _shadertools.ink
}), _objectSpread(_objectSpread({}, _constants.POSTPROCESSING_EFFECTS.brightnessContrast), {}, {
  "class": _shadertools.brightnessContrast
}), _objectSpread(_objectSpread({}, _constants.POSTPROCESSING_EFFECTS.hueSaturation), {}, {
  "class": _shadertools.hueSaturation
}), _objectSpread(_objectSpread({}, _constants.POSTPROCESSING_EFFECTS.vibrance), {}, {
  "class": _shadertools.vibrance
}), _objectSpread(_objectSpread({}, _constants.POSTPROCESSING_EFFECTS.sepia), {}, {
  "class": _shadertools.sepia
}), _objectSpread(_objectSpread({}, _constants.POSTPROCESSING_EFFECTS.dotScreen), {}, {
  "class": _shadertools.dotScreen
}), _objectSpread(_objectSpread({}, _constants.POSTPROCESSING_EFFECTS.colorHalftone), {}, {
  "class": _shadertools.colorHalftone
}), _objectSpread(_objectSpread({}, _constants.POSTPROCESSING_EFFECTS.noise), {}, {
  "class": _shadertools.noise
}), _objectSpread(_objectSpread({}, _constants.POSTPROCESSING_EFFECTS.triangleBlur), {}, {
  "class": _shadertools.triangleBlur
}), _objectSpread(_objectSpread({}, _constants.POSTPROCESSING_EFFECTS.zoomBlur), {}, {
  "class": _shadertools.zoomBlur
}), _objectSpread(_objectSpread({}, _constants.POSTPROCESSING_EFFECTS.tiltShift), {}, {
  "class": _shadertools.tiltShift
}), _objectSpread(_objectSpread({}, _constants.POSTPROCESSING_EFFECTS.edgeWork), {}, {
  "class": _shadertools.edgeWork
}), _objectSpread(_objectSpread({}, _constants.POSTPROCESSING_EFFECTS.vignette), {}, {
  "class": _shadertools.vignette
}), _objectSpread(_objectSpread({}, _constants.POSTPROCESSING_EFFECTS.magnify), {}, {
  "class": _shadertools.magnify
}), _objectSpread(_objectSpread({}, _constants.POSTPROCESSING_EFFECTS.hexagonalPixelate), {}, {
  "class": _shadertools.hexagonalPixelate
})];
/**
 * Returns default parameter value based on effect description.
 * @param name Name of the parameter.
 * @param effectDescription Effect's description.
 * @param uniformsDesc Effect's uniforms.
 * @returns
 */

var getDefaultValueForParameter = function getDefaultValueForParameter(name, effectDescription, uniformsDesc) {
  var _ref, _ref2, _description$defaultV;

  var description = effectDescription.find(function (param) {
    return param.name === name;
  });
  var uniform = uniformsDesc[name];
  return (_ref = (_ref2 = (_description$defaultV = description === null || description === void 0 ? void 0 : description.defaultValue) !== null && _description$defaultV !== void 0 ? _description$defaultV : uniform === null || uniform === void 0 ? void 0 : uniform.value) !== null && _ref2 !== void 0 ? _ref2 : uniform) !== null && _ref !== void 0 ? _ref : description === null || description === void 0 ? void 0 : description.min;
};

exports.getDefaultValueForParameter = getDefaultValueForParameter;

var PostProcessingEffect = /*#__PURE__*/function (_Effect) {
  (0, _inherits2["default"])(PostProcessingEffect, _Effect);

  var _super = _createSuper(PostProcessingEffect);

  // deckEffect: PostProcessEffect | LightingEffect | null;
  function PostProcessingEffect(props) {
    (0, _classCallCheck2["default"])(this, PostProcessingEffect);
    return _super.call(this, props);
  }

  (0, _createClass2["default"])(PostProcessingEffect, [{
    key: "_initializeEffect",
    value: function _initializeEffect() {
      var _this = this;

      var effectDesc = POSTPROCESSING_EFFECTS_DESCS.find(function (desc) {
        return desc.type === _this.type;
      });

      if (effectDesc) {
        var _this$deckEffect, _this$deckEffect$modu;

        this.deckEffect = new _core.PostProcessEffect(effectDesc["class"], this.parameters);
        var uniforms = (_this$deckEffect = this.deckEffect) === null || _this$deckEffect === void 0 ? void 0 : (_this$deckEffect$modu = _this$deckEffect.module) === null || _this$deckEffect$modu === void 0 ? void 0 : _this$deckEffect$modu.uniforms;

        if (uniforms) {
          var _this$deckEffect2;

          // get default parameters
          var keys = Object.keys(uniforms);
          var defaultParameters = {};
          keys.forEach(function (key) {
            defaultParameters[key] = getDefaultValueForParameter(key, _this._uiConfig, uniforms);
          });
          this.parameters = _objectSpread(_objectSpread({}, defaultParameters), this.parameters);
          (_this$deckEffect2 = this.deckEffect) === null || _this$deckEffect2 === void 0 ? void 0 : _this$deckEffect2.setProps(this.parameters);
        }
      }
    }
  }, {
    key: "getDefaultProps",
    value: function getDefaultProps() {
      var props = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
      return (0, _get2["default"])((0, _getPrototypeOf2["default"])(PostProcessingEffect.prototype), "getDefaultProps", this).call(this, _objectSpread({
        type: _constants.DEFAULT_POST_PROCESSING_EFFECT_TYPE
      }, props));
    }
  }, {
    key: "setProps",
    value: function setProps(props) {
      (0, _get2["default"])((0, _getPrototypeOf2["default"])(PostProcessingEffect.prototype), "setProps", this).call(this, props); // any uniform updated?

      if (props.parameters) {
        var _this$deckEffect3;

        (_this$deckEffect3 = this.deckEffect) === null || _this$deckEffect3 === void 0 ? void 0 : _this$deckEffect3.setProps(this.parameters);
      }
    }
  }]);
  return PostProcessingEffect;
}(_effect["default"]);

var _default = PostProcessingEffect;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wb3N0LXByb2Nlc3NpbmctZWZmZWN0LnRzIl0sIm5hbWVzIjpbIlBPU1RQUk9DRVNTSU5HX0VGRkVDVFNfREVTQ1MiLCJQT1NUUFJPQ0VTU0lOR19FRkZFQ1RTIiwiaW5rIiwiYnJpZ2h0bmVzc0NvbnRyYXN0IiwiaHVlU2F0dXJhdGlvbiIsInZpYnJhbmNlIiwic2VwaWEiLCJkb3RTY3JlZW4iLCJjb2xvckhhbGZ0b25lIiwibm9pc2UiLCJ0cmlhbmdsZUJsdXIiLCJ6b29tQmx1ciIsInRpbHRTaGlmdCIsImVkZ2VXb3JrIiwidmlnbmV0dGUiLCJtYWduaWZ5IiwiaGV4YWdvbmFsUGl4ZWxhdGUiLCJnZXREZWZhdWx0VmFsdWVGb3JQYXJhbWV0ZXIiLCJuYW1lIiwiZWZmZWN0RGVzY3JpcHRpb24iLCJ1bmlmb3Jtc0Rlc2MiLCJkZXNjcmlwdGlvbiIsImZpbmQiLCJwYXJhbSIsInVuaWZvcm0iLCJkZWZhdWx0VmFsdWUiLCJ2YWx1ZSIsIm1pbiIsIlBvc3RQcm9jZXNzaW5nRWZmZWN0IiwicHJvcHMiLCJlZmZlY3REZXNjIiwiZGVzYyIsInR5cGUiLCJkZWNrRWZmZWN0IiwiRGVja1Bvc3RQcm9jZXNzRWZmZWN0IiwicGFyYW1ldGVycyIsInVuaWZvcm1zIiwibW9kdWxlIiwia2V5cyIsIk9iamVjdCIsImRlZmF1bHRQYXJhbWV0ZXJzIiwiZm9yRWFjaCIsImtleSIsIl91aUNvbmZpZyIsInNldFByb3BzIiwiREVGQVVMVF9QT1NUX1BST0NFU1NJTkdfRUZGRUNUX1RZUEUiLCJFZmZlY3QiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBR0E7O0FBQ0E7O0FBa0JBOztBQUdBOzs7Ozs7Ozs7O0FBRUEsSUFBTUEsNEJBQTRCLEdBQUcsaUNBRTlCQyxrQ0FBdUJDLEdBRk87QUFHakMsV0FBT0E7QUFIMEIsb0NBTTlCRCxrQ0FBdUJFLGtCQU5PO0FBT2pDLFdBQU9BO0FBUDBCLG9DQVU5QkYsa0NBQXVCRyxhQVZPO0FBV2pDLFdBQU9BO0FBWDBCLG9DQWM5Qkgsa0NBQXVCSSxRQWRPO0FBZWpDLFdBQU9BO0FBZjBCLG9DQWtCOUJKLGtDQUF1QkssS0FsQk87QUFtQmpDLFdBQU9BO0FBbkIwQixvQ0FzQjlCTCxrQ0FBdUJNLFNBdEJPO0FBdUJqQyxXQUFPQTtBQXZCMEIsb0NBMEI5Qk4sa0NBQXVCTyxhQTFCTztBQTJCakMsV0FBT0E7QUEzQjBCLG9DQThCOUJQLGtDQUF1QlEsS0E5Qk87QUErQmpDLFdBQU9BO0FBL0IwQixvQ0FrQzlCUixrQ0FBdUJTLFlBbENPO0FBbUNqQyxXQUFPQTtBQW5DMEIsb0NBc0M5QlQsa0NBQXVCVSxRQXRDTztBQXVDakMsV0FBT0E7QUF2QzBCLG9DQTBDOUJWLGtDQUF1QlcsU0ExQ087QUEyQ2pDLFdBQU9BO0FBM0MwQixvQ0E4QzlCWCxrQ0FBdUJZLFFBOUNPO0FBK0NqQyxXQUFPQTtBQS9DMEIsb0NBa0Q5Qlosa0NBQXVCYSxRQWxETztBQW1EakMsV0FBT0E7QUFuRDBCLG9DQXNEOUJiLGtDQUF1QmMsT0F0RE87QUF1RGpDLFdBQU9BO0FBdkQwQixvQ0EwRDlCZCxrQ0FBdUJlLGlCQTFETztBQTJEakMsV0FBT0E7QUEzRDBCLEdBQXJDO0FBK0RBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUNPLElBQU1DLDJCQUEyQixHQUFHLFNBQTlCQSwyQkFBOEIsQ0FDekNDLElBRHlDLEVBRXpDQyxpQkFGeUMsRUFHekNDLFlBSHlDLEVBSXRDO0FBQUE7O0FBQ0gsTUFBTUMsV0FBVyxHQUFHRixpQkFBaUIsQ0FBQ0csSUFBbEIsQ0FBdUIsVUFBQUMsS0FBSztBQUFBLFdBQUlBLEtBQUssQ0FBQ0wsSUFBTixLQUFlQSxJQUFuQjtBQUFBLEdBQTVCLENBQXBCO0FBQ0EsTUFBTU0sT0FBTyxHQUFHSixZQUFZLENBQUNGLElBQUQsQ0FBNUI7QUFDQSxtREFBT0csV0FBUCxhQUFPQSxXQUFQLHVCQUFPQSxXQUFXLENBQUVJLFlBQXBCLHlFQUFvQ0QsT0FBcEMsYUFBb0NBLE9BQXBDLHVCQUFvQ0EsT0FBTyxDQUFFRSxLQUE3Qyx5Q0FBc0RGLE9BQXRELHVDQUFpRUgsV0FBakUsYUFBaUVBLFdBQWpFLHVCQUFpRUEsV0FBVyxDQUFFTSxHQUE5RTtBQUNELENBUk07Ozs7SUFVREMsb0I7Ozs7O0FBQ0o7QUFFQSxnQ0FBWUMsS0FBWixFQUF1QztBQUFBO0FBQUEsNkJBQy9CQSxLQUQrQjtBQUV0Qzs7OztXQUVELDZCQUFvQjtBQUFBOztBQUNsQixVQUFNQyxVQUFVLEdBQUc5Qiw0QkFBNEIsQ0FBQ3NCLElBQTdCLENBQWtDLFVBQUFTLElBQUk7QUFBQSxlQUFJQSxJQUFJLENBQUNDLElBQUwsS0FBYyxLQUFJLENBQUNBLElBQXZCO0FBQUEsT0FBdEMsQ0FBbkI7O0FBQ0EsVUFBSUYsVUFBSixFQUFnQjtBQUFBOztBQUNkLGFBQUtHLFVBQUwsR0FBa0IsSUFBSUMsdUJBQUosQ0FBMEJKLFVBQVUsU0FBcEMsRUFBNEMsS0FBS0ssVUFBakQsQ0FBbEI7QUFFQSxZQUFNQyxRQUFRLHVCQUFHLEtBQUtILFVBQVIsOEVBQUcsaUJBQWlCSSxNQUFwQiwwREFBRyxzQkFBeUJELFFBQTFDOztBQUNBLFlBQUlBLFFBQUosRUFBYztBQUFBOztBQUNaO0FBQ0EsY0FBTUUsSUFBSSxHQUFHQyxNQUFNLENBQUNELElBQVAsQ0FBWUYsUUFBWixDQUFiO0FBQ0EsY0FBTUksaUJBQWlCLEdBQUcsRUFBMUI7QUFDQUYsVUFBQUEsSUFBSSxDQUFDRyxPQUFMLENBQWEsVUFBQUMsR0FBRyxFQUFJO0FBQ2xCRixZQUFBQSxpQkFBaUIsQ0FBQ0UsR0FBRCxDQUFqQixHQUF5QnpCLDJCQUEyQixDQUFDeUIsR0FBRCxFQUFNLEtBQUksQ0FBQ0MsU0FBWCxFQUFzQlAsUUFBdEIsQ0FBcEQ7QUFDRCxXQUZEO0FBR0EsZUFBS0QsVUFBTCxtQ0FBc0JLLGlCQUF0QixHQUE0QyxLQUFLTCxVQUFqRDtBQUNBLG9DQUFLRixVQUFMLHdFQUFpQlcsUUFBakIsQ0FBMEIsS0FBS1QsVUFBL0I7QUFDRDtBQUNGO0FBQ0Y7OztXQUVELDJCQUFnRDtBQUFBLFVBQWhDTixLQUFnQyx1RUFBSixFQUFJO0FBQzlDO0FBQThCRyxRQUFBQSxJQUFJLEVBQUVhO0FBQXBDLFNBQTRFaEIsS0FBNUU7QUFDRDs7O1dBRUQsa0JBQVNBLEtBQVQsRUFBb0M7QUFDbEMsMkhBQWVBLEtBQWYsRUFEa0MsQ0FHbEM7O0FBQ0EsVUFBSUEsS0FBSyxDQUFDTSxVQUFWLEVBQXNCO0FBQUE7O0FBQ3BCLGtDQUFLRixVQUFMLHdFQUFpQlcsUUFBakIsQ0FBMEIsS0FBS1QsVUFBL0I7QUFDRDtBQUNGOzs7RUFyQ2dDVyxrQjs7ZUF3Q3BCbEIsb0IiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTUlUXG4vLyBDb3B5cmlnaHQgY29udHJpYnV0b3JzIHRvIHRoZSBrZXBsZXIuZ2wgcHJvamVjdFxuXG5pbXBvcnQge1Bvc3RQcm9jZXNzRWZmZWN0IGFzIERlY2tQb3N0UHJvY2Vzc0VmZmVjdH0gZnJvbSAnQGRlY2suZ2wvY29yZSc7XG5pbXBvcnQge1xuICBicmlnaHRuZXNzQ29udHJhc3QsXG4gIGluayxcbiAgdHJpYW5nbGVCbHVyLFxuICBodWVTYXR1cmF0aW9uLFxuICB2aWJyYW5jZSxcbiAgY29sb3JIYWxmdG9uZSxcbiAgZG90U2NyZWVuLFxuICBlZGdlV29yayxcbiAgbm9pc2UsXG4gIHNlcGlhLFxuICB0aWx0U2hpZnQsXG4gIHZpZ25ldHRlLFxuICB6b29tQmx1cixcbiAgbWFnbmlmeSxcbiAgaGV4YWdvbmFsUGl4ZWxhdGVcbn0gZnJvbSAnQGx1bWEuZ2wvc2hhZGVydG9vbHMnO1xuXG5pbXBvcnQge1BPU1RQUk9DRVNTSU5HX0VGRkVDVFMsIERFRkFVTFRfUE9TVF9QUk9DRVNTSU5HX0VGRkVDVF9UWVBFfSBmcm9tICdAa2VwbGVyLmdsL2NvbnN0YW50cyc7XG5pbXBvcnQge0VmZmVjdFByb3BzUGFydGlhbCwgRWZmZWN0UGFyYW1ldGVyRGVzY3JpcHRpb259IGZyb20gJ0BrZXBsZXIuZ2wvdHlwZXMnO1xuXG5pbXBvcnQgRWZmZWN0IGZyb20gJy4vZWZmZWN0JztcblxuY29uc3QgUE9TVFBST0NFU1NJTkdfRUZGRUNUU19ERVNDUyA9IFtcbiAge1xuICAgIC4uLlBPU1RQUk9DRVNTSU5HX0VGRkVDVFMuaW5rLFxuICAgIGNsYXNzOiBpbmtcbiAgfSxcbiAge1xuICAgIC4uLlBPU1RQUk9DRVNTSU5HX0VGRkVDVFMuYnJpZ2h0bmVzc0NvbnRyYXN0LFxuICAgIGNsYXNzOiBicmlnaHRuZXNzQ29udHJhc3RcbiAgfSxcbiAge1xuICAgIC4uLlBPU1RQUk9DRVNTSU5HX0VGRkVDVFMuaHVlU2F0dXJhdGlvbixcbiAgICBjbGFzczogaHVlU2F0dXJhdGlvblxuICB9LFxuICB7XG4gICAgLi4uUE9TVFBST0NFU1NJTkdfRUZGRUNUUy52aWJyYW5jZSxcbiAgICBjbGFzczogdmlicmFuY2VcbiAgfSxcbiAge1xuICAgIC4uLlBPU1RQUk9DRVNTSU5HX0VGRkVDVFMuc2VwaWEsXG4gICAgY2xhc3M6IHNlcGlhXG4gIH0sXG4gIHtcbiAgICAuLi5QT1NUUFJPQ0VTU0lOR19FRkZFQ1RTLmRvdFNjcmVlbixcbiAgICBjbGFzczogZG90U2NyZWVuXG4gIH0sXG4gIHtcbiAgICAuLi5QT1NUUFJPQ0VTU0lOR19FRkZFQ1RTLmNvbG9ySGFsZnRvbmUsXG4gICAgY2xhc3M6IGNvbG9ySGFsZnRvbmVcbiAgfSxcbiAge1xuICAgIC4uLlBPU1RQUk9DRVNTSU5HX0VGRkVDVFMubm9pc2UsXG4gICAgY2xhc3M6IG5vaXNlXG4gIH0sXG4gIHtcbiAgICAuLi5QT1NUUFJPQ0VTU0lOR19FRkZFQ1RTLnRyaWFuZ2xlQmx1cixcbiAgICBjbGFzczogdHJpYW5nbGVCbHVyXG4gIH0sXG4gIHtcbiAgICAuLi5QT1NUUFJPQ0VTU0lOR19FRkZFQ1RTLnpvb21CbHVyLFxuICAgIGNsYXNzOiB6b29tQmx1clxuICB9LFxuICB7XG4gICAgLi4uUE9TVFBST0NFU1NJTkdfRUZGRUNUUy50aWx0U2hpZnQsXG4gICAgY2xhc3M6IHRpbHRTaGlmdFxuICB9LFxuICB7XG4gICAgLi4uUE9TVFBST0NFU1NJTkdfRUZGRUNUUy5lZGdlV29yayxcbiAgICBjbGFzczogZWRnZVdvcmtcbiAgfSxcbiAge1xuICAgIC4uLlBPU1RQUk9DRVNTSU5HX0VGRkVDVFMudmlnbmV0dGUsXG4gICAgY2xhc3M6IHZpZ25ldHRlXG4gIH0sXG4gIHtcbiAgICAuLi5QT1NUUFJPQ0VTU0lOR19FRkZFQ1RTLm1hZ25pZnksXG4gICAgY2xhc3M6IG1hZ25pZnlcbiAgfSxcbiAge1xuICAgIC4uLlBPU1RQUk9DRVNTSU5HX0VGRkVDVFMuaGV4YWdvbmFsUGl4ZWxhdGUsXG4gICAgY2xhc3M6IGhleGFnb25hbFBpeGVsYXRlXG4gIH1cbl07XG5cbi8qKlxuICogUmV0dXJucyBkZWZhdWx0IHBhcmFtZXRlciB2YWx1ZSBiYXNlZCBvbiBlZmZlY3QgZGVzY3JpcHRpb24uXG4gKiBAcGFyYW0gbmFtZSBOYW1lIG9mIHRoZSBwYXJhbWV0ZXIuXG4gKiBAcGFyYW0gZWZmZWN0RGVzY3JpcHRpb24gRWZmZWN0J3MgZGVzY3JpcHRpb24uXG4gKiBAcGFyYW0gdW5pZm9ybXNEZXNjIEVmZmVjdCdzIHVuaWZvcm1zLlxuICogQHJldHVybnNcbiAqL1xuZXhwb3J0IGNvbnN0IGdldERlZmF1bHRWYWx1ZUZvclBhcmFtZXRlciA9IChcbiAgbmFtZTogc3RyaW5nLFxuICBlZmZlY3REZXNjcmlwdGlvbjogRWZmZWN0UGFyYW1ldGVyRGVzY3JpcHRpb25bXSxcbiAgdW5pZm9ybXNEZXNjOiBhbnlcbikgPT4ge1xuICBjb25zdCBkZXNjcmlwdGlvbiA9IGVmZmVjdERlc2NyaXB0aW9uLmZpbmQocGFyYW0gPT4gcGFyYW0ubmFtZSA9PT0gbmFtZSk7XG4gIGNvbnN0IHVuaWZvcm0gPSB1bmlmb3Jtc0Rlc2NbbmFtZV07XG4gIHJldHVybiBkZXNjcmlwdGlvbj8uZGVmYXVsdFZhbHVlID8/IHVuaWZvcm0/LnZhbHVlID8/IHVuaWZvcm0gPz8gZGVzY3JpcHRpb24/Lm1pbjtcbn07XG5cbmNsYXNzIFBvc3RQcm9jZXNzaW5nRWZmZWN0IGV4dGVuZHMgRWZmZWN0IHtcbiAgLy8gZGVja0VmZmVjdDogUG9zdFByb2Nlc3NFZmZlY3QgfCBMaWdodGluZ0VmZmVjdCB8IG51bGw7XG5cbiAgY29uc3RydWN0b3IocHJvcHM6IEVmZmVjdFByb3BzUGFydGlhbCkge1xuICAgIHN1cGVyKHByb3BzKTtcbiAgfVxuXG4gIF9pbml0aWFsaXplRWZmZWN0KCkge1xuICAgIGNvbnN0IGVmZmVjdERlc2MgPSBQT1NUUFJPQ0VTU0lOR19FRkZFQ1RTX0RFU0NTLmZpbmQoZGVzYyA9PiBkZXNjLnR5cGUgPT09IHRoaXMudHlwZSk7XG4gICAgaWYgKGVmZmVjdERlc2MpIHtcbiAgICAgIHRoaXMuZGVja0VmZmVjdCA9IG5ldyBEZWNrUG9zdFByb2Nlc3NFZmZlY3QoZWZmZWN0RGVzYy5jbGFzcywgdGhpcy5wYXJhbWV0ZXJzKTtcblxuICAgICAgY29uc3QgdW5pZm9ybXMgPSB0aGlzLmRlY2tFZmZlY3Q/Lm1vZHVsZT8udW5pZm9ybXM7XG4gICAgICBpZiAodW5pZm9ybXMpIHtcbiAgICAgICAgLy8gZ2V0IGRlZmF1bHQgcGFyYW1ldGVyc1xuICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXModW5pZm9ybXMpO1xuICAgICAgICBjb25zdCBkZWZhdWx0UGFyYW1ldGVycyA9IHt9O1xuICAgICAgICBrZXlzLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgICBkZWZhdWx0UGFyYW1ldGVyc1trZXldID0gZ2V0RGVmYXVsdFZhbHVlRm9yUGFyYW1ldGVyKGtleSwgdGhpcy5fdWlDb25maWcsIHVuaWZvcm1zKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMucGFyYW1ldGVycyA9IHsuLi5kZWZhdWx0UGFyYW1ldGVycywgLi4udGhpcy5wYXJhbWV0ZXJzfTtcbiAgICAgICAgdGhpcy5kZWNrRWZmZWN0Py5zZXRQcm9wcyh0aGlzLnBhcmFtZXRlcnMpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGdldERlZmF1bHRQcm9wcyhwcm9wczogRWZmZWN0UHJvcHNQYXJ0aWFsID0ge30pIHtcbiAgICByZXR1cm4gc3VwZXIuZ2V0RGVmYXVsdFByb3BzKHt0eXBlOiBERUZBVUxUX1BPU1RfUFJPQ0VTU0lOR19FRkZFQ1RfVFlQRSwgLi4ucHJvcHN9KTtcbiAgfVxuXG4gIHNldFByb3BzKHByb3BzOiBFZmZlY3RQcm9wc1BhcnRpYWwpIHtcbiAgICBzdXBlci5zZXRQcm9wcyhwcm9wcyk7XG5cbiAgICAvLyBhbnkgdW5pZm9ybSB1cGRhdGVkP1xuICAgIGlmIChwcm9wcy5wYXJhbWV0ZXJzKSB7XG4gICAgICB0aGlzLmRlY2tFZmZlY3Q/LnNldFByb3BzKHRoaXMucGFyYW1ldGVycyk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFBvc3RQcm9jZXNzaW5nRWZmZWN0O1xuIl19