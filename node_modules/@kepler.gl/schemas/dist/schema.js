"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _window = require("global/window");

var _versions = require("./versions");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var Schema = /*#__PURE__*/function () {
  function Schema() {
    var _ref = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},
        _ref$version = _ref.version,
        version = _ref$version === void 0 ? _versions.CURRENT_VERSION : _ref$version,
        _ref$key = _ref.key,
        key = _ref$key === void 0 ? '' : _ref$key,
        _ref$properties = _ref.properties,
        properties = _ref$properties === void 0 ? null : _ref$properties;

    (0, _classCallCheck2["default"])(this, Schema);
    (0, _defineProperty2["default"])(this, "version", void 0);
    (0, _defineProperty2["default"])(this, "key", void 0);
    (0, _defineProperty2["default"])(this, "properties", void 0);
    this.version = version;
    this.properties = properties;
    this.key = key;
  }

  (0, _createClass2["default"])(Schema, [{
    key: "loadPropertiesOrApplySchema",
    value: function loadPropertiesOrApplySchema(node) {
      var parents = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
      var accumulator = arguments.length > 2 ? arguments[2] : undefined;
      return this._getPropertyValueFromSchema('load', node, parents, accumulator);
    }
  }, {
    key: "savePropertiesOrApplySchema",
    value: function savePropertiesOrApplySchema(node) {
      var parents = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
      var accumulator = arguments.length > 2 ? arguments[2] : undefined;
      return this._getPropertyValueFromSchema('save', node, parents, accumulator);
    }
  }, {
    key: "_getPropertyValueFromSchema",
    value: function _getPropertyValueFromSchema(operation, node) {
      var _this = this;

      var parents = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];
      var accumulator = arguments.length > 3 ? arguments[3] : undefined;
      var internal = "_".concat(operation);
      return (0, _defineProperty2["default"])({}, this.key, this.properties ? Object.keys(this.properties).reduce(function (accu, key) {
        return _objectSpread(_objectSpread({}, accu), key in node ? // @ts-expect-error
        _this.properties[key] ? // if it's another schema
        // @ts-expect-error
        _this.properties[key][operation] ? // call save or load
        // @ts-expect-error
        _this.properties[key][internal](node[key], [].concat((0, _toConsumableArray2["default"])(parents), [node]), accu) : {} : (0, _defineProperty2["default"])({}, key, node[key]) : {});
      }, {}) : node);
    }
  }, {
    key: "_isCurrentVersion",
    value: function _isCurrentVersion() {
      return this.version === _versions.CURRENT_VERSION;
    }
  }, {
    key: "outdatedVersionError",
    value: function outdatedVersionError() {
      if (!this._isCurrentVersion()) {
        _window.console.error("".concat(this.key, " ").concat(this.version, " is outdated. save should not be called anymore"));
      }
    }
  }, {
    key: "_save",
    value: function _save() {
      // make sure nothing is saved to an outdated version
      this.outdatedVersionError(); // @ts-expect-error

      return this.save.apply(this, arguments);
    }
  }, {
    key: "save",
    value: function save(node) {
      var parents = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
      var accumulator = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};
      return this.savePropertiesOrApplySchema(node, parents, accumulator);
    }
  }, {
    key: "_load",
    value: function _load() {
      // @ts-expect-error
      return this.load.apply(this, arguments);
    }
  }, {
    key: "load",
    value: function load(node) {
      var parents = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
      var accumulator = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};
      return this.loadPropertiesOrApplySchema(node, parents, accumulator);
    }
  }]);
  return Schema;
}();

exports["default"] = Schema;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zY2hlbWEudHMiXSwibmFtZXMiOlsiU2NoZW1hIiwidmVyc2lvbiIsIkNVUlJFTlRfVkVSU0lPTiIsImtleSIsInByb3BlcnRpZXMiLCJub2RlIiwicGFyZW50cyIsImFjY3VtdWxhdG9yIiwiX2dldFByb3BlcnR5VmFsdWVGcm9tU2NoZW1hIiwib3BlcmF0aW9uIiwiaW50ZXJuYWwiLCJPYmplY3QiLCJrZXlzIiwicmVkdWNlIiwiYWNjdSIsIl9pc0N1cnJlbnRWZXJzaW9uIiwiQ29uc29sZSIsImVycm9yIiwib3V0ZGF0ZWRWZXJzaW9uRXJyb3IiLCJzYXZlIiwic2F2ZVByb3BlcnRpZXNPckFwcGx5U2NoZW1hIiwibG9hZCIsImxvYWRQcm9wZXJ0aWVzT3JBcHBseVNjaGVtYSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFHQTs7QUFFQTs7Ozs7O0lBRXFCQSxNO0FBVW5CLG9CQWFRO0FBQUEsbUZBQUosRUFBSTtBQUFBLDRCQVpOQyxPQVlNO0FBQUEsUUFaTkEsT0FZTSw2QkFaSUMseUJBWUo7QUFBQSx3QkFYTkMsR0FXTTtBQUFBLFFBWE5BLEdBV00seUJBWEEsRUFXQTtBQUFBLCtCQVZOQyxVQVVNO0FBQUEsUUFWTkEsVUFVTSxnQ0FWTyxJQVVQOztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQ04sU0FBS0gsT0FBTCxHQUFlQSxPQUFmO0FBQ0EsU0FBS0csVUFBTCxHQUFrQkEsVUFBbEI7QUFDQSxTQUFLRCxHQUFMLEdBQVdBLEdBQVg7QUFDRDs7OztXQUVELHFDQUNFRSxJQURGLEVBSXdCO0FBQUEsVUFGdEJDLE9BRXNCLHVFQUZMLEVBRUs7QUFBQSxVQUR0QkMsV0FDc0I7QUFDdEIsYUFBTyxLQUFLQywyQkFBTCxDQUFpQyxNQUFqQyxFQUF5Q0gsSUFBekMsRUFBK0NDLE9BQS9DLEVBQXdEQyxXQUF4RCxDQUFQO0FBQ0Q7OztXQUVELHFDQUNFRixJQURGLEVBSXdCO0FBQUEsVUFGdEJDLE9BRXNCLHVFQUZGLEVBRUU7QUFBQSxVQUR0QkMsV0FDc0I7QUFDdEIsYUFBTyxLQUFLQywyQkFBTCxDQUFpQyxNQUFqQyxFQUF5Q0gsSUFBekMsRUFBK0NDLE9BQS9DLEVBQXdEQyxXQUF4RCxDQUFQO0FBQ0Q7OztXQUVELHFDQUE0QkUsU0FBNUIsRUFBdUNKLElBQXZDLEVBQXVGO0FBQUE7O0FBQUEsVUFBckNDLE9BQXFDLHVFQUFqQixFQUFpQjtBQUFBLFVBQWJDLFdBQWE7QUFDckYsVUFBTUcsUUFBUSxjQUFPRCxTQUFQLENBQWQ7QUFDQSxrREFDRyxLQUFLTixHQURSLEVBQ2MsS0FBS0MsVUFBTCxHQUNSTyxNQUFNLENBQUNDLElBQVAsQ0FBWSxLQUFLUixVQUFqQixFQUE2QlMsTUFBN0IsQ0FBb0MsVUFBQ0MsSUFBRCxFQUFPWCxHQUFQLEVBQWU7QUFDakQsK0NBQ0tXLElBREwsR0FFTVgsR0FBRyxJQUFJRSxJQUFQLEdBQ0E7QUFDQSxRQUFBLEtBQUksQ0FBQ0QsVUFBTCxDQUFnQkQsR0FBaEIsSUFDRTtBQUNBO0FBQ0EsUUFBQSxLQUFJLENBQUNDLFVBQUwsQ0FBZ0JELEdBQWhCLEVBQXFCTSxTQUFyQixJQUNFO0FBQ0E7QUFDQSxRQUFBLEtBQUksQ0FBQ0wsVUFBTCxDQUFnQkQsR0FBaEIsRUFBcUJPLFFBQXJCLEVBQStCTCxJQUFJLENBQUNGLEdBQUQsQ0FBbkMsZ0RBQThDRyxPQUE5QyxJQUF1REQsSUFBdkQsSUFBOERTLElBQTlELENBSEYsR0FJRSxFQVBKLHdDQVFJWCxHQVJKLEVBUVVFLElBQUksQ0FBQ0YsR0FBRCxDQVJkLENBRkEsR0FXQSxFQWJOO0FBZUQsT0FoQkQsRUFnQkcsRUFoQkgsQ0FEUSxHQWtCUkUsSUFuQk47QUFxQkQ7OztXQUVELDZCQUFvQjtBQUNsQixhQUFPLEtBQUtKLE9BQUwsS0FBaUJDLHlCQUF4QjtBQUNEOzs7V0FFRCxnQ0FBdUI7QUFDckIsVUFBSSxDQUFDLEtBQUthLGlCQUFMLEVBQUwsRUFBK0I7QUFDN0JDLHdCQUFRQyxLQUFSLFdBQWlCLEtBQUtkLEdBQXRCLGNBQTZCLEtBQUtGLE9BQWxDO0FBQ0Q7QUFDRjs7O1dBRUQsaUJBQWU7QUFDYjtBQUNBLFdBQUtpQixvQkFBTCxHQUZhLENBR2I7O0FBQ0EsYUFBTyxLQUFLQyxJQUFMLHVCQUFQO0FBQ0Q7OztXQUVELGNBQUtkLElBQUwsRUFBcUY7QUFBQSxVQUFyRUMsT0FBcUUsdUVBQWpELEVBQWlEO0FBQUEsVUFBN0NDLFdBQTZDLHVFQUExQixFQUEwQjtBQUNuRixhQUFPLEtBQUthLDJCQUFMLENBQWlDZixJQUFqQyxFQUF1Q0MsT0FBdkMsRUFBZ0RDLFdBQWhELENBQVA7QUFDRDs7O1dBRUQsaUJBQWU7QUFDYjtBQUNBLGFBQU8sS0FBS2MsSUFBTCx1QkFBUDtBQUNEOzs7V0FFRCxjQUFLaEIsSUFBTCxFQUFxRjtBQUFBLFVBQXJFQyxPQUFxRSx1RUFBakQsRUFBaUQ7QUFBQSxVQUE3Q0MsV0FBNkMsdUVBQTFCLEVBQTBCO0FBQ25GLGFBQU8sS0FBS2UsMkJBQUwsQ0FBaUNqQixJQUFqQyxFQUF1Q0MsT0FBdkMsRUFBZ0RDLFdBQWhELENBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIi8vIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVRcbi8vIENvcHlyaWdodCBjb250cmlidXRvcnMgdG8gdGhlIGtlcGxlci5nbCBwcm9qZWN0XG5cbmltcG9ydCB7Y29uc29sZSBhcyBDb25zb2xlfSBmcm9tICdnbG9iYWwvd2luZG93JztcblxuaW1wb3J0IHtDVVJSRU5UX1ZFUlNJT059IGZyb20gJy4vdmVyc2lvbnMnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTY2hlbWEge1xuICB2ZXJzaW9uOiBzdHJpbmc7XG4gIGtleTogc3RyaW5nO1xuICBwcm9wZXJ0aWVzOlxuICAgIHwge1xuICAgICAgICBba2V5OiBzdHJpbmddOiBudWxsIHwgU2NoZW1hO1xuICAgICAgfVxuICAgIHwgc3RyaW5nW11cbiAgICB8IG51bGw7XG5cbiAgY29uc3RydWN0b3Ioe1xuICAgIHZlcnNpb24gPSBDVVJSRU5UX1ZFUlNJT04sXG4gICAga2V5ID0gJycsXG4gICAgcHJvcGVydGllcyA9IG51bGxcbiAgfToge1xuICAgIHZlcnNpb24/OiBzdHJpbmc7XG4gICAga2V5Pzogc3RyaW5nO1xuICAgIHByb3BlcnRpZXM/OlxuICAgICAgfCB7XG4gICAgICAgICAgW2tleTogc3RyaW5nXTogbnVsbCB8IFNjaGVtYTtcbiAgICAgICAgfVxuICAgICAgfCBzdHJpbmdbXVxuICAgICAgfCBudWxsO1xuICB9ID0ge30pIHtcbiAgICB0aGlzLnZlcnNpb24gPSB2ZXJzaW9uO1xuICAgIHRoaXMucHJvcGVydGllcyA9IHByb3BlcnRpZXM7XG4gICAgdGhpcy5rZXkgPSBrZXk7XG4gIH1cblxuICBsb2FkUHJvcGVydGllc09yQXBwbHlTY2hlbWEoXG4gICAgbm9kZTogYW55LFxuICAgIHBhcmVudHM6IGFueVtdID0gW10sXG4gICAgYWNjdW11bGF0b3I/OiBhbnlcbiAgKToge1trZXk6IHN0cmluZ106IGFueX0ge1xuICAgIHJldHVybiB0aGlzLl9nZXRQcm9wZXJ0eVZhbHVlRnJvbVNjaGVtYSgnbG9hZCcsIG5vZGUsIHBhcmVudHMsIGFjY3VtdWxhdG9yKTtcbiAgfVxuXG4gIHNhdmVQcm9wZXJ0aWVzT3JBcHBseVNjaGVtYShcbiAgICBub2RlOiBhbnksXG4gICAgcGFyZW50czogb2JqZWN0W10gPSBbXSxcbiAgICBhY2N1bXVsYXRvcj86IGFueVxuICApOiB7W2tleTogc3RyaW5nXTogYW55fSB7XG4gICAgcmV0dXJuIHRoaXMuX2dldFByb3BlcnR5VmFsdWVGcm9tU2NoZW1hKCdzYXZlJywgbm9kZSwgcGFyZW50cywgYWNjdW11bGF0b3IpO1xuICB9XG5cbiAgX2dldFByb3BlcnR5VmFsdWVGcm9tU2NoZW1hKG9wZXJhdGlvbiwgbm9kZTogYW55LCBwYXJlbnRzOiBvYmplY3RbXSA9IFtdLCBhY2N1bXVsYXRvcikge1xuICAgIGNvbnN0IGludGVybmFsID0gYF8ke29wZXJhdGlvbn1gO1xuICAgIHJldHVybiB7XG4gICAgICBbdGhpcy5rZXldOiB0aGlzLnByb3BlcnRpZXNcbiAgICAgICAgPyBPYmplY3Qua2V5cyh0aGlzLnByb3BlcnRpZXMpLnJlZHVjZSgoYWNjdSwga2V5KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAuLi5hY2N1LFxuICAgICAgICAgICAgICAuLi4oa2V5IGluIG5vZGVcbiAgICAgICAgICAgICAgICA/IC8vIEB0cy1leHBlY3QtZXJyb3JcbiAgICAgICAgICAgICAgICAgIHRoaXMucHJvcGVydGllc1trZXldXG4gICAgICAgICAgICAgICAgICA/IC8vIGlmIGl0J3MgYW5vdGhlciBzY2hlbWFcbiAgICAgICAgICAgICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb3BlcnRpZXNba2V5XVtvcGVyYXRpb25dXG4gICAgICAgICAgICAgICAgICAgID8gLy8gY2FsbCBzYXZlIG9yIGxvYWRcbiAgICAgICAgICAgICAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yXG4gICAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9wZXJ0aWVzW2tleV1baW50ZXJuYWxdKG5vZGVba2V5XSwgWy4uLnBhcmVudHMsIG5vZGVdLCBhY2N1KVxuICAgICAgICAgICAgICAgICAgICA6IHt9XG4gICAgICAgICAgICAgICAgICA6IHtba2V5XTogbm9kZVtrZXldfVxuICAgICAgICAgICAgICAgIDoge30pXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH0sIHt9KVxuICAgICAgICA6IG5vZGVcbiAgICB9O1xuICB9XG5cbiAgX2lzQ3VycmVudFZlcnNpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMudmVyc2lvbiA9PT0gQ1VSUkVOVF9WRVJTSU9OO1xuICB9XG5cbiAgb3V0ZGF0ZWRWZXJzaW9uRXJyb3IoKSB7XG4gICAgaWYgKCF0aGlzLl9pc0N1cnJlbnRWZXJzaW9uKCkpIHtcbiAgICAgIENvbnNvbGUuZXJyb3IoYCR7dGhpcy5rZXl9ICR7dGhpcy52ZXJzaW9ufSBpcyBvdXRkYXRlZC4gc2F2ZSBzaG91bGQgbm90IGJlIGNhbGxlZCBhbnltb3JlYCk7XG4gICAgfVxuICB9XG5cbiAgX3NhdmUoLi4uYXJncykge1xuICAgIC8vIG1ha2Ugc3VyZSBub3RoaW5nIGlzIHNhdmVkIHRvIGFuIG91dGRhdGVkIHZlcnNpb25cbiAgICB0aGlzLm91dGRhdGVkVmVyc2lvbkVycm9yKCk7XG4gICAgLy8gQHRzLWV4cGVjdC1lcnJvclxuICAgIHJldHVybiB0aGlzLnNhdmUoLi4uYXJncyk7XG4gIH1cblxuICBzYXZlKG5vZGU6IGFueSwgcGFyZW50czogb2JqZWN0W10gPSBbXSwgYWNjdW11bGF0b3I6IGFueSA9IHt9KToge1trZXk6IHN0cmluZ106IGFueX0ge1xuICAgIHJldHVybiB0aGlzLnNhdmVQcm9wZXJ0aWVzT3JBcHBseVNjaGVtYShub2RlLCBwYXJlbnRzLCBhY2N1bXVsYXRvcik7XG4gIH1cblxuICBfbG9hZCguLi5hcmdzKSB7XG4gICAgLy8gQHRzLWV4cGVjdC1lcnJvclxuICAgIHJldHVybiB0aGlzLmxvYWQoLi4uYXJncyk7XG4gIH1cblxuICBsb2FkKG5vZGU6IGFueSwgcGFyZW50czogb2JqZWN0W10gPSBbXSwgYWNjdW11bGF0b3I6IGFueSA9IHt9KToge1trZXk6IHN0cmluZ106IGFueX0ge1xuICAgIHJldHVybiB0aGlzLmxvYWRQcm9wZXJ0aWVzT3JBcHBseVNjaGVtYShub2RlLCBwYXJlbnRzLCBhY2N1bXVsYXRvcik7XG4gIH1cbn1cbiJdfQ==