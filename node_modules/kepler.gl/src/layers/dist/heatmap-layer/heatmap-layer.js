"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.heatmapVisConfigs = exports.pointColResolver = exports.pointPosAccessor = exports.MAX_ZOOM_LEVEL = void 0;

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _get2 = _interopRequireDefault(require("@babel/runtime/helpers/get"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _reselect = require("reselect");

var _lodash = _interopRequireDefault(require("lodash.memoize"));

var _constants = require("@kepler.gl/constants");

var _mapboxglLayer = _interopRequireDefault(require("../mapboxgl-layer"));

var _heatmapLayerIcon = _interopRequireDefault(require("./heatmap-layer-icon"));

var _utils = require("@kepler.gl/utils");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = (0, _getPrototypeOf2["default"])(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = (0, _getPrototypeOf2["default"])(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return (0, _possibleConstructorReturn2["default"])(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }

var MAX_ZOOM_LEVEL = 18;
exports.MAX_ZOOM_LEVEL = MAX_ZOOM_LEVEL;

var pointPosAccessor = function pointPosAccessor(_ref) {
  var lat = _ref.lat,
      lng = _ref.lng;
  return function (dc) {
    return function (d) {
      return [dc.valueAt(d.index, lng.fieldIdx), dc.valueAt(d.index, lat.fieldIdx)];
    };
  };
};

exports.pointPosAccessor = pointPosAccessor;

var pointColResolver = function pointColResolver(_ref2) {
  var lat = _ref2.lat,
      lng = _ref2.lng;
  return "".concat(lat.fieldIdx, "-").concat(lng.fieldIdx);
};

exports.pointColResolver = pointColResolver;
var heatmapVisConfigs = {
  opacity: 'opacity',
  colorRange: 'colorRange',
  radius: 'heatmapRadius'
};
/**
 *
 * @param colorRange
 * @return [
 *  0, "rgba(33,102,172,0)",
 *  0.2, "rgb(103,169,207)",
 *  0.4, "rgb(209,229,240)",
 *  0.6, "rgb(253,219,199)",
 *  0.8, "rgb(239,138,98)",
 *  1, "rgb(178,24,43)"
 * ]
 */

exports.heatmapVisConfigs = heatmapVisConfigs;

var heatmapDensity = function heatmapDensity(colorRange) {
  var scaleFunction = _constants.SCALE_FUNC.quantize;
  var colors = ['#000000'].concat((0, _toConsumableArray2["default"])(colorRange.colors));
  var scale = scaleFunction().domain([0, 1]).range(colors);
  var colorDensity = scale.range().reduce(function (bands, level) {
    var invert = scale.invertExtent(level);
    return [].concat((0, _toConsumableArray2["default"])(bands), [invert[0], // first value in the range
    "rgb(".concat((0, _utils.hexToRgb)(level).join(','), ")") // color
    ]);
  }, []);
  colorDensity[1] = 'rgba(0,0,0,0)';
  return colorDensity;
};

var HeatmapLayer = /*#__PURE__*/function (_MapboxGLLayer) {
  (0, _inherits2["default"])(HeatmapLayer, _MapboxGLLayer);

  var _super = _createSuper(HeatmapLayer);

  function HeatmapLayer(props) {
    var _this;

    (0, _classCallCheck2["default"])(this, HeatmapLayer);
    _this = _super.call(this, props);
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "getPosition", void 0);
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "columnsSelector", function (config) {
      return pointColResolver(config.columns);
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "visConfigSelector", function (config) {
      return config.visConfig;
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "weightFieldSelector", function (config) {
      return config.weightField ? config.weightField.name : null;
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "weightDomainSelector", function (config) {
      return config.weightDomain;
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "paintSelector", (0, _reselect.createSelector)(_this.visConfigSelector, _this.weightFieldSelector, _this.weightDomainSelector, function (visConfig, weightField, weightDomain) {
      return {
        'heatmap-weight': weightField ? ['interpolate', ['linear'], ['get', weightField], weightDomain[0], 0, weightDomain[1], 1] : 1,
        'heatmap-intensity': ['interpolate', ['linear'], ['zoom'], 0, 1, MAX_ZOOM_LEVEL, 3],
        'heatmap-color': ['interpolate', ['linear'], ['heatmap-density']].concat((0, _toConsumableArray2["default"])(heatmapDensity(visConfig.colorRange))),
        'heatmap-radius': ['interpolate', ['linear'], ['zoom'], 0, 2, MAX_ZOOM_LEVEL, visConfig.radius // radius
        ],
        'heatmap-opacity': visConfig.opacity
      };
    }));
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "computeHeatmapConfiguration", (0, _reselect.createSelector)(_this.sourceSelector, _this.filterSelector, _this.paintSelector, function (source, filter, paint) {
      return _objectSpread({
        type: 'heatmap',
        id: _this.id,
        source: source,
        layout: {
          visibility: 'visible'
        },
        paint: paint
      }, _this.isValidFilter(filter) ? {
        filter: filter
      } : {});
    }));

    _this.registerVisConfig(heatmapVisConfigs);

    _this.getPosition = (0, _lodash["default"])(pointPosAccessor, pointColResolver);
    return _this;
  }

  (0, _createClass2["default"])(HeatmapLayer, [{
    key: "type",
    get: function get() {
      return 'heatmap';
    }
  }, {
    key: "visualChannels",
    get: function get() {
      return {
        // @ts-expect-error
        weight: {
          property: 'weight',
          field: 'weightField',
          scale: 'weightScale',
          domain: 'weightDomain',
          key: 'weight',
          // supportedFieldTypes can be determined by channelScaleType
          // or specified here
          defaultMeasure: 'property.density',
          supportedFieldTypes: [_constants.ALL_FIELD_TYPES.real, _constants.ALL_FIELD_TYPES.integer],
          channelScaleType: _constants.CHANNEL_SCALES.size
        }
      };
    }
  }, {
    key: "layerIcon",
    get: function get() {
      return _heatmapLayerIcon["default"];
    }
  }, {
    key: "getVisualChannelDescription",
    value: function getVisualChannelDescription(channel) {
      return channel === 'color' ? {
        label: 'property.color',
        measure: 'property.density'
      } : {
        label: 'property.weight',
        measure: this.config.weightField ? this.config.weightField.name : 'property.density'
      };
    }
  }, {
    key: "getDefaultLayerConfig",
    value: function getDefaultLayerConfig(props) {
      // mapbox heatmap layer color is always based on density
      // no need to set colorField, colorDomain and colorScale
      // eslint-disable-next-line no-unused-vars
      var _get$call$weightField = _objectSpread(_objectSpread({}, (0, _get2["default"])((0, _getPrototypeOf2["default"])(HeatmapLayer.prototype), "getDefaultLayerConfig", this).call(this, props)), {}, {
        weightField: null,
        weightDomain: [0, 1],
        weightScale: 'linear'
      }),
          colorField = _get$call$weightField.colorField,
          colorDomain = _get$call$weightField.colorDomain,
          colorScale = _get$call$weightField.colorScale,
          layerConfig = (0, _objectWithoutProperties2["default"])(_get$call$weightField, ["colorField", "colorDomain", "colorScale"]); // @ts-expect-error


      return layerConfig;
    }
  }, {
    key: "getPositionAccessor",
    value: function getPositionAccessor(dataContainer) {
      return this.getPosition(this.config.columns)(dataContainer);
    }
  }, {
    key: "updateLayerMeta",
    value: function updateLayerMeta(dataContainer) {
      var getPosition = this.getPositionAccessor(dataContainer);
      var bounds = this.getPointsBounds(dataContainer, getPosition);
      this.updateMeta({
        bounds: bounds
      });
    }
  }, {
    key: "formatLayerData",
    value: function formatLayerData(datasets, oldLayerData) {
      if (this.config.dataId === null) {
        return {};
      }

      var weightField = this.config.weightField;
      var dataContainer = datasets[this.config.dataId].dataContainer;
      var getPosition = this.getPositionAccessor(dataContainer);

      var _this$updateData = this.updateData(datasets, oldLayerData),
          data = _this$updateData.data;

      var newConfig = this.computeHeatmapConfiguration(this.config, datasets);
      newConfig.id = this.id;
      return {
        columns: this.config.columns,
        config: newConfig,
        data: data,
        weightField: weightField,
        getPosition: getPosition
      };
    }
  }]);
  return HeatmapLayer;
}(_mapboxglLayer["default"]);

var _default = HeatmapLayer;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9oZWF0bWFwLWxheWVyL2hlYXRtYXAtbGF5ZXIudHMiXSwibmFtZXMiOlsiTUFYX1pPT01fTEVWRUwiLCJwb2ludFBvc0FjY2Vzc29yIiwibGF0IiwibG5nIiwiZGMiLCJkIiwidmFsdWVBdCIsImluZGV4IiwiZmllbGRJZHgiLCJwb2ludENvbFJlc29sdmVyIiwiaGVhdG1hcFZpc0NvbmZpZ3MiLCJvcGFjaXR5IiwiY29sb3JSYW5nZSIsInJhZGl1cyIsImhlYXRtYXBEZW5zaXR5Iiwic2NhbGVGdW5jdGlvbiIsIlNDQUxFX0ZVTkMiLCJxdWFudGl6ZSIsImNvbG9ycyIsInNjYWxlIiwiZG9tYWluIiwicmFuZ2UiLCJjb2xvckRlbnNpdHkiLCJyZWR1Y2UiLCJiYW5kcyIsImxldmVsIiwiaW52ZXJ0IiwiaW52ZXJ0RXh0ZW50Iiwiam9pbiIsIkhlYXRtYXBMYXllciIsInByb3BzIiwiY29uZmlnIiwiY29sdW1ucyIsInZpc0NvbmZpZyIsIndlaWdodEZpZWxkIiwibmFtZSIsIndlaWdodERvbWFpbiIsInZpc0NvbmZpZ1NlbGVjdG9yIiwid2VpZ2h0RmllbGRTZWxlY3RvciIsIndlaWdodERvbWFpblNlbGVjdG9yIiwic291cmNlU2VsZWN0b3IiLCJmaWx0ZXJTZWxlY3RvciIsInBhaW50U2VsZWN0b3IiLCJzb3VyY2UiLCJmaWx0ZXIiLCJwYWludCIsInR5cGUiLCJpZCIsImxheW91dCIsInZpc2liaWxpdHkiLCJpc1ZhbGlkRmlsdGVyIiwicmVnaXN0ZXJWaXNDb25maWciLCJnZXRQb3NpdGlvbiIsIndlaWdodCIsInByb3BlcnR5IiwiZmllbGQiLCJrZXkiLCJkZWZhdWx0TWVhc3VyZSIsInN1cHBvcnRlZEZpZWxkVHlwZXMiLCJBTExfRklFTERfVFlQRVMiLCJyZWFsIiwiaW50ZWdlciIsImNoYW5uZWxTY2FsZVR5cGUiLCJDSEFOTkVMX1NDQUxFUyIsInNpemUiLCJIZWF0bWFwTGF5ZXJJY29uIiwiY2hhbm5lbCIsImxhYmVsIiwibWVhc3VyZSIsIndlaWdodFNjYWxlIiwiY29sb3JGaWVsZCIsImNvbG9yRG9tYWluIiwiY29sb3JTY2FsZSIsImxheWVyQ29uZmlnIiwiZGF0YUNvbnRhaW5lciIsImdldFBvc2l0aW9uQWNjZXNzb3IiLCJib3VuZHMiLCJnZXRQb2ludHNCb3VuZHMiLCJ1cGRhdGVNZXRhIiwiZGF0YXNldHMiLCJvbGRMYXllckRhdGEiLCJkYXRhSWQiLCJ1cGRhdGVEYXRhIiwiZGF0YSIsIm5ld0NvbmZpZyIsImNvbXB1dGVIZWF0bWFwQ29uZmlndXJhdGlvbiIsIk1hcGJveEdMTGF5ZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBUUE7Ozs7Ozs7Ozs7QUF1Qk8sSUFBTUEsY0FBYyxHQUFHLEVBQXZCOzs7QUFFQSxJQUFNQyxnQkFBZ0IsR0FBRyxTQUFuQkEsZ0JBQW1CO0FBQUEsTUFBRUMsR0FBRixRQUFFQSxHQUFGO0FBQUEsTUFBT0MsR0FBUCxRQUFPQSxHQUFQO0FBQUEsU0FBMkMsVUFDekVDLEVBRHlFO0FBQUEsV0FFdEUsVUFBQUMsQ0FBQztBQUFBLGFBQUksQ0FBQ0QsRUFBRSxDQUFDRSxPQUFILENBQVdELENBQUMsQ0FBQ0UsS0FBYixFQUFvQkosR0FBRyxDQUFDSyxRQUF4QixDQUFELEVBQW9DSixFQUFFLENBQUNFLE9BQUgsQ0FBV0QsQ0FBQyxDQUFDRSxLQUFiLEVBQW9CTCxHQUFHLENBQUNNLFFBQXhCLENBQXBDLENBQUo7QUFBQSxLQUZxRTtBQUFBLEdBQTNDO0FBQUEsQ0FBekI7Ozs7QUFJQSxJQUFNQyxnQkFBZ0IsR0FBRyxTQUFuQkEsZ0JBQW1CO0FBQUEsTUFBRVAsR0FBRixTQUFFQSxHQUFGO0FBQUEsTUFBT0MsR0FBUCxTQUFPQSxHQUFQO0FBQUEsbUJBQzNCRCxHQUFHLENBQUNNLFFBRHVCLGNBQ1hMLEdBQUcsQ0FBQ0ssUUFETztBQUFBLENBQXpCOzs7QUFHQSxJQUFNRSxpQkFJWixHQUFHO0FB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O0FBQ0EsV0FBSzBCLFVBQUwsQ0FBZ0I7QUFBQ0YsUUFBQUEsTUFBTSxFQUFOQTtBQUFELE9BQWhCO0FBQ0Q7OztXQXFERCx5QkFBZ0JHLFFBQWhCLEVBQTBCQyxZQUExQixFQUF3QztBQUN0QyxVQUFJLEtBQUtqRCxNQUFMLENBQVlrRCxNQUFaLEtBQXVCLElBQTNCLEVBQWlDO0FBQy9CLGVBQU8sRUFBUDtBQUNEOztBQUhxQyxVQUkvQi9DLFdBSitCLEdBSWhCLEtBQUtILE1BSlcsQ0FJL0JHLFdBSitCO0FBQUEsVUFLL0J3QyxhQUwrQixHQUtkSyxRQUFRLENBQUMsS0FBS2hELE1BQUwsQ0FBWWtELE1BQWIsQ0FMTSxDQUsvQlAsYUFMK0I7QUFNdEMsVUFBTXRCLFdBQVcsR0FBRyxLQUFLdUIsbUJBQUwsQ0FBeUJELGFBQXpCLENBQXBCOztBQU5zQyw2QkFPdkIsS0FBS1EsVUFBTCxDQUFnQkgsUUFBaEIsRUFBMEJDLFlBQTFCLENBUHVCO0FBQUEsVUFPL0JHLElBUCtCLG9CQU8vQkEsSUFQK0I7O0FBU3RDLFVBQU1DLFNBQVMsR0FBRyxLQUFLQywyQkFBTCxDQUFpQyxLQUFLdEQsTUFBdEMsRUFBOENnRCxRQUE5QyxDQUFsQjtBQUNBSyxNQUFBQSxTQUFTLENBQUNyQyxFQUFWLEdBQWUsS0FBS0EsRUFBcEI7QUFFQSxhQUFPO0FBQ0xmLFFBQUFBLE9BQU8sRUFBRSxLQUFLRCxNQUFMLENBQVlDLE9BRGhCO0FBRUxELFFBQUFBLE1BQU0sRUFBRXFELFNBRkg7QUFHTEQsUUFBQUEsSUFBSSxFQUFKQSxJQUhLO0FBSUxqRCxRQUFBQSxXQUFXLEVBQVhBLFdBSks7QUFLTGtCLFFBQUFBLFdBQVcsRUFBWEE7QUFMSyxPQUFQO0FBT0Q7OztFQWxKd0JrQyx5Qjs7ZUFxSlp6RCxZIiwic291cmNlc0NvbnRlbnQiOlsiLy8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVFxuLy8gQ29weXJpZ2h0IGNvbnRyaWJ1dG9ycyB0byB0aGUga2VwbGVyLmdsIHByb2plY3RcblxuaW1wb3J0IHtjcmVhdGVTZWxlY3Rvcn0gZnJvbSAncmVzZWxlY3QnO1xuaW1wb3J0IG1lbW9pemUgZnJvbSAnbG9kYXNoLm1lbW9pemUnO1xuaW1wb3J0IHtDSEFOTkVMX1NDQUxFUywgU0NBTEVfRlVOQywgQUxMX0ZJRUxEX1RZUEVTLCBDb2xvclJhbmdlfSBmcm9tICdAa2VwbGVyLmdsL2NvbnN0YW50cyc7XG5pbXBvcnQgTWFwYm94R0xMYXllciwge01hcGJveExheWVyR0xDb25maWd9IGZyb20gJy4uL21hcGJveGdsLWxheWVyJztcbmltcG9ydCBIZWF0bWFwTGF5ZXJJY29uIGZyb20gJy4vaGVhdG1hcC1sYXllci1pY29uJztcbmltcG9ydCB7XG4gIExheWVyQmFzZUNvbmZpZ1BhcnRpYWwsXG4gIExheWVyQ29sdW1uLFxuICBMYXllcldlaWdodENvbmZpZyxcbiAgVmlzdWFsQ2hhbm5lbHNcbn0gZnJvbSAnLi4vYmFzZS1sYXllcic7XG5pbXBvcnQge1Zpc0NvbmZpZ0NvbG9yUmFuZ2UsIFZpc0NvbmZpZ051bWJlciwgSGV4Q29sb3IsIE1lcmdlfSBmcm9tICdAa2VwbGVyLmdsL3R5cGVzJztcbmltcG9ydCB7aGV4VG9SZ2IsIERhdGFDb250YWluZXJJbnRlcmZhY2V9IGZyb20gJ0BrZXBsZXIuZ2wvdXRpbHMnO1xuXG5leHBvcnQgdHlwZSBIZWF0bWFwTGF5ZXJWaXNDb25maWdTZXR0aW5ncyA9IHtcbiAgb3BhY2l0eTogVmlzQ29uZmlnTnVtYmVyO1xuICBjb2xvclJhbmdlOiBWaXNDb25maWdDb2xvclJhbmdlO1xuICByYWRpdXM6IFZpc0NvbmZpZ051bWJlcjtcbn07XG5cbmV4cG9ydCB0eXBlIEhlYXRtYXBMYXllckNvbHVtbnNDb25maWcgPSB7bGF0OiBMYXllckNvbHVtbjsgbG5nOiBMYXllckNvbHVtbn07XG5cbmV4cG9ydCB0eXBlIEhlYXRtYXBMYXllclZpc0NvbmZpZyA9IHtcbiAgb3BhY2l0eTogbnVtYmVyO1xuICBjb2xvclJhbmdlOiBDb2xvclJhbmdlO1xuICByYWRpdXM6IG51bWJlcjtcbn07XG5cbmV4cG9ydCB0eXBlIEhlYXRtYXBMYXllclZpc3VhbENoYW5uZWxDb25maWcgPSBMYXllcldlaWdodENvbmZpZztcbmV4cG9ydCB0eXBlIEhlYXRtYXBMYXllckNvbmZpZyA9IE1lcmdlPFxuICBNYXBib3hMYXllckdMQ29uZmlnLFxuICB7Y29sdW1uczogSGVhdG1hcExheWVyQ29sdW1uc0NvbmZpZzsgdmlzQ29uZmlnOiBIZWF0bWFwTGF5ZXJWaXNDb25maWd9XG4+ICZcbiAgSGVhdG1hcExheWVyVmlzdWFsQ2hhbm5lbENvbmZpZztcblxuZXhwb3J0IGNvbnN0IE1BWF9aT09NX0xFVkVMID0gMTg7XG5cbmV4cG9ydCBjb25zdCBwb2ludFBvc0FjY2Vzc29yID0gKHtsYXQsIGxuZ306IEhlYXRtYXBMYXllckNvbHVtbnNDb25maWcpID0+IChcbiAgZGM6IERhdGFDb250YWluZXJJbnRlcmZhY2VcbikgPT4gZCA9PiBbZGMudmFsdWVBdChkLmluZGV4LCBsbmcuZmllbGRJZHgpLCBkYy52YWx1ZUF0KGQuaW5kZXgsIGxhdC5maWVsZElkeCldO1xuXG5leHBvcnQgY29uc3QgcG9pbnRDb2xSZXNvbHZlciA9ICh7bGF0LCBsbmd9OiBIZWF0bWFwTGF5ZXJDb2x1bW5zQ29uZmlnKSA9PlxuICBgJHtsYXQuZmllbGRJZHh9LSR7bG5nLmZpZWxkSWR4fWA7XG5cbmV4cG9ydCBjb25zdCBoZWF0bWFwVmlzQ29uZmlnczoge1xuICBvcGFjaXR5OiAnb3BhY2l0eSc7XG4gIGNvbG9yUmFuZ2U6ICdjb2xvclJhbmdlJztcbiAgcmFkaXVzOiAnaGVhdG1hcFJhZGl1cyc7XG59ID0ge1xuICBvcGFjaXR5OiAnb3BhY2l0eScsXG4gIGNvbG9yUmFuZ2U6ICdjb2xvclJhbmdlJyxcbiAgcmFkaXVzOiAnaGVhdG1hcFJhZGl1cydcbn07XG5cbi8qKlxuICpcbiAqIEBwYXJhbSBjb2xvclJhbmdlXG4gKiBAcmV0dXJuIFtcbiAqICAwLCBcInJnYmEoMzMsMTAyLDE3MiwwKVwiLFxuICogIDAuMiwgXCJyZ2IoMTAzLDE2OSwyMDcpXCIsXG4gKiAgMC40LCBcInJnYigyMDksMjI5LDI0MClcIixcbiAqICAwLjYsIFwicmdiKDI1MywyMTksMTk5KVwiLFxuICogIDAuOCwgXCJyZ2IoMjM5LDEzOCw5OClcIixcbiAqICAxLCBcInJnYigxNzgsMjQsNDMpXCJcbiAqIF1cbiAqL1xuY29uc3QgaGVhdG1hcERlbnNpdHkgPSAoY29sb3JSYW5nZTogQ29sb3JSYW5nZSk6IChzdHJpbmcgfCBudW1iZXIpW10gPT4ge1xuICBjb25zdCBzY2FsZUZ1bmN0aW9uID0gU0NBTEVfRlVOQy5xdWFudGl6ZTtcblxuICBjb25zdCBjb2xvcnM6IEhleENvbG9yW10gPSBbJyMwMDAwMDAnLCAuLi5jb2xvclJhbmdlLmNvbG9yc107XG5cbiAgY29uc3Qgc2NhbGUgPSBzY2FsZUZ1bmN0aW9uPEhleENvbG9yPigpXG4gICAgLmRvbWFpbihbMCwgMV0pXG4gICAgLnJhbmdlKGNvbG9ycyk7XG5cbiAgY29uc3QgY29sb3JEZW5zaXR5ID0gc2NhbGUucmFuZ2UoKS5yZWR1Y2UoKGJhbmRzOiAoc3RyaW5nIHwgbnVtYmVyKVtdLCBsZXZlbCkgPT4ge1xuICAgIGNvbnN0IGludmVydCA9IHNjYWxlLmludmVydEV4dGVudChsZXZlbCk7XG4gICAgcmV0dXJuIFtcbiAgICAgIC4uLmJhbmRzLFxuICAgICAgaW52ZXJ0WzBdLCAvLyBmaXJzdCB2YWx1ZSBpbiB0aGUgcmFuZ2VcbiAgICAgIGByZ2IoJHtoZXhUb1JnYihsZXZlbCkuam9pbignLCcpfSlgIC8vIGNvbG9yXG4gICAgXTtcbiAgfSwgW10pO1xuICBjb2xvckRlbnNpdHlbMV0gPSAncmdiYSgwLDAsMCwwKSc7XG4gIHJldHVybiBjb2xvckRlbnNpdHk7XG59O1xuXG5jbGFzcyBIZWF0bWFwTGF5ZXIgZXh0ZW5kcyBNYXBib3hHTExheWVyIHtcbiAgZGVjbGFyZSB2aXNDb25maWdTZXR0aW5nczogSGVhdG1hcExheWVyVmlzQ29uZmlnU2V0dGluZ3M7XG4gIGRlY2xhcmUgY29uZmlnOiBIZWF0bWFwTGF5ZXJDb25maWc7XG5cbiAgZ2V0UG9zaXRpb246IChjb25maWc6IEhlYXRtYXBMYXllckNvbHVtbnNDb25maWcpID0+IGFueTtcblxuICBjb25zdHJ1Y3Rvcihwcm9wcykge1xuICAgIHN1cGVyKHByb3BzKTtcbiAgICB0aGlzLnJlZ2lzdGVyVmlzQ29uZmlnKGhlYXRtYXBWaXNDb25maWdzKTtcbiAgICB0aGlzLmdldFBvc2l0aW9uID0gbWVtb2l6ZShwb2ludFBvc0FjY2Vzc29yLCBwb2ludENvbFJlc29sdmVyKTtcbiAgfVxuXG4gIGdldCB0eXBlKCk6ICdoZWF0bWFwJyB7XG4gICAgcmV0dXJuICdoZWF0bWFwJztcbiAgfVxuXG4gIGdldCB2aXN1YWxDaGFubmVscygpOiBWaXN1YWxDaGFubmVscyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3JcbiAgICAgIHdlaWdodDoge1xuICAgICAgICBwcm9wZXJ0eTogJ3dlaWdodCcsXG4gICAgICAgIGZpZWxkOiAnd2VpZ2h0RmllbGQnLFxuICAgICAgICBzY2FsZTogJ3dlaWdodFNjYWxlJyxcbiAgICAgICAgZG9tYWluOiAnd2VpZ2h0RG9tYWluJyxcbiAgICAgICAga2V5OiAnd2VpZ2h0JyxcbiAgICAgICAgLy8gc3VwcG9ydGVkRmllbGRUeXBlcyBjYW4gYmUgZGV0ZXJtaW5lZCBieSBjaGFubmVsU2NhbGVUeXBlXG4gICAgICAgIC8vIG9yIHNwZWNpZmllZCBoZXJlXG4gICAgICAgIGRlZmF1bHRNZWFzdXJlOiAncHJvcGVydHkuZGVuc2l0eScsXG4gICAgICAgIHN1cHBvcnRlZEZpZWxkVHlwZXM6IFtBTExfRklFTERfVFlQRVMucmVhbCwgQUxMX0ZJRUxEX1RZUEVTLmludGVnZXJdLFxuICAgICAgICBjaGFubmVsU2NhbGVUeXBlOiBDSEFOTkVMX1NDQUxFUy5zaXplXG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIGdldCBsYXllckljb24oKSB7XG4gICAgcmV0dXJuIEhlYXRtYXBMYXllckljb247XG4gIH1cblxuICBnZXRWaXN1YWxDaGFubmVsRGVzY3JpcHRpb24oY2hhbm5lbCkge1xuICAgIHJldHVybiBjaGFubmVsID09PSAnY29sb3InXG4gICAgICA/IHtcbiAgICAgICAgICBsYWJlbDogJ3Byb3BlcnR5LmNvbG9yJyxcbiAgICAgICAgICBtZWFzdXJlOiAncHJvcGVydHkuZGVuc2l0eSdcbiAgICAgICAgfVxuICAgICAgOiB7XG4gICAgICAgICAgbGFiZWw6ICdwcm9wZXJ0eS53ZWlnaHQnLFxuICAgICAgICAgIG1lYXN1cmU6IHRoaXMuY29uZmlnLndlaWdodEZpZWxkID8gdGhpcy5jb25maWcud2VpZ2h0RmllbGQubmFtZSA6ICdwcm9wZXJ0eS5kZW5zaXR5J1xuICAgICAgICB9O1xuICB9XG5cbiAgZ2V0RGVmYXVsdExheWVyQ29uZmlnKHByb3BzOiBMYXllckJhc2VDb25maWdQYXJ0aWFsKTogSGVhdG1hcExheWVyQ29uZmlnIHtcbiAgICAvLyBtYXBib3ggaGVhdG1hcCBsYXllciBjb2xvciBpcyBhbHdheXMgYmFzZWQgb24gZGVuc2l0eVxuICAgIC8vIG5vIG5lZWQgdG8gc2V0IGNvbG9yRmllbGQsIGNvbG9yRG9tYWluIGFuZCBjb2xvclNjYWxlXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVudXNlZC12YXJzXG4gICAgY29uc3Qge2NvbG9yRmllbGQsIGNvbG9yRG9tYWluLCBjb2xvclNjYWxlLCAuLi5sYXllckNvbmZpZ30gPSB7XG4gICAgICAuLi5zdXBlci5nZXREZWZhdWx0TGF5ZXJDb25maWcocHJvcHMpLFxuXG4gICAgICB3ZWlnaHRGaWVsZDogbnVsbCxcbiAgICAgIHdlaWdodERvbWFpbjogWzAsIDFdLFxuICAgICAgd2VpZ2h0U2NhbGU6ICdsaW5lYXInXG4gICAgfTtcblxuICAgIC8vIEB0cy1leHBlY3QtZXJyb3JcbiAgICByZXR1cm4gbGF5ZXJDb25maWc7XG4gIH1cblxuICBnZXRQb3NpdGlvbkFjY2Vzc29yKGRhdGFDb250YWluZXIpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRQb3NpdGlvbih0aGlzLmNvbmZpZy5jb2x1bW5zKShkYXRhQ29udGFpbmVyKTtcbiAgfVxuXG4gIHVwZGF0ZUxheWVyTWV0YShkYXRhQ29udGFpbmVyKSB7XG4gICAgY29uc3QgZ2V0UG9zaXRpb24gPSB0aGlzLmdldFBvc2l0aW9uQWNjZXNzb3IoZGF0YUNvbnRhaW5lcik7XG4gICAgY29uc3QgYm91bmRzID0gdGhpcy5nZXRQb2ludHNCb3VuZHMoZGF0YUNvbnRhaW5lciwgZ2V0UG9zaXRpb24pO1xuICAgIHRoaXMudXBkYXRlTWV0YSh7Ym91bmRzfSk7XG4gIH1cblxuICBjb2x1bW5zU2VsZWN0b3IgPSBjb25maWcgPT4gcG9pbnRDb2xSZXNvbHZlcihjb25maWcuY29sdW1ucyk7XG4gIHZpc0NvbmZpZ1NlbGVjdG9yID0gY29uZmlnID0+IGNvbmZpZy52aXNDb25maWc7XG4gIHdlaWdodEZpZWxkU2VsZWN0b3IgPSBjb25maWcgPT4gKGNvbmZpZy53ZWlnaHRGaWVsZCA/IGNvbmZpZy53ZWlnaHRGaWVsZC5uYW1lIDogbnVsbCk7XG4gIHdlaWdodERvbWFpblNlbGVjdG9yID0gY29uZmlnID0+IGNvbmZpZy53ZWlnaHREb21haW47XG5cbiAgcGFpbnRTZWxlY3RvciA9IGNyZWF0ZVNlbGVjdG9yKFxuICAgIHRoaXMudmlzQ29uZmlnU2VsZWN0b3IsXG4gICAgdGhpcy53ZWlnaHRGaWVsZFNlbGVjdG9yLFxuICAgIHRoaXMud2VpZ2h0RG9tYWluU2VsZWN0b3IsXG4gICAgKHZpc0NvbmZpZywgd2VpZ2h0RmllbGQsIHdlaWdodERvbWFpbikgPT4gKHtcbiAgICAgICdoZWF0bWFwLXdlaWdodCc6IHdlaWdodEZpZWxkXG4gICAgICAgID8gWydpbnRlcnBvbGF0ZScsIFsnbGluZWFyJ10sIFsnZ2V0Jywgd2VpZ2h0RmllbGRdLCB3ZWlnaHREb21haW5bMF0sIDAsIHdlaWdodERvbWFpblsxXSwgMV1cbiAgICAgICAgOiAxLFxuICAgICAgJ2hlYXRtYXAtaW50ZW5zaXR5JzogWydpbnRlcnBvbGF0ZScsIFsnbGluZWFyJ10sIFsnem9vbSddLCAwLCAxLCBNQVhfWk9PTV9MRVZFTCwgM10sXG4gICAgICAnaGVhdG1hcC1jb2xvcic6IFtcbiAgICAgICAgJ2ludGVycG9sYXRlJyxcbiAgICAgICAgWydsaW5lYXInXSxcbiAgICAgICAgWydoZWF0bWFwLWRlbnNpdHknXSxcbiAgICAgICAgLi4uaGVhdG1hcERlbnNpdHkodmlzQ29uZmlnLmNvbG9yUmFuZ2UpXG4gICAgICBdLFxuICAgICAgJ2hlYXRtYXAtcmFkaXVzJzogW1xuICAgICAgICAnaW50ZXJwb2xhdGUnLFxuICAgICAgICBbJ2xpbmVhciddLFxuICAgICAgICBbJ3pvb20nXSxcbiAgICAgICAgMCxcbiAgICAgICAgMixcbiAgICAgICAgTUFYX1pPT01fTEVWRUwsXG4gICAgICAgIHZpc0NvbmZpZy5yYWRpdXMgLy8gcmFkaXVzXG4gICAgICBdLFxuICAgICAgJ2hlYXRtYXAtb3BhY2l0eSc6IHZpc0NvbmZpZy5vcGFjaXR5XG4gICAgfSlcbiAgKTtcblxuICBjb21wdXRlSGVhdG1hcENvbmZpZ3VyYXRpb24gPSBjcmVhdGVTZWxlY3RvcihcbiAgICB0aGlzLnNvdXJjZVNlbGVjdG9yLFxuICAgIHRoaXMuZmlsdGVyU2VsZWN0b3IsXG4gICAgdGhpcy5wYWludFNlbGVjdG9yLFxuICAgIChzb3VyY2UsIGZpbHRlciwgcGFpbnQpID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHR5cGU6ICdoZWF0bWFwJyxcbiAgICAgICAgaWQ6IHRoaXMuaWQsXG4gICAgICAgIHNvdXJjZSxcbiAgICAgICAgbGF5b3V0OiB7XG4gICAgICAgICAgdmlzaWJpbGl0eTogJ3Zpc2libGUnXG4gICAgICAgIH0sXG4gICAgICAgIHBhaW50LFxuICAgICAgICAuLi4odGhpcy5pc1ZhbGlkRmlsdGVyKGZpbHRlcikgPyB7ZmlsdGVyfSA6IHt9KVxuICAgICAgfTtcbiAgICB9XG4gICk7XG5cbiAgZm9ybWF0TGF5ZXJEYXRhKGRhdGFzZXRzLCBvbGRMYXllckRhdGEpIHtcbiAgICBpZiAodGhpcy5jb25maWcuZGF0YUlkID09PSBudWxsKSB7XG4gICAgICByZXR1cm4ge307XG4gICAgfVxuICAgIGNvbnN0IHt3ZWlnaHRGaWVsZH0gPSB0aGlzLmNvbmZpZztcbiAgICBjb25zdCB7ZGF0YUNvbnRhaW5lcn0gPSBkYXRhc2V0c1t0aGlzLmNvbmZpZy5kYXRhSWRdO1xuICAgIGNvbnN0IGdldFBvc2l0aW9uID0gdGhpcy5nZXRQb3NpdGlvbkFjY2Vzc29yKGRhdGFDb250YWluZXIpO1xuICAgIGNvbnN0IHtkYXRhfSA9IHRoaXMudXBkYXRlRGF0YShkYXRhc2V0cywgb2xkTGF5ZXJEYXRhKTtcblxuICAgIGNvbnN0IG5ld0NvbmZpZyA9IHRoaXMuY29tcHV0ZUhlYXRtYXBDb25maWd1cmF0aW9uKHRoaXMuY29uZmlnLCBkYXRhc2V0cyk7XG4gICAgbmV3Q29uZmlnLmlkID0gdGhpcy5pZDtcblxuICAgIHJldHVybiB7XG4gICAgICBjb2x1bW5zOiB0aGlzLmNvbmZpZy5jb2x1bW5zLFxuICAgICAgY29uZmlnOiBuZXdDb25maWcsXG4gICAgICBkYXRhLFxuICAgICAgd2VpZ2h0RmllbGQsXG4gICAgICBnZXRQb3NpdGlvblxuICAgIH07XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgSGVhdG1hcExheWVyO1xuIl19