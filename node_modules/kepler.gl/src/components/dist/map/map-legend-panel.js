"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _react = _interopRequireWildcard(require("react"));

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _icons = require("../common/icons");

var _styledComponents2 = require("../common/styled-components");

var _mapControlTooltip = _interopRequireDefault(require("./map-control-tooltip"));

var _mapControlPanel = _interopRequireDefault(require("./map-control-panel"));

var _mapLegend = _interopRequireDefault(require("./map-legend"));

var _lazyTippy = _interopRequireDefault(require("./lazy-tippy"));

var _reactDom = require("react-dom");

var _constants = require("@kepler.gl/constants");

var _styles = require("@kepler.gl/styles");

var _context = require("../context");

var _templateObject, _templateObject2;

MapLegendPanelFactory.deps = [_mapControlTooltip["default"], _mapControlPanel["default"], _mapLegend["default"]];

var PinToBottom = _styledComponents["default"].div(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2["default"])(["\n  position: absolute;\n  bottom: ", "px;\n  right: ", "px;\n  ", ";\n"])), _constants.DIMENSIONS.mapControl.mapLegend.pinned.bottom, function (props) {
  return (props.offsetRight || 0) + _constants.DIMENSIONS.mapControl.mapLegend.pinned.right;
}, _styles.media.portable(_templateObject2 || (_templateObject2 = (0, _taggedTemplateLiteral2["default"])(["\n    bottom: 0px;\n    right: 0px;\n    min-width: ", "px;\n    .map-control-panel {\n      min-height: 215px;\n      margin-bottom: 0px;\n    };\n  "])), _constants.DIMENSIONS.mapControl.width + _constants.DIMENSIONS.mapControl.mapLegend.pinned.right));

function MapLegendPanelFactory(MapControlTooltip, MapControlPanel, MapLegend) {
  var defaultActionIcons = {
    legend: _icons.Legend
  };

  var MapLegendPanel = function MapLegendPanel(_ref) {
    var layers = _ref.layers,
        mapControls = _ref.mapControls,
        scale = _ref.scale,
        onToggleMapControl = _ref.onToggleMapControl,
        isExport = _ref.isExport,
        logoComponent = _ref.logoComponent,
        _ref$actionIcons = _ref.actionIcons,
        actionIcons = _ref$actionIcons === void 0 ? defaultActionIcons : _ref$actionIcons,
        mapState = _ref.mapState,
        mapHeight = _ref.mapHeight,
        offsetRight = _ref.offsetRight,
        onToggleSplitMapViewport = _ref.onToggleSplitMapViewport,
        onClickControlBtn = _ref.onClickControlBtn,
        _ref$isViewportUnsync = _ref.isViewportUnsyncAllowed,
        isViewportUnsyncAllowed = _ref$isViewportUnsync === void 0 ? true : _ref$isViewportUnsync;
    var mapLegend = (mapControls === null || mapControls === void 0 ? void 0 : mapControls.mapLegend) || {};

    var _ref2 = mapLegend || {},
        isPinned = _ref2.active;

    var onClick = (0, _react.useCallback)(function () {
      var _mapControls$mapDraw;

      onClickControlBtn === null || onClickControlBtn === void 0 ? void 0 : onClickControlBtn();

      if (mapControls !== null && mapControls !== void 0 && (_mapControls$mapDraw = mapControls.mapDraw) !== null && _mapControls$mapDraw !== void 0 && _mapControls$mapDraw.active) {
        onToggleMapControl('mapDraw');
      }
    }, [onClickControlBtn, onToggleMapControl, mapControls]);

    var _useState = (0, _react.useState)(null),
        _useState2 = (0, _slicedToArray2["default"])(_useState, 2),
        tippyInstance = _useState2[0],
        setTippyInstance = _useState2[1];

    var onCloseClick = (0, _react.useCallback)(function (e) {
      e.preventDefault();
      onToggleMapControl('mapLegend');
    }, [onToggleMapControl]);
    var onPinClick = (0, _react.useCallback)(function (e) {
      e.preventDefault();

      if (tippyInstance) {
        // @ts-ignore
        tippyInstance.hide();
      }

      onToggleMapControl('mapLegend');
    }, [tippyInstance, onToggleMapControl]);

    if (!mapLegend.show) {
      return null;
    }

    var mapControlPanel = /*#__PURE__*/_react["default"].createElement(MapControlPanel, (0, _extends2["default"])({
      scale: scale,
      header: 'header.layerLegend',
      isPinned: true
    }, isPinned ? {
      onClick: onCloseClick,
      pinnable: false,
      disableClose: false
    } : {
      onPinClick: onPinClick,
      pinnable: true,
      disableClose: true
    }, {
      isExport: isExport,
      logoComponent: logoComponent,
      mapState: mapState,
      onToggleSplitMapViewport: onToggleSplitMapViewport,
      isViewportUnsyncAllowed: isViewportUnsyncAllowed
    }), /*#__PURE__*/_react["default"].createElement(MapLegend, {
      layers: layers,
      mapHeight: mapHeight
    }));

    var rootContext = (0, _react.useContext)(_context.RootContext);

    if (isPinned) {
      // Pinned panel is not supported in export mode
      if (isExport) {
        return mapControlPanel;
      }

      var pinnedPanel = /*#__PURE__*/_react["default"].createElement(PinToBottom, {
        offsetRight: offsetRight
      }, mapControlPanel);

      return /*#__PURE__*/(0, _reactDom.createPortal)(pinnedPanel, (rootContext === null || rootContext === void 0 ? void 0 : rootContext.current) || document.body);
    }

    return (
      /*#__PURE__*/
      // The outer div is to prevent an accessibility warning from Tippy
      _react["default"].createElement("div", null, /*#__PURE__*/_react["default"].createElement(_lazyTippy["default"], {
        interactive: true,
        trigger: "click",
        placement: "left-start",
        onCreate: setTippyInstance,
        render: function render(attrs) {
          return /*#__PURE__*/_react["default"].createElement("div", attrs, mapControlPanel);
        },
        appendTo: "parent"
      }, /*#__PURE__*/_react["default"].createElement("div", null, /*#__PURE__*/_react["default"].createElement(MapControlTooltip, {
        id: "show-legend",
        message: "tooltip.showLegend"
      }, /*#__PURE__*/_react["default"].createElement(_styledComponents2.MapControlButton, {
        className: "map-control-button show-legend",
        onClick: onClick
      }, /*#__PURE__*/_react["default"].createElement(actionIcons.legend, {
        height: "22px"
      }))))))
    );
  };

  MapLegendPanel.displayName = 'MapLegendPanel';
  return MapLegendPanel;
}

var _default = MapLegendPanelFactory;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYXAvbWFwLWxlZ2VuZC1wYW5lbC50c3giXSwibmFtZXMiOlsiTWFwTGVnZW5kUGFuZWxGYWN0b3J5IiwiZGVwcyIsIk1hcENvbnRyb2xUb29sdGlwRmFjdG9yeSIsIk1hcENvbnRyb2xQYW5lbEZhY3RvcnkiLCJNYXBMZWdlbmRGYWN0b3J5IiwiUGluVG9Cb3R0b20iLCJzdHlsZWQiLCJkaXYiLCJESU1FTlNJT05TIiwibWFwQ29udHJvbCIsIm1hcExlZ2VuZCIsInBpbm5lZCIsImJvdHRvbSIsInByb3BzIiwib2Zmc2V0UmlnaHQiLCJyaWdodCIsIm1lZGlhIiwicG9ydGFibGUiLCJ3aWR0aCIsIk1hcENvbnRyb2xUb29sdGlwIiwiTWFwQ29udHJvbFBhbmVsIiwiTWFwTGVnZW5kIiwiZGVmYXVsdEFjdGlvbkljb25zIiwibGVnZW5kIiwiTGVnZW5kIiwiTWFwTGVnZW5kUGFuZWwiLCJsYXllcnMiLCJtYXBDb250cm9scyIsInNjYWxlIiwib25Ub2dnbGVNYXBDb250cm9sIiwiaXNFeHBvcnQiLCJsb2dvQ29tcG9uZW50IiwiYWN0aW9uSWNvbnMiLCJtYXBTdGF0ZSIsIm1hcEhlaWdodCIsIm9uVG9nZ2xlU3BsaXRNYXBWaWV3cG9ydCIsIm9uQ2xpY2tDb250cm9sQnRuIiwiaXNWaWV3cG9ydFVuc3luY0FsbG93ZWQiLCJpc1Bpbm5lZCIsImFjdGl2ZSIsIm9uQ2xpY2siLCJtYXBEcmF3IiwidGlwcHlJbnN0YW5jZSIsInNldFRpcHB5SW5zdGFuY2UiLCJvbkNsb3NlQ2xpY2siLCJlIiwicHJldmVudERlZmF1bHQiLCJvblBpbkNsaWNrIiwiaGlkZSIsInNob3ciLCJtYXBDb250cm9sUGFuZWwiLCJwaW5uYWJsZSIsImRpc2FibGVDbG9zZSIsInJvb3RDb250ZXh0IiwiUm9vdENvbnRleHQiLCJwaW5uZWRQYW5lbCIsImN1cnJlbnQiLCJkb2N1bWVudCIsImJvZHkiLCJhdHRycyIsImRpc3BsYXlOYW1lIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUdBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBOztBQUdBOzs7O0FBRUFBLHFCQUFxQixDQUFDQyxJQUF0QixHQUE2QixDQUFDQyw2QkFBRCxFQUEyQkMsMkJBQTNCLEVBQW1EQyxxQkFBbkQsQ0FBN0I7O0FBV0EsSUFBTUMsV0FBVyxHQUFHQyw2QkFBT0MsR0FBViw4SkFFTEMsc0JBQVdDLFVBQVgsQ0FBc0JDLFNBQXRCLENBQWdDQyxNQUFoQyxDQUF1Q0MsTUFGbEMsRUFHTixVQUFBQyxLQUFLO0FBQUEsU0FBSSxDQUFDQSxLQUFLLENBQUNDLFdBQU4sSUFBcUIsQ0FBdEIsSUFBMkJOLHNCQUFXQyxVQUFYLENBQXNCQyxTQUF0QixDQUFnQ0MsTUFBaEMsQ0FBdUNJLEtBQXRFO0FBQUEsQ0FIQyxFQUliQyxjQUFNQyxRQUpPLCtPQU9BVCxzQkFBV0MsVUFBWCxDQUFzQlMsS0FBdEIsR0FBOEJWLHNCQUFXQyxVQUFYLENBQXNCQyxTQUF0QixDQUFnQ0MsTUFBaEMsQ0FBdUNJLEtBUHJFLEVBQWpCOztBQW1DQSxTQUFTZixxQkFBVCxDQUErQm1CLGlCQUEvQixFQUFrREMsZUFBbEQsRUFBbUVDLFNBQW5FLEVBQThFO0FBQzVFLE1BQU1DLGtCQUFrQixHQUFHO0FBQ3pCQyxJQUFBQSxNQUFNLEVBQUVDO0FBRGlCLEdBQTNCOztBQUlBLE1BQU1DLGNBQTZDLEdBQUcsU0FBaERBLGNBQWdELE9BY2hEO0FBQUEsUUFiSkMsTUFhSSxRQWJKQSxNQWFJO0FBQUEsUUFaSkMsV0FZSSxRQVpKQSxXQVlJO0FBQUEsUUFYSkMsS0FXSSxRQVhKQSxLQVdJO0FBQUEsUUFWSkMsa0JBVUksUUFWSkEsa0JBVUk7QUFBQSxRQVRKQyxRQVNJLFFBVEpBLFFBU0k7QUFBQSxRQVJKQyxhQVFJLFFBUkpBLGFBUUk7QUFBQSxnQ0FQSkMsV0FPSTtBQUFBLFFBUEpBLFdBT0ksaUNBUFVWLGtCQU9WO0FBQUEsUUFOSlcsUUFNSSxRQU5KQSxRQU1JO0FBQUEsUUFMSkMsU0FLSSxRQUxKQSxTQUtJO0FBQUEsUUFKSnBCLFdBSUksUUFKSkEsV0FJSTtBQUFBLFFBSEpxQix3QkFHSSxRQUhKQSx3QkFHSTtBQUFBLFFBRkpDLGlCQUVJLFFBRkpBLGlCQUVJO0FBQUEscUNBREpDLHVCQUNJO0FBQUEsUUFESkEsdUJBQ0ksc0NBRHNCLElBQ3RCO0FBQ0osUUFBTTNCLFNBQVMsR0FBRyxDQUFBaUIsV0FBVyxTQUFYLElBQUFBLFdBQVcsV0FBWCxZQUFBQSxXQUFXLENBQUVqQixTQUFiLEtBQTJCLEVBQTdDOztBQURJLGdCQUV1QkEsU0FBUyxJQUFJLEVBRnBDO0FBQUEsUUFFVzRCLFFBRlgsU0FFR0MsTUFGSDs7QUFJSixRQUFNQyxPQUFPLEdBQUcsd0JBQVksWUFBTTtBQUFBOztBQUNoQ0osTUFBQUEsaUJBQWlCLFNBQWpCLElBQUFBLGlCQUFpQixXQUFqQixZQUFBQSxpQkFBaUI7O0FBQ2pCLFVBQUlULFdBQUosYUFBSUEsV0FBSix1Q0FBSUEsV0FBVyxDQUFFYyxPQUFqQixpREFBSSxxQkFBc0JGLE1BQTFCLEVBQWtDO0FBQ2hDVixRQUFBQSxrQkFBa0IsQ0FBQyxTQUFELENBQWxCO0FBQ0Q7QUFDRixLQUxlLEVBS2IsQ0FBQ08saUJBQUQsRUFBb0JQLGtCQUFwQixFQUF3Q0YsV0FBeEMsQ0FMYSxDQUFoQjs7QUFKSSxvQkFVc0MscUJBQVMsSUFBVCxDQVZ0QztBQUFBO0FBQUEsUUFVR2UsYUFWSDtBQUFBLFFBVWtCQyxnQkFWbEI7O0FBV0osUUFBTUMsWUFBWSxHQUFHLHdCQUNuQixVQUFBQyxDQUFDLEVBQUk7QUFDSEEsTUFBQUEsQ0FBQyxDQUFDQyxjQUFGO0FBQ0FqQixNQUFBQSxrQkFBa0IsQ0FBQyxXQUFELENBQWxCO0FBQ0QsS0FKa0IsRUFLbkIsQ0FBQ0Esa0JBQUQsQ0FMbUIsQ0FBckI7QUFPQSxRQUFNa0IsVUFBVSxHQUFHLHdCQUNqQixVQUFBRixDQUFDLEVBQUk7QUFDSEEsTUFBQUEsQ0FBQyxDQUFDQyxjQUFGOztBQUNBLFVBQUlKLGFBQUosRUFBbUI7QUFDakI7QUFDQUEsUUFBQUEsYUFBYSxDQUFDTSxJQUFkO0FBQ0Q7O0FBQ0RuQixNQUFBQSxrQkFBa0IsQ0FBQyxXQUFELENBQWxCO0FBQ0QsS0FSZ0IsRUFTakIsQ0FBQ2EsYUFBRCxFQUFnQmIsa0JBQWhCLENBVGlCLENBQW5COztBQVlBLFFBQUksQ0FBQ25CLFNBQVMsQ0FBQ3VDLElBQWYsRUFBcUI7QUFDbkIsYUFBTyxJQUFQO0FBQ0Q7O0FBQ0QsUUFBTUMsZUFBZSxnQkFDbkIsZ0NBQUMsZUFBRDtBQUNFLE1BQUEsS0FBSyxFQUFFdEIsS0FEVDtBQUVFLE1BQUEsTUFBTSxFQUFFLG9CQUZWO0FBR0UsTUFBQSxRQUFRLEVBQUU7QUFIWixPQUlPVSxRQUFRLEdBQ1Q7QUFDRUUsTUFBQUEsT0FBTyxFQUFFSSxZQURYO0FBRUVPLE1BQUFBLFFBQVEsRUFBRSxLQUZaO0FBR0VDLE1BQUFBLFlBQVksRUFBRTtBQUhoQixLQURTLEdBTVQ7QUFDRUwsTUFBQUEsVUFBVSxFQUFWQSxVQURGO0FBRUVJLE1BQUFBLFFBQVEsRUFBRSxJQUZaO0FBR0VDLE1BQUFBLFlBQVksRUFBRTtBQUhoQixLQVZOO0FBZUUsTUFBQSxRQUFRLEVBQUV0QixRQWZaO0FBZ0JFLE1BQUEsYUFBYSxFQUFFQyxhQWhCakI7QUFpQkUsTUFBQSxRQUFRLEVBQUVFLFFBakJaO0FBa0JFLE1BQUEsd0JBQXdCLEVBQUVFLHdCQWxCNUI7QUFtQkUsTUFBQSx1QkFBdUIsRUFBRUU7QUFuQjNCLHFCQXFCRSxnQ0FBQyxTQUFEO0FBQVcsTUFBQSxNQUFNLEVBQUVYLE1BQW5CO0FBQTJCLE1BQUEsU0FBUyxFQUFFUTtBQUF0QyxNQXJCRixDQURGOztBQTBCQSxRQUFNbUIsV0FBVyxHQUFHLHVCQUFXQyxvQkFBWCxDQUFwQjs7QUFDQSxRQUFJaEIsUUFBSixFQUFjO0FBQ1o7QUFDQSxVQUFJUixRQUFKLEVBQWM7QUFDWixlQUFPb0IsZUFBUDtBQUNEOztBQUNELFVBQU1LLFdBQVcsZ0JBQUcsZ0NBQUMsV0FBRDtBQUFhLFFBQUEsV0FBVyxFQUFFekM7QUFBMUIsU0FBd0NvQyxlQUF4QyxDQUFwQjs7QUFDQSwwQkFBTyw0QkFBYUssV0FBYixFQUEwQixDQUFBRixXQUFXLFNBQVgsSUFBQUEsV0FBVyxXQUFYLFlBQUFBLFdBQVcsQ0FBRUcsT0FBYixLQUF3QkMsUUFBUSxDQUFDQyxJQUEzRCxDQUFQO0FBQ0Q7O0FBRUQ7QUFBQTtBQUNFO0FBQ0EsZ0VBR0UsZ0NBQUMscUJBQUQ7QUFDRSxRQUFBLFdBQVcsRUFBRSxJQURmO0FBRUUsUUFBQSxPQUFPLEVBQUMsT0FGVjtBQUdFLFFBQUEsU0FBUyxFQUFDLFlBSFo7QUFJRSxRQUFBLFFBQVEsRUFBRWYsZ0JBSlo7QUFLRSxRQUFBLE1BQU0sRUFBRSxnQkFBQWdCLEtBQUs7QUFBQSw4QkFBSSx1Q0FBU0EsS0FBVCxFQUFpQlQsZUFBakIsQ0FBSjtBQUFBLFNBTGY7QUFNRSxRQUFBLFFBQVEsRUFBQztBQU5YLHNCQVFFLDBEQUNFLGdDQUFDLGlCQUFEO0FBQW1CLFFBQUEsRUFBRSxFQUFDLGFBQXRCO0FBQW9DLFFBQUEsT0FBTyxFQUFDO0FBQTVDLHNCQUNFLGdDQUFDLG1DQUFEO0FBQWtCLFFBQUEsU0FBUyxFQUFDLGdDQUE1QjtBQUE2RCxRQUFBLE9BQU8sRUFBRVY7QUFBdEUsc0JBQ0UsZ0NBQUMsV0FBRCxDQUFhLE1BQWI7QUFBb0IsUUFBQSxNQUFNLEVBQUM7QUFBM0IsUUFERixDQURGLENBREYsQ0FSRixDQUhGO0FBRkY7QUF1QkQsR0ExR0Q7O0FBNEdBZixFQUFBQSxjQUFjLENBQUNtQyxXQUFmLEdBQTZCLGdCQUE3QjtBQUNBLFNBQU9uQyxjQUFQO0FBQ0Q7O2VBRWN6QixxQiIsInNvdXJjZXNDb250ZW50IjpbIi8vIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVRcbi8vIENvcHlyaWdodCBjb250cmlidXRvcnMgdG8gdGhlIGtlcGxlci5nbCBwcm9qZWN0XG5cbmltcG9ydCBSZWFjdCwge0NvbXBvbmVudFR5cGUsIHVzZUNhbGxiYWNrLCB1c2VDb250ZXh0LCB1c2VTdGF0ZX0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHN0eWxlZCBmcm9tICdzdHlsZWQtY29tcG9uZW50cyc7XG5cbmltcG9ydCB7TGVnZW5kfSBmcm9tICcuLi9jb21tb24vaWNvbnMnO1xuaW1wb3J0IHtNYXBDb250cm9sQnV0dG9ufSBmcm9tICcuLi9jb21tb24vc3R5bGVkLWNvbXBvbmVudHMnO1xuaW1wb3J0IE1hcENvbnRyb2xUb29sdGlwRmFjdG9yeSBmcm9tICcuL21hcC1jb250cm9sLXRvb2x0aXAnO1xuaW1wb3J0IE1hcENvbnRyb2xQYW5lbEZhY3RvcnkgZnJvbSAnLi9tYXAtY29udHJvbC1wYW5lbCc7XG5pbXBvcnQgTWFwTGVnZW5kRmFjdG9yeSBmcm9tICcuL21hcC1sZWdlbmQnO1xuaW1wb3J0IExhenlUaXBweSBmcm9tICcuL2xhenktdGlwcHknO1xuaW1wb3J0IHtjcmVhdGVQb3J0YWx9IGZyb20gJ3JlYWN0LWRvbSc7XG5pbXBvcnQge0RJTUVOU0lPTlN9IGZyb20gJ0BrZXBsZXIuZ2wvY29uc3RhbnRzJztcbmltcG9ydCB7TWFwQ29udHJvbEl0ZW0sIE1hcENvbnRyb2xzLCBNYXBTdGF0ZX0gZnJvbSAnQGtlcGxlci5nbC90eXBlcyc7XG5pbXBvcnQge0xheWVyfSBmcm9tICdAa2VwbGVyLmdsL2xheWVycyc7XG5pbXBvcnQge21lZGlhfSBmcm9tICdAa2VwbGVyLmdsL3N0eWxlcyc7XG5pbXBvcnQge0FjdGlvbkhhbmRsZXIsIHRvZ2dsZVNwbGl0TWFwVmlld3BvcnR9IGZyb20gJ0BrZXBsZXIuZ2wvYWN0aW9ucyc7XG5cbmltcG9ydCB7Um9vdENvbnRleHR9IGZyb20gJy4uL2NvbnRleHQnO1xuXG5NYXBMZWdlbmRQYW5lbEZhY3RvcnkuZGVwcyA9IFtNYXBDb250cm9sVG9vbHRpcEZhY3RvcnksIE1hcENvbnRyb2xQYW5lbEZhY3RvcnksIE1hcExlZ2VuZEZhY3RvcnldO1xuXG5leHBvcnQgdHlwZSBNYXBMZWdlbmRQYW5lbEZhY3RvcnlEZXBzID0gW1xuICB0eXBlb2YgTWFwQ29udHJvbFRvb2x0aXBGYWN0b3J5LFxuICB0eXBlb2YgTWFwQ29udHJvbFBhbmVsRmFjdG9yeSxcbiAgdHlwZW9mIE1hcExlZ2VuZEZhY3Rvcnlcbl07XG5pbnRlcmZhY2UgUGluVG9Cb3R0b21Qcm9wcyB7XG4gIG9mZnNldFJpZ2h0PzogbnVtYmVyO1xufVxuXG5jb25zdCBQaW5Ub0JvdHRvbSA9IHN0eWxlZC5kaXY8UGluVG9Cb3R0b21Qcm9wcz5gXG4gIHBvc2l0aW9uOiBhYnNvbHV0ZTtcbiAgYm90dG9tOiAke0RJTUVOU0lPTlMubWFwQ29udHJvbC5tYXBMZWdlbmQucGlubmVkLmJvdHRvbX1weDtcbiAgcmlnaHQ6ICR7cHJvcHMgPT4gKHByb3BzLm9mZnNldFJpZ2h0IHx8IDApICsgRElNRU5TSU9OUy5tYXBDb250cm9sLm1hcExlZ2VuZC5waW5uZWQucmlnaHR9cHg7XG4gICR7bWVkaWEucG9ydGFibGVgXG4gICAgYm90dG9tOiAwcHg7XG4gICAgcmlnaHQ6IDBweDtcbiAgICBtaW4td2lkdGg6ICR7RElNRU5TSU9OUy5tYXBDb250cm9sLndpZHRoICsgRElNRU5TSU9OUy5tYXBDb250cm9sLm1hcExlZ2VuZC5waW5uZWQucmlnaHR9cHg7XG4gICAgLm1hcC1jb250cm9sLXBhbmVsIHtcbiAgICAgIG1pbi1oZWlnaHQ6IDIxNXB4O1xuICAgICAgbWFyZ2luLWJvdHRvbTogMHB4O1xuICAgIH07XG4gIGB9O1xuYDtcblxuaW50ZXJmYWNlIE1hcExlZ2VuZFBhbmVsSWNvbnMge1xuICBsZWdlbmQ6IENvbXBvbmVudFR5cGU8YW55Pjtcbn1cblxuZXhwb3J0IHR5cGUgTWFwTGVnZW5kUGFuZWxQcm9wcyA9IHtcbiAgbGF5ZXJzOiBSZWFkb25seUFycmF5PExheWVyPjtcbiAgc2NhbGU6IG51bWJlcjtcbiAgb25Ub2dnbGVNYXBDb250cm9sOiAoY29udHJvbDogc3RyaW5nKSA9PiB2b2lkO1xuICBpc0V4cG9ydDogYm9vbGVhbjtcbiAgbG9nb0NvbXBvbmVudDogRWxlbWVudDtcbiAgYWN0aW9uSWNvbnM6IE1hcExlZ2VuZFBhbmVsSWNvbnM7XG4gIG1hcENvbnRyb2xzOiBNYXBDb250cm9scztcbiAgbWFwU3RhdGU/OiBNYXBTdGF0ZTtcbiAgbWFwSGVpZ2h0PzogbnVtYmVyO1xuICBvZmZzZXRSaWdodD86IG51bWJlcjtcbiAgb25Ub2dnbGVTcGxpdE1hcFZpZXdwb3J0PzogQWN0aW9uSGFuZGxlcjx0eXBlb2YgdG9nZ2xlU3BsaXRNYXBWaWV3cG9ydD47XG4gIGlzVmlld3BvcnRVbnN5bmNBbGxvd2VkPzogYm9vbGVhbjtcbiAgb25DbGlja0NvbnRyb2xCdG4/OiAoZT86IE1vdXNlRXZlbnQpID0+IHZvaWQ7XG59O1xuXG5mdW5jdGlvbiBNYXBMZWdlbmRQYW5lbEZhY3RvcnkoTWFwQ29udHJvbFRvb2x0aXAsIE1hcENvbnRyb2xQYW5lbCwgTWFwTGVnZW5kKSB7XG4gIGNvbnN0IGRlZmF1bHRBY3Rpb25JY29ucyA9IHtcbiAgICBsZWdlbmQ6IExlZ2VuZFxuICB9O1xuXG4gIGNvbnN0IE1hcExlZ2VuZFBhbmVsOiBSZWFjdC5GQzxNYXBMZWdlbmRQYW5lbFByb3BzPiA9ICh7XG4gICAgbGF5ZXJzLFxuICAgIG1hcENvbnRyb2xzLFxuICAgIHNjYWxlLFxuICAgIG9uVG9nZ2xlTWFwQ29udHJvbCxcbiAgICBpc0V4cG9ydCxcbiAgICBsb2dvQ29tcG9uZW50LFxuICAgIGFjdGlvbkljb25zID0gZGVmYXVsdEFjdGlvbkljb25zLFxuICAgIG1hcFN0YXRlLFxuICAgIG1hcEhlaWdodCxcbiAgICBvZmZzZXRSaWdodCxcbiAgICBvblRvZ2dsZVNwbGl0TWFwVmlld3BvcnQsXG4gICAgb25DbGlja0NvbnRyb2xCdG4sXG4gICAgaXNWaWV3cG9ydFVuc3luY0FsbG93ZWQgPSB0cnVlXG4gIH0pID0+IHtcbiAgICBjb25zdCBtYXBMZWdlbmQgPSBtYXBDb250cm9scz8ubWFwTGVnZW5kIHx8ICh7fSBhcyBNYXBDb250cm9sSXRlbSk7XG4gICAgY29uc3Qge2FjdGl2ZTogaXNQaW5uZWR9ID0gbWFwTGVnZW5kIHx8IHt9O1xuXG4gICAgY29uc3Qgb25DbGljayA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICAgIG9uQ2xpY2tDb250cm9sQnRuPy4oKTtcbiAgICAgIGlmIChtYXBDb250cm9scz8ubWFwRHJhdz8uYWN0aXZlKSB7XG4gICAgICAgIG9uVG9nZ2xlTWFwQ29udHJvbCgnbWFwRHJhdycpO1xuICAgICAgfVxuICAgIH0sIFtvbkNsaWNrQ29udHJvbEJ0biwgb25Ub2dnbGVNYXBDb250cm9sLCBtYXBDb250cm9sc10pO1xuICAgIGNvbnN0IFt0aXBweUluc3RhbmNlLCBzZXRUaXBweUluc3RhbmNlXSA9IHVzZVN0YXRlKG51bGwpO1xuICAgIGNvbnN0IG9uQ2xvc2VDbGljayA9IHVzZUNhbGxiYWNrKFxuICAgICAgZSA9PiB7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgb25Ub2dnbGVNYXBDb250cm9sKCdtYXBMZWdlbmQnKTtcbiAgICAgIH0sXG4gICAgICBbb25Ub2dnbGVNYXBDb250cm9sXVxuICAgICk7XG4gICAgY29uc3Qgb25QaW5DbGljayA9IHVzZUNhbGxiYWNrKFxuICAgICAgZSA9PiB7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgaWYgKHRpcHB5SW5zdGFuY2UpIHtcbiAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgdGlwcHlJbnN0YW5jZS5oaWRlKCk7XG4gICAgICAgIH1cbiAgICAgICAgb25Ub2dnbGVNYXBDb250cm9sKCdtYXBMZWdlbmQnKTtcbiAgICAgIH0sXG4gICAgICBbdGlwcHlJbnN0YW5jZSwgb25Ub2dnbGVNYXBDb250cm9sXVxuICAgICk7XG5cbiAgICBpZiAoIW1hcExlZ2VuZC5zaG93KSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3QgbWFwQ29udHJvbFBhbmVsID0gKFxuICAgICAgPE1hcENvbnRyb2xQYW5lbFxuICAgICAgICBzY2FsZT17c2NhbGV9XG4gICAgICAgIGhlYWRlcj17J2hlYWRlci5sYXllckxlZ2VuZCd9XG4gICAgICAgIGlzUGlubmVkPXt0cnVlfVxuICAgICAgICB7Li4uKGlzUGlubmVkXG4gICAgICAgICAgPyB7XG4gICAgICAgICAgICAgIG9uQ2xpY2s6IG9uQ2xvc2VDbGljayxcbiAgICAgICAgICAgICAgcGlubmFibGU6IGZhbHNlLFxuICAgICAgICAgICAgICBkaXNhYmxlQ2xvc2U6IGZhbHNlXG4gICAgICAgICAgICB9XG4gICAgICAgICAgOiB7XG4gICAgICAgICAgICAgIG9uUGluQ2xpY2ssXG4gICAgICAgICAgICAgIHBpbm5hYmxlOiB0cnVlLFxuICAgICAgICAgICAgICBkaXNhYmxlQ2xvc2U6IHRydWVcbiAgICAgICAgICAgIH0pfVxuICAgICAgICBpc0V4cG9ydD17aXNFeHBvcnR9XG4gICAgICAgIGxvZ29Db21wb25lbnQ9e2xvZ29Db21wb25lbnR9XG4gICAgICAgIG1hcFN0YXRlPXttYXBTdGF0ZX1cbiAgICAgICAgb25Ub2dnbGVTcGxpdE1hcFZpZXdwb3J0PXtvblRvZ2dsZVNwbGl0TWFwVmlld3BvcnR9XG4gICAgICAgIGlzVmlld3BvcnRVbnN5bmNBbGxvd2VkPXtpc1ZpZXdwb3J0VW5zeW5jQWxsb3dlZH1cbiAgICAgID5cbiAgICAgICAgPE1hcExlZ2VuZCBsYXllcnM9e2xheWVyc30gbWFwSGVpZ2h0PXttYXBIZWlnaHR9IC8+XG4gICAgICA8L01hcENvbnRyb2xQYW5lbD5cbiAgICApO1xuXG4gICAgY29uc3Qgcm9vdENvbnRleHQgPSB1c2VDb250ZXh0KFJvb3RDb250ZXh0KTtcbiAgICBpZiAoaXNQaW5uZWQpIHtcbiAgICAgIC8vIFBpbm5lZCBwYW5lbCBpcyBub3Qgc3VwcG9ydGVkIGluIGV4cG9ydCBtb2RlXG4gICAgICBpZiAoaXNFeHBvcnQpIHtcbiAgICAgICAgcmV0dXJuIG1hcENvbnRyb2xQYW5lbDtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHBpbm5lZFBhbmVsID0gPFBpblRvQm90dG9tIG9mZnNldFJpZ2h0PXtvZmZzZXRSaWdodH0+e21hcENvbnRyb2xQYW5lbH08L1BpblRvQm90dG9tPjtcbiAgICAgIHJldHVybiBjcmVhdGVQb3J0YWwocGlubmVkUGFuZWwsIHJvb3RDb250ZXh0Py5jdXJyZW50IHx8IGRvY3VtZW50LmJvZHkpO1xuICAgIH1cblxuICAgIHJldHVybiAoXG4gICAgICAvLyBUaGUgb3V0ZXIgZGl2IGlzIHRvIHByZXZlbnQgYW4gYWNjZXNzaWJpbGl0eSB3YXJuaW5nIGZyb20gVGlwcHlcbiAgICAgIDxkaXY+XG4gICAgICAgIHsvKiBcbiAgLy8gQHRzLWlnbm9yZSAqL31cbiAgICAgICAgPExhenlUaXBweVxuICAgICAgICAgIGludGVyYWN0aXZlPXt0cnVlfVxuICAgICAgICAgIHRyaWdnZXI9XCJjbGlja1wiXG4gICAgICAgICAgcGxhY2VtZW50PVwibGVmdC1zdGFydFwiXG4gICAgICAgICAgb25DcmVhdGU9e3NldFRpcHB5SW5zdGFuY2V9XG4gICAgICAgICAgcmVuZGVyPXthdHRycyA9PiA8ZGl2IHsuLi5hdHRyc30+e21hcENvbnRyb2xQYW5lbH08L2Rpdj59XG4gICAgICAgICAgYXBwZW5kVG89XCJwYXJlbnRcIlxuICAgICAgICA+XG4gICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgIDxNYXBDb250cm9sVG9vbHRpcCBpZD1cInNob3ctbGVnZW5kXCIgbWVzc2FnZT1cInRvb2x0aXAuc2hvd0xlZ2VuZFwiPlxuICAgICAgICAgICAgICA8TWFwQ29udHJvbEJ1dHRvbiBjbGFzc05hbWU9XCJtYXAtY29udHJvbC1idXR0b24gc2hvdy1sZWdlbmRcIiBvbkNsaWNrPXtvbkNsaWNrfT5cbiAgICAgICAgICAgICAgICA8YWN0aW9uSWNvbnMubGVnZW5kIGhlaWdodD1cIjIycHhcIiAvPlxuICAgICAgICAgICAgICA8L01hcENvbnRyb2xCdXR0b24+XG4gICAgICAgICAgICA8L01hcENvbnRyb2xUb29sdGlwPlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICA8L0xhenlUaXBweT5cbiAgICAgIDwvZGl2PlxuICAgICk7XG4gIH07XG5cbiAgTWFwTGVnZW5kUGFuZWwuZGlzcGxheU5hbWUgPSAnTWFwTGVnZW5kUGFuZWwnO1xuICByZXR1cm4gTWFwTGVnZW5kUGFuZWw7XG59XG5cbmV4cG9ydCBkZWZhdWx0IE1hcExlZ2VuZFBhbmVsRmFjdG9yeTtcbiJdfQ==