{"version":3,"file":"deck-adapter.js","names":["DeckAdapter","animationManager","undefined","glContext","AnimationManager","videoCapture","VideoCapture","shouldAnimate","enabled","getProps","bind","render","stop","seek","deck","onNextFrame","extraProps","props","_animate","onAfterRender","controller","gl","Encoder","PreviewEncoder","formatConfigs","filename","timecode","start","end","framerate","onStopped","onSave","onComplete","onStop","timeMs","abort","timeline","setTime","draw","proceedToNextFrame","readyToCapture","areAllLayersLoaded","layers","every","layer","isLoaded","isRecording","capture","canvas","nextTimeMs"],"sources":["../../../src/adapters/deck-adapter.js"],"sourcesContent":["// Copyright (c) 2021 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n/* eslint-disable no-console */\nimport {PreviewEncoder} from '../encoders';\n// eslint-disable-next-line no-unused-vars\nimport {AnimationManager} from '../animations';\nimport {VideoCapture} from '../capture/video-capture';\n\nexport default class DeckAdapter {\n  /** @type {any} */\n  deck;\n  /** @type {AnimationManager} */\n  animationManager;\n  /** @type {boolean} */\n  shouldAnimate;\n  /** @type {boolean} */\n  enabled;\n  /** @type {WebGL2RenderingContext} */\n  glContext;\n\n  /**\n   * @param {Object} params\n   * @param {AnimationManager} params.animationManager\n   * @param {WebGL2RenderingContext} params.glContext\n   */\n  constructor({animationManager = undefined, glContext = undefined}) {\n    this.animationManager = animationManager || new AnimationManager({});\n    this.glContext = glContext;\n    this.videoCapture = new VideoCapture();\n    this.shouldAnimate = false;\n    this.enabled = false;\n    this.getProps = this.getProps.bind(this);\n    this.render = this.render.bind(this);\n    this.stop = this.stop.bind(this);\n    this.seek = this.seek.bind(this);\n  }\n\n  setDeck(deck) {\n    this.deck = deck;\n  }\n\n  /**\n   * @param {Object} params\n   * @param {any} params.deck\n   * @param {(nextTimeMs: number) => void} params.onNextFrame\n   * @param {Object} params.extraProps\n   */\n  getProps({deck, onNextFrame = undefined, extraProps = undefined}) {\n    if (deck) {\n      this.deck = deck;\n    }\n    const props = {\n      _animate: this.shouldAnimate\n    };\n\n    if (onNextFrame) {\n      props.onAfterRender = () => this.onAfterRender(onNextFrame);\n    }\n\n    if (this.enabled) {\n      props.controller = false;\n    } else {\n      props.controller = true;\n    }\n\n    if (this.glContext) {\n      props.gl = this.glContext;\n    }\n    return {...extraProps, ...props};\n  }\n\n  /**\n   * @param {Object} params\n   * @param {typeof import('../encoders').FrameEncoder} params.Encoder\n   * @param {Partial<import('types').FormatConfigs>} params.formatConfigs\n   * @param {string} params.filename\n   * @param {{start: number, end: number, framerate: number}} params.timecode\n   * @param {() => void} params.onStopped\n   * @param {(blob: Blob) => void} params.onSave\n   * @param {() => void} params.onComplete\n   */\n  render({\n    Encoder = PreviewEncoder,\n    formatConfigs = {},\n    filename = undefined,\n    timecode = {start: 0, end: 0, framerate: 30},\n    onStopped = undefined,\n    onSave = undefined,\n    onComplete = undefined\n  }) {\n    this.shouldAnimate = true;\n    this.videoCapture.render({\n      Encoder,\n      formatConfigs,\n      timecode,\n      filename,\n      onStop: () => this.stop({onStopped, onSave, onComplete})\n    });\n    this.enabled = true;\n    this.seek({timeMs: timecode.start});\n  }\n\n  /**\n   * @param {Object} params\n   * @param {() => void} params.onStopped\n   * @param {(blob: Blob) => void} params.onSave\n   * @param {() => void} params.onComplete\n   * @param {boolean} [params.abort]\n   */\n  stop({onStopped, onSave, onComplete, abort}) {\n    this.enabled = false;\n    this.shouldAnimate = false;\n    this.videoCapture.stop({onStopped, onSave, onComplete, abort});\n  }\n\n  /**\n   * @param {Object} params\n   * @param {number} params.timeMs\n   */\n  seek({timeMs}) {\n    this.animationManager.timeline.setTime(timeMs);\n    this.animationManager.draw();\n  }\n\n  /**\n   * @param {(nextTimeMs: number) => void} proceedToNextFrame\n   * @param {boolean} readyToCapture\n   */\n  onAfterRender(proceedToNextFrame, readyToCapture = true) {\n    const areAllLayersLoaded = this.deck && this.deck.props.layers.every(layer => layer.isLoaded);\n    if (this.videoCapture.isRecording() && areAllLayersLoaded && readyToCapture) {\n      this.videoCapture.capture(this.deck.canvas, nextTimeMs => {\n        this.seek({timeMs: nextTimeMs});\n        proceedToNextFrame(nextTimeMs);\n      });\n    }\n  }\n}\n"],"mappings":"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"}