"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getEditorLayer = getEditorLayer;

var _layers = require("@nebula.gl/layers");

var _editModes = require("@nebula.gl/edit-modes");

var _extensions = require("@deck.gl/extensions");

var _constants = require("@kepler.gl/constants");

var _utils = require("@kepler.gl/utils");

var _constants2 = require("./constants");

var _featureStyles = require("./feature-styles");

var _modifyModeExtended = require("./modify-mode-extended");

var _editorLayerUtils = require("./editor-layer-utils");

// SPDX-License-Identifier: MIT
// Copyright contributors to the kepler.gl project
var DEFAULT_COMPOSITE_MODE = new _editModes.CompositeMode([new _editModes.TranslateMode(), new _modifyModeExtended.ModifyModeExtended()]);

/**
 * Returns editable layer to edit polygon filters.
 * @param params
 * @param params.editorMenuActive Indicates whether the editor side menu is active.
 * @param params.editor
 * @param params.onSetFeatures A callback to set features.
 * @param params.setSelectedFeature A callback to set selected feature and selection context.
 * @param params.viewport Current viewport.
 * @param params.featureCollection Feature collection with an array of features
 * @param params.selectedFeatureIndexes An array with index of currently selected feature.
 */
function getEditorLayer(_ref) {
  var editorMenuActive = _ref.editorMenuActive,
      editor = _ref.editor,
      onSetFeatures = _ref.onSetFeatures,
      setSelectedFeature = _ref.setSelectedFeature,
      featureCollection = _ref.featureCollection,
      selectedFeatureIndexes = _ref.selectedFeatureIndexes,
      viewport = _ref.viewport;
  var editorMode = editor.mode;
  var mode = DEFAULT_COMPOSITE_MODE;

  if (editorMenuActive) {
    // @ts-ignore
    if (editorMode === _constants.EDITOR_MODES.DRAW_POLYGON) mode = _editModes.DrawPolygonMode; // @ts-ignore
    else if (editorMode === _constants.EDITOR_MODES.DRAW_RECTANGLE) mode = _editModes.DrawRectangleMode;
  } // @ts-ignore


  return new _layers.EditableGeoJsonLayer({
    id: _constants.EDITOR_LAYER_ID,
    mode: mode,
    // @ts-ignore
    data: featureCollection,
    selectedFeatureIndexes: selectedFeatureIndexes,
    visible: editor.visible,
    pickable: true,
    pickingRadius: _constants.EDITOR_LAYER_PICKING_RADIUS,
    modeConfig: {
      viewport: viewport,
      screenSpace: true,
      lockRectangles: true
    },
    pickingLineWidthExtraPixels: 5,
    // Only show fill when polygons are selected,
    // there is no way atm to enable fill for only one feature
    filled: selectedFeatureIndexes.length > 0,
    onEdit: function onEdit(_ref2) {
      var updatedData = _ref2.updatedData,
          editType = _ref2.editType;

      switch (editType) {
        case _constants2.EDIT_TYPES.ADD_FEATURE:
          var _features = updatedData.features;

          if (_features.length) {
            var lastFeature = _features[_features.length - 1];
            lastFeature.properties.isClosed = true;
            lastFeature.id = (0, _utils.generateHashId)(6);
            onSetFeatures(updatedData.features);
            setSelectedFeature(lastFeature);
          }

          break;

        case _constants2.EDIT_TYPES.ADD_POSITION:
        case _constants2.EDIT_TYPES.MOVE_POSITION:
        case _constants2.EDIT_TYPES.TRANSLATING:
          onSetFeatures(updatedData.features);
          break;

        default:
          break;
      }
    },
    // prevent self-highlights with tentative features
    autoHighlight: !(0, _editorLayerUtils.isDrawingActive)(editorMenuActive, editorMode),
    // @ts-ignore
    highlightColor: function highlightColor(info) {
      // Note: lines are reported as parent polygon
      var object = info.object;

      if (object) {
        var _editor$selectedFeatu;

        if (object.id === ((_editor$selectedFeatu = editor.selectedFeature) === null || _editor$selectedFeatu === void 0 ? void 0 : _editor$selectedFeatu.id)) {
          return _featureStyles.FEATURE_STYLE.highlightMultiplierNone;
        }

        var type = object.properties.editHandleType;
        if (type === 'intermediate') return _featureStyles.EDIT_HANDLE_STYLE.highlightMultiplierNone;else if (type === 'existing') return _featureStyles.EDIT_HANDLE_STYLE.highlightMultiplier;
      } // Note: highlight color affects even transparent filled polygons


      return selectedFeatureIndexes.length ? _featureStyles.FEATURE_STYLE.highlightMultiplier : _featureStyles.LINE_STYLE.highlightMultiplier;
    },
    extensions: [new _extensions.PathStyleExtension({
      dash: true
    })],
    dashGapPickable: true,
    getDashArray: function getDashArray(feature, _isSelected) {
      var _feature$properties, _editor$selectedFeatu2;

      if ((feature === null || feature === void 0 ? void 0 : (_feature$properties = feature.properties) === null || _feature$properties === void 0 ? void 0 : _feature$properties.guideType) === 'tentative') {
        return _featureStyles.LINE_STYLE.dashArray;
      }

      if ((feature === null || feature === void 0 ? void 0 : feature.id) === ((_editor$selectedFeatu2 = editor.selectedFeature) === null || _editor$selectedFeatu2 === void 0 ? void 0 : _editor$selectedFeatu2.id)) return _featureStyles.LINE_STYLE.solidArray;
      return _featureStyles.LINE_STYLE.dashArray;
    },
    getLineColor: _featureStyles.LINE_STYLE.getColor,
    getFillColor: _featureStyles.FEATURE_STYLE.getColor,
    getRadius: _featureStyles.EDIT_HANDLE_STYLE.getRadius,
    // @ts-ignore
    getLineWidth: _featureStyles.LINE_STYLE.getWidth,
    getEditHandlePointRadius: _featureStyles.EDIT_HANDLE_STYLE.getRadius,
    getEditHandlePointColor: _featureStyles.EDIT_HANDLE_STYLE.getFillColor,
    getEditHandlePointOutlineColor: _featureStyles.EDIT_HANDLE_STYLE.getOutlineColor,
    getTentativeLineColor: _featureStyles.LINE_STYLE.getTentativeLineColor,
    // @ts-ignore
    getTentativeLineWidth: _featureStyles.LINE_STYLE.getTentativeLineWidth,
    getTentativeFillColor: _featureStyles.LINE_STYLE.getTentativeFillColor,
    parameters: {}
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lZGl0b3ItbGF5ZXIvZWRpdG9yLWxheWVyLnRzIl0sIm5hbWVzIjpbIkRFRkFVTFRfQ09NUE9TSVRFX01PREUiLCJDb21wb3NpdGVNb2RlIiwiVHJhbnNsYXRlTW9kZSIsIk1vZGlmeU1vZGVFeHRlbmRlZCIsImdldEVkaXRvckxheWVyIiwiZWRpdG9yTWVudUFjdGl2ZSIsImVkaXRvciIsIm9uU2V0RmVhdHVyZXMiLCJzZXRTZWxlY3RlZEZlYXR1cmUiLCJmZWF0dXJlQ29sbGVjdGlvbiIsInNlbGVjdGVkRmVhdHVyZUluZGV4ZXMiLCJ2aWV3cG9ydCIsImVkaXRvck1vZGUiLCJtb2RlIiwiRURJVE9SX01PREVTIiwiRFJBV19QT0xZR09OIiwiRHJhd1BvbHlnb25Nb2RlIiwiRFJBV19SRUNUQU5HTEUiLCJEcmF3UmVjdGFuZ2xlTW9kZSIsIkVkaXRhYmxlR2VvSnNvbkxheWVyIiwiaWQiLCJFRElUT1JfTEFZRVJfSUQiLCJkYXRhIiwidmlzaWJsZSIsInBpY2thYmxlIiwicGlja2luZ1JhZGl1cyIsIkVESVRPUl9MQVlFUl9QSUNLSU5HX1JBRElVUyIsIm1vZGVDb25maWciLCJzY3JlZW5TcGFjZSIsImxvY2tSZWN0YW5nbGVzIiwicGlja2luZ0xpbmVXaWR0aEV4dHJhUGl4ZWxzIiwiZmlsbGVkIiwibGVuZ3RoIiwib25FZGl0IiwidXBkYXRlZERhdGEiLCJlZGl0VHlwZSIsIkVESVRfVFlQRVMiLCJBRERfRkVBVFVSRSIsIl9mZWF0dXJlcyIsImZlYXR1cmVzIiwibGFzdEZlYXR1cmUiLCJwcm9wZXJ0aWVzIiwiaXNDbG9zZWQiLCJBRERfUE9TSVRJT04iLCJNT1ZFX1BPU0lUSU9OIiwiVFJBTlNMQVRJTkciLCJhdXRvSGlnaGxpZ2h0IiwiaGlnaGxpZ2h0Q29sb3IiLCJpbmZvIiwib2JqZWN0Iiwic2VsZWN0ZWRGZWF0dXJlIiwiRkVBVFVSRV9TVFlMRSIsImhpZ2hsaWdodE11bHRpcGxpZXJOb25lIiwidHlwZSIsImVkaXRIYW5kbGVUeXBlIiwiRURJVF9IQU5ETEVfU1RZTEUiLCJoaWdobGlnaHRNdWx0aXBsaWVyIiwiTElORV9TVFlMRSIsImV4dGVuc2lvbnMiLCJQYXRoU3R5bGVFeHRlbnNpb24iLCJkYXNoIiwiZGFzaEdhcFBpY2thYmxlIiwiZ2V0RGFzaEFycmF5IiwiZmVhdHVyZSIsIl9pc1NlbGVjdGVkIiwiZ3VpZGVUeXBlIiwiZGFzaEFycmF5Iiwic29saWRBcnJheSIsImdldExpbmVDb2xvciIsImdldENvbG9yIiwiZ2V0RmlsbENvbG9yIiwiZ2V0UmFkaXVzIiwiZ2V0TGluZVdpZHRoIiwiZ2V0V2lkdGgiLCJnZXRFZGl0SGFuZGxlUG9pbnRSYWRpdXMiLCJnZXRFZGl0SGFuZGxlUG9pbnRDb2xvciIsImdldEVkaXRIYW5kbGVQb2ludE91dGxpbmVDb2xvciIsImdldE91dGxpbmVDb2xvciIsImdldFRlbnRhdGl2ZUxpbmVDb2xvciIsImdldFRlbnRhdGl2ZUxpbmVXaWR0aCIsImdldFRlbnRhdGl2ZUZpbGxDb2xvciIsInBhcmFtZXRlcnMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFHQTs7QUFFQTs7QUFNQTs7QUFFQTs7QUFFQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFwQkE7QUFDQTtBQXFCQSxJQUFNQSxzQkFBc0IsR0FBRyxJQUFJQyx3QkFBSixDQUFrQixDQUFDLElBQUlDLHdCQUFKLEVBQUQsRUFBc0IsSUFBSUMsc0NBQUosRUFBdEIsQ0FBbEIsQ0FBL0I7O0FBZUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNPLFNBQVNDLGNBQVQsT0FRNEM7QUFBQSxNQVBqREMsZ0JBT2lELFFBUGpEQSxnQkFPaUQ7QUFBQSxNQU5qREMsTUFNaUQsUUFOakRBLE1BTWlEO0FBQUEsTUFMakRDLGFBS2lELFFBTGpEQSxhQUtpRDtBQUFBLE1BSmpEQyxrQkFJaUQsUUFKakRBLGtCQUlpRDtBQUFBLE1BSGpEQyxpQkFHaUQsUUFIakRBLGlCQUdpRDtBQUFBLE1BRmpE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QkFBdUIsRUFBRXBCLGlDQUFrQmUsWUFyRmI7QUFzRjlCTSxJQUFBQSw4QkFBOEIsRUFBRXJCLGlDQUFrQnNCLGVBdEZwQjtBQXdGOUJDLElBQUFBLHFCQUFxQixFQUFFckIsMEJBQVdxQixxQkF4Rko7QUF5RjlCO0FBQ0FDLElBQUFBLHFCQUFxQixFQUFFdEIsMEJBQVdzQixxQkExRko7QUEyRjlCQyxJQUFBQSxxQkFBcUIsRUFBRXZCLDBCQUFXdUIscUJBM0ZKO0FBNkY5QkMsSUFBQUEsVUFBVSxFQUFFO0FBN0ZrQixHQUF6QixDQUFQO0FBK0ZEIiwic291cmNlc0NvbnRlbnQiOlsiLy8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVFxuLy8gQ29weXJpZ2h0IGNvbnRyaWJ1dG9ycyB0byB0aGUga2VwbGVyLmdsIHByb2plY3RcblxuaW1wb3J0IHtFZGl0YWJsZUdlb0pzb25MYXllcn0gZnJvbSAnQG5lYnVsYS5nbC9sYXllcnMnO1xuaW1wb3J0IHtMYXllciBhcyBEZWNrTGF5ZXIsIExheWVyUHJvcHMgYXMgRGVja0xheWVyUHJvcHN9IGZyb20gJ0BkZWNrLmdsL2NvcmUvdHlwZWQnO1xuaW1wb3J0IHtcbiAgRHJhd1BvbHlnb25Nb2RlLFxuICBUcmFuc2xhdGVNb2RlLFxuICBDb21wb3NpdGVNb2RlLFxuICBEcmF3UmVjdGFuZ2xlTW9kZVxufSBmcm9tICdAbmVidWxhLmdsL2VkaXQtbW9kZXMnO1xuaW1wb3J0IHtQYXRoU3R5bGVFeHRlbnNpb259IGZyb20gJ0BkZWNrLmdsL2V4dGVuc2lvbnMnO1xuXG5pbXBvcnQge0VESVRPUl9MQVlFUl9JRCwgRURJVE9SX01PREVTLCBFRElUT1JfTEFZRVJfUElDS0lOR19SQURJVVN9IGZyb20gJ0BrZXBsZXIuZ2wvY29uc3RhbnRzJztcbmltcG9ydCB7Vmlld3BvcnQsIEVkaXRvciwgRmVhdHVyZSwgRmVhdHVyZVNlbGVjdGlvbkNvbnRleHR9IGZyb20gJ0BrZXBsZXIuZ2wvdHlwZXMnO1xuaW1wb3J0IHtnZW5lcmF0ZUhhc2hJZH0gZnJvbSAnQGtlcGxlci5nbC91dGlscyc7XG5cbmltcG9ydCB7RURJVF9UWVBFU30gZnJvbSAnLi9jb25zdGFudHMnO1xuaW1wb3J0IHtMSU5FX1NUWUxFLCBGRUFUVVJFX1NUWUxFLCBFRElUX0hBTkRMRV9TVFlMRX0gZnJvbSAnLi9mZWF0dXJlLXN0eWxlcyc7XG5pbXBvcnQge01vZGlmeU1vZGVFeHRlbmRlZH0gZnJvbSAnLi9tb2RpZnktbW9kZS1leHRlbmRlZCc7XG5pbXBvcnQge2lzRHJhd2luZ0FjdGl2ZX0gZnJvbSAnLi9lZGl0b3ItbGF5ZXItdXRpbHMnO1xuXG5jb25zdCBERUZBVUxUX0NPTVBPU0lURV9NT0RFID0gbmV3IENvbXBvc2l0ZU1vZGUoW25ldyBUcmFuc2xhdGVNb2RlKCksIG5ldyBNb2RpZnlNb2RlRXh0ZW5kZWQoKV0pO1xuXG5leHBvcnQgdHlwZSBHZXRFZGl0b3JMYXllclByb3BzID0ge1xuICBlZGl0b3JNZW51QWN0aXZlOiBib29sZWFuO1xuICBlZGl0b3I6IEVkaXRvcjtcbiAgb25TZXRGZWF0dXJlczogKGZlYXR1cmVzOiBGZWF0dXJlW10pID0+IGFueTtcbiAgc2V0U2VsZWN0ZWRGZWF0dXJlOiAoZmVhdHVyZTogRmVhdHVyZSB8IG51bGwsIHNlbGVjdGlvbkNvbnRleHQ/OiBGZWF0dXJlU2VsZWN0aW9uQ29udGV4dCkgPT4gYW55O1xuICB2aWV3cG9ydDogVmlld3BvcnQ7XG4gIGZlYXR1cmVDb2xsZWN0aW9uOiB7XG4gICAgdHlwZTogc3RyaW5nO1xuICAgIGZlYXR1cmVzOiBGZWF0dXJlW107XG4gIH07XG4gIHNlbGVjdGVkRmVhdHVyZUluZGV4ZXM6IG51bWJlcltdO1xufTtcblxuLyoqXG4gKiBSZXR1cm5zIGVkaXRhYmxlIGxheWVyIHRvIGVkaXQgcG9seWdvbiBmaWx0ZXJzLlxuICogQHBhcmFtIHBhcmFtc1xuICogQHBhcmFtIHBhcmFtcy5lZGl0b3JNZW51QWN0aXZlIEluZGljYXRlcyB3aGV0aGVyIHRoZSBlZGl0b3Igc2lkZSBtZW51IGlzIGFjdGl2ZS5cbiAqIEBwYXJhbSBwYXJhbXMuZWRpdG9yXG4gKiBAcGFyYW0gcGFyYW1zLm9uU2V0RmVhdHVyZXMgQSBjYWxsYmFjayB0byBzZXQgZmVhdHVyZXMuXG4gKiBAcGFyYW0gcGFyYW1zLnNldFNlbGVjdGVkRmVhdHVyZSBBIGNhbGxiYWNrIHRvIHNldCBzZWxlY3RlZCBmZWF0dXJlIGFuZCBzZWxlY3Rpb24gY29udGV4dC5cbiAqIEBwYXJhbSBwYXJhbXMudmlld3BvcnQgQ3VycmVudCB2aWV3cG9ydC5cbiAqIEBwYXJhbSBwYXJhbXMuZmVhdHVyZUNvbGxlY3Rpb24gRmVhdHVyZSBjb2xsZWN0aW9uIHdpdGggYW4gYXJyYXkgb2YgZmVhdHVyZXNcbiAqIEBwYXJhbSBwYXJhbXMuc2VsZWN0ZWRGZWF0dXJlSW5kZXhlcyBBbiBhcnJheSB3aXRoIGluZGV4IG9mIGN1cnJlbnRseSBzZWxlY3RlZCBmZWF0dXJlLlxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0RWRpdG9yTGF5ZXIoe1xuICBlZGl0b3JNZW51QWN0aXZlLFxuICBlZGl0b3IsXG4gIG9uU2V0RmVhdHVyZXMsXG4gIHNldFNlbGVjdGVkRmVhdHVyZSxcbiAgZmVhdHVyZUNvbGxlY3Rpb24sXG4gIHNlbGVjdGVkRmVhdHVyZUluZGV4ZXMsXG4gIHZpZXdwb3J0XG59OiBHZXRFZGl0b3JMYXllclByb3BzKTogRGVja0xheWVyPERlY2tMYXllclByb3BzPiB7XG4gIGNvbnN0IHttb2RlOiBlZGl0b3JNb2RlfSA9IGVkaXRvcjtcblxuICBsZXQgbW9kZSA9IERFRkFVTFRfQ09NUE9TSVRFX01PREU7XG4gIGlmIChlZGl0b3JNZW51QWN0aXZlKSB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGlmIChlZGl0b3JNb2RlID09PSBFRElUT1JfTU9ERVMuRFJBV19QT0xZR09OKSBtb2RlID0gRHJhd1BvbHlnb25Nb2RlO1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBlbHNlIGlmIChlZGl0b3JNb2RlID09PSBFRElUT1JfTU9ERVMuRFJBV19SRUNUQU5HTEUpIG1vZGUgPSBEcmF3UmVjdGFuZ2xlTW9kZTtcbiAgfVxuXG4gIC8vIEB0cy1pZ25vcmVcbiAgcmV0dXJuIG5ldyBFZGl0YWJsZUdlb0pzb25MYXllcih7XG4gICAgaWQ6IEVESVRPUl9MQVlFUl9JRCxcbiAgICBtb2RlLFxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBkYXRhOiBmZWF0dXJlQ29sbGVjdGlvbixcbiAgICBzZWxlY3RlZEZlYXR1cmVJbmRleGVzLFxuICAgIHZpc2libGU6IGVkaXRvci52aXNpYmxlLFxuICAgIHBpY2thYmxlOiB0cnVlLFxuICAgIHBpY2tpbmdSYWRpdXM6IEVESVRPUl9MQVlFUl9QSUNLSU5HX1JBRElVUyxcbiAgICBtb2RlQ29uZmlnOiB7XG4gICAgICB2aWV3cG9ydCxcbiAgICAgIHNjcmVlblNwYWNlOiB0cnVlLFxuICAgICAgbG9ja1JlY3RhbmdsZXM6IHRydWVcbiAgICB9LFxuXG4gICAgcGlja2luZ0xpbmVXaWR0aEV4dHJhUGl4ZWxzOiA1LFxuXG4gICAgLy8gT25seSBzaG93IGZpbGwgd2hlbiBwb2x5Z29ucyBhcmUgc2VsZWN0ZWQsXG4gICAgLy8gdGhlcmUgaXMgbm8gd2F5IGF0bSB0byBlbmFibGUgZmlsbCBmb3Igb25seSBvbmUgZmVhdHVyZVxuICAgIGZpbGxlZDogc2VsZWN0ZWRGZWF0dXJlSW5kZXhlcy5sZW5ndGggPiAwLFxuXG4gICAgb25FZGl0OiAoe3VwZGF0ZWREYXRhLCBlZGl0VHlwZX0pID0+IHtcbiAgICAgIHN3aXRjaCAoZWRpdFR5cGUpIHtcbiAgICAgICAgY2FzZSBFRElUX1RZUEVTLkFERF9GRUFUVVJFOlxuICAgICAgICAgIGNvbnN0IHtmZWF0dXJlczogX2ZlYXR1cmVzfSA9IHVwZGF0ZWREYXRhO1xuICAgICAgICAgIGlmIChfZmVhdHVyZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICBjb25zdCBsYXN0RmVhdHVyZSA9IF9mZWF0dXJlc1tfZmVhdHVyZXMubGVuZ3RoIC0gMV07XG4gICAgICAgICAgICBsYXN0RmVhdHVyZS5wcm9wZXJ0aWVzLmlzQ2xvc2VkID0gdHJ1ZTtcbiAgICAgICAgICAgIGxhc3RGZWF0dXJlLmlkID0gZ2VuZXJhdGVIYXNoSWQoNik7XG4gICAgICAgICAgICBvblNldEZlYXR1cmVzKHVwZGF0ZWREYXRhLmZlYXR1cmVzKTtcbiAgICAgICAgICAgIHNldFNlbGVjdGVkRmVhdHVyZShsYXN0RmVhdHVyZSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIEVESVRfVFlQRVMuQUREX1BPU0lUSU9OOlxuICAgICAgICBjYXNlIEVESVRfVFlQRVMuTU9WRV9QT1NJVElPTjpcbiAgICAgICAgY2FzZSBFRElUX1RZUEVTLlRSQU5TTEFUSU5HOlxuICAgICAgICAgIG9uU2V0RmVhdHVyZXModXBkYXRlZERhdGEuZmVhdHVyZXMpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH0sXG5cbiAgICAvLyBwcmV2ZW50IHNlbGYtaGlnaGxpZ2h0cyB3aXRoIHRlbnRhdGl2ZSBmZWF0dXJlc1xuICAgIGF1dG9IaWdobGlnaHQ6ICFpc0RyYXdpbmdBY3RpdmUoZWRpdG9yTWVudUFjdGl2ZSwgZWRpdG9yTW9kZSksXG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGhpZ2hsaWdodENvbG9yOiBpbmZvID0+IHtcbiAgICAgIC8vIE5vdGU6IGxpbmVzIGFyZSByZXBvcnRlZCBhcyBwYXJlbnQgcG9seWdvblxuICAgICAgY29uc3Qge29iamVjdH0gPSBpbmZvO1xuICAgICAgaWYgKG9iamVjdCkge1xuICAgICAgICBpZiAob2JqZWN0LmlkID09PSBlZGl0b3Iuc2VsZWN0ZWRGZWF0dXJlPy5pZCkge1xuICAgICAgICAgIHJldHVybiBGRUFUVVJFX1NUWUxFLmhpZ2hsaWdodE11bHRpcGxpZXJOb25lO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdHlwZSA9IG9iamVjdC5wcm9wZXJ0aWVzLmVkaXRIYW5kbGVUeXBlO1xuICAgICAgICBpZiAodHlwZSA9PT0gJ2ludGVybWVkaWF0ZScpIHJldHVybiBFRElUX0hBTkRMRV9TVFlMRS5oaWdobGlnaHRNdWx0aXBsaWVyTm9uZTtcbiAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ2V4aXN0aW5nJykgcmV0dXJuIEVESVRfSEFORExFX1NUWUxFLmhpZ2hsaWdodE11bHRpcGxpZXI7XG4gICAgICB9XG5cbiAgICAgIC8vIE5vdGU6IGhpZ2hsaWdodCBjb2xvciBhZmZlY3RzIGV2ZW4gdHJhbnNwYXJlbnQgZmlsbGVkIHBvbHlnb25zXG4gICAgICByZXR1cm4gc2VsZWN0ZWRGZWF0dXJlSW5kZXhlcy5sZW5ndGhcbiAgICAgICAgPyBGRUFUVVJFX1NUWUxFLmhpZ2hsaWdodE11bHRpcGxpZXJcbiAgICAgICAgOiBMSU5FX1NUWUxFLmhpZ2hsaWdodE11bHRpcGxpZXI7XG4gICAgfSxcblxuICAgIGV4dGVuc2lvbnM6IFtuZXcgUGF0aFN0eWxlRXh0ZW5zaW9uKHtkYXNoOiB0cnVlfSldLFxuICAgIGRhc2hHYXBQaWNrYWJsZTogdHJ1ZSxcbiAgICBnZXREYXNoQXJyYXk6IChmZWF0dXJlLCBfaXNTZWxlY3RlZCkgPT4ge1xuICAgICAgaWYgKGZlYXR1cmU/LnByb3BlcnRpZXM/Lmd1aWRlVHlwZSA9PT0gJ3RlbnRhdGl2ZScpIHtcbiAgICAgICAgcmV0dXJuIExJTkVfU1RZTEUuZGFzaEFycmF5O1xuICAgICAgfVxuXG4gICAgICBpZiAoZmVhdHVyZT8uaWQgPT09IGVkaXRvci5zZWxlY3RlZEZlYXR1cmU/LmlkKSByZXR1cm4gTElORV9TVFlMRS5zb2xpZEFycmF5O1xuXG4gICAgICByZXR1cm4gTElORV9TVFlMRS5kYXNoQXJyYXk7XG4gICAgfSxcblxuICAgIGdldExpbmVDb2xvcjogTElORV9TVFlMRS5nZXRDb2xvcixcbiAgICBnZXRGaWxsQ29sb3I6IEZFQVRVUkVfU1RZTEUuZ2V0Q29sb3IsXG5cbiAgICBnZXRSYWRpdXM6IEVESVRfSEFORExFX1NUWUxFLmdldFJhZGl1cyxcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgZ2V0TGluZVdpZHRoOiBMSU5FX1NUWUxFLmdldFdpZHRoLFxuXG4gICAgZ2V0RWRpdEhhbmRsZVBvaW50UmFkaXVzOiBFRElUX0hBTkRMRV9TVFlMRS5nZXRSYWRpdXMsXG4gICAgZ2V0RWRpdEhhbmRsZVBvaW50Q29sb3I6IEVESVRfSEFORExFX1NUWUxFLmdldEZpbGxDb2xvcixcbiAgICBnZXRFZGl0SGFuZGxlUG9pbnRPdXRsaW5lQ29sb3I6IEVESVRfSEFORExFX1NUWUxFLmdldE91dGxpbmVDb2xvcixcblxuICAgIGdldFRlbnRhdGl2ZUxpbmVDb2xvcjogTElORV9TVFlMRS5nZXRUZW50YXRpdmVMaW5lQ29sb3IsXG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGdldFRlbnRhdGl2ZUxpbmVXaWR0aDogTElORV9TVFlMRS5nZXRUZW50YXRpdmVMaW5lV2lkdGgsXG4gICAgZ2V0VGVudGF0aXZlRmlsbENvbG9yOiBMSU5FX1NUWUxFLmdldFRlbnRhdGl2ZUZpbGxDb2xvcixcblxuICAgIHBhcmFtZXRlcnM6IHt9XG4gIH0pO1xufVxuIl19