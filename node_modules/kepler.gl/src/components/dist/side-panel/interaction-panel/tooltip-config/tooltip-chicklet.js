"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _react = _interopRequireWildcard(require("react"));

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _classnames = _interopRequireDefault(require("classnames"));

var _utilities = require("@dnd-kit/utilities");

var _chickletedInput = require("../../../common/item-selector/chickleted-input");

var _icons = require("../../../common/icons");

var _dropdownList = _interopRequireDefault(require("../../../common/item-selector/dropdown-list"));

var _localization = require("@kepler.gl/localization");

var _utils = require("@kepler.gl/utils");

var _reactOnclickoutside = _interopRequireDefault(require("react-onclickoutside"));

var _tippyTooltip = _interopRequireDefault(require("../../../common/tippy-tooltip"));

var _templateObject, _templateObject2, _templateObject3, _templateObject4, _templateObject5, _templateObject6, _templateObject7;

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = (0, _getPrototypeOf2["default"])(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = (0, _getPrototypeOf2["default"])(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return (0, _possibleConstructorReturn2["default"])(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }

var ChickletAddonWrapper = _styledComponents["default"].div(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2["default"])(["\n  position: relative;\n"])));

var ChickletAddon = _styledComponents["default"].div(_templateObject2 || (_templateObject2 = (0, _taggedTemplateLiteral2["default"])(["\n  margin-right: 4px;\n"])));

var StyledPopover = _styledComponents["default"].div(_templateObject3 || (_templateObject3 = (0, _taggedTemplateLiteral2["default"])(["\n  margin-left: -64px;\n  position: absolute;\n  top: 20px;\n  width: 140px;\n  z-index: 101;\n"])));

var hashStyles = {
  SHOW: 'SHOW',
  ACTIVE: 'ACTIVE'
};

var IconDiv = _styledComponents["default"].div.attrs({
  className: 'tooltip-chicklet__icon'
})(_templateObject4 || (_templateObject4 = (0, _taggedTemplateLiteral2["default"])(["\n  color: ", ";\n"])), function (props) {
  return props.status === hashStyles.SHOW ? props.theme.subtextColorActive : props.status === hashStyles.ACTIVE ? props.theme.activeColor : props.theme.textColor;
});

var SortableStyledItem = _styledComponents["default"].div(_templateObject5 || (_templateObject5 = (0, _taggedTemplateLiteral2["default"])(["\n  transition: ", ";\n  transform: ", ";\n  &.sorting {\n    opacity: 0.3;\n    pointer-events: none;\n  }\n  :hover {\n    .tooltip-chicklet__drag-handler {\n      opacity: 1;\n    }\n  }\n"])), function (props) {
  return props.transition;
}, function (props) {
  return props.transform;
});

var StyledDragHandle = _styledComponents["default"].div.attrs({
  className: 'tooltip-chicklet__drag-handler'
})(_templateObject6 || (_templateObject6 = (0, _taggedTemplateLiteral2["default"])(["\n  display: flex;\n  align-items: center;\n  z-index: 1000;\n  opacity: 0;\n  margin-left: -5px;\n  :hover {\n    cursor: move;\n    color: ", ";\n  }\n"])), function (props) {
  return props.theme.tooltipVerticalLineColor;
});

var StyledTag = _styledComponents["default"].span(_templateObject7 || (_templateObject7 = (0, _taggedTemplateLiteral2["default"])(["\n  margin-right: 5px;\n  text-overflow: ellipsis;\n  width: 100%;\n  overflow: hidden;\n  max-width: 160px;\n"])));

function getFormatTooltip(formatLabels, format) {
  if (!format) {
    return null;
  }

  var formatLabel = formatLabels.find(function (fl) {
    return (0, _utils.getFormatValue)(fl) === format;
  });

  if (formatLabel) {
    return formatLabel.label;
  }

  return (0, _typeof2["default"])(format) === 'object' ? JSON.stringify(format, null, 2) : String(format);
}

function TooltipChickletFactory(dataId, config, onChange, fields, onDisplayFormatChange) {
  var TooltipChicklet = /*#__PURE__*/function (_Component) {
    (0, _inherits2["default"])(TooltipChicklet, _Component);

    var _super = _createSuper(TooltipChicklet);

    function TooltipChicklet() {
      var _this;

      (0, _classCallCheck2["default"])(this, TooltipChicklet);

      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
        args[_key] = arguments[_key];
      }

      _this = _super.call.apply(_super, [this].concat(args));
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "state", {
        show: false
      });
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "node", void 0);
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "handleClickOutside", function (e) {
        var _this$node;

        if ((_this$node = _this.node) !== null && _this$node !== void 0 && _this$node.contains(e.target)) {
          return;
        }
      });
      return _this;
    }

    (0, _createClass2["default"])(TooltipChicklet, [{
      key: "componentDidMount",
      value: function componentDidMount() {
        document.addEventListener('mousedown', this.handleClickOutside, false);
      }
    }, {
      key: "componentWillUnmount",
      value: function componentWillUnmount() {
        document.removeEventListener('mousedown', this.handleClickOutside, false);
      }
    }, {
      key: "render",
      value: function render() {
        var _this2 = this;

        var _this$props = this.props,
            disabled = _this$props.disabled,
            item = _this$props.item,
            displayOption = _this$props.displayOption,
            remove = _this$props.remove,
            attributes = _this$props.attributes,
            listeners = _this$props.listeners,
            setNodeRef = _this$props.setNodeRef,
            transform = _this$props.transform,
            transition = _this$props.transition,
            isDragging = _this$props.isDragging;
        var show = this.state.show;
        var tooltipField = config.fieldsToShow[dataId].find(function (fieldToShow) {
          return fieldToShow.name === item.name;
        });

        if (!tooltipField) {
          return null;
        }

        var field = fields.find(function (f) {
          return f.name === tooltipField.name;
        });

        if (!field) {
          return null;
        }

        var formatLabels = (0, _utils.getFormatLabels)(fields, tooltipField.name);
        var hasFormat = Boolean(field.displayFormat);
        var selectionIndex = formatLabels.findIndex(function (fl) {
          return (0, _utils.getFormatValue)(fl) === field.displayFormat;
        });
        var hashStyle = show ? hashStyles.SHOW : hasFormat ? hashStyles.ACTIVE : null;
        return /*#__PURE__*/_react["default"].createElement(SortableStyledItem, (0, _extends2["default"])({
          ref: setNodeRef,
          className: (0, _classnames["default"])('sortable-layer-items', {
            sorting: isDragging
          }),
          transform: _utilities.CSS.Translate.toString(transform),
          transition: transition || ''
        }, attributes), /*#__PURE__*/_react["default"].createElement(_chickletedInput.ChickletButton, {
          ref: function ref(node) {
            return _this2.node = node;
          }
        }, /*#__PURE__*/_react["default"].createElement(StyledDragHandle, listeners, /*#__PURE__*/_react["default"].createElement(_icons.VertDots, {
          height: "12px"
        })), /*#__PURE__*/_react["default"].createElement(StyledTag, {
          title: displayOption(item)
        }, displayOption(item)), formatLabels.length > 1 && /*#__PURE__*/_react["default"].createElement(ChickletAddonWrapper, null, /*#__PURE__*/_react["default"].createElement(_tippyTooltip["default"], {
          placement: "top",
          render: function render() {
            return /*#__PURE__*/_react["default"].createElement("span", null, hasFormat ? getFormatTooltip(formatLabels, field.displayName) : /*#__PURE__*/_react["default"].createElement(_localization.FormattedMessage, {
              id: 'fieldSelector.formatting'
            }));
          }
        }, /*#__PURE__*/_react["default"].createElement(ChickletAddon, null, /*#__PURE__*/_react["default"].createElement(IconDiv, {
          status: hashStyle
        }, /*#__PURE__*/_react["default"].createElement(_icons.Hash, {
          height: "8px",
          onClick: function onClick(e) {
            e.stopPropagation();

            _this2.setState({
              show: Boolean(!show)
            });
          }
        })))), show && /*#__PURE__*/_react["default"].createElement(StyledPopover, null, /*#__PURE__*/_react["default"].createElement(_dropdownList["default"], {
          options: formatLabels,
          selectionIndex: selectionIndex,
          displayOption: function displayOption(_ref) {
            var label = _ref.label;
            return label;
          },
          onOptionSelected: function onOptionSelected(result, e) {
            e.stopPropagation();

            _this2.setState({
              show: false
            });

            var displayFormat = (0, _utils.getFormatValue)(result);
            var oldFieldsToShow = config.fieldsToShow[dataId];
            var fieldsToShow = oldFieldsToShow.map(function (fieldToShow) {
              return fieldToShow.name === tooltipField.name ? {
                name: tooltipField.name,
                format: displayFormat
              } : fieldToShow;
            });

            var newConfig = _objectSpread(_objectSpread({}, config), {}, {
              fieldsToShow: _objectSpread(_objectSpread({}, config.fieldsToShow), {}, (0, _defineProperty2["default"])({}, dataId, fieldsToShow))
            });

            onChange(newConfig);
            onDisplayFormatChange(dataId, field.name, displayFormat);
          }
        }))), /*#__PURE__*/_react["default"].createElement(_icons.Delete, {
          onClick: disabled ? null : remove
        })));
      }
    }]);
    return TooltipChicklet;
  }(_react.Component);

  return (0, _reactOnclickoutside["default"])(TooltipChicklet);
}

var _default = TooltipChickletFactory;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9zaWRlLXBhbmVsL2ludGVyYWN0aW9uLXBhbmVsL3Rvb2x0aXAtY29uZmlnL3Rvb2x0aXAtY2hpY2tsZXQudHN4Il0sIm5hbWVzIjpbIkNoaWNrbGV0QWRkb25XcmFwcGVyIiwic3R5bGVkIiwiZGl2IiwiQ2hpY2tsZXRBZGRvbiIsIlN0eWxlZFBvcG92ZXIiLCJoYXNoU3R5bGVzIiwiU0hPVyIsIkFDVElWRSIsIkljb25EaXYiLCJhdHRycyIsImNsYXNzTmFtZSIsInByb3BzIiwic3RhdHVzIiwidGhlbWUiLCJzdWJ0ZXh0Q29sb3JBY3RpdmUiLCJhY3RpdmVDb2xvciIsInRleHRDb2xvciIsIlNvcnRhYmxlU3R5bGVkSXRlbSIsInRyYW5zaXRpb24iLCJ0cmFuc2Zvcm0iLCJTdHlsZWREcmFnSGFuZGxlIiwidG9vbHRpcFZlcnRpY2FsTGluZUNvbG9yIiwiU3R5bGVkVGFnIiwic3BhbiIsImdldEZvcm1hdFRvb2x0aXAiLCJmb3JtYXRMYWJlbHMiLCJmb3JtYXQiLCJmb3JtYXRMYWJlbCIsImZpbmQiLCJmbCIsImxhYmVsIiwiSlNPTiIsInN0cmluZ2lmeSIsIlN0cmluZyIsIlRvb2x0aXBDaGlja2xldEZhY3RvcnkiLCJkYXRhSWQiLCJjb25maWciLCJvbkNoYW5nZSIsImZpZWxkcyIsIm9uRGlzcGxheUZvcm1hdENoYW5nZSIsIlRvb2x0aXBDaGlja2xldCIsInNob3ciLCJlIiwibm9kZSIsImNvbnRhaW5zIiwidGFyZ2V0IiwiZG9jdW1lbnQiLCJhZGRFdmVudExpc3RlbmVyIiwiaGFuZGxlQ2xpY2tPdXRzaWRlIiwicmVtb3ZlRXZlbnRMaXN0ZW5lciIsImRpc2FibGVkIiwiaXRlbSIsImRpc3BsYXlPcHRpb24iLCJyZW1vdmUiLCJhdHRyaWJ1dGVzIiwibGlzdGVuZXJzIiwic2V0Tm9kZVJlZiIsImlzRHJhZ2dpbmciLCJzdGF0ZSIsInRvb2x0aXBGaWVsZCIsImZpZWxkc1RvU2hvdyIsImZpZWxkVG9TaG93IiwibmFtZSIsImZpZWxkIiwiZiIsImhhc0Zvcm1hdCIsIkJvb2xlYW4iLCJkaXNwbGF5Rm9ybWF0Iiwic2VsZWN0aW9uSW5kZXgiLCJmaW5kSW5kZXgiLCJoYXNoU3R5bGUiLCJzb3J0aW5nIiwiQ1NTIiwiVHJhbnNsYXRlIiwidG9TdHJpbmciLCJsZW5ndGgiLCJkaXNwbGF5TmFtZSIsInN0b3BQcm9wYWdhdGlvbiIsInNldFN0YXRlIiwicmVzdWx0Iiwib2xkRmllbGRzVG9TaG93IiwibWFwIiwibmV3Q29uZmlnIiwiQ29tcG9uZW50Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7OztBQTRCQSxJQUFNQSxvQkFBb0IsR0FBR0MsNkJBQU9DLEdBQVYsK0dBQTFCOztBQUlBLElBQU1DLGFBQWEsR0FBR0YsNkJBQU9DLEdBQVYsZ0hBQW5COztBQUlBLElBQU1FLGFBQWEsR0FBR0gsNkJBQU9DLEdBQVYsd0xBQW5COztBQVFBLElBQU1HLFVBQVUsR0FBRztBQUNqQkMsRUFBQUEsSUFBSSxFQUFFLE1BRFc7QUFFakJDLEVBQUFBLE1BQU0sRUFBRTtBQUZTLENBQW5COztBQUtBLElBQU1DLE9BQU8sR0FBR1AsNkJBQU9DLEdBQVAsQ0FBV08sS0FBWCxDQUFpQjtBQUMvQkMsRUFBQUEsU0FBUyxFQUFFO0FBRG9CLENBQWpCLENBQUgsMkdBR0YsVUFBQUMsS0FBSztBQUFBLFNBQ1pBLEtBQUssQ0FBQ0MsTUFBTixLQUFpQlAsVUFBVSxDQUFDQyxJQUE1QixHQUNJSyxLQUFLLENBQUNFLEtBQU4sQ0FBWUMsa0JBRGhCLEdBRUlILEtBQUssQ0FBQ0MsTUFBTixLQUFpQlAsVUFBVSxDQUFDRSxNQUE1QixHQUNBSSxLQUFLLENBQUNFLEtBQU4sQ0FBWUUsV0FEWixHQUVBSixLQUFLLENBQUNFLEtBQU4sQ0FBWUcsU0FMSjtBQUFBLENBSEgsQ0FBYjs7QUFl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QUFlM0MsZUFBZixDQUFQO0FBQ0Q7O2VBRWNOLHNCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVFxuLy8gQ29weXJpZ2h0IGNvbnRyaWJ1dG9ycyB0byB0aGUga2VwbGVyLmdsIHByb2plY3RcblxuaW1wb3J0IFJlYWN0LCB7Q29tcG9uZW50LCBDb21wb25lbnRUeXBlfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgc3R5bGVkIGZyb20gJ3N0eWxlZC1jb21wb25lbnRzJztcbmltcG9ydCBjbGFzc25hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xuaW1wb3J0IHtEcmFnZ2FibGVBdHRyaWJ1dGVzfSBmcm9tICdAZG5kLWtpdC9jb3JlJztcbmltcG9ydCB7Q1NTLCBUcmFuc2Zvcm19IGZyb20gJ0BkbmQta2l0L3V0aWxpdGllcyc7XG5pbXBvcnQge0NoaWNrbGV0QnV0dG9ufSBmcm9tICcuLi8uLi8uLi9jb21tb24vaXRlbS1zZWxlY3Rvci9jaGlja2xldGVkLWlucHV0JztcbmltcG9ydCB7SGFzaCwgRGVsZXRlLCBWZXJ0RG90c30gZnJvbSAnLi4vLi4vLi4vY29tbW9uL2ljb25zJztcbmltcG9ydCBEcm9wZG93bkxpc3QgZnJvbSAnLi4vLi4vLi4vY29tbW9uL2l0ZW0tc2VsZWN0b3IvZHJvcGRvd24tbGlzdCc7XG5pbXBvcnQge0Zvcm1hdHRlZE1lc3NhZ2V9IGZyb20gJ0BrZXBsZXIuZ2wvbG9jYWxpemF0aW9uJztcbmltcG9ydCB7VGltZUxhYmVsRm9ybWF0LCBUb29sdGlwRmllbGRzfSBmcm9tICdAa2VwbGVyLmdsL3R5cGVzJztcbmltcG9ydCB7Z2V0Rm9ybWF0VmFsdWUsIGdldEZvcm1hdExhYmVsc30gZnJvbSAnQGtlcGxlci5nbC91dGlscyc7XG5pbXBvcnQgb25DbGlja091dHNpZGUgZnJvbSAncmVhY3Qtb25jbGlja291dHNpZGUnO1xuaW1wb3J0IFRpcHB5VG9vbHRpcCBmcm9tICcuLi8uLi8uLi9jb21tb24vdGlwcHktdG9vbHRpcCc7XG5cbmludGVyZmFjZSBUb29sdGlwQ2hpY2tsZXRQcm9wcyB7XG4gIGRpc2FibGVkOiBib29sZWFuO1xuICBpdGVtOiB7bmFtZTogc3RyaW5nfTtcbiAgZGlzcGxheU9wdGlvbjogRnVuY3Rpb247XG4gIHJlbW92ZTogYW55O1xuXG4gIGF0dHJpYnV0ZXM6IERyYWdnYWJsZUF0dHJpYnV0ZXM7XG4gIGxpc3RlbmVyczogYW55O1xuICBzZXROb2RlUmVmOiAobm9kZTogSFRNTEVsZW1lbnQgfCBudWxsKSA9PiB2b2lkO1xuICB0cmFuc2Zvcm06IFRyYW5zZm9ybSB8IG51bGw7XG4gIHRyYW5zaXRpb24/OiBzdHJpbmc7XG4gIGlzRHJhZ2dpbmc6IGJvb2xlYW47XG59XG5cbnR5cGUgVG9vbHRpcENvbmZpZyA9IHtcbiAgZmllbGRzVG9TaG93OiB7XG4gICAgW2tleTogc3RyaW5nXToge25hbWU6IHN0cmluZzsgZm9ybWF0OiBzdHJpbmcgfCBudWxsfVtdO1xuICB9O1xuICBjb21wYXJlTW9kZTogYm9vbGVhbjtcbiAgY29tcGFyZVR5cGU6IHN0cmluZyB8IG51bGw7XG59O1xuXG50eXBlIEljb25EaXZQcm9wcyA9IHtcbiAgc3RhdHVzOiBzdHJpbmcgfCBudWxsO1xufTtcblxuY29uc3QgQ2hpY2tsZXRBZGRvbldyYXBwZXIgPSBzdHlsZWQuZGl2YFxuICBwb3NpdGlvbjogcmVsYXRpdmU7XG5gO1xuXG5jb25zdCBDaGlja2xldEFkZG9uID0gc3R5bGVkLmRpdmBcbiAgbWFyZ2luLXJpZ2h0OiA0cHg7XG5gO1xuXG5jb25zdCBTdHlsZWRQb3BvdmVyID0gc3R5bGVkLmRpdmBcbiAgbWFyZ2luLWxlZnQ6IC02NHB4O1xuICBwb3NpdGlvbjogYWJzb2x1dGU7XG4gIHRvcDogMjBweDtcbiAgd2lkdGg6IDE0MHB4O1xuICB6LWluZGV4OiAxMDE7XG5gO1xuXG5jb25zdCBoYXNoU3R5bGVzID0ge1xuICBTSE9XOiAnU0hPVycsXG4gIEFDVElWRTogJ0FDVElWRSdcbn07XG5cbmNvbnN0IEljb25EaXYgPSBzdHlsZWQuZGl2LmF0dHJzKHtcbiAgY2xhc3NOYW1lOiAndG9vbHRpcC1jaGlja2xldF9faWNvbidcbn0pPEljb25EaXZQcm9wcz5gXG4gIGNvbG9yOiAke3Byb3BzID0+XG4gICAgcHJvcHMuc3RhdHVzID09PSBoYXNoU3R5bGVzLlNIT1dcbiAgICAgID8gcHJvcHMudGhlbWUuc3VidGV4dENvbG9yQWN0aXZlXG4gICAgICA6IHByb3BzLnN0YXR1cyA9PT0gaGFzaFN0eWxlcy5BQ1RJVkVcbiAgICAgID8gcHJvcHMudGhlbWUuYWN0aXZlQ29sb3JcbiAgICAgIDogcHJvcHMudGhlbWUudGV4dENvbG9yfTtcbmA7XG5cbnR5cGUgU29ydGFibGVTdHlsZWRJdGVtUHJvcHMgPSB7XG4gIHRyYW5zaXRpb24/OiBzdHJpbmc7XG4gIHRyYW5zZm9ybT86IHN0cmluZztcbn07XG5jb25zdCBTb3J0YWJsZVN0eWxlZEl0ZW0gPSBzdHlsZWQuZGl2PFNvcnRhYmxlU3R5bGVkSXRlbVByb3BzPmBcbiAgdHJhbnNpdGlvbjogJHtwcm9wcyA9PiBwcm9wcy50cmFuc2l0aW9ufTtcbiAgdHJhbnNmb3JtOiAke3Byb3BzID0+IHByb3BzLnRyYW5zZm9ybX07XG4gICYuc29ydGluZyB7XG4gICAgb3BhY2l0eTogMC4zO1xuICAgIHBvaW50ZXItZXZlbnRzOiBub25lO1xuICB9XG4gIDpob3ZlciB7XG4gICAgLnRvb2x0aXAtY2hpY2tsZXRfX2RyYWctaGFuZGxlciB7XG4gICAgICBvcGFjaXR5OiAxO1xuICAgIH1cbiAgfVxuYDtcblxuY29uc3QgU3R5bGVkRHJhZ0hhbmRsZSA9IHN0eWxlZC5kaXYuYXR0cnMoe1xuICBjbGFzc05hbWU6ICd0b29sdGlwLWNoaWNrbGV0X19kcmFnLWhhbmRsZXInXG59KWBcbiAgZGlzcGxheTogZmxleDtcbiAgYWxpZ24taXRlbXM6IGNlbnRlcjtcbiAgei1pbmRleDogMTAwMDtcbiAgb3BhY2l0eTogMDtcbiAgbWFyZ2luLWxlZnQ6IC01cHg7XG4gIDpob3ZlciB7XG4gICAgY3Vyc29yOiBtb3ZlO1xuICAgIGNvbG9yOiAke3Byb3BzID0+IHByb3BzLnRoZW1lLnRvb2x0aXBWZXJ0aWNhbExpbmVDb2xvcn07XG4gIH1cbmA7XG5cbmNvbnN0IFN0eWxlZFRhZyA9IHN0eWxlZC5zcGFuYFxuICBtYXJnaW4tcmlnaHQ6IDVweDtcbiAgdGV4dC1vdmVyZmxvdzogZWxsaXBzaXM7XG4gIHdpZHRoOiAxMDAlO1xuICBvdmVyZmxvdzogaGlkZGVuO1xuICBtYXgtd2lkdGg6IDE2MHB4O1xuYDtcblxuZnVuY3Rpb24gZ2V0Rm9ybWF0VG9vbHRpcChmb3JtYXRMYWJlbHM6IFRpbWVMYWJlbEZvcm1hdFtdLCBmb3JtYXQ6IHN0cmluZyB8IG51bGwpIHtcbiAgaWYgKCFmb3JtYXQpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICBjb25zdCBmb3JtYXRMYWJlbCA9IGZvcm1hdExhYmVscy5maW5kKGZsID0+IGdldEZvcm1hdFZhbHVlKGZsKSA9PT0gZm9ybWF0KTtcbiAgaWYgKGZvcm1hdExhYmVsKSB7XG4gICAgcmV0dXJuIGZvcm1hdExhYmVsLmxhYmVsO1xuICB9XG4gIHJldHVybiB0eXBlb2YgZm9ybWF0ID09PSAnb2JqZWN0JyA/IEpTT04uc3RyaW5naWZ5KGZvcm1hdCwgbnVsbCwgMikgOiBTdHJpbmcoZm9ybWF0KTtcbn1cblxuZnVuY3Rpb24gVG9vbHRpcENoaWNrbGV0RmFjdG9yeShcbiAgZGF0YUlkOiBzdHJpbmcsXG4gIGNvbmZpZzogVG9vbHRpcENvbmZpZyxcbiAgb25DaGFuZ2U6IChjZmc6IFRvb2x0aXBDb25maWcpID0+IHZvaWQsXG4gIGZpZWxkczogVG9vbHRpcEZpZWxkc1tdLFxuICBvbkRpc3BsYXlGb3JtYXRDaGFuZ2Vcbik6IENvbXBvbmVudFR5cGU8VG9vbHRpcENoaWNrbGV0UHJvcHM+IHtcbiAgY2xhc3MgVG9vbHRpcENoaWNrbGV0IGV4dGVuZHMgQ29tcG9uZW50PFRvb2x0aXBDaGlja2xldFByb3BzPiB7XG4gICAgc3RhdGUgPSB7XG4gICAgICBzaG93OiBmYWxzZVxuICAgIH07XG4gICAgcHJpdmF0ZSBub2RlITogSFRNTERpdkVsZW1lbnQgfCBudWxsO1xuXG4gICAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCB0aGlzLmhhbmRsZUNsaWNrT3V0c2lkZSwgZmFsc2UpO1xuICAgIH1cblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgdGhpcy5oYW5kbGVDbGlja091dHNpZGUsIGZhbHNlKTtcbiAgICB9XG5cbiAgICBoYW5kbGVDbGlja091dHNpZGUgPSAoZTogYW55KSA9PiB7XG4gICAgICBpZiAodGhpcy5ub2RlPy5jb250YWlucyhlLnRhcmdldCkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH07XG5cbiAgICByZW5kZXIoKSB7XG4gICAgICBjb25zdCB7XG4gICAgICAgIGRpc2FibGVkLFxuICAgICAgICBpdGVtLFxuICAgICAgICBkaXNwbGF5T3B0aW9uLFxuICAgICAgICByZW1vdmUsXG4gICAgICAgIGF0dHJpYnV0ZXMsXG4gICAgICAgIGxpc3RlbmVycyxcbiAgICAgICAgc2V0Tm9kZVJlZixcbiAgICAgICAgdHJhbnNmb3JtLFxuICAgICAgICB0cmFuc2l0aW9uLFxuICAgICAgICBpc0RyYWdnaW5nXG4gICAgICB9ID0gdGhpcy5wcm9wcztcblxuICAgICAgY29uc3Qge3Nob3d9ID0gdGhpcy5zdGF0ZTtcbiAgICAgIGNvbnN0IHRvb2x0aXBGaWVsZCA9IGNvbmZpZy5maWVsZHNUb1Nob3dbZGF0YUlkXS5maW5kKFxuICAgICAgICBmaWVsZFRvU2hvdyA9PiBmaWVsZFRvU2hvdy5uYW1lID09PSBpdGVtLm5hbWVcbiAgICAgICk7XG4gICAgICBpZiAoIXRvb2x0aXBGaWVsZCkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGZpZWxkID0gZmllbGRzLmZpbmQoZiA9PiBmLm5hbWUgPT09IHRvb2x0aXBGaWVsZC5uYW1lKTtcbiAgICAgIGlmICghZmllbGQpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG4gICAgICBjb25zdCBmb3JtYXRMYWJlbHMgPSBnZXRGb3JtYXRMYWJlbHMoZmllbGRzLCB0b29sdGlwRmllbGQubmFtZSk7XG4gICAgICBjb25zdCBoYXNGb3JtYXQgPSBCb29sZWFuKGZpZWxkLmRpc3BsYXlGb3JtYXQpO1xuICAgICAgY29uc3Qgc2VsZWN0aW9uSW5kZXggPSBmb3JtYXRMYWJlbHMuZmluZEluZGV4KFxuICAgICAgICBmbCA9PiBnZXRGb3JtYXRWYWx1ZShmbCkgPT09IGZpZWxkLmRpc3BsYXlGb3JtYXRcbiAgICAgICk7XG4gICAgICBjb25zdCBoYXNoU3R5bGUgPSBzaG93ID8gaGFzaFN0eWxlcy5TSE9XIDogaGFzRm9ybWF0ID8gaGFzaFN0eWxlcy5BQ1RJVkUgOiBudWxsO1xuXG4gICAgICByZXR1cm4gKFxuICAgICAgICA8U29ydGFibGVTdHlsZWRJdGVtXG4gICAgICAgICAgcmVmPXtzZXROb2RlUmVmfVxuICAgICAgICAgIGNsYXNzTmFtZT17Y2xhc3NuYW1lcygnc29ydGFibGUtbGF5ZXItaXRlbXMnLCB7c29ydGluZzogaXNEcmFnZ2luZ30pfVxuICAgICAgICAgIHRyYW5zZm9ybT17Q1NTLlRyYW5zbGF0ZS50b1N0cmluZyh0cmFuc2Zvcm0pfVxuICAgICAgICAgIHRyYW5zaXRpb249e3RyYW5zaXRpb24gfHwgJyd9XG4gICAgICAgICAgey4uLmF0dHJpYnV0ZXN9XG4gICAgICAgID5cbiAgICAgICAgICA8Q2hpY2tsZXRCdXR0b24gcmVmPXtub2RlID0+ICh0aGlzLm5vZGUgPSBub2RlKX0+XG4gICAgICAgICAgICA8U3R5bGVkRHJhZ0hhbmRsZSB7Li4ubGlzdGVuZXJzfT5cbiAgICAgICAgICAgICAgPFZlcnREb3RzIGhlaWdodD1cIjEycHhcIiAvPlxuICAgICAgICAgICAgPC9TdHlsZWREcmFnSGFuZGxlPlxuICAgICAgICAgICAgPFN0eWxlZFRhZyB0aXRsZT17ZGlzcGxheU9wdGlvbihpdGVtKX0+e2Rpc3BsYXlPcHRpb24oaXRlbSl9PC9TdHlsZWRUYWc+XG4gICAgICAgICAgICB7Zm9ybWF0TGFiZWxzLmxlbmd0aCA+IDEgJiYgKFxuICAgICAgICAgICAgICA8Q2hpY2tsZXRBZGRvbldyYXBwZXI+XG4gICAgICAgICAgICAgICAgPFRpcHB5VG9vbHRpcFxuICAgICAgICAgICAgICAgICAgcGxhY2VtZW50PVwidG9wXCJcbiAgICAgICAgICAgICAgICAgIHJlbmRlcj17KCkgPT4gKFxuICAgICAgICAgICAgICAgICAgICA8c3Bhbj5cbiAgICAgICAgICAgICAgICAgICAgICB7aGFzRm9ybWF0ID8gKFxuICAgICAgICAgICAgICAgICAgICAgICAgZ2V0Rm9ybWF0VG9vbHRpcChmb3JtYXRMYWJlbHMsIGZpZWxkLmRpc3BsYXlOYW1lKVxuICAgICAgICAgICAgICAgICAgICAgICkgOiAoXG4gICAgICAgICAgICAgICAgICAgICAgICA8Rm9ybWF0dGVkTWVzc2FnZSBpZD17J2ZpZWxkU2VsZWN0b3IuZm9ybWF0dGluZyd9IC8+XG4gICAgICAgICAgICAgICAgICAgICAgKX1cbiAgICAgICAgICAgICAgICAgICAgPC9zcGFuPlxuICAgICAgICAgICAgICAgICAgKX1cbiAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICA8Q2hpY2tsZXRBZGRvbj5cbiAgICAgICAgICAgICAgICAgICAgPEljb25EaXYgc3RhdHVzPXtoYXNoU3R5bGV9PlxuICAgICAgICAgICAgICAgICAgICAgIDxIYXNoXG4gICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ9XCI4cHhcIlxuICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17ZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe3Nob3c6IEJvb2xlYW4oIXNob3cpfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgICAgIDwvSWNvbkRpdj5cbiAgICAgICAgICAgICAgICAgIDwvQ2hpY2tsZXRBZGRvbj5cbiAgICAgICAgICAgICAgICA8L1RpcHB5VG9vbHRpcD5cbiAgICAgICAgICAgICAgICB7c2hvdyAmJiAoXG4gICAgICAgICAgICAgICAgICA8U3R5bGVkUG9wb3Zlcj5cbiAgICAgICAgICAgICAgICAgICAgPERyb3Bkb3duTGlzdFxuICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM9e2Zvcm1hdExhYmVsc31cbiAgICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb25JbmRleD17c2VsZWN0aW9uSW5kZXh9XG4gICAgICAgICAgICAgICAgICAgICAgZGlzcGxheU9wdGlvbj17KHtsYWJlbH0pID0+IGxhYmVsfVxuICAgICAgICAgICAgICAgICAgICAgIG9uT3B0aW9uU2VsZWN0ZWQ9eyhyZXN1bHQsIGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvdzogZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXNwbGF5Rm9ybWF0ID0gZ2V0Rm9ybWF0VmFsdWUocmVzdWx0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9sZEZpZWxkc1RvU2hvdyA9IGNvbmZpZy5maWVsZHNUb1Nob3dbZGF0YUlkXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpZWxkc1RvU2hvdyA9IG9sZEZpZWxkc1RvU2hvdy5tYXAoZmllbGRUb1Nob3cgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmllbGRUb1Nob3cubmFtZSA9PT0gdG9vbHRpcEZpZWxkLm5hbWVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdG9vbHRpcEZpZWxkLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdDogZGlzcGxheUZvcm1hdFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogZmllbGRUb1Nob3c7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld0NvbmZpZyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgLi4uY29uZmlnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZHNUb1Nob3c6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5jb25maWcuZmllbGRzVG9TaG93LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtkYXRhSWRdOiBmaWVsZHNUb1Nob3dcbiAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlKG5ld0NvbmZpZyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBvbkRpc3BsYXlGb3JtYXRDaGFuZ2UoZGF0YUlkLCBmaWVsZC5uYW1lLCBkaXNwbGF5Rm9ybWF0KTtcbiAgICAgICAgICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgPC9TdHlsZWRQb3BvdmVyPlxuICAgICAgICAgICAgICAgICl9XG4gICAgICAgICAgICAgIDwvQ2hpY2tsZXRBZGRvbldyYXBwZXI+XG4gICAgICAgICAgICApfVxuICAgICAgICAgICAgPERlbGV0ZSBvbkNsaWNrPXtkaXNhYmxlZCA/IG51bGwgOiByZW1vdmV9IC8+XG4gICAgICAgICAgPC9DaGlja2xldEJ1dHRvbj5cbiAgICAgICAgPC9Tb3J0YWJsZVN0eWxlZEl0ZW0+XG4gICAgICApO1xuICAgIH1cbiAgfVxuICByZXR1cm4gb25DbGlja091dHNpZGUoVG9vbHRpcENoaWNrbGV0KTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgVG9vbHRpcENoaWNrbGV0RmFjdG9yeTtcbiJdfQ==