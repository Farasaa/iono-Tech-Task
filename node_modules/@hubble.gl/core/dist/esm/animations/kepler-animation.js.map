{"version":3,"file":"kepler-animation.js","names":["CameraKeyframes","KeplerFilterKeyframes","KeplerLayerKeyframes","KeplerTripKeyframes","Animation","noop","findLayer","layers","layerKeyframe","find","layer","id","config","label","findFilterIdx","filters","filterKeyframe","Number","isFinite","filterIdx","findIndex","filter","KeplerAnimation","constructor","layerKeyframes","filterKeyframes","getTimeRangeFilterKeyframes","undefined","animationConfig","tripKeyframe","cameraKeyframe","onTripFrameUpdate","onFilterFrameUpdate","onLayerFrameUpdate","onCameraFrameUpdate","setKeyframes","draw","timeline","set","unattachedKeyframes","push","length","reduce","acc","attachKeyframes","getKeyframes","animator","animation","getFrame","currentTime","Object","values"],"sources":["../../../src/animations/kepler-animation.js"],"sourcesContent":["// Copyright (c) 2021 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport {\n  CameraKeyframes,\n  KeplerFilterKeyframes,\n  KeplerLayerKeyframes,\n  KeplerTripKeyframes\n} from '../keyframes';\nimport Animation from './animation';\n\nfunction noop() {}\n\nexport function findLayer({layers, layerKeyframe}) {\n  // Either find layer using id or label.\n  return (\n    layers.find(layer => layer.id === layerKeyframe.id) ||\n    layers.find(layer => layer.config.label === layerKeyframe.label)\n  );\n}\n\nexport function findFilterIdx({filters, filterKeyframe}) {\n  // Either find filter using index or id.\n  return Number.isFinite(filterKeyframe.filterIdx)\n    ? filterKeyframe.filterIdx\n    : filters.findIndex(filter => filter.id === filterKeyframe.id);\n}\n\nexport default class KeplerAnimation extends Animation {\n  cameraKeyframe;\n  layerKeyframes = {};\n  filterKeyframes = {};\n  tripKeyframe = undefined;\n\n  constructor({\n    id = 'kepler',\n    layers = [],\n    layerKeyframes = [],\n    filters = [],\n    filterKeyframes = [],\n    getTimeRangeFilterKeyframes = undefined,\n    animationConfig = undefined,\n    tripKeyframe = undefined,\n    cameraKeyframe = undefined,\n    onTripFrameUpdate = noop,\n    onFilterFrameUpdate = noop,\n    onLayerFrameUpdate = noop,\n    onCameraFrameUpdate = noop\n  }) {\n    super({id});\n    this.onTripFrameUpdate = onTripFrameUpdate;\n    this.onFilterFrameUpdate = onFilterFrameUpdate;\n    this.onLayerFrameUpdate = onLayerFrameUpdate;\n    this.onCameraFrameUpdate = onCameraFrameUpdate;\n    this.layerKeyframes = {};\n    this.filterKeyframes = {};\n    this.setKeyframes({\n      layers,\n      layerKeyframes,\n      filters,\n      filterKeyframes,\n      cameraKeyframe,\n      animationConfig,\n      tripKeyframe,\n      getTimeRangeFilterKeyframes\n    });\n    this.draw();\n  }\n\n  setKeyframes({\n    layers = [],\n    layerKeyframes = [],\n    filters = [],\n    filterKeyframes = [],\n    getTimeRangeFilterKeyframes = undefined,\n    animationConfig = undefined,\n    tripKeyframe = undefined,\n    cameraKeyframe = undefined,\n    timeline = undefined\n  }) {\n    if (this.tripKeyframe && tripKeyframe) {\n      this.tripKeyframe.set({animationConfig, ...tripKeyframe});\n    } else if (tripKeyframe) {\n      this.tripKeyframe = new KeplerTripKeyframes({animationConfig, ...tripKeyframe});\n      this.unattachedKeyframes.push(this.tripKeyframe);\n    }\n\n    if (this.cameraKeyframe && cameraKeyframe) {\n      this.cameraKeyframe.set(cameraKeyframe);\n    } else if (cameraKeyframe) {\n      this.cameraKeyframe = new CameraKeyframes(cameraKeyframe);\n      this.unattachedKeyframes.push(this.cameraKeyframe);\n    }\n\n    if (layerKeyframes.length > 0) {\n      this.layerKeyframes = layerKeyframes.reduce((acc, layerKeyframe) => {\n        // Either find layer using id or label.\n        const layer = findLayer({layers, layerKeyframe});\n        if (layer) {\n          if (acc[layer.id]) {\n            acc[layer.id].set({layer, ...layerKeyframe});\n          } else {\n            acc[layer.id] = new KeplerLayerKeyframes({layer, ...layerKeyframe});\n            this.unattachedKeyframes.push(acc[layer.id]);\n          }\n        }\n        return acc;\n      }, this.layerKeyframes);\n    }\n\n    if (filterKeyframes.length > 0) {\n      this.filterKeyframes = filterKeyframes.reduce((acc, filterKeyframe) => {\n        const filterIdx = findFilterIdx({filters, filterKeyframe});\n        const filter = filters[filterIdx];\n        if (filter) {\n          if (acc[filter.id]) {\n            acc[filter.id].set({filter, ...filterKeyframe});\n          } else {\n            acc[filter.id] = new KeplerFilterKeyframes({\n              filter,\n              filterIdx,\n              getTimeRangeFilterKeyframes,\n              ...filterKeyframe\n            });\n            this.unattachedKeyframes.push(acc[filter.id]);\n          }\n        }\n        return acc;\n      }, this.filterKeyframes);\n    }\n\n    if (timeline) {\n      this.attachKeyframes(timeline);\n    }\n  }\n\n  getKeyframes() {\n    return {\n      cameraKeyframe: this.cameraKeyframe,\n      layerKeyframes: this.layerKeyframes,\n      filterKeyframes: this.filterKeyframes,\n      tripKeyframe: this.tripKeyframe\n    };\n  }\n\n  animator(animation) {\n    if (animation.cameraKeyframe) {\n      animation.onCameraFrameUpdate(animation.cameraKeyframe.getFrame());\n    }\n    if (animation.tripKeyframe) {\n      animation.onTripFrameUpdate(animation.tripKeyframe.getFrame().currentTime);\n    }\n    for (const filterKeyframe of Object.values(animation.filterKeyframes)) {\n      animation.onFilterFrameUpdate(filterKeyframe.filterIdx, 'value', filterKeyframe.getFrame());\n    }\n    for (const layerKeyframe of Object.values(animation.layerKeyframes)) {\n      animation.onLayerFrameUpdate(layerKeyframe.layer, layerKeyframe.getFrame());\n    }\n  }\n}\n"],"mappings":"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"}