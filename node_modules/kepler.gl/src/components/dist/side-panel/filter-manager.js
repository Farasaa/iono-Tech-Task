"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _reactIntl = require("react-intl");

var _styledComponents = require("../common/styled-components");

var _sourceDataCatalog = _interopRequireDefault(require("./common/source-data-catalog"));

var _filterPanel = _interopRequireDefault(require("./filter-panel/filter-panel"));

var _constants = require("@kepler.gl/constants");

var _utils = require("@kepler.gl/utils");

var _panelViewListToggle = _interopRequireDefault(require("./panel-view-list-toggle"));

var _panelTitle = _interopRequireDefault(require("./panel-title"));

var _addFilterButton = _interopRequireDefault(require("./filter-panel/add-filter-button"));

var _datasetSection = _interopRequireDefault(require("./layer-panel/dataset-section"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

FilterManagerFactory.deps = [_datasetSection["default"], _filterPanel["default"], _panelTitle["default"], _addFilterButton["default"], _panelViewListToggle["default"], _sourceDataCatalog["default"]];

function FilterManagerFactory(DatasetSection, FilterPanel, PanelTitle, AddFilterButton, PanelViewListToggle, SourceDataCatalog) {
  var FilterList = function FilterList(_ref) {
    var filtersByIndex = _ref.filtersByIndex,
        filters = _ref.filters,
        datasets = _ref.datasets,
        layers = _ref.layers,
        isAnyFilterAnimating = _ref.isAnyFilterAnimating,
        visStateActions = _ref.visStateActions;
    var _removeFilter = visStateActions.removeFilter,
        setFilter = visStateActions.setFilter,
        toggleFilterAnimation = visStateActions.toggleFilterAnimation,
        _toggleFilterFeature = visStateActions.toggleFilterFeature,
        setFilterView = visStateActions.setFilterView;
    var filterPanelCallbacks = (0, _react.useMemo)(function () {
      return filtersByIndex.reduce(function (accu, _ref2) {
        var filter = _ref2.filter,
            idx = _ref2.idx;
        return _objectSpread(_objectSpread({}, accu), {}, (0, _defineProperty2["default"])({}, filter.id, {
          removeFilter: function removeFilter() {
            return _removeFilter(idx);
          },
          toggleFilterView: function toggleFilterView() {
            return setFilterView(idx, (0, _utils.isSideFilter)(filter) ? _constants.FILTER_VIEW_TYPES.enlarged : _constants.FILTER_VIEW_TYPES.side);
          },
          toggleAnimation: function toggleAnimation() {
            return toggleFilterAnimation(idx);
          },
          toggleFilterFeature: function toggleFilterFeature() {
            return _toggleFilterFeature(idx);
          }
        }));
      }, {});
    }, [filtersByIndex, _removeFilter, setFilterView, toggleFilterAnimation, _toggleFilterFeature]);
    return /*#__PURE__*/_react["default"].createElement(_styledComponents.SidePanelSection, null, (0, _toConsumableArray2["default"])(filtersByIndex).reverse().map(function (_ref3) {
      var filter = _ref3.filter,
          idx = _ref3.idx;
      return /*#__PURE__*/_react["default"].createElement(FilterPanel, {
        key: "".concat(filter.id, "-").concat(idx),
        idx: idx,
        filters: filters,
        filter: filter,
        datasets: datasets,
        layers: layers,
        isAnyFilterAnimating: isAnyFilterAnimating,
        removeFilter: filterPanelCallbacks[filter.id].removeFilter,
        enlargeFilter: filterPanelCallbacks[filter.id].toggleFilterView,
        toggleAnimation: filterPanelCallbacks[filter.id].toggleAnimation,
        toggleFilterFeature: filterPanelCallbacks[filter.id].toggleFilterFeature,
        setFilter: setFilter
      });
    }));
  };

  var DatasetFilterSection = function DatasetFilterSection(_ref4) {
    var filtersByIndex = _ref4.filtersByIndex,
        filters = _ref4.filters,
        dataset = _ref4.dataset,
        datasets = _ref4.datasets,
        layers = _ref4.layers,
        isAnyFilterAnimating = _ref4.isAnyFilterAnimating,
        visStateActions = _ref4.visStateActions,
        showDatasetTable = _ref4.showDatasetTable,
        updateTableColor = _ref4.updateTableColor,
        removeDataset = _ref4.removeDataset,
        showDeleteDataset = _ref4.showDeleteDataset;
    var datasetCatalog = (0, _react.useMemo)(function () {
      return (0, _defineProperty2["default"])({}, dataset.id, dataset);
    }, [dataset]);
    return /*#__PURE__*/_react["default"].createElement(_react["default"].Fragment, null, /*#__PURE__*/_react["default"].createElement(SourceDataCatalog, {
      datasets: datasetCatalog,
      showDatasetTable: showDatasetTable,
      updateTableColor: updateTableColor,
      removeDataset: removeDataset,
      showDeleteDataset: showDeleteDataset
    }), /*#__PURE__*/_react["default"].createElement(FilterList, {
      filtersByIndex: filtersByIndex,
      filters: filters,
      datasets: datasets,
      layers: layers,
      isAnyFilterAnimating: isAnyFilterAnimating,
      visStateActions: visStateActions
    }));
  };

  var FilterManager = function FilterManager(_ref6) {
    var _ref6$filters = _ref6.filters,
        filters = _ref6$filters === void 0 ? [] : _ref6$filters,
        datasets = _ref6.datasets,
        layers = _ref6.layers,
        showDatasetTable = _ref6.showDatasetTable,
        updateTableColor = _ref6.updateTableColor,
        removeDataset = _ref6.removeDataset,
        showAddDataModal = _ref6.showAddDataModal,
        panelMetadata = _ref6.panelMetadata,
        panelListView = _ref6.panelListView,
        visStateActions = _ref6.visStateActions,
        uiStateActions = _ref6.uiStateActions;
    var addFilter = visStateActions.addFilter;
    var togglePanelListView = uiStateActions.togglePanelListView;
    var isAnyFilterAnimating = filters.some(function (f) {
      return f.isAnimating;
    });
    var onClickAddFilter = (0, _react.useCallback)(function (dataset) {
      return addFilter(dataset);
    }, [addFilter]);
    var isSortByDatasetMode = panelListView === _constants.PANEL_VIEW_TOGGLES.byDataset;
    var filtersByIndex = (0, _react.useMemo)(function () {
      return filters.map(function (f, idx) {
        return {
          filter: f,
          idx: idx
        };
      });
    }, [filters]);
    var filtersByDatasets = (0, _react.useMemo)(function () {
      return Object.keys(datasets).reduce(function (accu, dataId) {
        return _objectSpread(_objectSpread({}, accu), {}, (0, _defineProperty2["default"])({}, dataId, filtersByIndex.filter(function (fidx) {
          return fidx.filter.dataId && fidx.filter.dataId[0] === dataId;
        })));
      }, {});
    }, [datasets, filtersByIndex]);

    var _TogglePanelListView = (0, _react.useCallback)(function (listView) {
      togglePanelListView({
        panelId: 'filter',
        listView: listView
      });
    }, [togglePanelListView]);

    var intl = (0, _reactIntl.useIntl)();
    var filterListProps = {
      datasets: datasets,
      filters: filters,
      layers: layers,
      isAnyFilterAnimating: isAnyFilterAnimating,
      visStateActions: visStateActions
    };
    var sourceDataCatalogProps = {
      showDatasetTable: showDatasetTable,
      updateTableColor: updateTableColor,
      removeDataset: removeDataset,
      showDeleteDataset: true
    };
    return /*#__PURE__*/_react["default"].createElement("div", {
      className: "filter-manager"
    }, /*#__PURE__*/_react["default"].createElement(_styledComponents.SidePanelSection, null, /*#__PURE__*/_react["default"].createElement(PanelViewListToggle, {
      togglePanelListView: _TogglePanelListView,
      mode: panelListView
    })), /*#__PURE__*/_react["default"].createElement(DatasetSection, (0, _extends2["default"])({
      datasets: datasets
    }, sourceDataCatalogProps, {
      showDatasetList: !isSortByDatasetMode,
      showAddDataModal: showAddDataModal
    })), /*#__PURE__*/_react["default"].createElement(_styledComponents.SidePanelDivider, null), /*#__PURE__*/_react["default"].createElement(_styledComponents.SidePanelSection, null, /*#__PURE__*/_react["default"].createElement(PanelTitle, {
      className: "filter-manager-title",
      title: intl.formatMessage({
        id: panelMetadata.label
      })
    }, /*#__PURE__*/_react["default"].createElement(AddFilterButton, {
      datasets: datasets,
      onAdd: onClickAddFilter
    }))), /*#__PURE__*/_react["default"].createElement(_styledComponents.SidePanelSection, null, isSortByDatasetMode ? Object.keys(filtersByDatasets).map(function (dataId) {
      return /*#__PURE__*/_react["default"].createElement(DatasetFilterSection, (0, _extends2["default"])({
        key: dataId,
        filtersByIndex: filtersByDatasets[dataId],
        dataset: datasets[dataId]
      }, filterListProps, sourceDataCatalogProps));
    }) : /*#__PURE__*/_react["default"].createElement(FilterList, (0, _extends2["default"])({
      filtersByIndex: filtersByIndex
    }, filterListProps))));
  };

  return FilterManager;
}

var _default = FilterManagerFactory;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zaWRlLXBhbmVsL2ZpbHRlci1tYW5hZ2VyLnRzeCJdLCJuYW1lcyI6WyJGaWx0ZXJNYW5hZ2VyRmFjdG9yeSIsImRlcHMiLCJEYXRhc2V0U2VjdGlvbkZhY3RvcnkiLCJGaWx0ZXJQYW5lbEZhY3RvcnkiLCJQYW5lbFRpdGxlRmFjdG9yeSIsIkFkZEZpbHRlckJ1dHRvbkZhY3RvcnkiLCJQYW5lbFZpZXdMaXN0VG9nZ2xlRmFjdG9yeSIsIlNvdXJjZURhdGFDYXRhbG9nRmFjdG9yeSIsIkRhdGFzZXRTZWN0aW9uIiwiRmlsdGVyUGFuZWwiLCJQYW5lbFRpdGxlIiwiQWRkRmlsdGVyQnV0dG9uIiwiUGFuZWxWaWV3TGlzdFRvZ2dsZSIsIlNvdXJjZURhdGFDYXRhbG9nIiwiRmlsdGVyTGlzdCIsImZpbHRlcnNCeUluZGV4IiwiZmlsdGVycyIsImRhdGFzZXRzIiwibGF5ZXJzIiwiaXNBbnlGaWx0ZXJBbmltYXRpbmciLCJ2aXNTdGF0ZUFjdGlvbnMiLCJyZW1vdmVGaWx0ZXIiLCJzZXRGaWx0ZXIiLCJ0b2dnbGVGaWx0ZXJBbmltYXRpb24iLCJ0b2dnbGVGaWx0ZXJGZWF0dXJlIiwic2V0RmlsdGVyVmlldyIsImZpbHRlclBhbmVsQ2FsbGJhY2tzIiwicmVkdWNlIiwiYWNjdSIsImZpbHRlciIsImlkeCIsImlkIiwidG9nZ2xlRmlsdGVyVmlldyIsIkZJTFRFUl9WSUVXX1RZUEVTIiwiZW5sYXJnZWQiLCJzaWRlIiwidG9nZ2xlQW5pbWF0aW9uIiwicmV2ZXJzZSIsIm1hcCIsIkRhdGFzZXRGaWx0ZXJTZWN0aW9uIiwiZGF0YXNldCIsInNob3dEYXRhc2V0VGFibGUiLCJ1cGRhdGVUYWJsZUNvbG9yIiwicmVtb3ZlRGF0YXNldCIsInNob3dEZWxldGVEYXRhc2V0IiwiZGF0YXNldENhdGFsb2ciLCJGaWx0ZXJNYW5hZ2VyIiwic2hvd0FkZERhdGFNb2RhbCIsInBhbmVsTWV0YWRhdGEiLCJwYW5lbExpc3RWaWV3IiwidWlTdGF0ZUFjdGlvbnMiLCJhZGRGaWx0ZXIiLCJ0b2dnbGVQYW5lbExpc3RWaWV3Iiwic29tZSIsImYiLCJpc0FuaW1hdGluZyIsIm9uQ2xpY2tBZGRGaWx0ZXIiLCJpc1NvcnRCeURhdGFzZXRNb2RlIiwiUEFORUxfVklFV19UT0dHTEVTIiwiYnlEYXRhc2V0IiwiZmlsdGVyc0J5RGF0YXNldHMiLCJPYmplY3QiLCJrZXlzIiwiZGF0YUlkIiwiZmlkeCIsIl9Ub2dnbGVQYW5lbExpc3RWaWV3IiwibGlzdFZpZXciLCJwYW5lbElkIiwiaW50bCIsImZpbHRlckxpc3RQcm9wcyIsInNvdXJjZURhdGFDYXRhbG9nUHJvcHMiLCJmb3JtYXRNZXNzYWdlIiwibGFiZWwiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBSUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQWlDQUEsb0JBQW9CLENBQUNDLElBQXJCLEdBQTRCLENBQzFCQywwQkFEMEIsRUFFMUJDLHVCQUYwQixFQUcxQkMsc0JBSDBCLEVBSTFCQywyQkFKMEIsRUFLMUJDLCtCQUwwQixFQU0xQkMsNkJBTjBCLENBQTVCOztBQVNBLFNBQVNQLG9CQUFULENBQ0VRLGNBREYsRUFFRUMsV0FGRixFQUdFQyxVQUhGLEVBSUVDLGVBSkYsRUFLRUMsbUJBTEYsRUFNRUMsaUJBTkYsRUFPRTtBQUNBLE1BQU1DLFVBQVUsR0FBRyxTQUFiQSxVQUFhLE9BT0k7QUFBQSxRQU5yQkMsY0FNcUIsUUFOckJBLGNBTXFCO0FBQUEsUUFMckJDLE9BS3FCLFFBTHJCQSxPQUtxQjtBQUFBLFFBSnJCQyxRQUlxQixRQUpyQkEsUUFJcUI7QUFBQSxRQUhyQkMsTUFHcUIsUUFIckJBLE1BR3FCO0FBQUEsUUFGckJDLG9CQUVxQixRQUZyQkEsb0JBRXFCO0FBQUEsUUFEckJDLGVBQ3FCLFFBRHJCQSxlQUNxQjtBQUFBLFFBRW5CQyxhQUZtQixHQU9qQkQsZUFQaUIsQ0FFbkJDLFlBRm1CO0FBQUEsUUFHbkJD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QUFDLGtDQUFELE9BVkYsZUFXRSxnQ0FBQyxrQ0FBRCxxQkFDRSxnQ0FBQyxVQUFEO0FBQ0UsTUFBQSxTQUFTLEVBQUMsc0JBRFo7QUFFRSxNQUFBLEtBQUssRUFBRXFCLElBQUksQ0FBQ0csYUFBTCxDQUFtQjtBQUFDeEMsUUFBQUEsRUFBRSxFQUFFaUIsYUFBYSxDQUFDd0I7QUFBbkIsT0FBbkI7QUFGVCxvQkFJRSxnQ0FBQyxlQUFEO0FBQWlCLE1BQUEsUUFBUSxFQUFFdkQsUUFBM0I7QUFBcUMsTUFBQSxLQUFLLEVBQUV1QztBQUE1QyxNQUpGLENBREYsQ0FYRixlQW1CRSxnQ0FBQyxrQ0FBRCxRQUNHQyxtQkFBbUIsR0FDbEJJLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZRixpQkFBWixFQUErQnRCLEdBQS9CLENBQW1DLFVBQUF5QixNQUFNO0FBQUEsMEJBQ3ZDLGdDQUFDLG9CQUFEO0FBQ0UsUUFBQSxHQUFHLEVBQUVBLE1BRFA7QUFFRSxRQUFBLGNBQWMsRUFBRUgsaUJBQWlCLENBQUNHLE1BQUQsQ0FGbkM7QUFHRSxRQUFBLE9BQU8sRUFBRTlDLFFBQVEsQ0FBQzhDLE1BQUQ7QUFIbkIsU0FJTU0sZUFKTixFQUtNQyxzQkFMTixFQUR1QztBQUFBLEtBQXpDLENBRGtCLGdCQVdsQixnQ0FBQyxVQUFEO0FBQVksTUFBQSxjQUFjLEVBQUV2RDtBQUE1QixPQUFnRHNELGVBQWhELEVBWkosQ0FuQkYsQ0FERjtBQXFDRCxHQXBHRDs7QUFzR0EsU0FBT3ZCLGFBQVA7QUFDRDs7ZUFFYzlDLG9CIiwic291cmNlc0NvbnRlbnQiOlsiLy8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVFxuLy8gQ29weXJpZ2h0IGNvbnRyaWJ1dG9ycyB0byB0aGUga2VwbGVyLmdsIHByb2plY3RcblxuaW1wb3J0IFJlYWN0LCB7dXNlQ2FsbGJhY2ssIHVzZU1lbW99IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7dXNlSW50bH0gZnJvbSAncmVhY3QtaW50bCc7XG5pbXBvcnQge1NpZGVQYW5lbERpdmlkZXIsIFNpZGVQYW5lbFNlY3Rpb259IGZyb20gJy4uL2NvbW1vbi9zdHlsZWQtY29tcG9uZW50cyc7XG5pbXBvcnQgU291cmNlRGF0YUNhdGFsb2dGYWN0b3J5IGZyb20gJy4vY29tbW9uL3NvdXJjZS1kYXRhLWNhdGFsb2cnO1xuaW1wb3J0IEZpbHRlclBhbmVsRmFjdG9yeSBmcm9tICcuL2ZpbHRlci1wYW5lbC9maWx0ZXItcGFuZWwnO1xuaW1wb3J0IHtGSUxURVJfVklFV19UWVBFUywgUEFORUxfVklFV19UT0dHTEVTfSBmcm9tICdAa2VwbGVyLmdsL2NvbnN0YW50cyc7XG5pbXBvcnQge0ZpbHRlcn0gZnJvbSAnQGtlcGxlci5nbC90eXBlcyc7XG5pbXBvcnQge0xheWVyfSBmcm9tICdAa2VwbGVyLmdsL2xheWVycyc7XG5pbXBvcnQge2lzU2lkZUZpbHRlcn0gZnJvbSAnQGtlcGxlci5nbC91dGlscyc7XG5pbXBvcnQge1Zpc1N0YXRlQWN0aW9ucywgQWN0aW9uSGFuZGxlciwgVUlTdGF0ZUFjdGlvbnMsIEFjdGlvbkhhbmRsZXJzfSBmcm9tICdAa2VwbGVyLmdsL2FjdGlvbnMnO1xuaW1wb3J0IHtEYXRhc2V0c30gZnJvbSAnQGtlcGxlci5nbC90YWJsZSc7XG5cbmltcG9ydCBQYW5lbFZpZXdMaXN0VG9nZ2xlRmFjdG9yeSBmcm9tICcuL3BhbmVsLXZpZXctbGlzdC10b2dnbGUnO1xuaW1wb3J0IFBhbmVsVGl0bGVGYWN0b3J5IGZyb20gJy4vcGFuZWwtdGl0bGUnO1xuaW1wb3J0IEFkZEZpbHRlckJ1dHRvbkZhY3RvcnkgZnJvbSAnLi9maWx0ZXItcGFuZWwvYWRkLWZpbHRlci1idXR0b24nO1xuaW1wb3J0IERhdGFzZXRTZWN0aW9uRmFjdG9yeSBmcm9tICcuL2xheWVyLXBhbmVsL2RhdGFzZXQtc2VjdGlvbic7XG5pbXBvcnQge1BhbmVsTWV0YX0gZnJvbSAnLi9jb21tb24vdHlwZXMnO1xuXG50eXBlIFZpc1N0YXRlQWN0aW9uSGFuZGxlcnMgPSBBY3Rpb25IYW5kbGVyczx0eXBlb2YgVmlzU3RhdGVBY3Rpb25zPjtcbnR5cGUgVWlTdGF0ZUFjdGlvbkhhbmRsZXJzID0gQWN0aW9uSGFuZGxlcnM8dHlwZW9mIFVJU3RhdGVBY3Rpb25zPjtcblxuZXhwb3J0IHR5cGUgRmlsdGVyTWFuYWdlclByb3BzID0ge1xuICBmaWx0ZXJzOiBGaWx0ZXJbXTtcbiAgZGF0YXNldHM6IERhdGFzZXRzO1xuICBsYXllcnM6IExheWVyW107XG4gIHNob3dEYXRhc2V0VGFibGU6IEFjdGlvbkhhbmRsZXI8dHlwZW9mIFZpc1N0YXRlQWN0aW9ucy5zaG93RGF0YXNldFRhYmxlPjtcbiAgdXBkYXRlVGFibGVDb2xvcjogQWN0aW9uSGFuZGxlcjx0eXBlb2YgVmlzU3RhdGVBY3Rpb25zLnVwZGF0ZVRhYmxlQ29sb3I+O1xuICByZW1vdmVEYXRhc2V0OiBBY3Rpb25IYW5kbGVyPHR5cGVvZiBWaXNTdGF0ZUFjdGlvbnMucmVtb3ZlRGF0YXNldD47XG4gIHNob3dBZGREYXRhTW9kYWw6ICgpID0+IHZvaWQ7XG5cbiAgcGFuZWxNZXRhZGF0YTogUGFuZWxNZXRhO1xuICBwYW5lbExpc3RWaWV3OiBzdHJpbmc7XG4gIHZpc1N0YXRlQWN0aW9uczogVmlzU3RhdGVBY3Rpb25IYW5kbGVycztcbiAgdWlTdGF0ZUFjdGlvbnM6IFVpU3RhdGVBY3Rpb25IYW5kbGVycztcbn07XG5cbnR5cGUgRmlsdGVyTGlzdFByb3BzID0ge1xuICBmaWx0ZXJzOiBGaWx0ZXJbXTtcbiAgZGF0YXNldHM6IERhdGFzZXRzO1xuICBsYXllcnM6IExheWVyW107XG4gIGZpbHRlcnNCeUluZGV4OiB7XG4gICAgZmlsdGVyOiBGaWx0ZXI7XG4gICAgaWR4OiBudW1iZXI7XG4gIH1bXTtcbiAgaXNBbnlGaWx0ZXJBbmltYXRpbmc6IGJvb2xlYW47XG4gIHZpc1N0YXRlQWN0aW9uczogVmlzU3RhdGVBY3Rpb25IYW5kbGVycztcbn07XG5cbkZpbHRlck1hbmFnZXJGYWN0b3J5LmRlcHMgPSBbXG4gIERhdGFzZXRTZWN0aW9uRmFjdG9yeSxcbiAgRmlsdGVyUGFuZWxGYWN0b3J5LFxuICBQYW5lbFRpdGxlRmFjdG9yeSxcbiAgQWRkRmlsdGVyQnV0dG9uRmFjdG9yeSxcbiAgUGFuZWxWaWV3TGlzdFRvZ2dsZUZhY3RvcnksXG4gIFNvdXJjZURhdGFDYXRhbG9nRmFjdG9yeVxuXTtcblxuZnVuY3Rpb24gRmlsdGVyTWFuYWdlckZhY3RvcnkoXG4gIERhdGFzZXRTZWN0aW9uOiBSZXR1cm5UeXBlPHR5cGVvZiBEYXRhc2V0U2VjdGlvbkZhY3Rvcnk+LFxuICBGaWx0ZXJQYW5lbDogUmV0dXJuVHlwZTx0eXBlb2YgRmlsdGVyUGFuZWxGYWN0b3J5PixcbiAgUGFuZWxUaXRsZTogUmV0dXJuVHlwZTx0eXBlb2YgUGFuZWxUaXRsZUZhY3Rvcnk+LFxuICBBZGRGaWx0ZXJCdXR0b246IFJldHVyblR5cGU8dHlwZW9mIEFkZEZpbHRlckJ1dHRvbkZhY3Rvcnk+LFxuICBQYW5lbFZpZXdMaXN0VG9nZ2xlOiBSZXR1cm5UeXBlPHR5cGVvZiBQYW5lbFZpZXdMaXN0VG9nZ2xlRmFjdG9yeT4sXG4gIFNvdXJjZURhdGFDYXRhbG9nOiBSZXR1cm5UeXBlPHR5cGVvZiBTb3VyY2VEYXRhQ2F0YWxvZ0ZhY3Rvcnk+XG4pIHtcbiAgY29uc3QgRmlsdGVyTGlzdCA9ICh7XG4gICAgZmlsdGVyc0J5SW5kZXgsXG4gICAgZmlsdGVycyxcbiAgICBkYXRhc2V0cyxcbiAgICBsYXllcnMsXG4gICAgaXNBbnlGaWx0ZXJBbmltYXRpbmcsXG4gICAgdmlzU3RhdGVBY3Rpb25zXG4gIH06IEZpbHRlckxpc3RQcm9wcykgPT4ge1xuICAgIGNvbnN0IHtcbiAgICAgIHJlbW92ZUZpbHRlcixcbiAgICAgIHNldEZpbHRlcixcbiAgICAgIHRvZ2dsZUZpbHRlckFuaW1hdGlvbixcbiAgICAgIHRvZ2dsZUZpbHRlckZlYXR1cmUsXG4gICAgICBzZXRGaWx0ZXJWaWV3XG4gICAgfSA9IHZpc1N0YXRlQWN0aW9ucztcblxuICAgIGNvbnN0IGZpbHRlclBhbmVsQ2FsbGJhY2tzID0gdXNlTWVtbygoKSA9PiB7XG4gICAgICByZXR1cm4gZmlsdGVyc0J5SW5kZXgucmVkdWNlKFxuICAgICAgICAoYWNjdSwge2ZpbHRlciwgaWR4fSkgPT4gKHtcbiAgICAgICAgICAuLi5hY2N1LFxuICAgICAgICAgIFtmaWx0ZXIuaWRdOiB7XG4gICAgICAgICAgICByZW1vdmVGaWx0ZXI6ICgpID0+IHJlbW92ZUZpbHRlcihpZHgpLFxuICAgICAgICAgICAgdG9nZ2xlRmlsdGVyVmlldzogKCkgPT5cbiAgICAgICAgICAgICAgc2V0RmlsdGVyVmlldyhcbiAgICAgICAgICAgICAgICBpZHgsXG4gICAgICAgICAgICAgICAgaXNTaWRlRmlsdGVyKGZpbHRlcikgPyBGSUxURVJfVklFV19UWVBFUy5lbmxhcmdlZCA6IEZJTFRFUl9WSUVXX1RZUEVTLnNpZGVcbiAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIHRvZ2dsZUFuaW1hdGlvbjogKCkgPT4gdG9nZ2xlRmlsdGVyQW5pbWF0aW9uKGlkeCksXG4gICAgICAgICAgICB0b2dnbGVGaWx0ZXJGZWF0dXJlOiAoKSA9PiB0b2dnbGVGaWx0ZXJGZWF0dXJlKGlkeClcbiAgICAgICAgICB9XG4gICAgICAgIH0pLFxuICAgICAgICB7fVxuICAgICAgKTtcbiAgICB9LCBbZmlsdGVyc0J5SW5kZXgsIHJlbW92ZUZpbHRlciwgc2V0RmlsdGVyVmlldywgdG9nZ2xlRmlsdGVyQW5pbWF0aW9uLCB0b2dnbGVGaWx0ZXJGZWF0dXJlXSk7XG5cbiAgICByZXR1cm4gKFxuICAgICAgPFNpZGVQYW5lbFNlY3Rpb24+XG4gICAgICAgIHtbLi4uZmlsdGVyc0J5SW5kZXhdLnJldmVyc2UoKS5tYXAoKHtmaWx0ZXIsIGlkeH0pID0+IChcbiAgICAgICAgICA8RmlsdGVyUGFuZWxcbiAgICAgICAgICAgIGtleT17YCR7ZmlsdGVyLmlkfS0ke2lkeH1gfVxuICAgICAgICAgICAgaWR4PXtpZHh9XG4gICAgICAgICAgICBmaWx0ZXJzPXtmaWx0ZXJzfVxuICAgICAgICAgICAgZmlsdGVyPXtmaWx0ZXJ9XG4gICAgICAgICAgICBkYXRhc2V0cz17ZGF0YXNldHN9XG4gICAgICAgICAgICBsYXllcnM9e2xheWVyc31cbiAgICAgICAgICAgIGlzQW55RmlsdGVyQW5pbWF0aW5nPXtpc0FueUZpbHRlckFuaW1hdGluZ31cbiAgICAgICAgICAgIHJlbW92ZUZpbHRlcj17ZmlsdGVyUGFuZWxDYWxsYmFja3NbZmlsdGVyLmlkXS5yZW1vdmVGaWx0ZXJ9XG4gICAgICAgICAgICBlbmxhcmdlRmlsdGVyPXtmaWx0ZXJQYW5lbENhbGxiYWNrc1tmaWx0ZXIuaWRdLnRvZ2dsZUZpbHRlclZpZXd9XG4gICAgICAgICAgICB0b2dnbGVBbmltYXRpb249e2ZpbHRlclBhbmVsQ2FsbGJhY2tzW2ZpbHRlci5pZF0udG9nZ2xlQW5pbWF0aW9ufVxuICAgICAgICAgICAgdG9nZ2xlRmlsdGVyRmVhdHVyZT17ZmlsdGVyUGFuZWxDYWxsYmFja3NbZmlsdGVyLmlkXS50b2dnbGVGaWx0ZXJGZWF0dXJlfVxuICAgICAgICAgICAgc2V0RmlsdGVyPXtzZXRGaWx0ZXJ9XG4gICAgICAgICAgLz5cbiAgICAgICAgKSl9XG4gICAgICA8L1NpZGVQYW5lbFNlY3Rpb24+XG4gICAgKTtcbiAgfTtcblxuICBjb25zdCBEYXRhc2V0RmlsdGVyU2VjdGlvbiA9ICh7XG4gICAgZmlsdGVyc0J5SW5kZXgsXG4gICAgZmlsdGVycyxcbiAgICBkYXRhc2V0LFxuICAgIGRhdGFzZXRzLFxuICAgIGxheWVycyxcbiAgICBpc0FueUZpbHRlckFuaW1hdGluZyxcbiAgICB2aXNTdGF0ZUFjdGlvbnMsXG4gICAgc2hvd0RhdGFzZXRUYWJsZSxcbiAgICB1cGRhdGVUYWJsZUNvbG9yLFxuICAgIHJlbW92ZURhdGFzZXQsXG4gICAgc2hvd0RlbGV0ZURhdGFzZXRcbiAgfSkgPT4ge1xuICAgIGNvbnN0IGRhdGFzZXRDYXRhbG9nID0gdXNlTWVtbygoKSA9PiB7XG4gICAgICByZXR1cm4ge1tkYXRhc2V0LmlkXTogZGF0YXNldH07XG4gICAgfSwgW2RhdGFzZXRdKTtcblxuICAgIHJldHVybiAoXG4gICAgICA8PlxuICAgICAgICA8U291cmNlRGF0YUNhdGFsb2dcbiAgICAgICAgICBkYXRhc2V0cz17ZGF0YXNldENhdGFsb2d9XG4gICAgICAgICAgc2hvd0RhdGFzZXRUYWJsZT17c2hvd0RhdGFzZXRUYWJsZX1cbiAgICAgICAgICB1cGRhdGVUYWJsZUNvbG9yPXt1cGRhdGVUYWJsZUNvbG9yfVxuICAgICAgICAgIHJlbW92ZURhdGFzZXQ9e3JlbW92ZURhdGFzZXR9XG4gICAgICAgICAgc2hvd0RlbGV0ZURhdGFzZXQ9e3Nob3dEZWxldGVEYXRhc2V0fVxuICAgICAgICAvPlxuICAgICAgICA8RmlsdGVyTGlzdFxuICAgICAgICAgIGZpbHRlcnNCeUluZGV4PXtmaWx0ZXJzQnlJbmRleH1cbiAgICAgICAgICBmaWx0ZXJzPXtmaWx0ZXJzfVxuICAgICAgICAgIGRhdGFzZXRzPXtkYXRhc2V0c31cbiAgICAgICAgICBsYXllcnM9e2xheWVyc31cbiAgICAgICAgICBpc0FueUZpbHRlckFuaW1hdGluZz17aXNBbnlGaWx0ZXJBbmltYXRpbmd9XG4gICAgICAgICAgdmlzU3RhdGVBY3Rpb25zPXt2aXNTdGF0ZUFjdGlvbnN9XG4gICAgICAgIC8+XG4gICAgICA8Lz5cbiAgICApO1xuICB9O1xuXG4gIGNvbnN0IEZpbHRlck1hbmFnZXI6IFJlYWN0LkZDPEZpbHRlck1hbmFnZXJQcm9wcz4gPSAoe1xuICAgIGZpbHRlcnMgPSBbXSxcbiAgICBkYXRhc2V0cyxcbiAgICBsYXllcnMsXG4gICAgc2hvd0RhdGFzZXRUYWJsZSxcbiAgICB1cGRhdGVUYWJsZUNvbG9yLFxuICAgIHJlbW92ZURhdGFzZXQsXG4gICAgc2hvd0FkZERhdGFNb2RhbCxcbiAgICBwYW5lbE1ldGFkYXRhLFxuICAgIHBhbmVsTGlzdFZpZXcsXG4gICAgdmlzU3RhdGVBY3Rpb25zLFxuICAgIHVpU3RhdGVBY3Rpb25zXG4gIH0pID0+IHtcbiAgICBjb25zdCB7YWRkRmlsdGVyfSA9IHZpc1N0YXRlQWN0aW9ucztcbiAgICBjb25zdCB7dG9nZ2xlUGFuZWxMaXN0Vmlld30gPSB1aVN0YXRlQWN0aW9ucztcbiAgICBjb25zdCBpc0FueUZpbHRlckFuaW1hdGluZyA9IGZpbHRlcnMuc29tZShmID0+IGYuaXNBbmltYXRpbmcpO1xuICAgIGNvbnN0IG9uQ2xpY2tBZGRGaWx0ZXIgPSB1c2VDYWxsYmFjayhkYXRhc2V0ID0+IGFkZEZpbHRlcihkYXRhc2V0KSwgW2FkZEZpbHRlcl0pO1xuICAgIGNvbnN0IGlzU29ydEJ5RGF0YXNldE1vZGUgPSBwYW5lbExpc3RWaWV3ID09PSBQQU5FTF9WSUVXX1RPR0dMRVMuYnlEYXRhc2V0O1xuICAgIGNvbnN0IGZpbHRlcnNCeUluZGV4ID0gdXNlTWVtbyhcbiAgICAgICgpID0+XG4gICAgICAgIGZpbHRlcnMubWFwKChmLCBpZHgpID0+ICh7XG4gICAgICAgICAgZmlsdGVyOiBmLFxuICAgICAgICAgIGlkeFxuICAgICAgICB9KSksXG4gICAgICBbZmlsdGVyc11cbiAgICApO1xuICAgIGNvbnN0IGZpbHRlcnNCeURhdGFzZXRzID0gdXNlTWVtbyhcbiAgICAgICgpID0+XG4gICAgICAgIE9iamVjdC5rZXlzKGRhdGFzZXRzKS5yZWR1Y2UoXG4gICAgICAgICAgKGFjY3UsIGRhdGFJZCkgPT4gKHtcbiAgICAgICAgICAgIC4uLmFjY3UsXG4gICAgICAgICAgICAvLyBpZiBzeW5jZWQgZmlsdGVyLCBzaG93IGl0IHVuZmRlciBpdHMgdGhlIGZpcnN0IGRhdGFzZXRcbiAgICAgICAgICAgIFtkYXRhSWRdOiBmaWx0ZXJzQnlJbmRleC5maWx0ZXIoXG4gICAgICAgICAgICAgIGZpZHggPT4gZmlkeC5maWx0ZXIuZGF0YUlkICYmIGZpZHguZmlsdGVyLmRhdGFJZFswXSA9PT0gZGF0YUlkXG4gICAgICAgICAgICApXG4gICAgICAgICAgfSksXG4gICAgICAgICAge31cbiAgICAgICAgKSxcbiAgICAgIFtkYXRhc2V0cywgZmlsdGVyc0J5SW5kZXhdXG4gICAgKTtcbiAgICBjb25zdCBfVG9nZ2xlUGFuZWxMaXN0VmlldyA9IHVzZUNhbGxiYWNrKFxuICAgICAgbGlzdFZpZXcgPT4ge1xuICAgICAgICB0b2dnbGVQYW5lbExpc3RWaWV3KHtwYW5lbElkOiAnZmlsdGVyJywgbGlzdFZpZXd9KTtcbiAgICAgIH0sXG4gICAgICBbdG9nZ2xlUGFuZWxMaXN0Vmlld11cbiAgICApO1xuXG4gICAgY29uc3QgaW50bCA9IHVzZUludGwoKTtcbiAgICBjb25zdCBmaWx0ZXJMaXN0UHJvcHMgPSB7XG4gICAgICBkYXRhc2V0cyxcbiAgICAgIGZpbHRlcnMsXG4gICAgICBsYXllcnMsXG4gICAgICBpc0FueUZpbHRlckFuaW1hdGluZyxcbiAgICAgIHZpc1N0YXRlQWN0aW9uc1xuICAgIH07XG5cbiAgICBjb25zdCBzb3VyY2VEYXRhQ2F0YWxvZ1Byb3BzID0ge1xuICAgICAgc2hvd0RhdGFzZXRUYWJsZSxcbiAgICAgIHVwZGF0ZVRhYmxlQ29sb3IsXG4gICAgICByZW1vdmVEYXRhc2V0LFxuICAgICAgc2hvd0RlbGV0ZURhdGFzZXQ6IHRydWVcbiAgICB9O1xuXG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXYgY2xhc3NOYW1lPVwiZmlsdGVyLW1hbmFnZXJcIj5cbiAgICAgICAgPFNpZGVQYW5lbFNlY3Rpb24+XG4gICAgICAgICAgPFBhbmVsVmlld0xpc3RUb2dnbGUgdG9nZ2xlUGFuZWxMaXN0Vmlldz17X1RvZ2dsZVBhbmVsTGlzdFZpZXd9IG1vZGU9e3BhbmVsTGlzdFZpZXd9IC8+XG4gICAgICAgIDwvU2lkZVBhbmVsU2VjdGlvbj5cbiAgICAgICAgPERhdGFzZXRTZWN0aW9uXG4gICAgICAgICAgZGF0YXNldHM9e2RhdGFzZXRzfVxuICAgICAgICAgIHsuLi5zb3VyY2VEYXRhQ2F0YWxvZ1Byb3BzfVxuICAgICAgICAgIHNob3dEYXRhc2V0TGlzdD17IWlzU29ydEJ5RGF0YXNldE1vZGV9XG4gICAgICAgICAgc2hvd0FkZERhdGFNb2RhbD17c2hvd0FkZERhdGFNb2RhbH1cbiAgICAgICAgLz5cbiAgICAgICAgPFNpZGVQYW5lbERpdmlkZXIgLz5cbiAgICAgICAgPFNpZGVQYW5lbFNlY3Rpb24+XG4gICAgICAgICAgPFBhbmVsVGl0bGVcbiAgICAgICAgICAgIGNsYXNzTmFtZT1cImZpbHRlci1tYW5hZ2VyLXRpdGxlXCJcbiAgICAgICAgICAgIHRpdGxlPXtpbnRsLmZvcm1hdE1lc3NhZ2Uoe2lkOiBwYW5lbE1ldGFkYXRhLmxhYmVsfSl9XG4gICAgICAgICAgPlxuICAgICAgICAgICAgPEFkZEZpbHRlckJ1dHRvbiBkYXRhc2V0cz17ZGF0YXNldHN9IG9uQWRkPXtvbkNsaWNrQWRkRmlsdGVyfSAvPlxuICAgICAgICAgIDwvUGFuZWxUaXRsZT5cbiAgICAgICAgPC9TaWRlUGFuZWxTZWN0aW9uPlxuICAgICAgICA8U2lkZVBhbmVsU2VjdGlvbj5cbiAgICAgICAgICB7aXNTb3J0QnlEYXRhc2V0TW9kZSA/IChcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKGZpbHRlcnNCeURhdGFzZXRzKS5tYXAoZGF0YUlkID0+IChcbiAgICAgICAgICAgICAgPERhdGFzZXRGaWx0ZXJTZWN0aW9uXG4gICAgICAgICAgICAgICAga2V5PXtkYXRhSWR9XG4gICAgICAgICAgICAgICAgZmlsdGVyc0J5SW5kZXg9e2ZpbHRlcnNCeURhdGFzZXRzW2RhdGFJZF19XG4gICAgICAgICAgICAgICAgZGF0YXNldD17ZGF0YXNldHNbZGF0YUlkXX1cbiAgICAgICAgICAgICAgICB7Li4uZmlsdGVyTGlzdFByb3BzfVxuICAgICAgICAgICAgICAgIHsuLi5zb3VyY2VEYXRhQ2F0YWxvZ1Byb3BzfVxuICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgKSlcbiAgICAgICAgICApIDogKFxuICAgICAgICAgICAgPEZpbHRlckxpc3QgZmlsdGVyc0J5SW5kZXg9e2ZpbHRlcnNCeUluZGV4fSB7Li4uZmlsdGVyTGlzdFByb3BzfSAvPlxuICAgICAgICAgICl9XG4gICAgICAgIDwvU2lkZVBhbmVsU2VjdGlvbj5cbiAgICAgIDwvZGl2PlxuICAgICk7XG4gIH07XG5cbiAgcmV0dXJuIEZpbHRlck1hbmFnZXI7XG59XG5cbmV4cG9ydCBkZWZhdWx0IEZpbHRlck1hbmFnZXJGYWN0b3J5O1xuIl19